<!DOCTYPE html>
<html xmlns='http://www.w3.org/1999/xhtml'>
  <head>
    <title>Code coverage for Doubtfire-api</title>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <script src='./assets/0.10.2/application.js' type='text/javascript'></script>    
    <link href='./assets/0.10.2/application.css' media='screen, projection, print' rel='stylesheet' type='text/css'>
    <link rel="shortcut icon" type="image/png" href="./assets/0.10.2/favicon_red.png" />
    <link rel="icon" type="image/png" href="./assets/0.10.2/favicon.png" />
  </head>
  
  <body>
    <div id="loading">
      <img src="./assets/0.10.2/loading.gif" alt="loading"/>
    </div>
    <div id="wrapper" style="display:none;">
      <div class="timestamp">Generated <abbr class="timeago" title="2018-09-15T20:18:53+10:00">2018-09-15T20:18:53+10:00</abbr></div>
      <ul class="group_tabs"></ul>

      <div id="content">
        <div class="file_list_container" id="AllFiles">
  <h2>
    <span class="group_name">All Files</span>
    (<span class="covered_percent"><span class="red">36.88%</span></span>
     covered at
     <span class="covered_strength">
       <span class="green">
         1.87
       </span>
    </span> hits/line)
  </h2>
  <a name="AllFiles"></a>
  <div>
    <b>81</b> files in total.
    <b>6030</b> relevant lines. 
    <span class="green"><b>2224</b> lines covered</span> and
    <span class="red"><b>3806</b> lines missed </span>
  </div>
  <table class="file_list">
    <thead>
      <tr>
        <th>File</th>
        <th>% covered</th>
        <th>Lines</th>
        <th>Relevant Lines</th>
        <th>Lines covered</th>
        <th>Lines missed</th>
        <th>Avg. Hits / Line</th>
      </tr>
    </thead>
    <tbody>
      
      <tr>
        <td class="strong"><a href="#de28e6c35f296737c7fa5dfd3859a41b7162a037" class="src_link" title="app/api/api.rb">app/api/api.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>67</td>
        <td>45</td>
        <td>45</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#f2c3a0cad2023eecd1ebbf5663a06f1dec51c9a8" class="src_link" title="app/api/authentication.rb">app/api/authentication.rb</a></td>
        <td class="red strong">48.03 %</td>
        <td>256</td>
        <td>127</td>
        <td>61</td>
        <td>66</td>
        <td>1.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#b3bb08a0535aa66968e797a7b7f5502d413cb839" class="src_link" title="app/api/group_sets.rb">app/api/group_sets.rb</a></td>
        <td class="red strong">40.1 %</td>
        <td>351</td>
        <td>202</td>
        <td>81</td>
        <td>121</td>
        <td>0.4</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#8650be8936d82b6e8c5ec1a56aeace25ac69da64" class="src_link" title="app/api/learning_alignment.rb">app/api/learning_alignment.rb</a></td>
        <td class="red strong">39.23 %</td>
        <td>236</td>
        <td>130</td>
        <td>51</td>
        <td>79</td>
        <td>0.4</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#d1391db9828de0f1467536969613fed3d6ef8b83" class="src_link" title="app/api/learning_outcomes.rb">app/api/learning_outcomes.rb</a></td>
        <td class="red strong">47.89 %</td>
        <td>115</td>
        <td>71</td>
        <td>34</td>
        <td>37</td>
        <td>0.5</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#82c0b5f13f809eea7e70396360e08fcb9099e7db" class="src_link" title="app/api/projects.rb">app/api/projects.rb</a></td>
        <td class="red strong">33.33 %</td>
        <td>184</td>
        <td>99</td>
        <td>33</td>
        <td>66</td>
        <td>0.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#cf50cba59d1b146fd9cd765fe1297d85c8ad22e6" class="src_link" title="app/api/settings.rb">app/api/settings.rb</a></td>
        <td class="red strong">80.0 %</td>
        <td>25</td>
        <td>10</td>
        <td>8</td>
        <td>2</td>
        <td>0.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#134fb691d64d053f11b9d42b11a9d4a52b780a86" class="src_link" title="app/api/students.rb">app/api/students.rb</a></td>
        <td class="red strong">63.16 %</td>
        <td>32</td>
        <td>19</td>
        <td>12</td>
        <td>7</td>
        <td>0.6</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#d8eb0f313977cf3d3c3ba989f489116d50d087af" class="src_link" title="app/api/submission/batch_task.rb">app/api/submission/batch_task.rb</a></td>
        <td class="red strong">47.62 %</td>
        <td>68</td>
        <td>42</td>
        <td>20</td>
        <td>22</td>
        <td>0.5</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#b2f836c46ee48cef0c37a94dae7e5edbd9456fc9" class="src_link" title="app/api/submission/generate.rb">app/api/submission/generate.rb</a></td>
        <td class="red strong">57.89 %</td>
        <td>31</td>
        <td>19</td>
        <td>11</td>
        <td>8</td>
        <td>0.6</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#eb3b04cfe9892d064a1e1458035b78917b817bc6" class="src_link" title="app/api/submission/generate_helpers.rb">app/api/submission/generate_helpers.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>33</td>
        <td>15</td>
        <td>15</td>
        <td>0</td>
        <td>1.5</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#3d90eb0df8dff723abc74444a9e75e96b9560ae0" class="src_link" title="app/api/submission/portfolio_api.rb">app/api/submission/portfolio_api.rb</a></td>
        <td class="red strong">42.37 %</td>
        <td>101</td>
        <td>59</td>
        <td>25</td>
        <td>34</td>
        <td>0.4</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#764901a042c71484ce4bec92e4c154083e14d84b" class="src_link" title="app/api/submission/portfolio_evidence_api.rb">app/api/submission/portfolio_evidence_api.rb</a></td>
        <td class="red strong">55.22 %</td>
        <td>115</td>
        <td>67</td>
        <td>37</td>
        <td>30</td>
        <td>0.6</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#adbed66d95e171a44142eec74e66e6e3fba823e9" class="src_link" title="app/api/task_comments.rb">app/api/task_comments.rb</a></td>
        <td class="red strong">40.59 %</td>
        <td>179</td>
        <td>101</td>
        <td>41</td>
        <td>60</td>
        <td>0.6</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#24c2aa2f8127942b467d04739241ff8dc95be92b" class="src_link" title="app/api/task_definitions.rb">app/api/task_definitions.rb</a></td>
        <td class="red strong">55.66 %</td>
        <td>392</td>
        <td>212</td>
        <td>118</td>
        <td>94</td>
        <td>0.6</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#0b1ba3b571be18824c569cdec104abda810aabff" class="src_link" title="app/api/tasks.rb">app/api/tasks.rb</a></td>
        <td class="red strong">28.47 %</td>
        <td>300</td>
        <td>144</td>
        <td>41</td>
        <td>103</td>
        <td>0.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#0d1033d37baa6d3158f62d6dd254a737e7f237af" class="src_link" title="app/api/tutorials.rb">app/api/tutorials.rb</a></td>
        <td class="red strong">77.36 %</td>
        <td>90</td>
        <td>53</td>
        <td>41</td>
        <td>12</td>
        <td>0.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#4f47df35634135180eae3a31364b5be64589c69d" class="src_link" title="app/api/unit_roles.rb">app/api/unit_roles.rb</a></td>
        <td class="red strong">59.65 %</td>
        <td>103</td>
        <td>57</td>
        <td>34</td>
        <td>23</td>
        <td>0.7</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#d3457113caa011ee0d29ecdea29c851cbaf99775" class="src_link" title="app/api/units.rb">app/api/units.rb</a></td>
        <td class="red strong">60.75 %</td>
        <td>315</td>
        <td>186</td>
        <td>113</td>
        <td>73</td>
        <td>0.7</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#8d70df213d126e0f49d50f91ee51694b35f1733a" class="src_link" title="app/api/users.rb">app/api/users.rb</a></td>
        <td class="red strong">74.07 %</td>
        <td>221</td>
        <td>108</td>
        <td>80</td>
        <td>28</td>
        <td>3.1</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#e614753115f01fa413a4ffc71f3a088f8fa604ef" class="src_link" title="app/controllers/application_controller.rb">app/controllers/application_controller.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>9</td>
        <td>2</td>
        <td>2</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#f7f045879d13ff6b3ee34777e93f20bd318f6db0" class="src_link" title="app/controllers/lecture_resource_downloads_controller.rb">app/controllers/lecture_resource_downloads_controller.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>43</td>
        <td>31</td>
        <td>0</td>
        <td>31</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#d406371c7b079ec497132ddbd6bab709299b4dfd" class="src_link" title="app/controllers/portfolio_downloads_controller.rb">app/controllers/portfolio_downloads_controller.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>56</td>
        <td>33</td>
        <td>0</td>
        <td>33</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#894e845701f7f082eb42024fb5ddb0fbeb0da523" class="src_link" title="app/controllers/task_downloads_controller.rb">app/controllers/task_downloads_controller.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>53</td>
        <td>35</td>
        <td>0</td>
        <td>35</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#b70a6919b2ed8160d73c419c861fa725e99b4c9a" class="src_link" title="app/controllers/task_submission_pdfs_controller.rb">app/controllers/task_submission_pdfs_controller.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>53</td>
        <td>35</td>
        <td>0</td>
        <td>35</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#6d796a0da7713ee1930a1eef67f5ae56ca4daace" class="src_link" title="app/helpers/application_helper.rb">app/helpers/application_helper.rb</a></td>
        <td class="red strong">42.86 %</td>
        <td>14</td>
        <td>7</td>
        <td>3</td>
        <td>4</td>
        <td>0.4</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#f62e847bc864983a6f7b3442ac54f5ec83afd7dc" class="src_link" title="app/helpers/authentication_helpers.rb">app/helpers/authentication_helpers.rb</a></td>
        <td class="green strong">92.0 %</td>
        <td>78</td>
        <td>25</td>
        <td>23</td>
        <td>2</td>
        <td>33.5</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#11586388c30c6c9e654ecc551adffdfdf03f5931" class="src_link" title="app/helpers/authorisation_helpers.rb">app/helpers/authorisation_helpers.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>28</td>
        <td>13</td>
        <td>13</td>
        <td>0</td>
        <td>36.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#d8ff462429709007b4927004d583f8b63315d80b" class="src_link" title="app/helpers/csv_helper.rb">app/helpers/csv_helper.rb</a></td>
        <td class="red strong">26.32 %</td>
        <td>34</td>
        <td>19</td>
        <td>5</td>
        <td>14</td>
        <td>0.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#a175b5576a84efcd5ecf50e290f1fbc03d6ec0b5" class="src_link" title="app/helpers/db_helpers.rb">app/helpers/db_helpers.rb</a></td>
        <td class="red strong">30.0 %</td>
        <td>18</td>
        <td>10</td>
        <td>3</td>
        <td>7</td>
        <td>0.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#678b1178790f1aca9dd9e4b615f5ad151a8930a3" class="src_link" title="app/helpers/doubtfire_logger.rb">app/helpers/doubtfire_logger.rb</a></td>
        <td class="red strong">60.0 %</td>
        <td>33</td>
        <td>10</td>
        <td>6</td>
        <td>4</td>
        <td>4.7</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#4c6715f7912a828087ba329d8521f39b10e64559" class="src_link" title="app/helpers/file_helper.rb">app/helpers/file_helper.rb</a></td>
        <td class="red strong">43.05 %</td>
        <td>468</td>
        <td>223</td>
        <td>96</td>
        <td>127</td>
        <td>6.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#ab98b97adbb651c679d0fee480de13cf9bc9003d" class="src_link" title="app/helpers/log_helper.rb">app/helpers/log_helper.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>16</td>
        <td>5</td>
        <td>5</td>
        <td>0</td>
        <td>9.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#48ae01723f16f085934910f5b27509261e976d06" class="src_link" title="app/helpers/mime-check-helpers.rb">app/helpers/mime-check-helpers.rb</a></td>
        <td class="red strong">56.67 %</td>
        <td>54</td>
        <td>30</td>
        <td>17</td>
        <td>13</td>
        <td>1.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#cf0ff7ed81eb0a82a2363a983af26afbc2be9e1e" class="src_link" title="app/helpers/timeout_helper.rb">app/helpers/timeout_helper.rb</a></td>
        <td class="green strong">92.86 %</td>
        <td>39</td>
        <td>14</td>
        <td>13</td>
        <td>1</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#628cd95164a8d3cb9f794f3af7cbed0995669036" class="src_link" title="app/mailers/convenor_contact_mailer.rb">app/mailers/convenor_contact_mailer.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>16</td>
        <td>14</td>
        <td>0</td>
        <td>14</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#d6f41f97ddc570e7512c459ab8f42eb785015c3e" class="src_link" title="app/mailers/notifications_mailer.rb">app/mailers/notifications_mailer.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>96</td>
        <td>73</td>
        <td>0</td>
        <td>73</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#e23d12fabe8998103d305afda644c8af56fea046" class="src_link" title="app/mailers/portfolio_evidence_mailer.rb">app/mailers/portfolio_evidence_mailer.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>87</td>
        <td>69</td>
        <td>0</td>
        <td>69</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#7c46a085effbe3cbe115c6d08237455ebd04b9a4" class="src_link" title="app/models/badge.rb">app/models/badge.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>3</td>
        <td>3</td>
        <td>0</td>
        <td>3</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#28db7d56c23f1330818532a265e0e725a2289796" class="src_link" title="app/models/comments_read_receipts.rb">app/models/comments_read_receipts.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>7</td>
        <td>5</td>
        <td>5</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#87382f76ecb1bd41e2a22efd559c504f3d39fa07" class="src_link" title="app/models/group.rb">app/models/group.rb</a></td>
        <td class="red strong">28.45 %</td>
        <td>224</td>
        <td>116</td>
        <td>33</td>
        <td>83</td>
        <td>0.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#f085e67a49f9f6d8a37f4980a6426da20859c519" class="src_link" title="app/models/group_membership.rb">app/models/group_membership.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>26</td>
        <td>18</td>
        <td>0</td>
        <td>18</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#bc8e9ab21d0a14335f1e80195cb7645d0153f1eb" class="src_link" title="app/models/group_set.rb">app/models/group_set.rb</a></td>
        <td class="red strong">39.13 %</td>
        <td>62</td>
        <td>23</td>
        <td>9</td>
        <td>14</td>
        <td>0.4</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#839aed3fd9e420e38c44d5b9ca3fd0f128e74a7f" class="src_link" title="app/models/group_submission.rb">app/models/group_submission.rb</a></td>
        <td class="red strong">40.63 %</td>
        <td>62</td>
        <td>32</td>
        <td>13</td>
        <td>19</td>
        <td>0.4</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#97b73fc72eeb1ea3f4d0e556e47037d4d477ba9e" class="src_link" title="app/models/learning_outcome.rb">app/models/learning_outcome.rb</a></td>
        <td class="red strong">27.03 %</td>
        <td>62</td>
        <td>37</td>
        <td>10</td>
        <td>27</td>
        <td>0.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#3cae1fac280f9e74d9be0ebb5d6e4607455830de" class="src_link" title="app/models/learning_outcome_task_link.rb">app/models/learning_outcome_task_link.rb</a></td>
        <td class="red strong">47.62 %</td>
        <td>36</td>
        <td>21</td>
        <td>10</td>
        <td>11</td>
        <td>0.5</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#d81977c32f5db4bce2263b487accaba1688da1be" class="src_link" title="app/models/login.rb">app/models/login.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>3</td>
        <td>3</td>
        <td>0</td>
        <td>3</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#65d163891fdaa0fcb2e8af157d1859c64d2246da" class="src_link" title="app/models/plagiarism_match_link.rb">app/models/plagiarism_match_link.rb</a></td>
        <td class="red strong">40.63 %</td>
        <td>75</td>
        <td>32</td>
        <td>13</td>
        <td>19</td>
        <td>0.4</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#78cd237b694da1f663c10a29b7298bab9069f5dc" class="src_link" title="app/models/portfolio_evidence.rb">app/models/portfolio_evidence.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>95</td>
        <td>65</td>
        <td>0</td>
        <td>65</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#b1064dba5d6e902308ec66611b299f922764c943" class="src_link" title="app/models/progress.rb">app/models/progress.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>39</td>
        <td>34</td>
        <td>0</td>
        <td>34</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#d969ced2b9a105997a944f292037a4033450227a" class="src_link" title="app/models/project.rb">app/models/project.rb</a></td>
        <td class="red strong">33.41 %</td>
        <td>986</td>
        <td>455</td>
        <td>152</td>
        <td>303</td>
        <td>0.6</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#a35a3538b419ef463052fdaebd3fbd0e5b696ee4" class="src_link" title="app/models/role.rb">app/models/role.rb</a></td>
        <td class="yellow strong">83.87 %</td>
        <td>75</td>
        <td>31</td>
        <td>26</td>
        <td>5</td>
        <td>35.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#c0bc6c1b67d3ae45a199f965c5f50ce5fe67d9c9" class="src_link" title="app/models/sub_task.rb">app/models/sub_task.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>7</td>
        <td>4</td>
        <td>4</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#19b7bd4c0d2afa41bc6be942bf9cbfaf437954e5" class="src_link" title="app/models/sub_task_definition.rb">app/models/sub_task_definition.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>5</td>
        <td>4</td>
        <td>0</td>
        <td>4</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#114665aaf43e5bf235b9ed95cd21eda064911063" class="src_link" title="app/models/task.rb">app/models/task.rb</a></td>
        <td class="red strong">43.19 %</td>
        <td>1067</td>
        <td>514</td>
        <td>222</td>
        <td>292</td>
        <td>0.6</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#6903e6357a04a7edffb2648b7af49bee6f0d77b0" class="src_link" title="app/models/task_comment.rb">app/models/task_comment.rb</a></td>
        <td class="red strong">72.58 %</td>
        <td>121</td>
        <td>62</td>
        <td>45</td>
        <td>17</td>
        <td>1.4</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#a2147f0eb4a3fbf8e748efc8aecf9978c3ff501c" class="src_link" title="app/models/task_definition.rb">app/models/task_definition.rb</a></td>
        <td class="red strong">44.8 %</td>
        <td>515</td>
        <td>250</td>
        <td>112</td>
        <td>138</td>
        <td>3.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#fa432c23e3fcf893b9e3311965b7aff48ee098fb" class="src_link" title="app/models/task_engagement.rb">app/models/task_engagement.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>3</td>
        <td>2</td>
        <td>2</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#5aeec9c9bd0581cafbc5d729f54153b23fc7c2e1" class="src_link" title="app/models/task_status.rb">app/models/task_status.rb</a></td>
        <td class="red strong">55.93 %</td>
        <td>79</td>
        <td>59</td>
        <td>33</td>
        <td>26</td>
        <td>6.6</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#6df2ae2e99e1b951d2613ee7d4792c23ea0bb129" class="src_link" title="app/models/task_submission.rb">app/models/task_submission.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>4</td>
        <td>3</td>
        <td>3</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#1848017ad1c1865041806c37f40cc4a589d1309e" class="src_link" title="app/models/tutorial.rb">app/models/tutorial.rb</a></td>
        <td class="red strong">54.84 %</td>
        <td>62</td>
        <td>31</td>
        <td>17</td>
        <td>14</td>
        <td>3.6</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#e9bef8bd548ebc37e74d79ed5c556d967949b969" class="src_link" title="app/models/unit.rb">app/models/unit.rb</a></td>
        <td class="red strong">14.27 %</td>
        <td>2159</td>
        <td>953</td>
        <td>136</td>
        <td>817</td>
        <td>0.4</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#444000ab681deec83bb0ef8354a59be67bb4d91a" class="src_link" title="app/models/unit_role.rb">app/models/unit_role.rb</a></td>
        <td class="red strong">42.65 %</td>
        <td>153</td>
        <td>68</td>
        <td>29</td>
        <td>39</td>
        <td>0.4</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#0af27a24a8b4dd55e259899999667e2ffdd54cd9" class="src_link" title="app/models/user.rb">app/models/user.rb</a></td>
        <td class="red strong">54.73 %</td>
        <td>494</td>
        <td>201</td>
        <td>110</td>
        <td>91</td>
        <td>14.6</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#8cf325e62291f6c5562bdfac50bd1aabc322c4ae" class="src_link" title="app/serializers/group_serializer.rb">app/serializers/group_serializer.rb</a></td>
        <td class="yellow strong">83.33 %</td>
        <td>12</td>
        <td>6</td>
        <td>5</td>
        <td>1</td>
        <td>0.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#c4a07f8e04336b0c352b7b8803b16d33be8e641a" class="src_link" title="app/serializers/group_set_serializer.rb">app/serializers/group_set_serializer.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>6</td>
        <td>2</td>
        <td>2</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#c23fd14ab725530d554630bcd58176590f3e704c" class="src_link" title="app/serializers/learning_outcome_serializer.rb">app/serializers/learning_outcome_serializer.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>4</td>
        <td>2</td>
        <td>2</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#597dace87a6249283bbc53b9bb9b65d612073e9b" class="src_link" title="app/serializers/learning_outcome_task_link_serializer.rb">app/serializers/learning_outcome_task_link_serializer.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>8</td>
        <td>2</td>
        <td>2</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#06ffb7be1bd2b207f92f0fe9a435a0c2a8e51a40" class="src_link" title="app/serializers/project_serializer.rb">app/serializers/project_serializer.rb</a></td>
        <td class="red strong">56.52 %</td>
        <td>107</td>
        <td>46</td>
        <td>26</td>
        <td>20</td>
        <td>0.6</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#e0a86349491149f80f2d5c7abb6212fc775d3313" class="src_link" title="app/serializers/role_serializer.rb">app/serializers/role_serializer.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>3</td>
        <td>3</td>
        <td>0</td>
        <td>3</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#b5acfb72ef42b695b165549c5a7c5dffd403741b" class="src_link" title="app/serializers/task_comment_serializer.rb">app/serializers/task_comment_serializer.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>19</td>
        <td>17</td>
        <td>0</td>
        <td>17</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#7aa61ebdb7b98f897c77fa7258bf65bdfd35e68e" class="src_link" title="app/serializers/task_definition_serializer.rb">app/serializers/task_definition_serializer.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>13</td>
        <td>4</td>
        <td>4</td>
        <td>0</td>
        <td>8.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#874fe9917169e93e61b6378d98789a718b5e1730" class="src_link" title="app/serializers/task_serializer.rb">app/serializers/task_serializer.rb</a></td>
        <td class="red strong">69.23 %</td>
        <td>53</td>
        <td>26</td>
        <td>18</td>
        <td>8</td>
        <td>0.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#c96e78d9fa0b34066abf0f2568a135fd9b2a4d73" class="src_link" title="app/serializers/tutorial_serializer.rb">app/serializers/tutorial_serializer.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>36</td>
        <td>20</td>
        <td>20</td>
        <td>0</td>
        <td>12.5</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#22ca2cd92ae6331364e89845bb5c9b8d236b383a" class="src_link" title="app/serializers/unit_role_serializer.rb">app/serializers/unit_role_serializer.rb</a></td>
        <td class="green strong">93.75 %</td>
        <td>66</td>
        <td>32</td>
        <td>30</td>
        <td>2</td>
        <td>2.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#f19b2895c64d322f0a8a4cd50e3123d2f8eaa373" class="src_link" title="app/serializers/unit_serializer.rb">app/serializers/unit_serializer.rb</a></td>
        <td class="green strong">97.44 %</td>
        <td>66</td>
        <td>39</td>
        <td>38</td>
        <td>1</td>
        <td>2.1</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#7a71d446d2a4d8ad45da838bf785d269e674e8b3" class="src_link" title="app/serializers/user_role_serializer.rb">app/serializers/user_role_serializer.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>6</td>
        <td>5</td>
        <td>0</td>
        <td>5</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#08becbc800961ae554eeef0740cce19c120ca2ab" class="src_link" title="app/serializers/user_serializer.rb">app/serializers/user_serializer.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>12</td>
        <td>6</td>
        <td>6</td>
        <td>0</td>
        <td>14.5</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#a5d5f8025fdac669c5c77913afaedb49083dcb71" class="src_link" title="lib/helpers/database_populator.rb">lib/helpers/database_populator.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>434</td>
        <td>345</td>
        <td>0</td>
        <td>345</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#38585849ec681e9a0a489b98ee2aec73aa3375e5" class="src_link" title="lib/helpers/find_or_create_students.rb">lib/helpers/find_or_create_students.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>24</td>
        <td>21</td>
        <td>0</td>
        <td>21</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#092a7f28fe849b641b460fceb6919b2074e5fded" class="src_link" title="lib/helpers/randomizer.rb">lib/helpers/randomizer.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>25</td>
        <td>14</td>
        <td>0</td>
        <td>14</td>
        <td>0.0</td>
      </tr>
      
    </tbody>
  </table>
</div>


        
          <div class="file_list_container" id="Controllers">
  <h2>
    <span class="group_name">Controllers</span>
    (<span class="covered_percent"><span class="red">1.47%</span></span>
     covered at
     <span class="covered_strength">
       <span class="red">
         0.01
       </span>
    </span> hits/line)
  </h2>
  <a name="Controllers"></a>
  <div>
    <b>5</b> files in total.
    <b>136</b> relevant lines. 
    <span class="green"><b>2</b> lines covered</span> and
    <span class="red"><b>134</b> lines missed </span>
  </div>
  <table class="file_list">
    <thead>
      <tr>
        <th>File</th>
        <th>% covered</th>
        <th>Lines</th>
        <th>Relevant Lines</th>
        <th>Lines covered</th>
        <th>Lines missed</th>
        <th>Avg. Hits / Line</th>
      </tr>
    </thead>
    <tbody>
      
      <tr>
        <td class="strong"><a href="#e614753115f01fa413a4ffc71f3a088f8fa604ef" class="src_link" title="app/controllers/application_controller.rb">app/controllers/application_controller.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>9</td>
        <td>2</td>
        <td>2</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#f7f045879d13ff6b3ee34777e93f20bd318f6db0" class="src_link" title="app/controllers/lecture_resource_downloads_controller.rb">app/controllers/lecture_resource_downloads_controller.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>43</td>
        <td>31</td>
        <td>0</td>
        <td>31</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#d406371c7b079ec497132ddbd6bab709299b4dfd" class="src_link" title="app/controllers/portfolio_downloads_controller.rb">app/controllers/portfolio_downloads_controller.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>56</td>
        <td>33</td>
        <td>0</td>
        <td>33</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#894e845701f7f082eb42024fb5ddb0fbeb0da523" class="src_link" title="app/controllers/task_downloads_controller.rb">app/controllers/task_downloads_controller.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>53</td>
        <td>35</td>
        <td>0</td>
        <td>35</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#b70a6919b2ed8160d73c419c861fa725e99b4c9a" class="src_link" title="app/controllers/task_submission_pdfs_controller.rb">app/controllers/task_submission_pdfs_controller.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>53</td>
        <td>35</td>
        <td>0</td>
        <td>35</td>
        <td>0.0</td>
      </tr>
      
    </tbody>
  </table>
</div>

        
          <div class="file_list_container" id="Models">
  <h2>
    <span class="group_name">Models</span>
    (<span class="covered_percent"><span class="red">32.52%</span></span>
     covered at
     <span class="covered_strength">
       <span class="green">
         2.16
       </span>
    </span> hits/line)
  </h2>
  <a name="Models"></a>
  <div>
    <b>26</b> files in total.
    <b>3026</b> relevant lines. 
    <span class="green"><b>984</b> lines covered</span> and
    <span class="red"><b>2042</b> lines missed </span>
  </div>
  <table class="file_list">
    <thead>
      <tr>
        <th>File</th>
        <th>% covered</th>
        <th>Lines</th>
        <th>Relevant Lines</th>
        <th>Lines covered</th>
        <th>Lines missed</th>
        <th>Avg. Hits / Line</th>
      </tr>
    </thead>
    <tbody>
      
      <tr>
        <td class="strong"><a href="#7c46a085effbe3cbe115c6d08237455ebd04b9a4" class="src_link" title="app/models/badge.rb">app/models/badge.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>3</td>
        <td>3</td>
        <td>0</td>
        <td>3</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#28db7d56c23f1330818532a265e0e725a2289796" class="src_link" title="app/models/comments_read_receipts.rb">app/models/comments_read_receipts.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>7</td>
        <td>5</td>
        <td>5</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#87382f76ecb1bd41e2a22efd559c504f3d39fa07" class="src_link" title="app/models/group.rb">app/models/group.rb</a></td>
        <td class="red strong">28.45 %</td>
        <td>224</td>
        <td>116</td>
        <td>33</td>
        <td>83</td>
        <td>0.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#f085e67a49f9f6d8a37f4980a6426da20859c519" class="src_link" title="app/models/group_membership.rb">app/models/group_membership.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>26</td>
        <td>18</td>
        <td>0</td>
        <td>18</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#bc8e9ab21d0a14335f1e80195cb7645d0153f1eb" class="src_link" title="app/models/group_set.rb">app/models/group_set.rb</a></td>
        <td class="red strong">39.13 %</td>
        <td>62</td>
        <td>23</td>
        <td>9</td>
        <td>14</td>
        <td>0.4</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#839aed3fd9e420e38c44d5b9ca3fd0f128e74a7f" class="src_link" title="app/models/group_submission.rb">app/models/group_submission.rb</a></td>
        <td class="red strong">40.63 %</td>
        <td>62</td>
        <td>32</td>
        <td>13</td>
        <td>19</td>
        <td>0.4</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#97b73fc72eeb1ea3f4d0e556e47037d4d477ba9e" class="src_link" title="app/models/learning_outcome.rb">app/models/learning_outcome.rb</a></td>
        <td class="red strong">27.03 %</td>
        <td>62</td>
        <td>37</td>
        <td>10</td>
        <td>27</td>
        <td>0.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#3cae1fac280f9e74d9be0ebb5d6e4607455830de" class="src_link" title="app/models/learning_outcome_task_link.rb">app/models/learning_outcome_task_link.rb</a></td>
        <td class="red strong">47.62 %</td>
        <td>36</td>
        <td>21</td>
        <td>10</td>
        <td>11</td>
        <td>0.5</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#d81977c32f5db4bce2263b487accaba1688da1be" class="src_link" title="app/models/login.rb">app/models/login.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>3</td>
        <td>3</td>
        <td>0</td>
        <td>3</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#65d163891fdaa0fcb2e8af157d1859c64d2246da" class="src_link" title="app/models/plagiarism_match_link.rb">app/models/plagiarism_match_link.rb</a></td>
        <td class="red strong">40.63 %</td>
        <td>75</td>
        <td>32</td>
        <td>13</td>
        <td>19</td>
        <td>0.4</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#78cd237b694da1f663c10a29b7298bab9069f5dc" class="src_link" title="app/models/portfolio_evidence.rb">app/models/portfolio_evidence.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>95</td>
        <td>65</td>
        <td>0</td>
        <td>65</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#b1064dba5d6e902308ec66611b299f922764c943" class="src_link" title="app/models/progress.rb">app/models/progress.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>39</td>
        <td>34</td>
        <td>0</td>
        <td>34</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#d969ced2b9a105997a944f292037a4033450227a" class="src_link" title="app/models/project.rb">app/models/project.rb</a></td>
        <td class="red strong">33.41 %</td>
        <td>986</td>
        <td>455</td>
        <td>152</td>
        <td>303</td>
        <td>0.6</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#a35a3538b419ef463052fdaebd3fbd0e5b696ee4" class="src_link" title="app/models/role.rb">app/models/role.rb</a></td>
        <td class="yellow strong">83.87 %</td>
        <td>75</td>
        <td>31</td>
        <td>26</td>
        <td>5</td>
        <td>35.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#c0bc6c1b67d3ae45a199f965c5f50ce5fe67d9c9" class="src_link" title="app/models/sub_task.rb">app/models/sub_task.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>7</td>
        <td>4</td>
        <td>4</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#19b7bd4c0d2afa41bc6be942bf9cbfaf437954e5" class="src_link" title="app/models/sub_task_definition.rb">app/models/sub_task_definition.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>5</td>
        <td>4</td>
        <td>0</td>
        <td>4</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#114665aaf43e5bf235b9ed95cd21eda064911063" class="src_link" title="app/models/task.rb">app/models/task.rb</a></td>
        <td class="red strong">43.19 %</td>
        <td>1067</td>
        <td>514</td>
        <td>222</td>
        <td>292</td>
        <td>0.6</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#6903e6357a04a7edffb2648b7af49bee6f0d77b0" class="src_link" title="app/models/task_comment.rb">app/models/task_comment.rb</a></td>
        <td class="red strong">72.58 %</td>
        <td>121</td>
        <td>62</td>
        <td>45</td>
        <td>17</td>
        <td>1.4</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#a2147f0eb4a3fbf8e748efc8aecf9978c3ff501c" class="src_link" title="app/models/task_definition.rb">app/models/task_definition.rb</a></td>
        <td class="red strong">44.8 %</td>
        <td>515</td>
        <td>250</td>
        <td>112</td>
        <td>138</td>
        <td>3.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#fa432c23e3fcf893b9e3311965b7aff48ee098fb" class="src_link" title="app/models/task_engagement.rb">app/models/task_engagement.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>3</td>
        <td>2</td>
        <td>2</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#5aeec9c9bd0581cafbc5d729f54153b23fc7c2e1" class="src_link" title="app/models/task_status.rb">app/models/task_status.rb</a></td>
        <td class="red strong">55.93 %</td>
        <td>79</td>
        <td>59</td>
        <td>33</td>
        <td>26</td>
        <td>6.6</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#6df2ae2e99e1b951d2613ee7d4792c23ea0bb129" class="src_link" title="app/models/task_submission.rb">app/models/task_submission.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>4</td>
        <td>3</td>
        <td>3</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#1848017ad1c1865041806c37f40cc4a589d1309e" class="src_link" title="app/models/tutorial.rb">app/models/tutorial.rb</a></td>
        <td class="red strong">54.84 %</td>
        <td>62</td>
        <td>31</td>
        <td>17</td>
        <td>14</td>
        <td>3.6</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#e9bef8bd548ebc37e74d79ed5c556d967949b969" class="src_link" title="app/models/unit.rb">app/models/unit.rb</a></td>
        <td class="red strong">14.27 %</td>
        <td>2159</td>
        <td>953</td>
        <td>136</td>
        <td>817</td>
        <td>0.4</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#444000ab681deec83bb0ef8354a59be67bb4d91a" class="src_link" title="app/models/unit_role.rb">app/models/unit_role.rb</a></td>
        <td class="red strong">42.65 %</td>
        <td>153</td>
        <td>68</td>
        <td>29</td>
        <td>39</td>
        <td>0.4</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#0af27a24a8b4dd55e259899999667e2ffdd54cd9" class="src_link" title="app/models/user.rb">app/models/user.rb</a></td>
        <td class="red strong">54.73 %</td>
        <td>494</td>
        <td>201</td>
        <td>110</td>
        <td>91</td>
        <td>14.6</td>
      </tr>
      
    </tbody>
  </table>
</div>

        
          <div class="file_list_container" id="Mailers">
  <h2>
    <span class="group_name">Mailers</span>
    (<span class="covered_percent"><span class="red">0.0%</span></span>
     covered at
     <span class="covered_strength">
       <span class="red">
         0.0
       </span>
    </span> hits/line)
  </h2>
  <a name="Mailers"></a>
  <div>
    <b>3</b> files in total.
    <b>156</b> relevant lines. 
    <span class="green"><b>0</b> lines covered</span> and
    <span class="red"><b>156</b> lines missed </span>
  </div>
  <table class="file_list">
    <thead>
      <tr>
        <th>File</th>
        <th>% covered</th>
        <th>Lines</th>
        <th>Relevant Lines</th>
        <th>Lines covered</th>
        <th>Lines missed</th>
        <th>Avg. Hits / Line</th>
      </tr>
    </thead>
    <tbody>
      
      <tr>
        <td class="strong"><a href="#628cd95164a8d3cb9f794f3af7cbed0995669036" class="src_link" title="app/mailers/convenor_contact_mailer.rb">app/mailers/convenor_contact_mailer.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>16</td>
        <td>14</td>
        <td>0</td>
        <td>14</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#d6f41f97ddc570e7512c459ab8f42eb785015c3e" class="src_link" title="app/mailers/notifications_mailer.rb">app/mailers/notifications_mailer.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>96</td>
        <td>73</td>
        <td>0</td>
        <td>73</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#e23d12fabe8998103d305afda644c8af56fea046" class="src_link" title="app/mailers/portfolio_evidence_mailer.rb">app/mailers/portfolio_evidence_mailer.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>87</td>
        <td>69</td>
        <td>0</td>
        <td>69</td>
        <td>0.0</td>
      </tr>
      
    </tbody>
  </table>
</div>

        
          <div class="file_list_container" id="Helpers">
  <h2>
    <span class="group_name">Helpers</span>
    (<span class="covered_percent"><span class="red">51.69%</span></span>
     covered at
     <span class="covered_strength">
       <span class="green">
         8.01
       </span>
    </span> hits/line)
  </h2>
  <a name="Helpers"></a>
  <div>
    <b>10</b> files in total.
    <b>356</b> relevant lines. 
    <span class="green"><b>184</b> lines covered</span> and
    <span class="red"><b>172</b> lines missed </span>
  </div>
  <table class="file_list">
    <thead>
      <tr>
        <th>File</th>
        <th>% covered</th>
        <th>Lines</th>
        <th>Relevant Lines</th>
        <th>Lines covered</th>
        <th>Lines missed</th>
        <th>Avg. Hits / Line</th>
      </tr>
    </thead>
    <tbody>
      
      <tr>
        <td class="strong"><a href="#6d796a0da7713ee1930a1eef67f5ae56ca4daace" class="src_link" title="app/helpers/application_helper.rb">app/helpers/application_helper.rb</a></td>
        <td class="red strong">42.86 %</td>
        <td>14</td>
        <td>7</td>
        <td>3</td>
        <td>4</td>
        <td>0.4</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#f62e847bc864983a6f7b3442ac54f5ec83afd7dc" class="src_link" title="app/helpers/authentication_helpers.rb">app/helpers/authentication_helpers.rb</a></td>
        <td class="green strong">92.0 %</td>
        <td>78</td>
        <td>25</td>
        <td>23</td>
        <td>2</td>
        <td>33.5</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#11586388c30c6c9e654ecc551adffdfdf03f5931" class="src_link" title="app/helpers/authorisation_helpers.rb">app/helpers/authorisation_helpers.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>28</td>
        <td>13</td>
        <td>13</td>
        <td>0</td>
        <td>36.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#d8ff462429709007b4927004d583f8b63315d80b" class="src_link" title="app/helpers/csv_helper.rb">app/helpers/csv_helper.rb</a></td>
        <td class="red strong">26.32 %</td>
        <td>34</td>
        <td>19</td>
        <td>5</td>
        <td>14</td>
        <td>0.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#a175b5576a84efcd5ecf50e290f1fbc03d6ec0b5" class="src_link" title="app/helpers/db_helpers.rb">app/helpers/db_helpers.rb</a></td>
        <td class="red strong">30.0 %</td>
        <td>18</td>
        <td>10</td>
        <td>3</td>
        <td>7</td>
        <td>0.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#678b1178790f1aca9dd9e4b615f5ad151a8930a3" class="src_link" title="app/helpers/doubtfire_logger.rb">app/helpers/doubtfire_logger.rb</a></td>
        <td class="red strong">60.0 %</td>
        <td>33</td>
        <td>10</td>
        <td>6</td>
        <td>4</td>
        <td>4.7</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#4c6715f7912a828087ba329d8521f39b10e64559" class="src_link" title="app/helpers/file_helper.rb">app/helpers/file_helper.rb</a></td>
        <td class="red strong">43.05 %</td>
        <td>468</td>
        <td>223</td>
        <td>96</td>
        <td>127</td>
        <td>6.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#ab98b97adbb651c679d0fee480de13cf9bc9003d" class="src_link" title="app/helpers/log_helper.rb">app/helpers/log_helper.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>16</td>
        <td>5</td>
        <td>5</td>
        <td>0</td>
        <td>9.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#48ae01723f16f085934910f5b27509261e976d06" class="src_link" title="app/helpers/mime-check-helpers.rb">app/helpers/mime-check-helpers.rb</a></td>
        <td class="red strong">56.67 %</td>
        <td>54</td>
        <td>30</td>
        <td>17</td>
        <td>13</td>
        <td>1.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#cf0ff7ed81eb0a82a2363a983af26afbc2be9e1e" class="src_link" title="app/helpers/timeout_helper.rb">app/helpers/timeout_helper.rb</a></td>
        <td class="green strong">92.86 %</td>
        <td>39</td>
        <td>14</td>
        <td>13</td>
        <td>1</td>
        <td>1.0</td>
      </tr>
      
    </tbody>
  </table>
</div>

        
          <div class="file_list_container" id="Jobs">
  <h2>
    <span class="group_name">Jobs</span>
    (<span class="covered_percent"><span class="green">100.0%</span></span>
     covered at
     <span class="covered_strength">
       <span class="red">
         0.0
       </span>
    </span> hits/line)
  </h2>
  <a name="Jobs"></a>
  <div>
    <b>0</b> files in total.
    <b>0.0</b> relevant lines. 
    <span class="green"><b>0.0</b> lines covered</span> and
    <span class="red"><b>0.0</b> lines missed </span>
  </div>
  <table class="file_list">
    <thead>
      <tr>
        <th>File</th>
        <th>% covered</th>
        <th>Lines</th>
        <th>Relevant Lines</th>
        <th>Lines covered</th>
        <th>Lines missed</th>
        <th>Avg. Hits / Line</th>
      </tr>
    </thead>
    <tbody>
      
    </tbody>
  </table>
</div>

        
          <div class="file_list_container" id="Libraries">
  <h2>
    <span class="group_name">Libraries</span>
    (<span class="covered_percent"><span class="red">0.0%</span></span>
     covered at
     <span class="covered_strength">
       <span class="red">
         0.0
       </span>
    </span> hits/line)
  </h2>
  <a name="Libraries"></a>
  <div>
    <b>3</b> files in total.
    <b>380</b> relevant lines. 
    <span class="green"><b>0</b> lines covered</span> and
    <span class="red"><b>380</b> lines missed </span>
  </div>
  <table class="file_list">
    <thead>
      <tr>
        <th>File</th>
        <th>% covered</th>
        <th>Lines</th>
        <th>Relevant Lines</th>
        <th>Lines covered</th>
        <th>Lines missed</th>
        <th>Avg. Hits / Line</th>
      </tr>
    </thead>
    <tbody>
      
      <tr>
        <td class="strong"><a href="#a5d5f8025fdac669c5c77913afaedb49083dcb71" class="src_link" title="lib/helpers/database_populator.rb">lib/helpers/database_populator.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>434</td>
        <td>345</td>
        <td>0</td>
        <td>345</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#38585849ec681e9a0a489b98ee2aec73aa3375e5" class="src_link" title="lib/helpers/find_or_create_students.rb">lib/helpers/find_or_create_students.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>24</td>
        <td>21</td>
        <td>0</td>
        <td>21</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#092a7f28fe849b641b460fceb6919b2074e5fded" class="src_link" title="lib/helpers/randomizer.rb">lib/helpers/randomizer.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>25</td>
        <td>14</td>
        <td>0</td>
        <td>14</td>
        <td>0.0</td>
      </tr>
      
    </tbody>
  </table>
</div>

        
          <div class="file_list_container" id="Ungrouped">
  <h2>
    <span class="group_name">Ungrouped</span>
    (<span class="covered_percent"><span class="red">53.34%</span></span>
     covered at
     <span class="covered_strength">
       <span class="red">
         0.96
       </span>
    </span> hits/line)
  </h2>
  <a name="Ungrouped"></a>
  <div>
    <b>34</b> files in total.
    <b>1976</b> relevant lines. 
    <span class="green"><b>1054</b> lines covered</span> and
    <span class="red"><b>922</b> lines missed </span>
  </div>
  <table class="file_list">
    <thead>
      <tr>
        <th>File</th>
        <th>% covered</th>
        <th>Lines</th>
        <th>Relevant Lines</th>
        <th>Lines covered</th>
        <th>Lines missed</th>
        <th>Avg. Hits / Line</th>
      </tr>
    </thead>
    <tbody>
      
      <tr>
        <td class="strong"><a href="#de28e6c35f296737c7fa5dfd3859a41b7162a037" class="src_link" title="app/api/api.rb">app/api/api.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>67</td>
        <td>45</td>
        <td>45</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#f2c3a0cad2023eecd1ebbf5663a06f1dec51c9a8" class="src_link" title="app/api/authentication.rb">app/api/authentication.rb</a></td>
        <td class="red strong">48.03 %</td>
        <td>256</td>
        <td>127</td>
        <td>61</td>
        <td>66</td>
        <td>1.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#b3bb08a0535aa66968e797a7b7f5502d413cb839" class="src_link" title="app/api/group_sets.rb">app/api/group_sets.rb</a></td>
        <td class="red strong">40.1 %</td>
        <td>351</td>
        <td>202</td>
        <td>81</td>
        <td>121</td>
        <td>0.4</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#8650be8936d82b6e8c5ec1a56aeace25ac69da64" class="src_link" title="app/api/learning_alignment.rb">app/api/learning_alignment.rb</a></td>
        <td class="red strong">39.23 %</td>
        <td>236</td>
        <td>130</td>
        <td>51</td>
        <td>79</td>
        <td>0.4</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#d1391db9828de0f1467536969613fed3d6ef8b83" class="src_link" title="app/api/learning_outcomes.rb">app/api/learning_outcomes.rb</a></td>
        <td class="red strong">47.89 %</td>
        <td>115</td>
        <td>71</td>
        <td>34</td>
        <td>37</td>
        <td>0.5</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#82c0b5f13f809eea7e70396360e08fcb9099e7db" class="src_link" title="app/api/projects.rb">app/api/projects.rb</a></td>
        <td class="red strong">33.33 %</td>
        <td>184</td>
        <td>99</td>
        <td>33</td>
        <td>66</td>
        <td>0.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#cf50cba59d1b146fd9cd765fe1297d85c8ad22e6" class="src_link" title="app/api/settings.rb">app/api/settings.rb</a></td>
        <td class="red strong">80.0 %</td>
        <td>25</td>
        <td>10</td>
        <td>8</td>
        <td>2</td>
        <td>0.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#134fb691d64d053f11b9d42b11a9d4a52b780a86" class="src_link" title="app/api/students.rb">app/api/students.rb</a></td>
        <td class="red strong">63.16 %</td>
        <td>32</td>
        <td>19</td>
        <td>12</td>
        <td>7</td>
        <td>0.6</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#d8eb0f313977cf3d3c3ba989f489116d50d087af" class="src_link" title="app/api/submission/batch_task.rb">app/api/submission/batch_task.rb</a></td>
        <td class="red strong">47.62 %</td>
        <td>68</td>
        <td>42</td>
        <td>20</td>
        <td>22</td>
        <td>0.5</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#b2f836c46ee48cef0c37a94dae7e5edbd9456fc9" class="src_link" title="app/api/submission/generate.rb">app/api/submission/generate.rb</a></td>
        <td class="red strong">57.89 %</td>
        <td>31</td>
        <td>19</td>
        <td>11</td>
        <td>8</td>
        <td>0.6</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#eb3b04cfe9892d064a1e1458035b78917b817bc6" class="src_link" title="app/api/submission/generate_helpers.rb">app/api/submission/generate_helpers.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>33</td>
        <td>15</td>
        <td>15</td>
        <td>0</td>
        <td>1.5</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#3d90eb0df8dff723abc74444a9e75e96b9560ae0" class="src_link" title="app/api/submission/portfolio_api.rb">app/api/submission/portfolio_api.rb</a></td>
        <td class="red strong">42.37 %</td>
        <td>101</td>
        <td>59</td>
        <td>25</td>
        <td>34</td>
        <td>0.4</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#764901a042c71484ce4bec92e4c154083e14d84b" class="src_link" title="app/api/submission/portfolio_evidence_api.rb">app/api/submission/portfolio_evidence_api.rb</a></td>
        <td class="red strong">55.22 %</td>
        <td>115</td>
        <td>67</td>
        <td>37</td>
        <td>30</td>
        <td>0.6</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#adbed66d95e171a44142eec74e66e6e3fba823e9" class="src_link" title="app/api/task_comments.rb">app/api/task_comments.rb</a></td>
        <td class="red strong">40.59 %</td>
        <td>179</td>
        <td>101</td>
        <td>41</td>
        <td>60</td>
        <td>0.6</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#24c2aa2f8127942b467d04739241ff8dc95be92b" class="src_link" title="app/api/task_definitions.rb">app/api/task_definitions.rb</a></td>
        <td class="red strong">55.66 %</td>
        <td>392</td>
        <td>212</td>
        <td>118</td>
        <td>94</td>
        <td>0.6</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#0b1ba3b571be18824c569cdec104abda810aabff" class="src_link" title="app/api/tasks.rb">app/api/tasks.rb</a></td>
        <td class="red strong">28.47 %</td>
        <td>300</td>
        <td>144</td>
        <td>41</td>
        <td>103</td>
        <td>0.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#0d1033d37baa6d3158f62d6dd254a737e7f237af" class="src_link" title="app/api/tutorials.rb">app/api/tutorials.rb</a></td>
        <td class="red strong">77.36 %</td>
        <td>90</td>
        <td>53</td>
        <td>41</td>
        <td>12</td>
        <td>0.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#4f47df35634135180eae3a31364b5be64589c69d" class="src_link" title="app/api/unit_roles.rb">app/api/unit_roles.rb</a></td>
        <td class="red strong">59.65 %</td>
        <td>103</td>
        <td>57</td>
        <td>34</td>
        <td>23</td>
        <td>0.7</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#d3457113caa011ee0d29ecdea29c851cbaf99775" class="src_link" title="app/api/units.rb">app/api/units.rb</a></td>
        <td class="red strong">60.75 %</td>
        <td>315</td>
        <td>186</td>
        <td>113</td>
        <td>73</td>
        <td>0.7</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#8d70df213d126e0f49d50f91ee51694b35f1733a" class="src_link" title="app/api/users.rb">app/api/users.rb</a></td>
        <td class="red strong">74.07 %</td>
        <td>221</td>
        <td>108</td>
        <td>80</td>
        <td>28</td>
        <td>3.1</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#8cf325e62291f6c5562bdfac50bd1aabc322c4ae" class="src_link" title="app/serializers/group_serializer.rb">app/serializers/group_serializer.rb</a></td>
        <td class="yellow strong">83.33 %</td>
        <td>12</td>
        <td>6</td>
        <td>5</td>
        <td>1</td>
        <td>0.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#c4a07f8e04336b0c352b7b8803b16d33be8e641a" class="src_link" title="app/serializers/group_set_serializer.rb">app/serializers/group_set_serializer.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>6</td>
        <td>2</td>
        <td>2</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#c23fd14ab725530d554630bcd58176590f3e704c" class="src_link" title="app/serializers/learning_outcome_serializer.rb">app/serializers/learning_outcome_serializer.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>4</td>
        <td>2</td>
        <td>2</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#597dace87a6249283bbc53b9bb9b65d612073e9b" class="src_link" title="app/serializers/learning_outcome_task_link_serializer.rb">app/serializers/learning_outcome_task_link_serializer.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>8</td>
        <td>2</td>
        <td>2</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#06ffb7be1bd2b207f92f0fe9a435a0c2a8e51a40" class="src_link" title="app/serializers/project_serializer.rb">app/serializers/project_serializer.rb</a></td>
        <td class="red strong">56.52 %</td>
        <td>107</td>
        <td>46</td>
        <td>26</td>
        <td>20</td>
        <td>0.6</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#e0a86349491149f80f2d5c7abb6212fc775d3313" class="src_link" title="app/serializers/role_serializer.rb">app/serializers/role_serializer.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>3</td>
        <td>3</td>
        <td>0</td>
        <td>3</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#b5acfb72ef42b695b165549c5a7c5dffd403741b" class="src_link" title="app/serializers/task_comment_serializer.rb">app/serializers/task_comment_serializer.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>19</td>
        <td>17</td>
        <td>0</td>
        <td>17</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#7aa61ebdb7b98f897c77fa7258bf65bdfd35e68e" class="src_link" title="app/serializers/task_definition_serializer.rb">app/serializers/task_definition_serializer.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>13</td>
        <td>4</td>
        <td>4</td>
        <td>0</td>
        <td>8.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#874fe9917169e93e61b6378d98789a718b5e1730" class="src_link" title="app/serializers/task_serializer.rb">app/serializers/task_serializer.rb</a></td>
        <td class="red strong">69.23 %</td>
        <td>53</td>
        <td>26</td>
        <td>18</td>
        <td>8</td>
        <td>0.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#c96e78d9fa0b34066abf0f2568a135fd9b2a4d73" class="src_link" title="app/serializers/tutorial_serializer.rb">app/serializers/tutorial_serializer.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>36</td>
        <td>20</td>
        <td>20</td>
        <td>0</td>
        <td>12.5</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#22ca2cd92ae6331364e89845bb5c9b8d236b383a" class="src_link" title="app/serializers/unit_role_serializer.rb">app/serializers/unit_role_serializer.rb</a></td>
        <td class="green strong">93.75 %</td>
        <td>66</td>
        <td>32</td>
        <td>30</td>
        <td>2</td>
        <td>2.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#f19b2895c64d322f0a8a4cd50e3123d2f8eaa373" class="src_link" title="app/serializers/unit_serializer.rb">app/serializers/unit_serializer.rb</a></td>
        <td class="green strong">97.44 %</td>
        <td>66</td>
        <td>39</td>
        <td>38</td>
        <td>1</td>
        <td>2.1</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#7a71d446d2a4d8ad45da838bf785d269e674e8b3" class="src_link" title="app/serializers/user_role_serializer.rb">app/serializers/user_role_serializer.rb</a></td>
        <td class="red strong">0.0 %</td>
        <td>6</td>
        <td>5</td>
        <td>0</td>
        <td>5</td>
        <td>0.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#08becbc800961ae554eeef0740cce19c120ca2ab" class="src_link" title="app/serializers/user_serializer.rb">app/serializers/user_serializer.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>12</td>
        <td>6</td>
        <td>6</td>
        <td>0</td>
        <td>14.5</td>
      </tr>
      
    </tbody>
  </table>
</div>

        
      </div>
    
      <div id="footer">
        Generated by <a href="http://github.com/colszowka/simplecov">simplecov</a> v0.15.1 
        and simplecov-html v0.10.2<br/>
        using MiniTest
      </div>
    
      <div class="source_files">
      
        <div class="source_table" id="de28e6c35f296737c7fa5dfd3859a41b7162a037">
  <div class="header">
    <h3>app/api/api.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>45</b> relevant lines. 
      <span class="green"><b>45</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;grape&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;grape-swagger&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">module Api</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  class Root &lt; Grape::API</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">    helpers AuthorisationHelpers</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">    helpers LogHelper</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">    helpers AuthenticationHelpers</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">    prefix &#39;api&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">    format :json</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">    formatter :json, Grape::Formatter::ActiveModelSerializers</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">    rescue_from :all</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">    # Mount the api modules</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">    mount Api::Authentication</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">    mount Api::GroupSets</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">    mount Api::Projects</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">    mount Api::Students</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">    mount Api::Tasks</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">    mount Api::TaskComments</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">    mount Api::TaskDefinitions</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">    mount Api::Tutorials</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="26">
          <span class="hits">1</span>
          
          <code class="ruby">    mount Api::UnitRoles</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>
          
          <code class="ruby">    mount Api::Units</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">    mount Api::Users</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">    mount Api::LearningOutcomes</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="30">
          <span class="hits">1</span>
          
          <code class="ruby">    mount Api::LearningAlignment</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>
          
          <code class="ruby">    mount Api::Submission::Generate</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">    mount Api::Submission::PortfolioApi</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="33">
          <span class="hits">1</span>
          
          <code class="ruby">    mount Api::Submission::PortfolioEvidenceApi</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="34">
          <span class="hits">1</span>
          
          <code class="ruby">    mount Api::Submission::BatchTask</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="35">
          <span class="hits">1</span>
          
          <code class="ruby">    mount Api::Settings</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">    # Add auth details to all end points</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="40">
          <span class="hits">1</span>
          
          <code class="ruby">    AuthenticationHelpers.add_auth_to Api::GroupSets</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="41">
          <span class="hits">1</span>
          
          <code class="ruby">    AuthenticationHelpers.add_auth_to Api::Units</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="42">
          <span class="hits">1</span>
          
          <code class="ruby">    AuthenticationHelpers.add_auth_to Api::Projects</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="43">
          <span class="hits">1</span>
          
          <code class="ruby">    AuthenticationHelpers.add_auth_to Api::Students</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="44">
          <span class="hits">1</span>
          
          <code class="ruby">    AuthenticationHelpers.add_auth_to Api::Tasks</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="45">
          <span class="hits">1</span>
          
          <code class="ruby">    AuthenticationHelpers.add_auth_to Api::TaskComments</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="46">
          <span class="hits">1</span>
          
          <code class="ruby">    AuthenticationHelpers.add_auth_to Api::TaskDefinitions</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="47">
          <span class="hits">1</span>
          
          <code class="ruby">    AuthenticationHelpers.add_auth_to Api::Tutorials</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="48">
          <span class="hits">1</span>
          
          <code class="ruby">    AuthenticationHelpers.add_auth_to Api::Users</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="49">
          <span class="hits">1</span>
          
          <code class="ruby">    AuthenticationHelpers.add_auth_to Api::UnitRoles</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="50">
          <span class="hits">1</span>
          
          <code class="ruby">    AuthenticationHelpers.add_auth_to Api::LearningOutcomes</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="51">
          <span class="hits">1</span>
          
          <code class="ruby">    AuthenticationHelpers.add_auth_to Api::LearningAlignment</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="52">
          <span class="hits">1</span>
          
          <code class="ruby">    AuthenticationHelpers.add_auth_to Api::Submission::PortfolioApi</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="53">
          <span class="hits">1</span>
          
          <code class="ruby">    AuthenticationHelpers.add_auth_to Api::Submission::PortfolioEvidenceApi</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="54">
          <span class="hits">1</span>
          
          <code class="ruby">    AuthenticationHelpers.add_auth_to Api::Submission::BatchTask</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">    add_swagger_documentation \</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="57">
          <span class="hits">1</span>
          
          <code class="ruby">      base_path: nil,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">      add_version: false,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">      hide_documentation_path: true,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">      info: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">        title: &#39;Doubtfire API Documentaion&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">        description: &#39;Doubtfire is a modern, lightweight learning management system.&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">        license: &#39;AGPL v3.0&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">        license_url: &#39;https://github.com/doubtfire-lms/doubtfire-api/blob/master/LICENSE&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="f2c3a0cad2023eecd1ebbf5663a06f1dec51c9a8">
  <div class="header">
    <h3>app/api/authentication.rb</h3>
    <h4><span class="red">48.03 %</span> covered</h4>
    <div>
      <b>127</b> relevant lines. 
      <span class="green"><b>61</b> lines covered</span> and
      <span class="red"><b>66</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;grape&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;user_serializer&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;json/jwt&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">module Api</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">  # Provides the authentication API for Doubtfire.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">  # Users can sign in via email and password and receive an auth token</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">  # that can be used with other API calls.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">  class Authentication &lt; Grape::API</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">    helpers LogHelper</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">    helpers AuthenticationHelpers</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">    # Sign in - only mounted if AAF auth is NOT used</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">    unless AuthenticationHelpers.aaf_auth?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">      desc &#39;Sign in&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">      params do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">        requires :username, type: String, desc: &#39;User username&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">        requires :password, type: String, desc: &#39;User\&#39;s password&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">        optional :remember, type: Boolean, desc: &#39;User has requested to remember login&#39;, default: false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">      post &#39;/auth&#39; do</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="26">
          <span class="hits">7</span>
          
          <code class="ruby">        username = params[:username]</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="27">
          <span class="hits">7</span>
          
          <code class="ruby">        password = params[:password]</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="28">
          <span class="hits">7</span>
          
          <code class="ruby">        remember = params[:remember]</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="29">
          <span class="hits">7</span>
          
          <code class="ruby">        logger.info &quot;Authenticate #{username} from #{request.ip}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">        # Truncate the &#39;s&#39; from sXXX for Swinburne auth</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="32">
          <span class="hits">7</span>
          
          <code class="ruby">        truncate_s_match = (username =~ /^[Ss]\d{6,10}([Xx]|\d)$/)</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="33">
          <span class="hits">7</span>
          
          <code class="ruby">        username[0] = &#39;&#39; if !truncate_s_match.nil? &amp;&amp; truncate_s_match.zero?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">        # No provided credentials</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="36">
          <span class="hits">7</span>
          
          <code class="ruby">        if username.nil? || password.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">          error!({ error: &#39;The request must contain the user username and password.&#39; }, 400)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">          return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">        # User lookup</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="42">
          <span class="hits">7</span>
          
          <code class="ruby">        username = username.downcase</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="43">
          <span class="hits">7</span>
          
          <code class="ruby">        institution_email_domain = Doubtfire::Application.config.institution[:email_domain]</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="44">
          <span class="hits">7</span>
          
          <code class="ruby">        user = User.find_or_create_by(username: username) do |new_user|</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="45">
          <span class="hits">1</span>
          
          <code class="ruby">          new_user.first_name = &#39;First Name&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="46">
          <span class="hits">1</span>
          
          <code class="ruby">          new_user.last_name  = &#39;Surname&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="47">
          <span class="hits">1</span>
          
          <code class="ruby">          new_user.email      = &quot;#{username}@#{institution_email_domain}&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="48">
          <span class="hits">1</span>
          
          <code class="ruby">          new_user.nickname   = &#39;Nickname&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="49">
          <span class="hits">1</span>
          
          <code class="ruby">          new_user.role_id    = Role.student.id</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="50">
          <span class="hits">1</span>
          
          <code class="ruby">          new_user.login_id   = username</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">        # Try to authenticate</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="54">
          <span class="hits">7</span>
          
          <code class="ruby">        unless user.authenticate?(password)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="55">
          <span class="hits">2</span>
          
          <code class="ruby">          error!({ error: &#39;Invalid email or password.&#39; }, 401)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="56">
          
          
          <code class="ruby">          return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">        # Create user if they are a new record</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="60">
          <span class="hits">5</span>
          
          <code class="ruby">        if user.new_record?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="61">
          
          
          <code class="ruby">          user.encrypted_password = BCrypt::Password.create(&#39;password&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="63">
          
          
          <code class="ruby">          unless user.valid?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="64">
          
          
          <code class="ruby">            error!(error: &#39;There was an error creating your account in Doubtfire. &#39; \</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">                          &#39;Please get in contact with your unit convenor or the &#39; \</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">                          &#39;Doubtfire administrators.&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="68">
          
          
          <code class="ruby">          user.save</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">        # Revise an auth_token for future requests</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="72">
          <span class="hits">5</span>
          
          <code class="ruby">        if user.authentication_token_expired?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">          # Create a new token</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="74">
          <span class="hits">5</span>
          
          <code class="ruby">          user.generate_authentication_token! remember</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">          # Extend the existing token&#39;s time</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="77">
          
          
          <code class="ruby">          user.extend_authentication_token remember</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">        # Return user details</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="81">
          <span class="hits">5</span>
          
          <code class="ruby">        { user: UserSerializer.new(user), auth_token: user.auth_token }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby">    # AAF JWT callback - only mounted if AAF auth is used</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="88">
          <span class="hits">1</span>
          
          <code class="ruby">    if AuthenticationHelpers.aaf_auth?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="89">
          
          
          <code class="ruby">      desc &#39;AAF Rapid Connect JWT callback&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="90">
          
          
          <code class="ruby">      params do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="91">
          
          
          <code class="ruby">        requires :assertion, type: String, desc: &#39;Data provided for further processing.&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="93">
          
          
          <code class="ruby">      post &#39;/auth/jwt&#39; do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="94">
          
          
          <code class="ruby">        jws = params[:assertion]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="95">
          
          
          <code class="ruby">        error!({ error: &#39;JWS was not found in request.&#39; }, 500) unless jws</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby">        # Identity provider must match the one set in the configuration -- this</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby">        # prevents an identity provider from a different institution from trying</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby">        # to log into this instance of Doubtfire</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="100">
          
          
          <code class="ruby">        referer = request.referer</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="101">
          
          
          <code class="ruby">        error!({ error: &#39;This URL must be referered by AAF.&#39; }, 500) unless referer</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="102">
          
          
          <code class="ruby">        request_idp = referer.split(&#39;entityID=&#39;).last</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="103">
          
          
          <code class="ruby">        unless request_idp == Doubtfire::Application.config.aaf[:identity_provider_url]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="104">
          
          
          <code class="ruby">          error!({ error: &#39;This request was not verified by the correct identity provider.&#39; }, 500)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby">        # Decode JWS</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="108">
          
          
          <code class="ruby">        jwt = User.decode_jws(jws)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="109">
          
          
          <code class="ruby">        error!({ error: &#39;Invalid JWS.&#39; }, 500) unless jwt</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby">        # User lookup via unique login id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="112">
          
          
          <code class="ruby">        attrs = jwt[&#39;https://aaf.edu.au/attributes&#39;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="113">
          
          
          <code class="ruby">        login_id = jwt[:sub]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="114">
          
          
          <code class="ruby">        email = attrs[:mail]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby">        # Lookup using login_id if it exists</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby">        # Lookup using email otherwise and set login_id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby">        # Otherwise create new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="119">
          
          
          <code class="ruby">        user = User.find_by(login_id: login_id) ||</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby">               User.find_by_username(email[/(.*)@/,1]) ||</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby">               User.find_by(email: email) ||</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby">               User.find_or_create_by(login_id: login_id) do |new_user|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="123">
          
          
          <code class="ruby">                 role = Role.aaf_affiliation_to_role_id(attrs[:edupersonscopedaffiliation])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="124">
          
          
          <code class="ruby">                 first_name = (attrs[:givenname] || attrs[:cn]).capitalize</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="125">
          
          
          <code class="ruby">                 last_name = attrs[:surname].capitalize</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="126">
          
          
          <code class="ruby">                 username = email.split(&#39;@&#39;).first</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby">                 # Some institutions may provide givenname and surname, others</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="128">
          
          
          <code class="ruby">                 # may only provide common name which we will use as first name</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="129">
          
          
          <code class="ruby">                 new_user.first_name = first_name</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="130">
          
          
          <code class="ruby">                 new_user.last_name  = last_name</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="131">
          
          
          <code class="ruby">                 new_user.email      = email</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="132">
          
          
          <code class="ruby">                 new_user.username   = username</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="133">
          
          
          <code class="ruby">                 new_user.nickname   = first_name</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="134">
          
          
          <code class="ruby">                 new_user.role_id    = role</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="135">
          
          
          <code class="ruby">               end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="136">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby">        # Set login id + username if not yet specified</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="138">
          
          
          <code class="ruby">        user.login_id = login_id if user.login_id.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="139">
          
          
          <code class="ruby">        user.username = username if user.username.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="140">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="141">
          
          
          <code class="ruby">        # Try to authenticate</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="142">
          
          
          <code class="ruby">        return error!({ error: &#39;Invalid JSON web token.&#39; }, 401) unless user.authenticate?(jws)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="143">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="144">
          
          
          <code class="ruby">        # Try and save the user once authenticated if new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="145">
          
          
          <code class="ruby">        if user.new_record?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="146">
          
          
          <code class="ruby">          user.encrypted_password = BCrypt::Password.create(&#39;password&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="147">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="148">
          
          
          <code class="ruby">          unless user.valid?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="149">
          
          
          <code class="ruby">            error!(error: &#39;There was an error creating your account in Doubtfire. &#39; \</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="150">
          
          
          <code class="ruby">                          &#39;Please get in contact with your unit convenor or the &#39; \</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="151">
          
          
          <code class="ruby">                          &#39;Doubtfire administrators.&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="152">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="153">
          
          
          <code class="ruby">          user.save</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="154">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="155">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="156">
          
          
          <code class="ruby">        # Generate a temporary auth_token for future requests</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="157">
          
          
          <code class="ruby">        user.generate_temporary_authentication_token!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="158">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="159">
          
          
          <code class="ruby">        # Must redirect to the front-end after sign in</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="160">
          
          
          <code class="ruby">        protocol = Rails.env.development? ? &#39;http&#39; : &#39;https&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="161">
          
          
          <code class="ruby">        host = Rails.env.development? ? &#39;localhost:8000&#39; : Doubtfire::Application.config.institution[:host]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="162">
          
          
          <code class="ruby">        redirect &quot;#{protocol}://#{host}/#sign_in?authToken=#{user.auth_token}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="164">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="165">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="166">
          
          
          <code class="ruby">      # Respond user details provided a temporary login token</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="167">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="168">
          
          
          <code class="ruby">      desc &#39;Get user details from an authentication token&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="169">
          
          
          <code class="ruby">      params do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="170">
          
          
          <code class="ruby">        requires :auth_token, type: String, desc: &#39;The user\&#39;s temporary auth token&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="171">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="172">
          
          
          <code class="ruby">      post &#39;/auth&#39; do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="173">
          
          
          <code class="ruby">        error!({ error: &#39;Invalid token.&#39; }, 404) if params[:auth_token].nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="174">
          
          
          <code class="ruby">        logger.info &quot;Get user via auth_token from #{request.ip}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="175">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="176">
          
          
          <code class="ruby">        # Authenticate that the token is okay</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="177">
          
          
          <code class="ruby">        if authenticated?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="178">
          
          
          <code class="ruby">          user = User.find_by_auth_token(params[:auth_token])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="179">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="180">
          
          
          <code class="ruby">          # Invalidate the token and regenrate a new one</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="181">
          
          
          <code class="ruby">          user.reset_authentication_token!</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="182">
          
          
          <code class="ruby">          user.generate_authentication_token! true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="183">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="184">
          
          
          <code class="ruby">          # Respond user details with new auth token</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="185">
          
          
          <code class="ruby">          { user: UserSerializer.new(user), auth_token: user.auth_token }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="186">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="187">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="188">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="189">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="190">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="191">
          
          
          <code class="ruby">    # Returns the current auth method</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="192">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="193">
          <span class="hits">1</span>
          
          <code class="ruby">    desc &#39;Authentication method configuration&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="194">
          <span class="hits">1</span>
          
          <code class="ruby">    get &#39;/auth/method&#39; do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="195">
          
          
          <code class="ruby">      response = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="196">
          
          
          <code class="ruby">        method: Doubtfire::Application.config.auth_method</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="197">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="198">
          
          
          <code class="ruby">      response[:redirect_to] = Doubtfire::Application.config.aaf[:redirect_url] if aaf_auth?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="199">
          
          
          <code class="ruby">      response</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="200">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="201">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="202">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="203">
          
          
          <code class="ruby">    # Returns the current auth signout URL</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="204">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="205">
          <span class="hits">1</span>
          
          <code class="ruby">    desc &#39;Authentication signout URL&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="206">
          <span class="hits">1</span>
          
          <code class="ruby">    get &#39;/auth/signout_url&#39; do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="207">
          
          
          <code class="ruby">      response = {}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="208">
          
          
          <code class="ruby">      response[:auth_signout_url] = Doubtfire::Application.config.aaf[:auth_signout_url] if aaf_auth? &amp;&amp; Doubtfire::Application.config.aaf[:auth_signout_url].present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="209">
          
          
          <code class="ruby">      response</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="210">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="211">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="212">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="213">
          
          
          <code class="ruby">    # Update token</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="214">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="215">
          <span class="hits">1</span>
          
          <code class="ruby">    desc &#39;Allow tokens to be updated&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="216">
          <span class="hits">1</span>
          
          <code class="ruby">    params do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="217">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :username, type: String,  desc: &#39;User username&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="218">
          <span class="hits">1</span>
          
          <code class="ruby">      optional :remember, type: Boolean, desc: &#39;User has requested to remember login&#39;, default: false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="219">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="220">
          <span class="hits">1</span>
          
          <code class="ruby">    put &#39;/auth/:auth_token&#39; do</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="221">
          <span class="hits">3</span>
          
          <code class="ruby">      error!({ error: &#39;Invalid token.&#39; }, 404) if params[:auth_token].nil?</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="222">
          <span class="hits">3</span>
          
          <code class="ruby">      logger.info &quot;Update token #{params[:username]} from #{request.ip}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="223">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="224">
          
          
          <code class="ruby">      # Find user</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="225">
          <span class="hits">3</span>
          
          <code class="ruby">      user = User.find_by_auth_token(params[:auth_token])</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="226">
          <span class="hits">3</span>
          
          <code class="ruby">      remember = params[:remember] || false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="227">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="228">
          
          
          <code class="ruby">      # Token does not match user</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="229">
          <span class="hits">3</span>
          
          <code class="ruby">      if user.nil? || user.username != params[:username]</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="230">
          <span class="hits">2</span>
          
          <code class="ruby">        error!({ error: &#39;Invalid token.&#39; }, 404)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="231">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="232">
          <span class="hits">1</span>
          
          <code class="ruby">        if user.auth_token_expiry &gt; Time.zone.now &amp;&amp; user.auth_token_expiry &lt; Time.zone.now + 1.hour</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="233">
          
          
          <code class="ruby">          user.reset_authentication_token!</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="234">
          
          
          <code class="ruby">          user.generate_authentication_token! remember</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="235">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="236">
          
          
          <code class="ruby">        # Return extended auth token</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="237">
          <span class="hits">1</span>
          
          <code class="ruby">        { auth_token: user.auth_token }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="238">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="239">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="240">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="241">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="242">
          
          
          <code class="ruby">    # Sign out</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="243">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="244">
          <span class="hits">1</span>
          
          <code class="ruby">    desc &#39;Sign out&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="245">
          <span class="hits">1</span>
          
          <code class="ruby">    delete &#39;/auth/:auth_token&#39; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="246">
          <span class="hits">1</span>
          
          <code class="ruby">      user = User.find_by_auth_token(params[:auth_token])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="247">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="248">
          <span class="hits">1</span>
          
          <code class="ruby">      if user</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="249">
          <span class="hits">1</span>
          
          <code class="ruby">        logger.info &quot;Sign out #{user.username} from #{request.ip}&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="250">
          <span class="hits">1</span>
          
          <code class="ruby">        user.reset_authentication_token!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="251">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="252">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="253">
          <span class="hits">1</span>
          
          <code class="ruby">      nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="254">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="255">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="256">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="b3bb08a0535aa66968e797a7b7f5502d413cb839">
  <div class="header">
    <h3>app/api/group_sets.rb</h3>
    <h4><span class="red">40.1 %</span> covered</h4>
    <div>
      <b>202</b> relevant lines. 
      <span class="green"><b>81</b> lines covered</span> and
      <span class="red"><b>121</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;grape&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;mime-check-helpers&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;group_serializer&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">module Api</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">  # Allow GroupSets to be managed via the API</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">  class GroupSets &lt; Grape::API</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">    helpers AuthenticationHelpers</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">    helpers AuthorisationHelpers</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">    helpers MimeCheckHelpers</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">    helpers LogHelper</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">    before do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">      authenticated?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">    # ------------------------------------------------------------------------</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">    # Group Sets</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">    # ------------------------------------------------------------------------</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">    desc &#39;Add a new group set to the given unit&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">    params do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :unit_id, type: Integer, desc: &#39;The unit for the new group set&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="26">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :group_set, type: Hash do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>
          
          <code class="ruby">        requires :name,                             type: String,   desc: &#39;The name of this group set&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">        optional :allow_students_to_create_groups,  type: Boolean,  desc: &#39;Are students allowed to create groups&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">        optional :allow_students_to_manage_groups,  type: Boolean,  desc: &#39;Are students allowed to manage their group memberships&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="30">
          <span class="hits">1</span>
          
          <code class="ruby">        optional :keep_groups_in_same_class,        type: Boolean,  desc: &#39;Must groups be kept in the one class&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="33">
          <span class="hits">1</span>
          
          <code class="ruby">    post &#39;/units/:unit_id/group_sets&#39; do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">      unit = Unit.find(params[:unit_id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">      unless authorise? current_user, unit, :update</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">        error!({ error: &#39;Not authorised to create a group set for this unit&#39; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">      logger.info &quot;Create group set: #{current_user.username} in #{unit.code} from #{request.ip}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">      group_params = ActionController::Parameters.new(params)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">                                                 .require(:group_set)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">                                                 .permit(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">                                                   :name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">                                                   :allow_students_to_create_groups,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">                                                   :allow_students_to_manage_groups,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">                                                   :keep_groups_in_same_class</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">                                                 )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">      group_set = GroupSet.create!(group_params)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">      group_set.unit = unit</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">      group_set.save!</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">      group_set</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="56">
          <span class="hits">1</span>
          
          <code class="ruby">    desc &#39;Edits the given group set&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="57">
          <span class="hits">1</span>
          
          <code class="ruby">    params do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="58">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :id, type: Integer, desc: &#39;The group set id to edit&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="59">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :group_set, type: Hash do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="60">
          <span class="hits">1</span>
          
          <code class="ruby">        optional :name,                             type: String,   desc: &#39;The name of this group set&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="61">
          <span class="hits">1</span>
          
          <code class="ruby">        optional :allow_students_to_create_groups,  type: Boolean,  desc: &#39;Are students allowed to create groups&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="62">
          <span class="hits">1</span>
          
          <code class="ruby">        optional :allow_students_to_manage_groups,  type: Boolean,  desc: &#39;Are students allowed to manage their group memberships&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="63">
          <span class="hits">1</span>
          
          <code class="ruby">        optional :keep_groups_in_same_class,        type: Boolean,  desc: &#39;Must groups be kept in the one class&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="66">
          <span class="hits">1</span>
          
          <code class="ruby">    put &#39;/units/:unit_id/group_sets/:id&#39; do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="67">
          
          
          <code class="ruby">      group_set = GroupSet.find(params[:id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="68">
          
          
          <code class="ruby">      unit = Unit.find(params[:unit_id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="70">
          
          
          <code class="ruby">      logger.info &quot;Edit group set: #{current_user.username} in #{unit.code} from #{request.ip}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="72">
          
          
          <code class="ruby">      if group_set.unit != unit</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="73">
          
          
          <code class="ruby">        error!({ error: &#39;Unable to locate group set for unit&#39; }, 404)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="76">
          
          
          <code class="ruby">      unless authorise? current_user, unit, :update</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="77">
          
          
          <code class="ruby">        error!({ error: &#39;Not authorised to update group set for this unit&#39; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="80">
          
          
          <code class="ruby">      group_params = ActionController::Parameters.new(params)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby">                                                 .require(:group_set)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">                                                 .permit(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby">                                                   :name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">                                                   :allow_students_to_create_groups,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">                                                   :allow_students_to_manage_groups,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby">                                                   :keep_groups_in_same_class</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby">                                                 )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="89">
          
          
          <code class="ruby">      group_set.update!(group_params)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="90">
          
          
          <code class="ruby">      group_set</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="93">
          <span class="hits">1</span>
          
          <code class="ruby">    desc &#39;Delete a group set&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="94">
          <span class="hits">1</span>
          
          <code class="ruby">    delete &#39;/units/:unit_id/group_sets/:id&#39; do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="95">
          
          
          <code class="ruby">      group_set = GroupSet.find(params[:id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="96">
          
          
          <code class="ruby">      unit = Unit.find(params[:unit_id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="98">
          
          
          <code class="ruby">      logger.info &quot;Delete group set: #{current_user.username} in #{unit.code} from #{request.ip}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="100">
          
          
          <code class="ruby">      if group_set.unit != unit</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="101">
          
          
          <code class="ruby">        error!({ error: &#39;Unable to locate group set for unit&#39; }, 404)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="104">
          
          
          <code class="ruby">      unless authorise? current_user, unit, :update</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="105">
          
          
          <code class="ruby">        error!({ error: &#39;Not authorised to delete group set for this unit&#39; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="108">
          
          
          <code class="ruby">      error!(error: group_set.errors[:base].last) unless group_set.destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="109">
          
          
          <code class="ruby">      nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby">    # ------------------------------------------------------------------------</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby">    # Groups</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby">    # ------------------------------------------------------------------------</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="116">
          <span class="hits">1</span>
          
          <code class="ruby">    desc &#39;Get the groups in a group set&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="117">
          <span class="hits">1</span>
          
          <code class="ruby">    get &#39;/units/:unit_id/group_sets/:id/groups&#39; do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="118">
          
          
          <code class="ruby">      unit = Unit.find(params[:unit_id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="119">
          
          
          <code class="ruby">      group_set = unit.group_sets.find(params[:id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="121">
          
          
          <code class="ruby">      unless authorise? current_user, group_set, :get_groups, -&gt;(role, perm_hash, other) { group_set.specific_permission_hash(role, perm_hash, other) }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="122">
          
          
          <code class="ruby">        error!({ error: &#39;Not authorised to get groups for this unit&#39; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="125">
          
          
          <code class="ruby">      group_set.groups</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="126">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="128">
          <span class="hits">1</span>
          
          <code class="ruby">    desc &#39;Get all groups in a unit&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="129">
          <span class="hits">1</span>
          
          <code class="ruby">    get &#39;/units/:unit_id/groups&#39; do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="130">
          
          
          <code class="ruby">      unit = Unit.find(params[:unit_id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="132">
          
          
          <code class="ruby">      unless authorise? current_user, unit, :get_students</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="133">
          
          
          <code class="ruby">        error!({ error: &#39;Not authorised to get groups for this unit&#39; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="134">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="135">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="136">
          
          
          <code class="ruby">      ActiveModel::ArraySerializer.new(unit.groups, each_serializer: DeepGroupSerializer)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="138">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="139">
          <span class="hits">1</span>
          
          <code class="ruby">    desc &#39;Download a CSV of groups in a group set&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="140">
          <span class="hits">1</span>
          
          <code class="ruby">    get &#39;/units/:unit_id/group_sets/:group_set_id/groups/csv&#39; do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="141">
          
          
          <code class="ruby">      unit = Unit.find(params[:unit_id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="142">
          
          
          <code class="ruby">      group_set = unit.group_sets.find(params[:group_set_id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="143">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="144">
          
          
          <code class="ruby">      unless authorise? current_user, unit, :update</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="145">
          
          
          <code class="ruby">        error!({ error: &#39;Not authorised to download csv of groups for this unit&#39; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="146">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="147">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="148">
          
          
          <code class="ruby">      content_type &#39;application/octet-stream&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="149">
          
          
          <code class="ruby">      header[&#39;Content-Disposition&#39;] = &quot;attachment; filename=#{unit.code}-groups.csv &quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="150">
          
          
          <code class="ruby">      env[&#39;api.format&#39;] = :binary</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="151">
          
          
          <code class="ruby">      unit.export_groups_to_csv(group_set)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="152">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="153">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="154">
          <span class="hits">1</span>
          
          <code class="ruby">    desc &quot;Add a new group to the given unit&#39;s group_set&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="155">
          <span class="hits">1</span>
          
          <code class="ruby">    params do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="156">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :unit_id,                            type: Integer,  desc: &#39;The unit for the new group&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="157">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :group_set_id,                       type: Integer,  desc: &#39;The id of the group set&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="158">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :group, type: Hash do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="159">
          <span class="hits">1</span>
          
          <code class="ruby">        optional :name,                             type: String,   desc: &#39;The name of this group&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="160">
          <span class="hits">1</span>
          
          <code class="ruby">        requires :tutorial_id,                      type: Integer,  desc: &#39;The id of the tutorial for the group&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="161">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="162">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="163">
          <span class="hits">1</span>
          
          <code class="ruby">    post &#39;/units/:unit_id/group_sets/:group_set_id/groups&#39; do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="164">
          
          
          <code class="ruby">      unit = Unit.find(params[:unit_id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="165">
          
          
          <code class="ruby">      group_set = unit.group_sets.find(params[:group_set_id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="166">
          
          
          <code class="ruby">      tutorial = unit.tutorials.find(params[:group][:tutorial_id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="167">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="168">
          
          
          <code class="ruby">      unless authorise? current_user, group_set, :create_group, -&gt;(role, perm_hash, other) { group_set.specific_permission_hash(role, perm_hash, other) }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="169">
          
          
          <code class="ruby">        error!({ error: &#39;Not authorised to create a group set for this unit&#39; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="170">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="171">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="172">
          
          
          <code class="ruby">      group_params = ActionController::Parameters.new(params)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="173">
          
          
          <code class="ruby">                                                 .require(:group)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="174">
          
          
          <code class="ruby">                                                 .permit(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="175">
          
          
          <code class="ruby">                                                   :name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="176">
          
          
          <code class="ruby">                                                 )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="177">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="178">
          
          
          <code class="ruby">      # Group with the same name</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="179">
          
          
          <code class="ruby">      unless group_set.groups.where(name: group_params[:name]).empty?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="180">
          
          
          <code class="ruby">        error!({ error: &quot;This group name is not unique to the #{group_set.name} group set.&quot; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="181">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="182">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="183">
          
          
          <code class="ruby">      last = group_set.groups.last</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="184">
          
          
          <code class="ruby">      num = last.nil? ? 1 : last.number + 1</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="185">
          
          
          <code class="ruby">      if group_params[:name].nil? || group_params[:name].empty?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="186">
          
          
          <code class="ruby">        group_params[:name] = &quot;Group #{num}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="187">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="188">
          
          
          <code class="ruby">      grp = Group.create(name: group_params[:name], group_set: group_set, tutorial: tutorial, number: num)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="189">
          
          
          <code class="ruby">      grp.save!</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="190">
          
          
          <code class="ruby">      grp</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="191">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="192">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="193">
          <span class="hits">1</span>
          
          <code class="ruby">    desc &#39;Upload a CSV for groups in a group set&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="194">
          <span class="hits">1</span>
          
          <code class="ruby">    params do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="195">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :unit_id,                            type: Integer,  desc: &#39;The unit for the new group&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="196">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :group_set_id,                       type: Integer,  desc: &#39;The id of the group set&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="197">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :file, type: Rack::Multipart::UploadedFile, desc: &#39;CSV upload file.&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="198">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="199">
          <span class="hits">1</span>
          
          <code class="ruby">    post &#39;/units/:unit_id/group_sets/:group_set_id/groups/csv&#39; do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="200">
          
          
          <code class="ruby">      # check mime is correct before uploading</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="201">
          
          
          <code class="ruby">      ensure_csv!(params[:file][:tempfile])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="202">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="203">
          
          
          <code class="ruby">      unit = Unit.find(params[:unit_id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="204">
          
          
          <code class="ruby">      group_set = unit.group_sets.find(params[:group_set_id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="205">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="206">
          
          
          <code class="ruby">      unless authorise? current_user, unit, :update</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="207">
          
          
          <code class="ruby">        error!({ error: &#39;Not authorised to upload csv of groups for this unit&#39; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="208">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="209">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="210">
          
          
          <code class="ruby">      unit.import_groups_from_csv(group_set, params[:file][:tempfile])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="211">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="212">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="213">
          <span class="hits">1</span>
          
          <code class="ruby">    desc &#39;Edits the given group&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="214">
          <span class="hits">1</span>
          
          <code class="ruby">    params do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="215">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :unit_id,                            type: Integer,  desc: &#39;The unit for the new group&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="216">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :group_set_id,                       type: Integer,  desc: &#39;The id of the group set&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="217">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :group_id,                           type: Integer,  desc: &#39;The id of the group&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="218">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :group, type: Hash do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="219">
          <span class="hits">1</span>
          
          <code class="ruby">        optional :name,                             type: String,   desc: &#39;The name of this group set&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="220">
          <span class="hits">1</span>
          
          <code class="ruby">        optional :tutorial_id,                      type: Integer,  desc: &#39;Tutorial of the group&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="221">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="222">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="223">
          <span class="hits">1</span>
          
          <code class="ruby">    put &#39;/units/:unit_id/group_sets/:group_set_id/groups/:group_id&#39; do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="224">
          
          
          <code class="ruby">      unit = Unit.find(params[:unit_id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="225">
          
          
          <code class="ruby">      gs = unit.group_sets.find(params[:group_set_id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="226">
          
          
          <code class="ruby">      grp = gs.groups.find(params[:group_id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="227">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="228">
          
          
          <code class="ruby">      unless authorise? current_user, grp, :manage_group, -&gt;(role, perm_hash, other) { grp.specific_permission_hash(role, perm_hash, other) }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="229">
          
          
          <code class="ruby">        error!({ error: &#39;Not authorised to update this group&#39; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="230">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="231">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="232">
          
          
          <code class="ruby">      group_params = ActionController::Parameters.new(params)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="233">
          
          
          <code class="ruby">                                                 .require(:group)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="234">
          
          
          <code class="ruby">                                                 .permit(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="235">
          
          
          <code class="ruby">                                                   :name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="236">
          
          
          <code class="ruby">                                                   :tutorial_id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="237">
          
          
          <code class="ruby">                                                 )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="238">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="239">
          
          
          <code class="ruby">      # Switching tutorials will violate any existing group members</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="240">
          
          
          <code class="ruby">      if group_params[:tutorial_id] != grp.tutorial.id &amp;&amp; gs.keep_groups_in_same_class &amp;&amp; grp.has_active_group_members?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="241">
          
          
          <code class="ruby">        error!({ error: &#39;Cannot modify group tutorial as members already exist and they must be in the same tutorial. Clear all members first.&#39; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="242">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="243">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="244">
          
          
          <code class="ruby">      grp.update!(group_params)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="245">
          
          
          <code class="ruby">      grp</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="246">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="247">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="248">
          <span class="hits">1</span>
          
          <code class="ruby">    desc &#39;Delete a group&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="249">
          <span class="hits">1</span>
          
          <code class="ruby">    params do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="250">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :unit_id,      type: Integer,  desc: &#39;The unit for the new group&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="251">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :group_set_id, type: Integer,  desc: &#39;The id of the group set&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="252">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :group_id,     type: Integer,  desc: &#39;The id of the group&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="253">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="254">
          <span class="hits">1</span>
          
          <code class="ruby">    delete &#39;/units/:unit_id/group_sets/:group_set_id/groups/:group_id&#39; do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="255">
          
          
          <code class="ruby">      unit = Unit.find(params[:unit_id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="256">
          
          
          <code class="ruby">      gs = unit.group_sets.find(params[:group_set_id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="257">
          
          
          <code class="ruby">      grp = gs.groups.find(params[:group_id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="258">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="259">
          
          
          <code class="ruby">      unless authorise? current_user, grp, :manage_group, -&gt;(role, perm_hash, other) { grp.specific_permission_hash(role, perm_hash, other) }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="260">
          
          
          <code class="ruby">        error!({ error: &#39;Not authorised to delete group set for this unit&#39; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="261">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="262">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="263">
          
          
          <code class="ruby">      unless unit.tutors.include? current_user</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="264">
          
          
          <code class="ruby">        # check that they are the only member of the group, or the group is empty</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="265">
          
          
          <code class="ruby">        error!({ error: &#39;You cannot delete a group with members&#39; }, 403) unless grp.projects.count &lt;= 1</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="266">
          
          
          <code class="ruby">        error!({ error: &#39;You cannot delete this group&#39; }, 403) unless grp.projects.count.zero? || grp.projects.first.student == current_user</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="267">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="268">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="269">
          
          
          <code class="ruby">      error!(error: grp.errors[:base].last) unless grp.destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="270">
          
          
          <code class="ruby">      nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="271">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="272">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="273">
          <span class="hits">1</span>
          
          <code class="ruby">    desc &#39;Get the members of a group&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="274">
          <span class="hits">1</span>
          
          <code class="ruby">    get &#39;/units/:unit_id/group_sets/:group_set_id/groups/:group_id/members&#39; do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="275">
          
          
          <code class="ruby">      unit = Unit.find(params[:unit_id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="276">
          
          
          <code class="ruby">      group_set = unit.group_sets.find(params[:group_set_id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="277">
          
          
          <code class="ruby">      grp = group_set.groups.find(params[:group_id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="278">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="279">
          
          
          <code class="ruby">      unless authorise? current_user, grp, :get_members, -&gt;(role, perm_hash, other) { grp.specific_permission_hash(role, perm_hash, other) }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="280">
          
          
          <code class="ruby">        error!({ error: &#39;Not authorised to get groups for this unit&#39; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="281">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="282">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="283">
          
          
          <code class="ruby">      Thread.current[:user] = current_user</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="284">
          
          
          <code class="ruby">      ActiveModel::ArraySerializer.new(grp.projects, each_serializer: GroupMemberProjectSerializer)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="285">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="286">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="287">
          <span class="hits">1</span>
          
          <code class="ruby">    desc &#39;Add a group member&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="288">
          <span class="hits">1</span>
          
          <code class="ruby">    params do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="289">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :unit_id,                            type: Integer,  desc: &#39;The unit for the new group&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="290">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :group_set_id,                       type: Integer,  desc: &#39;The id of the group set&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="291">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :group_id,                           type: Integer,  desc: &#39;The id of the group&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="292">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :project_id,                         type: Integer,  desc: &#39;The project id of the member&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="293">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="294">
          <span class="hits">1</span>
          
          <code class="ruby">    post &#39;/units/:unit_id/group_sets/:group_set_id/groups/:group_id/members&#39; do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="295">
          
          
          <code class="ruby">      unit = Unit.find(params[:unit_id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="296">
          
          
          <code class="ruby">      gs = unit.group_sets.find(params[:group_set_id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="297">
          
          
          <code class="ruby">      grp = gs.groups.find(params[:group_id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="298">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="299">
          
          
          <code class="ruby">      prj = unit.projects.find(params[:project_id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="300">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="301">
          
          
          <code class="ruby">      unless authorise? current_user, gs, :join_group, -&gt;(role, perm_hash, other) { gs.specific_permission_hash(role, perm_hash, other) }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="302">
          
          
          <code class="ruby">        error!({ error: &#39;Not authorised to manage this group&#39; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="303">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="304">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="305">
          
          
          <code class="ruby">      unless authorise? current_user, prj, :get</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="306">
          
          
          <code class="ruby">        error!({ error: &#39;Not authorised to manage this student&#39; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="307">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="308">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="309">
          
          
          <code class="ruby">      if gs.keep_groups_in_same_class &amp;&amp; prj.tutorial != grp.tutorial</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="310">
          
          
          <code class="ruby">        error!({ error: &quot;Students from the tutorial &#39;#{grp.tutorial.abbreviation}&#39; can only be added to this group.&quot; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="311">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="312">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="313">
          
          
          <code class="ruby">      if grp.active_group_members.find_by(project: prj, active: true)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="314">
          
          
          <code class="ruby">        error!({ error: &quot;#{prj.student.name} is already a member of this group&quot; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="315">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="316">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="317">
          
          
          <code class="ruby">      gm = grp.add_member(prj)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="318">
          
          
          <code class="ruby">      Thread.current[:user] = current_user</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="319">
          
          
          <code class="ruby">      GroupMemberProjectSerializer.new(prj)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="320">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="321">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="322">
          <span class="hits">1</span>
          
          <code class="ruby">    desc &#39;Remove a group member&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="323">
          <span class="hits">1</span>
          
          <code class="ruby">    params do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="324">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :unit_id,                            type: Integer,  desc: &#39;The unit for the new group&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="325">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :group_set_id,                       type: Integer,  desc: &#39;The id of the group set&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="326">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :group_id,                           type: Integer,  desc: &#39;The id of the group&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="327">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :id,                                 type: Integer,  desc: &#39;The project id of the member&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="328">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="329">
          <span class="hits">1</span>
          
          <code class="ruby">    delete &#39;/units/:unit_id/group_sets/:group_set_id/groups/:group_id/members/:id&#39; do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="330">
          
          
          <code class="ruby">      unit = Unit.find(params[:unit_id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="331">
          
          
          <code class="ruby">      gs = unit.group_sets.find(params[:group_set_id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="332">
          
          
          <code class="ruby">      grp = gs.groups.find(params[:group_id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="333">
          
          
          <code class="ruby">      prj = grp.projects.find(params[:id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="334">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="335">
          
          
          <code class="ruby">      unless authorise? current_user, grp, :manage_group, -&gt;(role, perm_hash, other) { grp.specific_permission_hash(role, perm_hash, other) }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="336">
          
          
          <code class="ruby">        error!({ error: &#39;Not authorised to manage this group&#39; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="337">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="338">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="339">
          
          
          <code class="ruby">      unless authorise? current_user, prj, :get</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="340">
          
          
          <code class="ruby">        error!({ error: &#39;Not authorised to manage this student&#39; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="341">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="342">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="343">
          
          
          <code class="ruby">      if grp.active_group_members.find_by(project: prj).nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="344">
          
          
          <code class="ruby">        error!({ error: &quot;#{prj.student.name} is not a member of this group&quot; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="345">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="346">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="347">
          
          
          <code class="ruby">      grp.remove_member(prj)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="348">
          
          
          <code class="ruby">      nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="349">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="350">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="351">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="8650be8936d82b6e8c5ec1a56aeace25ac69da64">
  <div class="header">
    <h3>app/api/learning_alignment.rb</h3>
    <h4><span class="red">39.23 %</span> covered</h4>
    <div>
      <b>130</b> relevant lines. 
      <span class="green"><b>51</b> lines covered</span> and
      <span class="red"><b>79</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;grape&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">module Api</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  class LearningAlignment &lt; Grape::API</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">    helpers AuthenticationHelpers</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">    helpers AuthorisationHelpers</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">    helpers MimeCheckHelpers</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">    before do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">      authenticated?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">    desc &#39;Get the task/outcome alignment details for a unit or a project&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">    params do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :unit_id, type: Integer, desc: &#39;The id of the unit&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">      optional :project_id, type: Integer, desc: &#39;The id of the student project to get the alignment from&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">    get &#39;/units/:unit_id/learning_alignments&#39; do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">      unit = Unit.find(params[:unit_id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">      unless authorise?(current_user, unit, :get_unit)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">        error!({ error: &#39;You are not authorised to access this unit.&#39; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">      if params[:project_id].nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">        return unit.task_outcome_alignments</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">        proj = unit.projects.find(params[:project_id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">        unless authorise?(current_user, proj, :get)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">          error!({ error: &#39;You are not authorised to access this project.&#39; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">        return proj.task_outcome_alignments</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="36">
          <span class="hits">1</span>
          
          <code class="ruby">    desc &#39;Download CSV of task alignments in this unit&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="37">
          <span class="hits">1</span>
          
          <code class="ruby">    params do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="38">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :unit_id, type: Integer, desc: &#39;The id of the unit&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="39">
          <span class="hits">1</span>
          
          <code class="ruby">      optional :project_id, type: Integer, desc: &#39;The id of the student project to get the alignment from&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="41">
          <span class="hits">1</span>
          
          <code class="ruby">    get &#39;/units/:unit_id/learning_alignments/csv&#39; do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">      unit = Unit.find(params[:unit_id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">      unless authorise?(current_user, unit, :get_unit)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">        error!({ error: &#39;You are not authorised to access this unit.&#39; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">      if params[:project_id].nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="49">
          
          
          <code class="ruby">        unless authorise? current_user, unit, :download_unit_csv</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">          error!({ error: &quot;Not authorised to download CSV of task alignment in #{unit.code}&quot; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">        content_type &#39;application/octet-stream&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby">        header[&#39;Content-Disposition&#39;] = &quot;attachment; filename=#{unit.code}-Alignment.csv &quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="55">
          
          
          <code class="ruby">        env[&#39;api.format&#39;] = :binary</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="56">
          
          
          <code class="ruby">        unit.export_task_alignment_to_csv</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="58">
          
          
          <code class="ruby">        proj = unit.projects.find(params[:project_id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="59">
          
          
          <code class="ruby">        unless authorise?(current_user, proj, :get)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="60">
          
          
          <code class="ruby">          error!({ error: &#39;You are not authorised to access this project.&#39; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="63">
          
          
          <code class="ruby">        content_type &#39;application/octet-stream&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="64">
          
          
          <code class="ruby">        header[&#39;Content-Disposition&#39;] = &quot;attachment; filename=#{unit.code}-#{proj.student.name}-Task-Alignment.csv &quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="65">
          
          
          <code class="ruby">        env[&#39;api.format&#39;] = :binary</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="67">
          
          
          <code class="ruby">        proj.export_task_alignment_to_csv</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="71">
          <span class="hits">1</span>
          
          <code class="ruby">    desc &#39;Upload CSV of task to outcome alignments&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="72">
          <span class="hits">1</span>
          
          <code class="ruby">    params do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="73">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :file, type: Rack::Multipart::UploadedFile, desc: &#39;CSV upload file.&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="74">
          <span class="hits">1</span>
          
          <code class="ruby">      optional :project_id, type: Integer, desc: &#39;The id of the student project to upload the alignment to&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="76">
          <span class="hits">1</span>
          
          <code class="ruby">    post &#39;/units/:unit_id/learning_alignments/csv&#39; do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="77">
          
          
          <code class="ruby">      ensure_csv!(params[:file][:tempfile])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="79">
          
          
          <code class="ruby">      unit = Unit.find(params[:unit_id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="81">
          
          
          <code class="ruby">      unless authorise?(current_user, unit, :get_unit)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="82">
          
          
          <code class="ruby">        error!({ error: &#39;You are not authorised to access this unit.&#39; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="85">
          
          
          <code class="ruby">      if params[:project_id].nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="86">
          
          
          <code class="ruby">        unless authorise? current_user, unit, :upload_csv</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="87">
          
          
          <code class="ruby">          error!({ error: &quot;Not authorised to upload CSV of task alignment to #{unit.code}&quot; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby">        # Actually import...</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="91">
          
          
          <code class="ruby">        unit.import_task_alignment_from_csv(params[:file][:tempfile], nil)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="93">
          
          
          <code class="ruby">        proj = unit.projects.find(params[:project_id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="94">
          
          
          <code class="ruby">        unless authorise?(current_user, proj, :make_submission)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="95">
          
          
          <code class="ruby">          error!({ error: &#39;You are not authorised to access this project.&#39; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="98">
          
          
          <code class="ruby">        unit.import_task_alignment_from_csv(params[:file][:tempfile], proj)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="102">
          <span class="hits">1</span>
          
          <code class="ruby">    desc &quot;Add an outcome to a unit&#39;s task definition&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="103">
          <span class="hits">1</span>
          
          <code class="ruby">    params do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="104">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :unit_id, type: Integer, desc: &#39;The id of the unit&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="105">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :learning_outcome_id, type: Integer, desc: &#39;The id of the learning outcome&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="106">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :task_definition_id, type: Integer, desc: &#39;The id of the task definition&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="107">
          <span class="hits">1</span>
          
          <code class="ruby">      optional :project_id, type: Integer, desc: &#39;The id of the project if this is a self reflection&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="108">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :description, type: String, desc: &#39;The ILO&#39;&#39;s description&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="109">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :rating, type: Integer, desc: &#39;The rating for this link, indicating the strength of this alignment&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="111">
          <span class="hits">1</span>
          
          <code class="ruby">    post &#39;/units/:unit_id/learning_alignments&#39; do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="112">
          
          
          <code class="ruby">      unit = Unit.find(params[:unit_id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby">      # if there is no project -- then this is a unit LO link</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby">      # so need to check the user is authorised to update the unit...</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="116">
          
          
          <code class="ruby">      if params[:project_id].nil? &amp;&amp; !authorise?(current_user, unit, :update)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="117">
          
          
          <code class="ruby">        error!({ error: &#39;You are not authorised to create task alignments in this unit.&#39; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="120">
          
          
          <code class="ruby">      unit.learning_outcomes.find(params[:learning_outcome_id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="122">
          
          
          <code class="ruby">      task_def = unit.task_definitions.find(params[:task_definition_id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="124">
          
          
          <code class="ruby">      link_parameters = ActionController::Parameters.new(params)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="125">
          
          
          <code class="ruby">                                                    .permit(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="126">
          
          
          <code class="ruby">                                                      :task_definition_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby">                                                      :learning_outcome_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="128">
          
          
          <code class="ruby">                                                      :description,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="129">
          
          
          <code class="ruby">                                                      :rating</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="130">
          
          
          <code class="ruby">                                                    )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="132">
          
          
          <code class="ruby">      unless params[:project_id].nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="133">
          
          
          <code class="ruby">        project = unit.projects.find(params[:project_id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="134">
          
          
          <code class="ruby">        task = project.task_for_task_definition(task_def)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="135">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="136">
          
          
          <code class="ruby">        unless authorise?(current_user, task, :make_submission)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="137">
          
          
          <code class="ruby">          error!({ error: &#39;You are not authorised to create outcome alignments for this task.&#39; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="138">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="139">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="140">
          
          
          <code class="ruby">        link_parameters[:task_id] = task.id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="141">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="142">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="143">
          
          
          <code class="ruby">      LearningOutcomeTaskLink.create! link_parameters</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="144">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="145">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="146">
          <span class="hits">1</span>
          
          <code class="ruby">    desc &#39;Update the alignment between a task and unit outcome&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="147">
          <span class="hits">1</span>
          
          <code class="ruby">    params do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="148">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :id, type: Integer, desc: &#39;The id of the task alignment&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="149">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :unit_id, type: Integer, desc: &#39;The id of the unit&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="150">
          <span class="hits">1</span>
          
          <code class="ruby">      optional :description, type: String, desc: &#39;The description of the alignment&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="151">
          <span class="hits">1</span>
          
          <code class="ruby">      optional :rating, type: Integer, desc: &#39;The rating for this link, indicating the strength of this alignment&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="152">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="153">
          <span class="hits">1</span>
          
          <code class="ruby">    put &#39;/units/:unit_id/learning_alignments/:id&#39; do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="154">
          
          
          <code class="ruby">      unit = Unit.find(params[:unit_id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="155">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="156">
          
          
          <code class="ruby">      align = unit.learning_outcome_task_links.find(params[:id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="157">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="158">
          
          
          <code class="ruby">      link_parameters = ActionController::Parameters.new(params)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="159">
          
          
          <code class="ruby">                                                    .permit(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="160">
          
          
          <code class="ruby">                                                      :description,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="161">
          
          
          <code class="ruby">                                                      :rating</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="162">
          
          
          <code class="ruby">                                                    )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="164">
          
          
          <code class="ruby">      # is this a project task alignment update?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="165">
          
          
          <code class="ruby">      if !align.task_id.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="166">
          
          
          <code class="ruby">        task = align.task</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="167">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="168">
          
          
          <code class="ruby">        unless authorise?(current_user, task, :make_submission)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="169">
          
          
          <code class="ruby">          error!({ error: &#39;You are not authorised to update outcome alignments for this task.&#39; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="170">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="171">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="172">
          
          
          <code class="ruby">      # else, this is a unit alignment update!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="173">
          
          
          <code class="ruby">      elsif !authorise?(current_user, unit, :update)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="174">
          
          
          <code class="ruby">        error!({ error: &#39;You are not authorised to update the task alignments in this unit.&#39; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="175">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="176">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="177">
          
          
          <code class="ruby">      align.update(link_parameters)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="178">
          
          
          <code class="ruby">      align.save!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="179">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="180">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="181">
          <span class="hits">1</span>
          
          <code class="ruby">    desc &#39;Delete the alignment between a task and unit outcome&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="182">
          <span class="hits">1</span>
          
          <code class="ruby">    params do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="183">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :id, type: Integer, desc: &#39;The id of the task alignment&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="184">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :unit_id, type: Integer, desc: &#39;The id of the unit&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="185">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="186">
          <span class="hits">1</span>
          
          <code class="ruby">    delete &#39;/units/:unit_id/learning_alignments/:id&#39; do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="187">
          
          
          <code class="ruby">      unit = Unit.find(params[:unit_id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="188">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="189">
          
          
          <code class="ruby">      align = unit.learning_outcome_task_links.find(params[:id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="190">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="191">
          
          
          <code class="ruby">      # is this a project task alignment update?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="192">
          
          
          <code class="ruby">      if !align.task_id.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="193">
          
          
          <code class="ruby">        task = align.task</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="194">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="195">
          
          
          <code class="ruby">        unless authorise?(current_user, task, :make_submission)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="196">
          
          
          <code class="ruby">          error!({ error: &#39;You are not authorised to update outcome alignments for this task.&#39; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="197">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="198">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="199">
          
          
          <code class="ruby">      # else, this is a unit alignment update!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="200">
          
          
          <code class="ruby">      elsif !authorise?(current_user, unit, :update)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="201">
          
          
          <code class="ruby">        error!({ error: &#39;You are not authorised to update the task alignments in this unit.&#39; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="202">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="203">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="204">
          
          
          <code class="ruby">      align.destroy!</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="205">
          
          
          <code class="ruby">      nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="206">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="207">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="208">
          <span class="hits">1</span>
          
          <code class="ruby">    desc &#39;Return unit learning alignment median values&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="209">
          <span class="hits">1</span>
          
          <code class="ruby">    params do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="210">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :unit_id, type: Integer, desc: &#39;The id of the unit&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="211">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="212">
          <span class="hits">1</span>
          
          <code class="ruby">    get &#39;/units/:unit_id/learning_alignments/class_stats&#39; do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="213">
          
          
          <code class="ruby">      unit = Unit.find(params[:unit_id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="214">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="215">
          
          
          <code class="ruby">      unless authorise?(current_user, unit, :get_unit)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="216">
          
          
          <code class="ruby">        error!({ error: &#39;You are not authorised to access these task alignments.&#39; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="217">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="218">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="219">
          
          
          <code class="ruby">      unit.ilo_progress_class_stats</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="220">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="221">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="222">
          <span class="hits">1</span>
          
          <code class="ruby">    desc &#39;Return unit learning alignment values with median stats for each tutorial&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="223">
          <span class="hits">1</span>
          
          <code class="ruby">    params do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="224">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :unit_id, type: Integer, desc: &#39;The id of the unit&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="225">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="226">
          <span class="hits">1</span>
          
          <code class="ruby">    get &#39;/units/:unit_id/learning_alignments/class_details&#39; do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="227">
          
          
          <code class="ruby">      unit = Unit.find(params[:unit_id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="228">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="229">
          
          
          <code class="ruby">      unless authorise?(current_user, unit, :provide_feedback)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="230">
          
          
          <code class="ruby">        error!({ error: &#39;You are not authorised to access these task alignments.&#39; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="231">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="232">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="233">
          
          
          <code class="ruby">      unit.ilo_progress_class_details</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="234">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="235">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="236">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="d1391db9828de0f1467536969613fed3d6ef8b83">
  <div class="header">
    <h3>app/api/learning_outcomes.rb</h3>
    <h4><span class="red">47.89 %</span> covered</h4>
    <div>
      <b>71</b> relevant lines. 
      <span class="green"><b>34</b> lines covered</span> and
      <span class="red"><b>37</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;grape&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">module Api</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  class LearningOutcomes &lt; Grape::API</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">    helpers AuthenticationHelpers</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">    helpers AuthorisationHelpers</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">    helpers MimeCheckHelpers</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">    before do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">      authenticated?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">    desc &#39;Add an outcome to a unit&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">    params do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :unit_id, type: Integer, desc: &#39;The unit ID for which the ILO belongs to&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :name, type: String, desc: &#39;The ILO&#39;&#39;s name&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :description, type: String, desc: &#39;The ILO&#39;&#39;s description&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">      optional :abbreviation, type: String, desc: &#39;The ILO&#39;&#39;s new abbreviation&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">    post &#39;/units/:unit_id/outcomes&#39; do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">      unit = Unit.find(params[:unit_id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">      unless authorise? current_user, unit, :update</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">        error!({ error: &#39;You are not authorised to create outcomes in this unit.&#39; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">      ilo = unit.add_ilo(params[:name], params[:description], params[:abbreviation])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">      ilo</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>
          
          <code class="ruby">    desc &#39;Update ILO&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">    params do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="33">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :unit_id, type: Integer, desc: &#39;The unit ID for which the ILO belongs to&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="34">
          <span class="hits">1</span>
          
          <code class="ruby">      optional :name, type: String, desc: &#39;The ILO&#39;&#39;s new name&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="35">
          <span class="hits">1</span>
          
          <code class="ruby">      optional :description, type: String, desc: &#39;The ILO&#39;&#39;s new description&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="36">
          <span class="hits">1</span>
          
          <code class="ruby">      optional :abbreviation, type: String, desc: &#39;The ILO&#39;&#39;s new abbreviation&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="37">
          <span class="hits">1</span>
          
          <code class="ruby">      optional :ilo_number, type: Integer, desc: &#39;The ILO&#39;&#39;s new sequence number&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="39">
          <span class="hits">1</span>
          
          <code class="ruby">    put &#39;/units/:unit_id/outcomes/:id&#39; do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">      unit = Unit.find(params[:unit_id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">      error!({ error: &#39;Unable to locate requested unit.&#39; }, 405) if unit.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">      unless authorise? current_user, unit, :update</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">        error!({ error: &#39;You are not authorised to update outcomes in this unit.&#39; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">      ilo = unit.learning_outcomes.find(params[:id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">      error!({ error: &#39;Unable to locate outcome requested.&#39; }, 405) if ilo.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">      ilo_parameters = ActionController::Parameters.new(params)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">                                                   .permit(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">                                                     :name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">                                                     :description,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">                                                     :abbreviation</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">                                                   )</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="56">
          
          
          <code class="ruby">      unit.move_ilo(ilo, params[:ilo_number]) if params[:ilo_number]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="57">
          
          
          <code class="ruby">      ilo.update!(ilo_parameters)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="58">
          
          
          <code class="ruby">      ilo</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="61">
          <span class="hits">1</span>
          
          <code class="ruby">    desc &#39;Delete an outcome from a unit&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="62">
          <span class="hits">1</span>
          
          <code class="ruby">    params do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="63">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :unit_id, type: Integer, desc: &#39;The id for the unit&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="64">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :id, type: Integer, desc: &#39;The id for the outcome you wish to delete&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="66">
          <span class="hits">1</span>
          
          <code class="ruby">    delete &#39;/units/:unit_id/outcomes/:id&#39; do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="67">
          
          
          <code class="ruby">      unit = Unit.find(params[:unit_id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="68">
          
          
          <code class="ruby">      error!({ error: &#39;Unable to locate requested unit.&#39; }, 405) if unit.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="70">
          
          
          <code class="ruby">      unless authorise? current_user, unit, :update</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="71">
          
          
          <code class="ruby">        error!({ error: &#39;You are not authorised to delete outcomes in this unit.&#39; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="74">
          
          
          <code class="ruby">      ilo = unit.learning_outcomes.find(params[:id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="75">
          
          
          <code class="ruby">      error!({ error: &#39;Unable to locate outcome requested.&#39; }, 405) if ilo.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="77">
          
          
          <code class="ruby">      ilo.destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="78">
          
          
          <code class="ruby">      nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="81">
          <span class="hits">1</span>
          
          <code class="ruby">    desc &#39;Download the outcomes for a unit to a csv&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="82">
          <span class="hits">1</span>
          
          <code class="ruby">    get &#39;/units/:unit_id/outcomes/csv&#39; do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="83">
          
          
          <code class="ruby">      unit = Unit.find(params[:unit_id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="84">
          
          
          <code class="ruby">      error!({ error: &#39;Unable to locate requested unit.&#39; }, 405) if unit.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="86">
          
          
          <code class="ruby">      unless authorise? current_user, unit, :update</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="87">
          
          
          <code class="ruby">        error!({ error: &#39;You are not authorised to download outcomes for this unit.&#39; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="90">
          
          
          <code class="ruby">      content_type &#39;application/octet-stream&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="91">
          
          
          <code class="ruby">      header[&#39;Content-Disposition&#39;] = &quot;attachment; filename=#{unit.code}-LearningOutcomes.csv &quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="92">
          
          
          <code class="ruby">      env[&#39;api.format&#39;] = :binary</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="93">
          
          
          <code class="ruby">      unit.export_learning_outcome_to_csv</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="96">
          <span class="hits">1</span>
          
          <code class="ruby">    desc &#39;Upload the outcomes for a unit from a csv&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="97">
          <span class="hits">1</span>
          
          <code class="ruby">    params do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="98">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :file, type: Rack::Multipart::UploadedFile, desc: &#39;CSV upload file.&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="99">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :unit_id, type: Integer, desc: &#39;The unit to upload tasks to&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="101">
          <span class="hits">1</span>
          
          <code class="ruby">    post &#39;/units/:unit_id/outcomes/csv&#39; do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby">      # check mime is correct before uploading</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="103">
          
          
          <code class="ruby">      ensure_csv!(params[:file][:tempfile])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="105">
          
          
          <code class="ruby">      unit = Unit.find(params[:unit_id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="107">
          
          
          <code class="ruby">      unless authorise? current_user, unit, :upload_csv</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="108">
          
          
          <code class="ruby">        error!({ error: &#39;Not authorised to upload CSV of outcomes&#39; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby">      # Actually import...</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="112">
          
          
          <code class="ruby">      unit.import_outcomes_from_csv(params[:file][:tempfile])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="82c0b5f13f809eea7e70396360e08fcb9099e7db">
  <div class="header">
    <h3>app/api/projects.rb</h3>
    <h4><span class="red">33.33 %</span> covered</h4>
    <div>
      <b>99</b> relevant lines. 
      <span class="green"><b>33</b> lines covered</span> and
      <span class="red"><b>66</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;grape&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;project_serializer&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">module Api</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  class Projects &lt; Grape::API</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">    helpers AuthenticationHelpers</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">    helpers AuthorisationHelpers</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">    helpers DbHelpers</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">    before do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">      authenticated?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">    desc &quot;Fetches all of the current user&#39;s projects&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">    params do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">      optional :include_inactive, type: Boolean, desc: &#39;Include projects for units that are no longer active?&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">    get &#39;/projects&#39; do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">      include_inactive = params[:include_inactive] || false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">      projects = Project.for_user current_user, include_inactive</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">      student_name = db_concat(&#39;users.first_name&#39;, &quot;&#39; &#39;&quot;, &#39;users.last_name&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">      tutor_name = db_concat(&#39;tutor.first_name&#39;, &quot;&#39; &#39;&quot;, &#39;tutor.last_name&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">      # join in other tables to fetch data</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">      projects = projects</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">                 .joins(:unit)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">                 .joins(:user)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">                 .joins(&#39;LEFT OUTER JOIN tutorials ON projects.tutorial_id = tutorials.id&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">                 .joins(&#39;LEFT OUTER JOIN unit_roles AS tutor_role ON tutorials.unit_role_id = tutor_role.id&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">                 .joins(&#39;LEFT OUTER JOIN users AS tutor ON tutor.id = tutor_role.user_id&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">                 .select(&#39;projects.*&#39;, &#39;units.name AS unit_name&#39;, &#39;units.id AS unit_id&#39;, &#39;units.code AS unit_code&#39;, &#39;units.start_date AS start_date&#39;, &quot;#{student_name} AS student_name&quot;, &quot;#{tutor_name} AS tutor_name&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">      ActiveModel::ArraySerializer.new(projects, each_serializer: ShallowProjectSerializer)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="39">
          <span class="hits">1</span>
          
          <code class="ruby">    desc &#39;Get project&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="40">
          <span class="hits">1</span>
          
          <code class="ruby">    params do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="41">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :id, type: Integer, desc: &#39;The id of the project to get&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="43">
          <span class="hits">1</span>
          
          <code class="ruby">    get &#39;/projects/:id&#39; do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">      project = Project.find(params[:id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">      if authorise? current_user, project, :get</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">        project</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="49">
          
          
          <code class="ruby">        error!({ error: &quot;Couldn&#39;t find Project with id=#{params[:id]}&quot; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">      Thread.current[:user] = current_user</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">      project</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="56">
          <span class="hits">1</span>
          
          <code class="ruby">    desc &#39;Update a project&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="57">
          <span class="hits">1</span>
          
          <code class="ruby">    params do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="58">
          <span class="hits">1</span>
          
          <code class="ruby">      optional :trigger,            type: String,  desc: &#39;The update trigger&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="59">
          <span class="hits">1</span>
          
          <code class="ruby">      optional :tutorial_id,        type: Integer, desc: &#39;Switch tutorial&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="60">
          <span class="hits">1</span>
          
          <code class="ruby">      optional :enrolled,           type: Boolean, desc: &#39;Enrol or withdraw this project&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="61">
          <span class="hits">1</span>
          
          <code class="ruby">      optional :target_grade,       type: Integer, desc: &#39;New target grade&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="62">
          <span class="hits">1</span>
          
          <code class="ruby">      optional :compile_portfolio,  type: Boolean, desc: &#39;Schedule a construction of the portfolio&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="63">
          <span class="hits">1</span>
          
          <code class="ruby">      optional :grade,              type: Integer, desc: &#39;New grade&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="64">
          <span class="hits">1</span>
          
          <code class="ruby">      optional :old_grade,          type: Integer, desc: &#39;Old grade to check it has not changed...&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="65">
          <span class="hits">1</span>
          
          <code class="ruby">      optional :grade_rationale,    type: String,  desc: &#39;New grade rationale&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="67">
          <span class="hits">1</span>
          
          <code class="ruby">    put &#39;/projects/:id&#39; do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="68">
          
          
          <code class="ruby">      project = Project.find(params[:id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="70">
          
          
          <code class="ruby">      if params[:trigger].nil? == false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="71">
          
          
          <code class="ruby">        if params[:trigger] == &#39;trigger_week_end&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="72">
          
          
          <code class="ruby">          if authorise? current_user, project, :trigger_week_end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="73">
          
          
          <code class="ruby">            project.trigger_week_end(current_user)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="75">
          
          
          <code class="ruby">            error!({ error: &quot;You are not authorised to perform this action for Project with id=#{params[:id]}&quot; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="78">
          
          
          <code class="ruby">          error!({ error: &quot;Invalid trigger - #{params[:trigger]} unknown&quot; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">      elsif !params[:tutorial_id].nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="81">
          
          
          <code class="ruby">        unless authorise? current_user, project, :change_tutorial</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="82">
          
          
          <code class="ruby">          error!({ error: &quot;Couldn&#39;t find Project with id=#{params[:id]}&quot; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="85">
          
          
          <code class="ruby">        tutorial_id = params[:tutorial_id]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="86">
          
          
          <code class="ruby">        if project.unit.tutorials.where(&#39;tutorials.id = :tutorial_id&#39;, tutorial_id: tutorial_id).count == 1</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="87">
          
          
          <code class="ruby">          project.tutorial_id = tutorial_id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="88">
          
          
          <code class="ruby">          project.save!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby">        elsif tutorial_id == -1</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="90">
          
          
          <code class="ruby">          project.tutorial = nil</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="91">
          
          
          <code class="ruby">          project.save!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="93">
          
          
          <code class="ruby">          error!({ error: &quot;Couldn&#39;t find Tutorial with id=#{params[:tutorial_id]}&quot; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby">      elsif !params[:enrolled].nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="96">
          
          
          <code class="ruby">        unless authorise? current_user, project.unit, :change_project_enrolment</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="97">
          
          
          <code class="ruby">          error!({ error: &quot;You cannot change the enrolment for project #{params[:id]}&quot; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="99">
          
          
          <code class="ruby">        project.enrolled = params[:enrolled]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="100">
          
          
          <code class="ruby">        project.save</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby">      elsif !params[:target_grade].nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="102">
          
          
          <code class="ruby">        unless authorise? current_user, project, :change</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="103">
          
          
          <code class="ruby">          error!({ error: &quot;You do not have permissions to change Project with id=#{params[:id]}&quot; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="106">
          
          
          <code class="ruby">        project.target_grade = params[:target_grade]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="107">
          
          
          <code class="ruby">        project.save</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby">      elsif !params[:grade].nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="109">
          
          
          <code class="ruby">        unless authorise? current_user, project, :assess</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="110">
          
          
          <code class="ruby">          error!({ error: &quot;You do not have permissions to assess Project with id=#{params[:id]}&quot; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="113">
          
          
          <code class="ruby">        if params[:grade_rationale].nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="114">
          
          
          <code class="ruby">          error!({ error: &#39;Grade rationale required to perform assessment.&#39; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="117">
          
          
          <code class="ruby">        if params[:old_grade].nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="118">
          
          
          <code class="ruby">          error!({ error: &#39;Existing project grade is required to perform assessment.&#39; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="121">
          
          
          <code class="ruby">        if params[:old_grade] != project.grade</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="122">
          
          
          <code class="ruby">          error!({ error: &#39;Existing project grade does not match current grade. Refresh project and try again.&#39; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="125">
          
          
          <code class="ruby">        project.grade = params[:grade]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="126">
          
          
          <code class="ruby">        project.grade_rationale = params[:grade_rationale]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="127">
          
          
          <code class="ruby">        project.save!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="128">
          
          
          <code class="ruby">      elsif !params[:compile_portfolio].nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="129">
          
          
          <code class="ruby">        unless authorise? current_user, project, :change</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="130">
          
          
          <code class="ruby">          error!({ error: &quot;You do not have permissions to change Project with id=#{params[:id]}&quot; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="132">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="133">
          
          
          <code class="ruby">        project.compile_portfolio = params[:compile_portfolio]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="134">
          
          
          <code class="ruby">        project.save</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="135">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="136">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="137">
          
          
          <code class="ruby">      Thread.current[:user] = current_user</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="138">
          
          
          <code class="ruby">      project</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="139">
          
          
          <code class="ruby">    end # put</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="140">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="141">
          <span class="hits">1</span>
          
          <code class="ruby">    desc &#39;Enrol a student in a unit, creating them a project&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="142">
          <span class="hits">1</span>
          
          <code class="ruby">    params do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="143">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :unit_id, type: Integer, desc: &#39;Unit Id&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="144">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :student_num, type: String,   desc: &#39;Student Number 7 digit code&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="145">
          <span class="hits">1</span>
          
          <code class="ruby">      optional :tutorial_id, type: Integer,  desc: &#39;Tutorial Id&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="146">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="147">
          <span class="hits">1</span>
          
          <code class="ruby">    post &#39;/projects&#39; do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="148">
          
          
          <code class="ruby">      unit = Unit.find(params[:unit_id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="149">
          
          
          <code class="ruby">      student = User.find_by(username: params[:student_num])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="150">
          
          
          <code class="ruby">      student = User.find_by(student_id: params[:student_num]) if student.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="151">
          
          
          <code class="ruby">      student = User.find_by(email: params[:student_num]) if student.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="152">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="153">
          
          
          <code class="ruby">      if student.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="154">
          
          
          <code class="ruby">        error!({ error: &quot;Couldn&#39;t find Student with username=#{params[:student_num]}&quot; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="155">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="156">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="157">
          
          
          <code class="ruby">      if authorise? current_user, unit, :enrol_student</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="158">
          
          
          <code class="ruby">        proj = unit.enrol_student(student, params[:tutorial_id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="159">
          
          
          <code class="ruby">        if proj.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="160">
          
          
          <code class="ruby">          error!({ error: &#39;Error adding student to unit&#39; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="161">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="162">
          
          
          <code class="ruby">          {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby">            project_id: proj.id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="164">
          
          
          <code class="ruby">            enrolled: proj.enrolled,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="165">
          
          
          <code class="ruby">            first_name: proj.student.first_name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="166">
          
          
          <code class="ruby">            last_name: proj.student.last_name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="167">
          
          
          <code class="ruby">            student_id: proj.student.username,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="168">
          
          
          <code class="ruby">            student_email: proj.student.email,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="169">
          
          
          <code class="ruby">            target_grade: proj.target_grade,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="170">
          
          
          <code class="ruby">            tutorial_id: proj.tutorial_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="171">
          
          
          <code class="ruby">            compile_portfolio: false,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="172">
          
          
          <code class="ruby">            grade: proj.grade,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="173">
          
          
          <code class="ruby">            grade_rationale: proj.grade_rationale,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="174">
          
          
          <code class="ruby">            max_pct_copy: 0,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="175">
          
          
          <code class="ruby">            has_portfolio: false,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="176">
          
          
          <code class="ruby">            stats: &#39;0|1|0|0|0|0|0|0|0|0|0&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="177">
          
          
          <code class="ruby">          }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="178">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="179">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="180">
          
          
          <code class="ruby">        error!({ error: &quot;Couldn&#39;t find Unit with id=#{params[:unit_id]}&quot; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="181">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="182">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="183">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="184">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="cf50cba59d1b146fd9cd765fe1297d85c8ad22e6">
  <div class="header">
    <h3>app/api/settings.rb</h3>
    <h4><span class="red">80.0 %</span> covered</h4>
    <div>
      <b>10</b> relevant lines. 
      <span class="green"><b>8</b> lines covered</span> and
      <span class="red"><b>2</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;grape&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;project_serializer&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">module Api</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  class Settings &lt; Grape::API</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">    # Returns the current auth method</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">    desc &#39;Return configurable details for the Doubtfire front end&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">    get &#39;/settings&#39; do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">      {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">        externalName: Doubtfire::Application.config.institution[:product_name]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">    desc &#39;Return privacy policy details&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">    get &#39;/settings/privacy&#39; do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">      {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">        privacy:    Doubtfire::Application.config.institution[:privacy],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">        plagiarism: Doubtfire::Application.config.institution[:plagiarism]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="134fb691d64d053f11b9d42b11a9d4a52b780a86">
  <div class="header">
    <h3>app/api/students.rb</h3>
    <h4><span class="red">63.16 %</span> covered</h4>
    <div>
      <b>19</b> relevant lines. 
      <span class="green"><b>12</b> lines covered</span> and
      <span class="red"><b>7</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;grape&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;project_serializer&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">module Api</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  class Students &lt; Grape::API</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">    helpers AuthenticationHelpers</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">    helpers AuthorisationHelpers</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">    before do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">      authenticated?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">    desc &#39;Get users&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">    params do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :unit_id, type: Integer, desc: &#39;The unit to get the students for&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">      optional :all, type: Boolean, desc: &#39;Show all students or just current students&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">    get &#39;/students&#39; do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">      unit = Unit.find(params[:unit_id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">      if (authorise? current_user, unit, :get_students) || (authorise? current_user, User, :admin_units)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">        result = if params[:all].nil? || (!params[:all].nil? &amp;&amp; !params[:all])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">                   unit.student_query(true)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">                 else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">                   unit.student_query(false)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">                 end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">        error!({ error: &quot;Couldn&#39;t find Unit with id=#{params[:unit_id]}&quot; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="d8eb0f313977cf3d3c3ba989f489116d50d087af">
  <div class="header">
    <h3>app/api/submission/batch_task.rb</h3>
    <h4><span class="red">47.62 %</span> covered</h4>
    <div>
      <b>42</b> relevant lines. 
      <span class="green"><b>20</b> lines covered</span> and
      <span class="red"><b>22</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;grape&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;project_serializer&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">module Api</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  module Submission</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">    class BatchTask &lt; Grape::API</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">      helpers GenerateHelpers</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">      helpers AuthenticationHelpers</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">      helpers AuthorisationHelpers</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">      before do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">        authenticated?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">      desc &quot;Retrieve all submission documents ready to mark for the provided user&#39;s tutorials for the given unit id&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">      params do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">        requires :unit_id, type: Integer, desc: &#39;Unit ID to retrieve submissions for.&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">        optional :user_id, type: Integer, desc: &#39;User ID to retrieve submissions for (optional; will use current_user otherwise).&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">      get &#39;/submission/assess/&#39; do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">        user = params[:user_id].nil? ? current_user : User.find(params[:user_id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">        unit = Unit.find(params[:unit_id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">        unless authorise? user, unit, :provide_feedback</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">          error!({ error: &#39;Not authorised to batch download ready to mark submissions&#39; }, 401)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">        unless authorise? current_user, unit, :provide_feedback</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">          error!({ error: &#39;Not authorised to batch download ready to mark submissions&#39; }, 401)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">        # Array of tasks that need marking for the given unit id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">        tasks_to_download = UnitRole.tasks_to_review(user)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">        output_zip = unit.generate_batch_task_zip(current_user, tasks_to_download)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">        error!({ error: &#39;No files to download&#39; }, 401) if output_zip.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">        # Set download headers...</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">        content_type &#39;application/octet-stream&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">        download_id = &quot;#{Time.new.strftime(&#39;%Y-%m-%d&#39;)}-#{unit.code}-#{current_user.username}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">        header[&#39;Content-Disposition&#39;] = &quot;attachment; filename=#{download_id}.zip&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">        env[&#39;api.format&#39;] = :binary</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">        out = File.read(output_zip.path)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">        output_zip.unlink</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">        out</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">      end # get</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="50">
          <span class="hits">1</span>
          
          <code class="ruby">      desc &#39;Upload submission documents for the given unit and user id&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="51">
          <span class="hits">1</span>
          
          <code class="ruby">      params do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="52">
          <span class="hits">1</span>
          
          <code class="ruby">        requires :file, type: Rack::Multipart::UploadedFile, desc: &#39;batch file upload&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="53">
          <span class="hits">1</span>
          
          <code class="ruby">        requires :unit_id, type: Integer, desc: &#39;Unit ID to upload marked submissions to.&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="54">
          <span class="hits">1</span>
          
          <code class="ruby">        optional :user_id, type: Integer, desc: &#39;User ID to upload marked submissions to (optional; will use current_user otherwise).&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="56">
          <span class="hits">1</span>
          
          <code class="ruby">      post &#39;/submission/assess/&#39; do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="57">
          
          
          <code class="ruby">        user = params[:user_id].nil? ? current_user : User.find(params[:user_id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="58">
          
          
          <code class="ruby">        unit = Unit.find(params[:unit_id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="60">
          
          
          <code class="ruby">        unless authorise? user, unit, :provide_feedback</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="61">
          
          
          <code class="ruby">          error!({ error: &#39;Not authorised to batch upload marks&#39; }, 401)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="64">
          
          
          <code class="ruby">        unit.upload_batch_task_zip_or_csv(current_user, params[:file])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">      end # post</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="b2f836c46ee48cef0c37a94dae7e5edbd9456fc9">
  <div class="header">
    <h3>app/api/submission/generate.rb</h3>
    <h4><span class="red">57.89 %</span> covered</h4>
    <div>
      <b>19</b> relevant lines. 
      <span class="green"><b>11</b> lines covered</span> and
      <span class="red"><b>8</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;grape&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;project_serializer&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">module Api</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  module Submission</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">    class Generate &lt; Grape::API</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">      helpers GenerateHelpers</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">      desc &#39;Generate doubtfire-task-inspecific submission document&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">      params do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">        requires :upload_requirements, type: JSON, desc: &quot;File details, eg: [ { key: &#39;file1&#39;, name: &#39;Shape Class&#39;, type: &#39;[image/code/document]&#39; }, ... ]&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">        requires :file0, type: Rack::Multipart::UploadedFile, desc: &#39;file 1.&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">      post &#39;/submission/generate/&#39; do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">        # Set download headers...</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">        content_type &#39;application/octet-stream&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">        header[&#39;Content-Disposition&#39;] = &#39;attachment; filename=output.pdf&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">        env[&#39;api.format&#39;] = :binary</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">        file = combine_to_pdf(scoop_files(params, params[:upload_requirements]))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">        file.path</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">        response = file.open.read</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">        # Remember to delete the file as we don&#39;t want to save it with this kind of inspecific request</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">        file.unlink</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">        response</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="eb3b04cfe9892d064a1e1458035b78917b817bc6">
  <div class="header">
    <h3>app/api/submission/generate_helpers.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>15</b> relevant lines. 
      <span class="green"><b>15</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># zipping files</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;zip&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">module Api::Submission::GenerateHelpers</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">  # Scoops out a files array from the params provided</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  def scoop_files(params, upload_reqs)</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="9">
          <span class="hits">6</span>
          
          <code class="ruby">    files = params.reject { |key| !(key =~ /^file\d+$/) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">    error!({ error: &#39;Upload requirements mismatch with files provided&#39; }, 403) if files.length != upload_reqs.length</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">    # Pair the name and type from upload_requirements to each file</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">    upload_reqs.each do |detail|</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">      key = detail[&#39;key&#39;]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">      next unless files.key? key</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">      files[key].id   = files[key].name</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">      files[key].name = detail[&#39;name&#39;]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">      files[key].type = detail[&#39;type&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">    # File didn&#39;t get assigned an id above, then reject it since there was a mismatch</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="24">
          <span class="hits">2</span>
          
          <code class="ruby">    files = files.reject { |_key, file| file.id.nil? }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">    error!({ error: &#39;Upload requirements mismatch with files provided&#39; }, 403) if files.length != upload_reqs.length</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">    # Kill the kvp</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="28">
          <span class="hits">2</span>
          
          <code class="ruby">    files.map { |_k, v| v }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">  # module_function :combine_to_pdf</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">  module_function :scoop_files</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="3d90eb0df8dff723abc74444a9e75e96b9560ae0">
  <div class="header">
    <h3>app/api/submission/portfolio_api.rb</h3>
    <h4><span class="red">42.37 %</span> covered</h4>
    <div>
      <b>59</b> relevant lines. 
      <span class="green"><b>25</b> lines covered</span> and
      <span class="red"><b>34</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;grape&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;project_serializer&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">module Api</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  module Submission</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">    class PortfolioApi &lt; Grape::API</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">      helpers GenerateHelpers</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">      helpers AuthenticationHelpers</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">      helpers AuthorisationHelpers</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">      before do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">        authenticated?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">      desc &quot;Upload documents for inclusion in a project&#39;s portfolio&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">      params do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">        requires :name,  type: String,                        desc: &#39;Name of the part being uploaded&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">        requires :kind,  type: String,                        desc: &#39;The kind of file being uploaded: document, code, or image&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">        requires :file0, type: Rack::Multipart::UploadedFile, desc: &#39;file 0.&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">      post &#39;/submission/project/:id/portfolio&#39; do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">        project = Project.find(params[:id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">        unless authorise? current_user, project, :make_submission</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">          error!({ error: &quot;Not authorised to submit portfolio for project &#39;#{params[:id]}&#39;&quot; }, 401)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">        file = params[:file0]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">        name = params[:name]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">        kind = params[:kind]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">        # Check that the file is OK to accept</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">        unless FileHelper.accept_file(file, name, kind)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">          error!({ error: &quot;&#39;#{file.filename}&#39; is not a valid #{kind} file&quot; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">        # Move file into place</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">        project.move_to_portfolio(file, name, kind) # returns details of file</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">      end # post</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="41">
          <span class="hits">1</span>
          
          <code class="ruby">      desc &#39;Remove a file from the portfolio files for a unit&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="42">
          <span class="hits">1</span>
          
          <code class="ruby">      params do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="43">
          <span class="hits">1</span>
          
          <code class="ruby">        optional :idx,   type: Integer, desc: &#39;The index of the file&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="44">
          <span class="hits">1</span>
          
          <code class="ruby">        optional :kind,  type: String, desc: &#39;The kind of file being removed: document, code, or image&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="45">
          <span class="hits">1</span>
          
          <code class="ruby">        optional :name,  type: String, desc: &#39;Name of file to remove&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="47">
          <span class="hits">1</span>
          
          <code class="ruby">      delete &#39;/submission/project/:id/portfolio&#39; do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">        project = Project.find(params[:id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">        unless authorise? current_user, project, :make_submission</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">          error!({ error: &quot;Not authorised to alter portfolio for project &#39;#{params[:id]}&#39;&quot; }, 401)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">        # Remove file or portfolio?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="55">
          
          
          <code class="ruby">        if params[:idx].nil? &amp;&amp; params[:name].nil? &amp;&amp; params[:kind].nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="56">
          
          
          <code class="ruby">          project.remove_portfolio # returns details of file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="57">
          
          
          <code class="ruby">        elsif !(params[:idx].nil? || params[:name].nil? || params[:kind].nil?)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="58">
          
          
          <code class="ruby">          idx = params[:idx]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="59">
          
          
          <code class="ruby">          name = params[:name]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="60">
          
          
          <code class="ruby">          kind = params[:kind]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="62">
          
          
          <code class="ruby">          project.remove_portfolio_file(idx, kind, name) # returns details of file</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="64">
          
          
          <code class="ruby">        nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="67">
          <span class="hits">1</span>
          
          <code class="ruby">      desc &#39;Retrieve portfolio for project with the given id&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="68">
          <span class="hits">1</span>
          
          <code class="ruby">      params do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="69">
          <span class="hits">1</span>
          
          <code class="ruby">        optional :as_attachment, type: Boolean, desc: &#39;Whether or not to download file as attachment. Default is false.&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="71">
          <span class="hits">1</span>
          
          <code class="ruby">      get &#39;/submission/project/:id/portfolio&#39; do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="72">
          
          
          <code class="ruby">        project = Project.find(params[:id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="74">
          
          
          <code class="ruby">        unless authorise? current_user, project, :get_submission</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="75">
          
          
          <code class="ruby">          error!({ error: &quot;Not authorised to download portfolio for project &#39;#{params[:id]}&#39;&quot; }, 401)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="78">
          
          
          <code class="ruby">        evidence_loc = project.portfolio_path</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="80">
          
          
          <code class="ruby">        if evidence_loc.nil? || File.exist?(evidence_loc) == false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="81">
          
          
          <code class="ruby">          evidence_loc = Rails.root.join(&#39;public&#39;, &#39;resources&#39;, &#39;FileNotFound.pdf&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="82">
          
          
          <code class="ruby">          filename = &quot;FileNotFound.pdf&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="84">
          
          
          <code class="ruby">          filename = &quot;#{project.unit.code}-#{project.student.username}-portfolio.pdf&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="87">
          
          
          <code class="ruby">        if params[:as_attachment]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="88">
          
          
          <code class="ruby">          header[&#39;Content-Disposition&#39;] = &quot;attachment; filename=#{filename}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby">        # Set download headers...</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="92">
          
          
          <code class="ruby">        content_type &#39;application/pdf&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="93">
          
          
          <code class="ruby">        env[&#39;api.format&#39;] = :binary</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="95">
          
          
          <code class="ruby">        File.read(evidence_loc)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby">      end # get</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby">      # &quot;Retrieve portfolios for a unit&quot; done using controller</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="764901a042c71484ce4bec92e4c154083e14d84b">
  <div class="header">
    <h3>app/api/submission/portfolio_evidence_api.rb</h3>
    <h4><span class="red">55.22 %</span> covered</h4>
    <div>
      <b>67</b> relevant lines. 
      <span class="green"><b>37</b> lines covered</span> and
      <span class="red"><b>30</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;grape&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;project_serializer&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">module Api</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  module Submission</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">    class PortfolioEvidenceApi &lt; Grape::API</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">      helpers GenerateHelpers</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">      helpers AuthenticationHelpers</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">      helpers AuthorisationHelpers</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">      before do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">        authenticated?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">      desc &#39;Upload and generate doubtfire-task-specific submission document&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">      params do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">        requires :file0, type: Rack::Multipart::UploadedFile, desc: &#39;file 0.&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">        optional :file1, type: Rack::Multipart::UploadedFile, desc: &#39;file 1.&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">        optional :contributions, type: JSON, desc: &quot;Contribution details JSON, eg: [ { project_id: 1, pct:&#39;0.44&#39;, pts: 4 }, ... ]&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">        optional :alignment_data, type: JSON, desc: &quot;Data for task alignment, eg: [ { ilo_id: 1, rating: 5, rationale: &#39;Hello&#39; }, ... ]&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">        optional :trigger, type: String, desc: &#39;Can be need_help to indicate upload is not a ready to mark submission&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">      post &#39;/projects/:id/task_def_id/:task_definition_id/submission&#39; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">        project = Project.find(params[:id])</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">        task_definition = project.unit.task_definitions.find(params[:task_definition_id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">        # check the user can put this task</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">        unless authorise? current_user, project, :make_submission</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">          error!({ error: &quot;Not authorised to submit task &#39;#{task_definition.name}&#39;&quot; }, 401)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">        task = project.task_for_task_definition(task_definition)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="34">
          <span class="hits">1</span>
          
          <code class="ruby">        if task.group_task? &amp;&amp; !task.group</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">          error!({ error: &quot;This task requires a group submission. Ensure you are in a group for the unit&#39;s #{task_definition.group_set.name}&quot; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="38">
          <span class="hits">1</span>
          
          <code class="ruby">        trigger = if params[:trigger] &amp;&amp; params[:trigger].tr(&#39;&quot;\&#39;&#39;, &#39;&#39;) == &#39;need_help&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">                    &#39;need_help&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">                  else</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="41">
          <span class="hits">1</span>
          
          <code class="ruby">                    &#39;ready_to_mark&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">                  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="44">
          <span class="hits">1</span>
          
          <code class="ruby">        alignments = params[:alignment_data]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="45">
          <span class="hits">1</span>
          
          <code class="ruby">        upload_reqs = task.upload_requirements</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="46">
          <span class="hits">1</span>
          
          <code class="ruby">        student = task.project.student</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="47">
          <span class="hits">1</span>
          
          <code class="ruby">        unit = task.project.unit</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">        # Copy files to be PDFed</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="50">
          <span class="hits">1</span>
          
          <code class="ruby">        task.accept_submission(current_user, scoop_files(params, upload_reqs), student, self, params[:contributions], trigger, alignments)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="52">
          <span class="hits">1</span>
          
          <code class="ruby">        TaskUpdateSerializer.new(task)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">      end # post</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="55">
          <span class="hits">1</span>
          
          <code class="ruby">      desc &#39;Retrieve submission document included for the task id&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="56">
          <span class="hits">1</span>
          
          <code class="ruby">      params do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="57">
          <span class="hits">1</span>
          
          <code class="ruby">        optional :as_attachment, type: Boolean, desc: &#39;Whether or not to download file as attachment. Default is false.&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="59">
          <span class="hits">1</span>
          
          <code class="ruby">      get &#39;/projects/:id/task_def_id/:task_definition_id/submission&#39; do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="60">
          
          
          <code class="ruby">        project = Project.find(params[:id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="61">
          
          
          <code class="ruby">        task_definition = project.unit.task_definitions.find(params[:task_definition_id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">        # check the user can put this task</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="64">
          
          
          <code class="ruby">        unless authorise? current_user, project, :get_submission</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="65">
          
          
          <code class="ruby">          error!({ error: &quot;Not authorised to get task &#39;#{task_definition.name}&#39;&quot; }, 401)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="68">
          
          
          <code class="ruby">        task = project.task_for_task_definition(task_definition)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="70">
          
          
          <code class="ruby">        evidence_loc = task.portfolio_evidence</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="71">
          
          
          <code class="ruby">        student = task.project.student</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="72">
          
          
          <code class="ruby">        unit = task.project.unit</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="74">
          
          
          <code class="ruby">        if task.processing_pdf?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="75">
          
          
          <code class="ruby">          evidence_loc = Rails.root.join(&#39;public&#39;, &#39;resources&#39;, &#39;AwaitingProcessing.pdf&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="76">
          
          
          <code class="ruby">          filename=&#39;AwaitingProcessing.pdf&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">        elsif evidence_loc.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="78">
          
          
          <code class="ruby">          evidence_loc = Rails.root.join(&#39;public&#39;, &#39;resources&#39;, &#39;FileNotFound.pdf&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="79">
          
          
          <code class="ruby">          filename=&#39;FileNotFound.pdf&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="81">
          
          
          <code class="ruby">          filename=&quot;#{task.task_definition.abbreviation}.pdf&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="85">
          
          
          <code class="ruby">        if params[:as_attachment]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="86">
          
          
          <code class="ruby">          header[&#39;Content-Disposition&#39;] = &quot;attachment; filename=#{filename}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby">        # Set download headers...</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="90">
          
          
          <code class="ruby">        content_type &#39;application/pdf&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="91">
          
          
          <code class="ruby">        env[&#39;api.format&#39;] = :binary</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="93">
          
          
          <code class="ruby">        File.read(evidence_loc)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby">      end # get</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="96">
          <span class="hits">1</span>
          
          <code class="ruby">      desc &quot;Request for a task&#39;s documents to be re-processed tp recreate the task&#39;s PDF&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="97">
          <span class="hits">1</span>
          
          <code class="ruby">      put &#39;/projects/:id/task_def_id/:task_definition_id/submission&#39; do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="98">
          
          
          <code class="ruby">        project = Project.find(params[:id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="99">
          
          
          <code class="ruby">        task_definition = project.unit.task_definitions.find(params[:task_definition_id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="101">
          
          
          <code class="ruby">        unless authorise? current_user, project, :get_submission</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="102">
          
          
          <code class="ruby">          error!({ error: &quot;Not authorised to get task &#39;#{task_definition.name}&#39;&quot; }, 401)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="105">
          
          
          <code class="ruby">        task = project.task_for_task_definition(task_definition)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="107">
          
          
          <code class="ruby">        if task &amp;&amp; PortfolioEvidence.recreate_task_pdf(task)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="108">
          
          
          <code class="ruby">          { result: &#39;done&#39; }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="110">
          
          
          <code class="ruby">          { result: &#39;false&#39; }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby">      end # put</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="adbed66d95e171a44142eec74e66e6e3fba823e9">
  <div class="header">
    <h3>app/api/task_comments.rb</h3>
    <h4><span class="red">40.59 %</span> covered</h4>
    <div>
      <b>101</b> relevant lines. 
      <span class="green"><b>41</b> lines covered</span> and
      <span class="red"><b>60</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;grape&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">module Api</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  class TaskComments &lt; Grape::API</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">    helpers AuthenticationHelpers</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">    helpers AuthorisationHelpers</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">    before do</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="9">
          <span class="hits">3</span>
          
          <code class="ruby">      authenticated?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">    desc &#39;Add a new comment to a task&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">    params do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">      optional :comment, type: String, desc: &#39;The comment text to add to the task&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">      optional :attachment, type: Rack::Multipart::UploadedFile, desc: &#39;Image, sound, PDF or video comment file&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">    post &#39;/projects/:project_id/task_def_id/:task_definition_id/comments&#39; do</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="18">
          <span class="hits">3</span>
          
          <code class="ruby">      project = Project.find(params[:project_id])</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="19">
          <span class="hits">3</span>
          
          <code class="ruby">      task_definition = project.unit.task_definitions.find(params[:task_definition_id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="21">
          <span class="hits">3</span>
          
          <code class="ruby">      unless authorise? current_user, project, :make_submission</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">        error!({ error: &#39;Not authorised to create a comment for this task&#39; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="25">
          <span class="hits">3</span>
          
          <code class="ruby">      text_comment = params[:comment]</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="26">
          <span class="hits">3</span>
          
          <code class="ruby">      attached_file = params[:attachment]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="28">
          <span class="hits">3</span>
          
          <code class="ruby">      if attached_file.present?</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="29">
          <span class="hits">2</span>
          
          <code class="ruby">        error!({error: &quot;Attachment is empty.&quot;}) unless File.size?(attached_file.tempfile.path).present?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="30">
          <span class="hits">1</span>
          
          <code class="ruby">        error!({error: &quot;Attachment exceeds the maximum attachment size of 30MB.&quot;}) unless File.size?(attached_file.tempfile.path) &lt; 30_000_000</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="33">
          <span class="hits">2</span>
          
          <code class="ruby">      task = project.task_for_task_definition(task_definition)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="34">
          <span class="hits">2</span>
          
          <code class="ruby">      type_string = content_type.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="36">
          <span class="hits">2</span>
          
          <code class="ruby">      logger.info(&quot;#{current_user.username} - added comment for task #{task.id} (#{task_definition.abbreviation})&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="38">
          <span class="hits">2</span>
          
          <code class="ruby">      if attached_file.nil? || attached_file.empty?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="39">
          <span class="hits">1</span>
          
          <code class="ruby">        error!({ error: &quot;Comment text is empty, unable to add new comment&quot;}, 403) unless text_comment.present?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="40">
          <span class="hits">1</span>
          
          <code class="ruby">        result = task.add_text_comment(current_user, text_comment)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="42">
          <span class="hits">1</span>
          
          <code class="ruby">        unless FileHelper.accept_file(attached_file, &quot;comment attachment - TaskComment&quot;, &quot;comment_attachment&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">          error!({ error: &quot;Please upload only images, audio or PDF documents&quot; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="46">
          <span class="hits">1</span>
          
          <code class="ruby">        result = task.add_comment_with_attachment(current_user, attached_file)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="49">
          <span class="hits">2</span>
          
          <code class="ruby">      if result.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">        error!({ error: &#39;No comment added. Comment duplicates last comment, so ignored.&#39; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="52">
          <span class="hits">2</span>
          
          <code class="ruby">        result.mark_as_read(current_user, project.unit)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="53">
          <span class="hits">2</span>
          
          <code class="ruby">        result.serialize(current_user)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="57">
          <span class="hits">1</span>
          
          <code class="ruby">    desc &#39;Get an attachment related to a task comment&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="58">
          <span class="hits">1</span>
          
          <code class="ruby">    params do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="59">
          <span class="hits">1</span>
          
          <code class="ruby">      optional :as_attachment, type: Boolean, desc: &#39;Whether or not to download file as attachment. Default is false.&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="61">
          <span class="hits">1</span>
          
          <code class="ruby">    get &#39;/projects/:project_id/task_def_id/:task_definition_id/comments/:id&#39; do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="62">
          
          
          <code class="ruby">      project = Project.find(params[:project_id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="63">
          
          
          <code class="ruby">      task_definition = project.unit.task_definitions.find(params[:task_definition_id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="65">
          
          
          <code class="ruby">      unless authorise? current_user, project, :get</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="66">
          
          
          <code class="ruby">        error!({ error: &#39;You cannot read the comments for this task&#39; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="69">
          
          
          <code class="ruby">      if project.has_task_for_task_definition? task_definition</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="70">
          
          
          <code class="ruby">        task = project.task_for_task_definition(task_definition)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="72">
          
          
          <code class="ruby">        comment = task.comments.find(params[:id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="74">
          
          
          <code class="ruby">        error!({error: &#39;No attachment for this comment.&#39;}, 404) unless [&quot;audio&quot;, &quot;image&quot;, &quot;pdf&quot;].include? comment.content_type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="76">
          
          
          <code class="ruby">        error!({error: &#39;File missing&#39;}, 404) unless File.exists? comment.attachment_path</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">        # Set return content type</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="79">
          
          
          <code class="ruby">        content_type comment.attachment_mime_type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="81">
          
          
          <code class="ruby">        env[&#39;api.format&#39;] = :binary</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby">        # mark as attachment</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="84">
          
          
          <code class="ruby">        if params[:as_attachment]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="85">
          
          
          <code class="ruby">          header[&#39;Content-Disposition&#39;] = &quot;attachment; filename=#{comment.attachment_file_name}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">        # Work out what part to return</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="89">
          
          
          <code class="ruby">        file_size = File.size(comment.attachment_path)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="90">
          
          
          <code class="ruby">        begin_point = 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="91">
          
          
          <code class="ruby">        end_point = file_size - 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby">        # Was it asked for just a part of the file?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="94">
          
          
          <code class="ruby">        if request.headers[&#39;Range&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby">          # indicate partial content</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="96">
          
          
          <code class="ruby">          status 206</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby">          # extract part desired from the content</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="99">
          
          
          <code class="ruby">          if request.headers[&#39;Range&#39;] =~ /bytes\=(\d+)\-(\d*)/</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="100">
          
          
          <code class="ruby">            begin_point = $1.to_i</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="101">
          
          
          <code class="ruby">            end_point = $2.to_i if $2.present?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="104">
          
          
          <code class="ruby">          end_point = file_size - 1 unless end_point &lt; file_size - 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby">        # Return the requested content</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="108">
          
          
          <code class="ruby">        content_length = end_point - begin_point + 1</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="109">
          
          
          <code class="ruby">        header[&#39;Content-Range&#39;] = &quot;bytes #{begin_point}-#{end_point}/#{file_size}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="110">
          
          
          <code class="ruby">        header[&#39;Content-Length&#39;] = content_length.to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="111">
          
          
          <code class="ruby">        header[&#39;Accept-Ranges&#39;] = &#39;bytes&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby">        # Read the binary data and return</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="114">
          
          
          <code class="ruby">        IO.binread(comment.attachment_path, content_length, begin_point)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="118">
          <span class="hits">1</span>
          
          <code class="ruby">    desc &#39;Get the comments related to a task&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="119">
          <span class="hits">1</span>
          
          <code class="ruby">    get &#39;/projects/:project_id/task_def_id/:task_definition_id/comments&#39; do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="120">
          
          
          <code class="ruby">      project = Project.find(params[:project_id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="121">
          
          
          <code class="ruby">      task_definition = project.unit.task_definitions.find(params[:task_definition_id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="123">
          
          
          <code class="ruby">      unless authorise? current_user, project, :get</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="124">
          
          
          <code class="ruby">        error!({ error: &#39;You cannot read the comments for this task&#39; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="125">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="126">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="127">
          
          
          <code class="ruby">      if project.has_task_for_task_definition? task_definition</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="128">
          
          
          <code class="ruby">        task = project.task_for_task_definition(task_definition)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="129">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="130">
          
          
          <code class="ruby">        comments = task.all_comments.order(&#39;created_at ASC&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="131">
          
          
          <code class="ruby">        result = comments.map { |c| c.serialize(current_user) }          </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="132">
          
          
          <code class="ruby">        task.mark_comments_as_read(current_user, comments)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="133">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="134">
          
          
          <code class="ruby">        result = []</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="135">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="136">
          
          
          <code class="ruby">      result</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="138">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="139">
          <span class="hits">1</span>
          
          <code class="ruby">    desc &#39;Delete a comment&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="140">
          <span class="hits">1</span>
          
          <code class="ruby">    delete &#39;/projects/:project_id/task_def_id/:task_definition_id/comments/:id&#39; do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="141">
          
          
          <code class="ruby">      project = Project.find(params[:project_id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="142">
          
          
          <code class="ruby">      task_definition = project.unit.task_definitions.find(params[:task_definition_id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="143">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="144">
          
          
          <code class="ruby">      unless authorise? current_user, project, :get</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="145">
          
          
          <code class="ruby">        error!({ error: &#39;You cannot read the comments for this task&#39; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="146">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="147">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="148">
          
          
          <code class="ruby">      task = project.task_for_task_definition(task_definition)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="149">
          
          
          <code class="ruby">      task_comment = task.all_comments.find(params[:id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="150">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="151">
          
          
          <code class="ruby">      key = if current_user == task_comment.user</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="152">
          
          
          <code class="ruby">              :delete_own_comment</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="153">
          
          
          <code class="ruby">            else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="154">
          
          
          <code class="ruby">              :delete_other_comment</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="155">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="156">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="157">
          
          
          <code class="ruby">      unless authorise? current_user, task, key</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="158">
          
          
          <code class="ruby">        error!({ error: &#39;Not authorised to delete this comment&#39; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="159">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="160">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="161">
          
          
          <code class="ruby">      task_comment.destroy</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="162">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="164">
          <span class="hits">1</span>
          
          <code class="ruby">    desc &#39;Mark a comment as unread&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="165">
          <span class="hits">1</span>
          
          <code class="ruby">    post &#39;/projects/:project_id/task_def_id/:task_definition_id/comments/:id&#39; do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="166">
          
          
          <code class="ruby">      project = Project.find(params[:project_id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="167">
          
          
          <code class="ruby">      task_definition = project.unit.task_definitions.find(params[:task_definition_id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="168">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="169">
          
          
          <code class="ruby">      unless authorise? current_user, project, :make_submission</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="170">
          
          
          <code class="ruby">        error!({ error: &#39;Not authorised to mark comment as unread&#39; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="171">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="172">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="173">
          
          
          <code class="ruby">      task = project.task_for_task_definition(task_definition)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="174">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="175">
          
          
          <code class="ruby">      task_comment = task.comments.find(params[:id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="176">
          
          
          <code class="ruby">      task_comment.mark_as_unread(current_user)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="177">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="178">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="179">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="24c2aa2f8127942b467d04739241ff8dc95be92b">
  <div class="header">
    <h3>app/api/task_definitions.rb</h3>
    <h4><span class="red">55.66 %</span> covered</h4>
    <div>
      <b>212</b> relevant lines. 
      <span class="green"><b>118</b> lines covered</span> and
      <span class="red"><b>94</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;grape&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;task_serializer&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;mime-check-helpers&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">module Api</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  class TaskDefinitions &lt; Grape::API</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">    helpers AuthenticationHelpers</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">    helpers AuthorisationHelpers</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">    helpers FileHelper</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">    helpers MimeCheckHelpers</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">    before do</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="13">
          <span class="hits">3</span>
          
          <code class="ruby">      authenticated?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">    desc &#39;Add a new task definition to the given unit&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">    params do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :task_def, type: Hash do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">        requires :unit_id,                  type: Integer,  desc: &#39;The unit to create the new task def for&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">        requires :name,                     type: String,   desc: &#39;The name of this task def&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">        requires :description,              type: String,   desc: &#39;The description of this task def&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">        requires :weighting,                type: Integer,  desc: &#39;The weighting of this task&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">        requires :target_grade,             type: Integer,  desc: &#39;Minimum grade for task&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">        optional :group_set_id,             type: Integer,  desc: &#39;Related group set&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">        requires :start_date,               type: Date,     desc: &#39;The date when the task should be started&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="26">
          <span class="hits">1</span>
          
          <code class="ruby">        requires :target_date,              type: Date,     desc: &#39;The date when the task is due&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>
          
          <code class="ruby">        optional :due_date,                 type: Date,     desc: &#39;The deadline date&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">        requires :abbreviation,             type: String,   desc: &#39;The abbreviation of the task&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">        requires :restrict_status_updates,  type: Boolean,  desc: &#39;Restrict updating of the status to staff&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="30">
          <span class="hits">1</span>
          
          <code class="ruby">        optional :upload_requirements,      type: String,   desc: &#39;Task file upload requirements&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>
          
          <code class="ruby">        optional :plagiarism_checks,        type: String,   desc: &#39;The list of checks to perform&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">        requires :plagiarism_warn_pct,      type: Integer,  desc: &#39;The percent at which to record and warn about plagiarism&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="33">
          <span class="hits">1</span>
          
          <code class="ruby">        requires :is_graded,                type: Boolean,  desc: &#39;Whether or not this task definition is a graded task&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="34">
          <span class="hits">1</span>
          
          <code class="ruby">        requires :max_quality_pts,          type: Integer,  desc: &#39;A range for quality points when quality is assessed&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="37">
          <span class="hits">1</span>
          
          <code class="ruby">    post &#39;/task_definitions/&#39; do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">      unit = Unit.find(params[:task_def][:unit_id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">      unless authorise? current_user, unit, :add_task_def</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">        error!({ error: &#39;Not authorised to create a task definition of this unit&#39; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">      params[:task_def][:upload_requirements] = &#39;[]&#39; if params[:task_def][:upload_requirements].nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">      task_params = ActionController::Parameters.new(params)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">                                                .require(:task_def)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">                                                .permit(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">                                                  :unit_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">                                                  :name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">                                                  :description,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">                                                  :weighting,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">                                                  :target_grade,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">                                                  :start_date,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">                                                  :target_date,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">                                                  :due_date,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">                                                  :abbreviation,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">                                                  :restrict_status_updates,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">                                                  :upload_requirements,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">                                                  :plagiarism_checks,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">                                                  :plagiarism_warn_pct,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">                                                  :is_graded,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">                                                  :max_quality_pts</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">                                                )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="66">
          
          
          <code class="ruby">      task_def = TaskDefinition.new(task_params)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">      # Link in group set if specified</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="71">
          
          
          <code class="ruby">      if params[:task_def][:group_set_id] &amp;&amp; params[:task_def][:group_set_id] &gt;= 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="72">
          
          
          <code class="ruby">        gs = GroupSet.find(params[:task_def][:group_set_id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="73">
          
          
          <code class="ruby">        task_def.group_set = gs if gs.unit == unit</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="76">
          
          
          <code class="ruby">      task_def.save!</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="77">
          
          
          <code class="ruby">      task_def</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="80">
          <span class="hits">1</span>
          
          <code class="ruby">    desc &#39;Edits the given task definition&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="81">
          <span class="hits">1</span>
          
          <code class="ruby">    params do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="82">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :id, type: Integer, desc: &#39;The task id to edit&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="83">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :task_def, type: Hash do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="84">
          <span class="hits">1</span>
          
          <code class="ruby">        optional :unit_id,                  type: Integer,  desc: &#39;The unit to create the new task def for&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="85">
          <span class="hits">1</span>
          
          <code class="ruby">        optional :name,                     type: String,   desc: &#39;The name of this task def&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="86">
          <span class="hits">1</span>
          
          <code class="ruby">        optional :description,              type: String,   desc: &#39;The description of this task def&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="87">
          <span class="hits">1</span>
          
          <code class="ruby">        optional :weighting,                type: Integer,  desc: &#39;The weighting of this task&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="88">
          <span class="hits">1</span>
          
          <code class="ruby">        optional :target_grade,             type: Integer,  desc: &#39;Target grade for task&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="89">
          <span class="hits">1</span>
          
          <code class="ruby">        optional :group_set_id,             type: Integer,  desc: &#39;Related group set&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="90">
          <span class="hits">1</span>
          
          <code class="ruby">        optional :start_date,               type: Date,     desc: &#39;The date when the task should be started&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="91">
          <span class="hits">1</span>
          
          <code class="ruby">        optional :target_date,              type: Date,     desc: &#39;The date when the task is due&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="92">
          <span class="hits">1</span>
          
          <code class="ruby">        optional :due_date,                 type: Date,     desc: &#39;The deadline date&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="93">
          <span class="hits">1</span>
          
          <code class="ruby">        optional :abbreviation,             type: String,   desc: &#39;The abbreviation of the task&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="94">
          <span class="hits">1</span>
          
          <code class="ruby">        optional :restrict_status_updates,  type: Boolean,  desc: &#39;Restrict updating of the status to staff&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="95">
          <span class="hits">1</span>
          
          <code class="ruby">        optional :upload_requirements,      type: String,   desc: &#39;Task file upload requirements&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="96">
          <span class="hits">1</span>
          
          <code class="ruby">        optional :plagiarism_checks,        type: String,   desc: &#39;The list of checks to perform&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="97">
          <span class="hits">1</span>
          
          <code class="ruby">        optional :plagiarism_warn_pct,      type: Integer,  desc: &#39;The percent at which to record and warn about plagiarism&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="98">
          <span class="hits">1</span>
          
          <code class="ruby">        optional :is_graded,                type: Boolean,  desc: &#39;Whether or not this task definition is a graded task&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="99">
          <span class="hits">1</span>
          
          <code class="ruby">        optional :max_quality_pts,          type: Integer,  desc: &#39;A range for quality points when quality is assessed&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="102">
          <span class="hits">1</span>
          
          <code class="ruby">    put &#39;/task_definitions/:id&#39; do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="103">
          
          
          <code class="ruby">      task_def = TaskDefinition.find(params[:id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="105">
          
          
          <code class="ruby">      unless authorise? current_user, task_def.unit, :add_task_def</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="106">
          
          
          <code class="ruby">        error!({ error: &#39;Not authorised to create a task definition of this unit&#39; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="109">
          
          
          <code class="ruby">      task_params = ActionController::Parameters.new(params)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby">                                                .require(:task_def)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby">                                                .permit(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby">                                                  :unit_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby">                                                  :name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby">                                                  :description,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby">                                                  :weighting,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby">                                                  :target_grade,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby">                                                  :start_date,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby">                                                  :target_date,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby">                                                  :due_date,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby">                                                  :abbreviation,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby">                                                  :restrict_status_updates,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby">                                                  :upload_requirements,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby">                                                  :plagiarism_checks,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby">                                                  :plagiarism_warn_pct,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="125">
          
          
          <code class="ruby">                                                  :is_graded,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="126">
          
          
          <code class="ruby">                                                  :max_quality_pts</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby">                                                )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="128">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="129">
          
          
          <code class="ruby">      task_def.update!(task_params)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="130">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby">      # Link in group set if specified</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="132">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="133">
          
          
          <code class="ruby">      if params[:task_def][:group_set_id]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="134">
          
          
          <code class="ruby">        if params[:task_def][:group_set_id] &gt;= 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="135">
          
          
          <code class="ruby">          gs = GroupSet.find(params[:task_def][:group_set_id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="136">
          
          
          <code class="ruby">          if gs.unit == task_def.unit</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="137">
          
          
          <code class="ruby">            task_def.group_set = gs</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="138">
          
          
          <code class="ruby">            task_def.save</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="139">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="140">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="141">
          
          
          <code class="ruby">          task_def.group_set = nil</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="142">
          
          
          <code class="ruby">          task_def.save</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="143">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="144">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="145">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="146">
          
          
          <code class="ruby">      task_def</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="147">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="148">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="149">
          <span class="hits">1</span>
          
          <code class="ruby">    desc &#39;Upload CSV of task definitions to the provided unit&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="150">
          <span class="hits">1</span>
          
          <code class="ruby">    params do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="151">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :file, type: Rack::Multipart::UploadedFile, desc: &#39;CSV upload file.&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="152">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :unit_id, type: Integer, desc: &#39;The unit to upload tasks to&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="153">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="154">
          <span class="hits">1</span>
          
          <code class="ruby">    post &#39;/csv/task_definitions&#39; do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="155">
          
          
          <code class="ruby">      # check mime is correct before uploading</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="156">
          
          
          <code class="ruby">      ensure_csv!(params[:file][:tempfile])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="157">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="158">
          
          
          <code class="ruby">      unit = Unit.find(params[:unit_id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="159">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="160">
          
          
          <code class="ruby">      unless authorise? current_user, unit, :upload_csv</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="161">
          
          
          <code class="ruby">        error!({ error: &#39;Not authorised to upload CSV of tasks&#39; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="162">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="164">
          
          
          <code class="ruby">      # Actually import...</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="165">
          
          
          <code class="ruby">      unit.import_tasks_from_csv(params[:file][:tempfile])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="166">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="167">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="168">
          <span class="hits">1</span>
          
          <code class="ruby">    desc &#39;Download CSV of all task definitions for the given unit&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="169">
          <span class="hits">1</span>
          
          <code class="ruby">    params do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="170">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :unit_id, type: Integer, desc: &#39;The unit to download tasks from&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="171">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="172">
          <span class="hits">1</span>
          
          <code class="ruby">    get &#39;/csv/task_definitions&#39; do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="173">
          
          
          <code class="ruby">      unit = Unit.find(params[:unit_id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="174">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="175">
          
          
          <code class="ruby">      unless authorise? current_user, unit, :download_unit_csv</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="176">
          
          
          <code class="ruby">        error!({ error: &#39;Not authorised to download CSV of tasks&#39; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="177">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="178">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="179">
          
          
          <code class="ruby">      content_type &#39;application/octet-stream&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="180">
          
          
          <code class="ruby">      header[&#39;Content-Disposition&#39;] = &quot;attachment; filename=#{unit.code}-Tasks.csv &quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="181">
          
          
          <code class="ruby">      env[&#39;api.format&#39;] = :binary</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="182">
          
          
          <code class="ruby">      unit.task_definitions_csv</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="183">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="184">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="185">
          <span class="hits">1</span>
          
          <code class="ruby">    desc &#39;Delete a task definition&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="186">
          <span class="hits">1</span>
          
          <code class="ruby">    delete &#39;/task_definitions/:id&#39; do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="187">
          
          
          <code class="ruby">      task_def = TaskDefinition.find(params[:id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="188">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="189">
          
          
          <code class="ruby">      unless authorise? current_user, task_def.unit, :add_task_def</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="190">
          
          
          <code class="ruby">        error!({ error: &#39;Not authorised to delete a task definition of this unit&#39; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="191">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="192">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="193">
          
          
          <code class="ruby">      task_def.destroy</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="194">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="195">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="196">
          <span class="hits">1</span>
          
          <code class="ruby">    desc &#39;Upload the task sheet for a given task&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="197">
          <span class="hits">1</span>
          
          <code class="ruby">    params do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="198">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :unit_id, type: Integer, desc: &#39;The related unit&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="199">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :task_def_id, type: Integer, desc: &#39;The related task definition&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="200">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :file, type: Rack::Multipart::UploadedFile, desc: &#39;The task sheet pdf&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="201">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="202">
          <span class="hits">1</span>
          
          <code class="ruby">    post &#39;/units/:unit_id/task_definitions/:task_def_id/task_sheet&#39; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="203">
          <span class="hits">1</span>
          
          <code class="ruby">      unit = Unit.find(params[:unit_id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="204">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="205">
          <span class="hits">1</span>
          
          <code class="ruby">      unless authorise? current_user, unit, :add_task_def</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="206">
          
          
          <code class="ruby">        error!({ error: &#39;Not authorised to upload tasks of unit&#39; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="207">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="208">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="209">
          <span class="hits">1</span>
          
          <code class="ruby">      task_def = unit.task_definitions.find(params[:task_def_id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="210">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="211">
          <span class="hits">1</span>
          
          <code class="ruby">      file = params[:file]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="212">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="213">
          <span class="hits">1</span>
          
          <code class="ruby">      unless FileHelper.accept_file(file, &#39;task sheet&#39;, &#39;document&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="214">
          
          
          <code class="ruby">        error!({ error: &quot;&#39;#{file.name}&#39; is not a valid #{file.type} file&quot; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="215">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="216">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="217">
          
          
          <code class="ruby">      # Actually import...</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="218">
          <span class="hits">1</span>
          
          <code class="ruby">      task_def.add_task_sheet(file[:tempfile].path)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="219">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="220">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="221">
          <span class="hits">1</span>
          
          <code class="ruby">    desc &#39;Remove the task sheet for a given task&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="222">
          <span class="hits">1</span>
          
          <code class="ruby">    params do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="223">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :unit_id, type: Integer, desc: &#39;The related unit&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="224">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :task_def_id, type: Integer, desc: &#39;The related task definition&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="225">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="226">
          <span class="hits">1</span>
          
          <code class="ruby">    delete &#39;/units/:unit_id/task_definitions/:task_def_id/task_sheet&#39; do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="227">
          
          
          <code class="ruby">      unit = Unit.find(params[:unit_id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="228">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="229">
          
          
          <code class="ruby">      unless authorise? current_user, unit, :add_task_def</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="230">
          
          
          <code class="ruby">        error!({ error: &#39;Not authorised to remove task sheets of unit&#39; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="231">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="232">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="233">
          
          
          <code class="ruby">      task_def = unit.task_definitions.find(params[:task_def_id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="234">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="235">
          
          
          <code class="ruby">      # Actually delete...</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="236">
          
          
          <code class="ruby">      task_def.remove_task_sheet()</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="237">
          
          
          <code class="ruby">      task_def</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="238">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="239">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="240">
          <span class="hits">1</span>
          
          <code class="ruby">    desc &#39;Upload the task resources for a given task&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="241">
          <span class="hits">1</span>
          
          <code class="ruby">    params do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="242">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :unit_id, type: Integer, desc: &#39;The related unit&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="243">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :task_def_id, type: Integer, desc: &#39;The related task definition&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="244">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :file, type: Rack::Multipart::UploadedFile, desc: &#39;The task resources zip&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="245">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="246">
          <span class="hits">1</span>
          
          <code class="ruby">    post &#39;/units/:unit_id/task_definitions/:task_def_id/task_resources&#39; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="247">
          <span class="hits">1</span>
          
          <code class="ruby">      unit = Unit.find(params[:unit_id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="248">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="249">
          <span class="hits">1</span>
          
          <code class="ruby">      unless authorise? current_user, unit, :add_task_def</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="250">
          
          
          <code class="ruby">        error!({ error: &#39;Not authorised to upload tasks of unit&#39; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="251">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="252">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="253">
          <span class="hits">1</span>
          
          <code class="ruby">      task_def = unit.task_definitions.find(params[:task_def_id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="254">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="255">
          <span class="hits">1</span>
          
          <code class="ruby">      file_path = params[:file][:tempfile].path</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="256">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="257">
          <span class="hits">1</span>
          
          <code class="ruby">      check_mime_against_list! file_path, &#39;zip&#39;, [&#39;application/zip&#39;, &#39;multipart/x-gzip&#39;, &#39;multipart/x-zip&#39;, &#39;application/x-gzip&#39;, &#39;application/octet-stream&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="258">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="259">
          
          
          <code class="ruby">      # Actually import...</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="260">
          <span class="hits">1</span>
          
          <code class="ruby">      task_def.add_task_resources(file_path)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="261">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="262">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="263">
          <span class="hits">1</span>
          
          <code class="ruby">    desc &#39;Remove the task resources for a given task&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="264">
          <span class="hits">1</span>
          
          <code class="ruby">    params do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="265">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :unit_id, type: Integer, desc: &#39;The related unit&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="266">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :task_def_id, type: Integer, desc: &#39;The related task definition&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="267">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="268">
          <span class="hits">1</span>
          
          <code class="ruby">    delete &#39;/units/:unit_id/task_definitions/:task_def_id/task_resources&#39; do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="269">
          
          
          <code class="ruby">      unit = Unit.find(params[:unit_id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="270">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="271">
          
          
          <code class="ruby">      unless authorise? current_user, unit, :add_task_def</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="272">
          
          
          <code class="ruby">        error!({ error: &#39;Not authorised to remove task resources of unit&#39; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="273">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="274">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="275">
          
          
          <code class="ruby">      task_def = unit.task_definitions.find(params[:task_def_id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="276">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="277">
          
          
          <code class="ruby">      # Actually remove...</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="278">
          
          
          <code class="ruby">      task_def.remove_task_resources</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="279">
          
          
          <code class="ruby">      task_def</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="280">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="281">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="282">
          <span class="hits">1</span>
          
          <code class="ruby">    desc &#39;Upload a zip file containing the task pdfs for a given task&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="283">
          <span class="hits">1</span>
          
          <code class="ruby">    params do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="284">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :unit_id, type: Integer, desc: &#39;The unit to upload tasks for&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="285">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :file, type: Rack::Multipart::UploadedFile, desc: &#39;batch file upload&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="286">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="287">
          <span class="hits">1</span>
          
          <code class="ruby">    post &#39;/units/:unit_id/task_definitions/task_pdfs&#39; do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="288">
          
          
          <code class="ruby">      unit = Unit.find(params[:unit_id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="289">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="290">
          
          
          <code class="ruby">      unless authorise? current_user, unit, :add_task_def</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="291">
          
          
          <code class="ruby">        error!({ error: &#39;Not authorised to upload tasks of unit&#39; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="292">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="293">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="294">
          
          
          <code class="ruby">      file = params[:file][:tempfile].path</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="295">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="296">
          
          
          <code class="ruby">      check_mime_against_list! file, &#39;zip&#39;, [&#39;application/zip&#39;, &#39;multipart/x-gzip&#39;, &#39;multipart/x-zip&#39;, &#39;application/x-gzip&#39;, &#39;application/octet-stream&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="297">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="298">
          
          
          <code class="ruby">      # Actually import...</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="299">
          
          
          <code class="ruby">      unit.import_task_files_from_zip file</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="300">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="301">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="302">
          <span class="hits">1</span>
          
          <code class="ruby">    desc &#39;Download the tasks related to a task definition&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="303">
          <span class="hits">1</span>
          
          <code class="ruby">    params do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="304">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :unit_id, type: Integer, desc: &#39;The unit containing the task definition&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="305">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :task_def_id, type: Integer, desc: &quot;The task definition&#39;s id&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="306">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="307">
          <span class="hits">1</span>
          
          <code class="ruby">    get &#39;/units/:unit_id/task_definitions/:task_def_id/tasks&#39; do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="308">
          
          
          <code class="ruby">      unit = Unit.find(params[:unit_id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="309">
          
          
          <code class="ruby">      unless authorise? current_user, unit, :provide_feedback</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="310">
          
          
          <code class="ruby">        error!({ error: &#39;Not authorised to access tasks for this unit&#39; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="311">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="312">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="313">
          
          
          <code class="ruby">      unit.student_tasks</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="314">
          
          
          <code class="ruby">          .joins(:project)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="315">
          
          
          <code class="ruby">          .joins(:task_status)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="316">
          
          
          <code class="ruby">          .select(&#39;projects.tutorial_id as tutorial_id&#39;, &#39;project_id&#39;, &#39;tasks.id as id&#39;, &#39;task_definition_id&#39;, &#39;task_statuses.id as status_id&#39;, &#39;completion_date&#39;, &#39;times_assessed&#39;, &#39;submission_date&#39;, &#39;grade&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="317">
          
          
          <code class="ruby">          .where(&#39;task_definition_id = :id&#39;, id: params[:task_def_id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="318">
          
          
          <code class="ruby">          .map do |t|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="319">
          
          
          <code class="ruby">        {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="320">
          
          
          <code class="ruby">          project_id: t.project_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="321">
          
          
          <code class="ruby">          id: t.id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="322">
          
          
          <code class="ruby">          task_definition_id: t.task_definition_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="323">
          
          
          <code class="ruby">          tutorial_id: t.tutorial_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="324">
          
          
          <code class="ruby">          status: TaskStatus.find(t.status_id).status_key,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="325">
          
          
          <code class="ruby">          completion_date: t.completion_date,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="326">
          
          
          <code class="ruby">          submission_date: t.submission_date,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="327">
          
          
          <code class="ruby">          times_assessed: t.times_assessed,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="328">
          
          
          <code class="ruby">          similar_to_count: t.similar_to_count,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="329">
          
          
          <code class="ruby">          grade: t.grade</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="330">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="331">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="332">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="333">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="334">
          <span class="hits">1</span>
          
          <code class="ruby">    desc &#39;Download the task sheet containing the details related to performing that task&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="335">
          <span class="hits">1</span>
          
          <code class="ruby">    params do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="336">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :unit_id, type: Integer, desc: &#39;The unit to upload tasks for&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="337">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :task_def_id, type: Integer, desc: &#39;The task definition to get the pdf of&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="338">
          <span class="hits">1</span>
          
          <code class="ruby">      optional :as_attachment, type: Boolean, desc: &#39;Whether or not to download file as attachment. Default is false.&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="339">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="340">
          <span class="hits">1</span>
          
          <code class="ruby">    get &#39;/units/:unit_id/task_definitions/:task_def_id/task_pdf&#39; do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="341">
          
          
          <code class="ruby">      unit = Unit.find(params[:unit_id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="342">
          
          
          <code class="ruby">      task_def = unit.task_definitions.find(params[:task_def_id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="343">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="344">
          
          
          <code class="ruby">      unless authorise? current_user, unit, :get_unit</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="345">
          
          
          <code class="ruby">        error!({ error: &#39;Not authorised to download task details of unit&#39; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="346">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="347">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="348">
          
          
          <code class="ruby">      if task_def.has_task_sheet?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="349">
          
          
          <code class="ruby">        path = task_def.task_sheet</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="350">
          
          
          <code class="ruby">        filename = &quot;#{task_def.unit.code}-#{task_def.abbreviation}.pdf&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="351">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="352">
          
          
          <code class="ruby">        path = Rails.root.join(&#39;public&#39;, &#39;resources&#39;, &#39;FileNotFound.pdf&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="353">
          
          
          <code class="ruby">        filename = &quot;FileNotFound.pdf&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="354">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="355">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="356">
          
          
          <code class="ruby">      if params[:as_attachment]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="357">
          
          
          <code class="ruby">        header[&#39;Content-Disposition&#39;] = &quot;attachment; filename=#{filename}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="358">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="359">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="360">
          
          
          <code class="ruby">      content_type &#39;application/pdf&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="361">
          
          
          <code class="ruby">      env[&#39;api.format&#39;] = :binary</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="362">
          
          
          <code class="ruby">      File.read(path)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="363">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="364">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="365">
          <span class="hits">1</span>
          
          <code class="ruby">    desc &#39;Download the task resources&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="366">
          <span class="hits">1</span>
          
          <code class="ruby">    params do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="367">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :unit_id, type: Integer, desc: &#39;The unit to upload tasks for&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="368">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :task_def_id, type: Integer, desc: &#39;The task definition to get the pdf of&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="369">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="370">
          <span class="hits">1</span>
          
          <code class="ruby">    get &#39;/units/:unit_id/task_definitions/:task_def_id/task_resources&#39; do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="371">
          
          
          <code class="ruby">      unit = Unit.find(params[:unit_id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="372">
          
          
          <code class="ruby">      task_def = unit.task_definitions.find(params[:task_def_id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="373">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="374">
          
          
          <code class="ruby">      unless authorise? current_user, unit, :get_unit</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="375">
          
          
          <code class="ruby">        error!({ error: &#39;Not authorised to download task details of unit&#39; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="376">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="377">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="378">
          
          
          <code class="ruby">      if task_def.has_task_resources?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="379">
          
          
          <code class="ruby">        path = task_def.task_resources</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="380">
          
          
          <code class="ruby">        content_type &#39;application/octet-stream&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="381">
          
          
          <code class="ruby">        header[&#39;Content-Disposition&#39;] = &quot;attachment; filename=#{task_def.abbreviation}-resources.zip&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="382">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="383">
          
          
          <code class="ruby">        path = Rails.root.join(&#39;public&#39;, &#39;resources&#39;, &#39;FileNotFound.pdf&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="384">
          
          
          <code class="ruby">        content_type &#39;application/pdf&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="385">
          
          
          <code class="ruby">        header[&#39;Content-Disposition&#39;] = &#39;attachment; filename=FileNotFound.pdf&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="386">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="387">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="388">
          
          
          <code class="ruby">      env[&#39;api.format&#39;] = :binary</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="389">
          
          
          <code class="ruby">      File.read(path)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="390">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="391">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="392">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="0b1ba3b571be18824c569cdec104abda810aabff">
  <div class="header">
    <h3>app/api/tasks.rb</h3>
    <h4><span class="red">28.47 %</span> covered</h4>
    <div>
      <b>144</b> relevant lines. 
      <span class="green"><b>41</b> lines covered</span> and
      <span class="red"><b>103</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;grape&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;task_serializer&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">module Api</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  class Tasks &lt; Grape::API</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">    helpers AuthenticationHelpers</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">    helpers AuthorisationHelpers</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">    before do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">      authenticated?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">    # Tasks only used for the task summary stats view...</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">    desc &quot;Get all the current user&#39;s tasks&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">    params do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :unit_id, type: Integer, desc: &#39;Unit to fetch the task details for&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">    get &#39;/tasks&#39; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">      unit = Unit.find(params[:unit_id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">      unless authorise? current_user, unit, :get_students</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">        error!({ error: &#39;You do not have permission to read these task details&#39; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">      unit.student_tasks</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">          .joins(:task_status)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">          .select(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">            &#39;tasks.id&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">            &#39;projects.tutorial_id as tutorial_id&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">            &#39;task_statuses.id as status_id&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">            &#39;task_definition_id&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">          )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">          .where(&#39;tasks.task_status_id &gt; 1 and projects.tutorial_id is not null&#39;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="36">
          <span class="hits">1</span>
          
          <code class="ruby">          .map do |r|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">            {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">              id: r.id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">              tutorial_id: r.tutorial_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">              task_definition_id: r.task_definition_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">              status: TaskStatus.find(r.status_id).status_key</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">            }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="46">
          <span class="hits">1</span>
          
          <code class="ruby">    desc &#39;Get a similarity match for a given task&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="47">
          <span class="hits">1</span>
          
          <code class="ruby">    get &#39;/tasks/:id/similarity/:count&#39; do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">      unless authenticated?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="49">
          
          
          <code class="ruby">        error!({ error: &quot;Not authorised to download details for task &#39;#{params[:id]}&#39;&quot; }, 401)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">      task = Task.find(params[:id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">      unless authorise? current_user, task, :get_submission</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby">        error!({ error: &quot;Not authorised to download details for task &#39;#{params[:id]}&#39;&quot; }, 401)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="57">
          
          
          <code class="ruby">      match = params[:count].to_i % task.similar_to_count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="58">
          
          
          <code class="ruby">      if match &lt; 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="59">
          
          
          <code class="ruby">        error!({ error: &#39;Invalid match sequence, must be 0 or larger&#39; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="62">
          
          
          <code class="ruby">      match_link = task.plagiarism_match_links.order(&#39;created_at DESC&#39;)[match]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="63">
          
          
          <code class="ruby">      return if match_link.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="65">
          
          
          <code class="ruby">      logger.debug &quot;Plagiarism match link 1: #{match_link}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="66">
          
          
          <code class="ruby">      other_match_link = match_link.other_party</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="67">
          
          
          <code class="ruby">      logger.debug &quot;Plagiarism match link 2: #{other_match_link}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="68">
          
          
          <code class="ruby">      output = FileHelper.path_to_plagarism_html(match_link)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="70">
          
          
          <code class="ruby">      if output.nil? || !File.exist?(output)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="71">
          
          
          <code class="ruby">        error!({ error: &#39;No files to download&#39; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="74">
          
          
          <code class="ruby">      if authorise? current_user, match_link.task, :view_plagiarism</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="75">
          
          
          <code class="ruby">        student_url = match_link.plagiarism_report_url</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="78">
          
          
          <code class="ruby">      student_hash = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">        username: match_link.student.username,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">        email: match_link.student.email,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby">        name: match_link.student.name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">        tutor: match_link.tutor.name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby">        tutorial: match_link.tutorial,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">        html: File.read(output),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">        url: student_url,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby">        pct: match_link.pct,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby">        dismissed: match_link.dismissed</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="89">
          
          
          <code class="ruby">      other_student_hash = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby">        username: nil,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby">        email: nil,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby">        name: nil,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby">        tutor: match_link.other_tutor.name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby">        tutorial: match_link.other_tutorial,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby">        html: nil,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby">        url: nil,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby">        pct: other_match_link.pct,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby">        dismissed: other_match_link.dismissed</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby">      # Check if returning both parties</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="102">
          
          
          <code class="ruby">      authorised_to_view_both = authorise? current_user, other_match_link.task, :get_submission</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="103">
          
          
          <code class="ruby">      if authorised_to_view_both</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="104">
          
          
          <code class="ruby">        other_output = FileHelper.path_to_plagarism_html(other_match_link)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="105">
          
          
          <code class="ruby">        if authorise? current_user, other_match_link.task, :view_plagiarism</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="106">
          
          
          <code class="ruby">          other_student_url = other_match_link.plagiarism_report_url</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby">        # Update other_student_hash to include details</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="109">
          
          
          <code class="ruby">        other_student_hash[:username]  = match_link.other_student.username</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="110">
          
          
          <code class="ruby">        other_student_hash[:email]     = match_link.other_student.email</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="111">
          
          
          <code class="ruby">        other_student_hash[:name]      = match_link.other_student.name</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="112">
          
          
          <code class="ruby">        other_student_hash[:tutor]     = match_link.other_tutor.name</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="113">
          
          
          <code class="ruby">        other_student_hash[:tutorial]  = match_link.other_tutorial</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="114">
          
          
          <code class="ruby">        other_student_hash[:html]      = File.read(other_output)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="115">
          
          
          <code class="ruby">        other_student_hash[:url]       = other_student_url</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="116">
          
          
          <code class="ruby">        other_student_hash[:pct]       = other_match_link.pct</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="117">
          
          
          <code class="ruby">        other_student_hash[:dismissed] = other_match_link.dismissed</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby">      {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby">        student: student_hash,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby">        other_student: other_student_hash</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="122">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="125">
          <span class="hits">1</span>
          
          <code class="ruby">    desc &#39;Dismiss a similarity match for a given task&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="126">
          <span class="hits">1</span>
          
          <code class="ruby">    params do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="127">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :dismissed, type: Boolean, desc: &#39;Should this similarity be dismissed?&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="128">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :other, type: Boolean, desc: &#39;This tasks match or its reverse?&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="129">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="130">
          <span class="hits">1</span>
          
          <code class="ruby">    put &#39;/tasks/:id/similarity/:count&#39; do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="131">
          
          
          <code class="ruby">      unless authenticated?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="132">
          
          
          <code class="ruby">        error!({ error: &quot;Not authorised to access this task &#39;#{params[:id]}&#39;&quot; }, 401)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="133">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="134">
          
          
          <code class="ruby">      task = Task.find(params[:id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="135">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="136">
          
          
          <code class="ruby">      unless authorise? current_user, task, :delete_plagiarism</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="137">
          
          
          <code class="ruby">        error!({ error: &quot;Not authorised to remove similarity for task &#39;#{params[:id]}&#39;&quot; }, 401)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="138">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="139">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="140">
          
          
          <code class="ruby">      match = params[:count].to_i % task.similar_to_count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="141">
          
          
          <code class="ruby">      if match &lt; 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="142">
          
          
          <code class="ruby">        error!({ error: &#39;Invalid match sequence, must be 0 or larger&#39; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="143">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="144">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="145">
          
          
          <code class="ruby">      match_link = task.plagiarism_match_links.order(&#39;created_at DESC&#39;)[match]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="146">
          
          
          <code class="ruby">      return if match_link.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="147">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="148">
          
          
          <code class="ruby">      match_link = match_link.other_party if params[:other]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="149">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="150">
          
          
          <code class="ruby">      logger.info &quot;#{current_user.username} changing plagiarism: setting dismissed for #{task.task_definition.abbreviation} by #{task.student.username} to #{params[:dismissed]}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="151">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="152">
          
          
          <code class="ruby">      logger.debug &quot;    plagiarism match link 1: #{match_link}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="153">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="154">
          
          
          <code class="ruby">      match_link.dismissed = params[:dismissed]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="155">
          
          
          <code class="ruby">      match_link.save!</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="156">
          
          
          <code class="ruby">      match_link.dismissed</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="157">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="158">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="159">
          <span class="hits">1</span>
          
          <code class="ruby">    desc &#39;Update a task using its related project and task definition&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="160">
          <span class="hits">1</span>
          
          <code class="ruby">    params do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="161">
          
          
          <code class="ruby">      # requires :id, type: Integer, desc: &#39;The project id to locate&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="162">
          
          
          <code class="ruby">      # requires :task_definition_id, type: Integer, desc: &#39;The id of the task definition of the task to update in this project&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="163">
          <span class="hits">1</span>
          
          <code class="ruby">      optional :trigger, type: String, desc: &#39;New status&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="164">
          <span class="hits">1</span>
          
          <code class="ruby">      optional :include_in_portfolio, type: Boolean, desc: &#39;Indicate if this task should be in the portfolio&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="165">
          <span class="hits">1</span>
          
          <code class="ruby">      optional :grade, type: Integer, desc: &#39;Grade value if task is a graded task (required if task definition is a graded task)&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="166">
          <span class="hits">1</span>
          
          <code class="ruby">      optional :quality_pts, type: Integer, desc: &#39;Quality points value if task has quality assessment&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="167">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="168">
          <span class="hits">1</span>
          
          <code class="ruby">    put &#39;/projects/:id/task_def_id/:task_definition_id&#39; do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="169">
          
          
          <code class="ruby">      project = Project.find(params[:id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="170">
          
          
          <code class="ruby">      grade = params[:grade]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="171">
          
          
          <code class="ruby">      task_definition = project.unit.task_definitions.find(params[:task_definition_id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="172">
          
          
          <code class="ruby">      needs_upload_docs = !task_definition.upload_requirements.empty?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="173">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="174">
          
          
          <code class="ruby">      # check the user can put this task</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="175">
          
          
          <code class="ruby">      if authorise? current_user, project, :make_submission</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="176">
          
          
          <code class="ruby">        task = project.task_for_task_definition(task_definition)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="177">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="178">
          
          
          <code class="ruby">        # if trigger supplied...</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="179">
          
          
          <code class="ruby">        unless params[:trigger].nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="180">
          
          
          <code class="ruby">          # Check if they should be using portfolio_evidence api</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="181">
          
          
          <code class="ruby">          if needs_upload_docs &amp;&amp; params[:trigger] == &#39;ready_to_mark&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="182">
          
          
          <code class="ruby">            error!({ error: &#39;Cannot set this task status to ready to mark without uploading documents.&#39; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="183">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="184">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="185">
          
          
          <code class="ruby">          if task.group_task? &amp;&amp; !task.group</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="186">
          
          
          <code class="ruby">            error!({ error: &quot;This task requires a group. Ensure you are in a group for the unit&#39;s #{task.task_definition.group_set.name}&quot; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="187">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="188">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="189">
          
          
          <code class="ruby">          logger.info &quot;#{current_user.username} assessing task #{task.id} to #{params[:trigger]}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="190">
          
          
          <code class="ruby">          result = task.trigger_transition(trigger: params[:trigger], by_user: current_user, quality: params[:quality_pts])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="191">
          
          
          <code class="ruby">          if result.nil? &amp;&amp; task.task_definition.restrict_status_updates</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="192">
          
          
          <code class="ruby">            error!({ error: &#39;This task can only be updated by your tutor.&#39; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="193">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="194">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="195">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="196">
          
          
          <code class="ruby">        # if grade was supplied</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="197">
          
          
          <code class="ruby">        unless grade.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="198">
          
          
          <code class="ruby">          # try to grade the task</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="199">
          
          
          <code class="ruby">          task.grade_task grade, self</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="200">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="201">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="202">
          
          
          <code class="ruby">        # if include in portfolio supplied</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="203">
          
          
          <code class="ruby">        unless params[:include_in_portfolio].nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="204">
          
          
          <code class="ruby">          task.include_in_portfolio = params[:include_in_portfolio]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="205">
          
          
          <code class="ruby">          task.save</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="206">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="207">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="208">
          
          
          <code class="ruby">        TaskUpdateSerializer.new(task)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="209">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="210">
          
          
          <code class="ruby">        error!({ error: &quot;Couldn&#39;t find Task with id=#{params[:id]}&quot; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="211">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="212">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="213">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="214">
          <span class="hits">1</span>
          
          <code class="ruby">    desc &#39;Request an extension - adds a week to the due date if extensions are available for the task&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="215">
          <span class="hits">1</span>
          
          <code class="ruby">    post &#39;/projects/:id/task_def_id/:task_definition_id/extension&#39; do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="216">
          
          
          <code class="ruby">      project = Project.find(params[:id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="217">
          
          
          <code class="ruby">      task_definition = project.unit.task_definitions.find(params[:task_definition_id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="218">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="219">
          
          
          <code class="ruby">      # check the user can put this task</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="220">
          
          
          <code class="ruby">      if authorise? current_user, project, :apply_extension</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="221">
          
          
          <code class="ruby">        task = project.task_for_task_definition(task_definition)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="222">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="223">
          
          
          <code class="ruby">        task.apply_for_extension</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="224">
          
          
          <code class="ruby">        task.save!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="225">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="226">
          
          
          <code class="ruby">        TaskUpdateSerializer.new(task)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="227">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="228">
          
          
          <code class="ruby">        error!({ error: &quot;You do not have permission to apply for an extension for this task.&quot; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="229">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="230">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="231">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="232">
          <span class="hits">1</span>
          
          <code class="ruby">    desc &#39;Get the submission details of a task, indicating if it has a pdf to view&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="233">
          <span class="hits">1</span>
          
          <code class="ruby">    params do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="234">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :id, type: Integer, desc: &#39;The project id to locate&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="235">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :task_definition_id, type: Integer, desc: &#39;The id of the task definition of the task to update in this project&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="236">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="237">
          <span class="hits">1</span>
          
          <code class="ruby">    get &#39;/projects/:id/task_def_id/:task_definition_id/submission_details&#39; do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="238">
          
          
          <code class="ruby">      # Get the project and task_definition based on uploaded details.</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="239">
          
          
          <code class="ruby">      project = Project.find(params[:id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="240">
          
          
          <code class="ruby">      task_definition = project.unit.task_definitions.find(params[:task_definition_id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="241">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="242">
          
          
          <code class="ruby">      # check the user can put this task</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="243">
          
          
          <code class="ruby">      error!(error: &#39;You do not have permission to read submissions for this project.&#39;) unless authorise? current_user, project, :get_submission</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="244">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="245">
          
          
          <code class="ruby">      # ensure there can be a pdf...</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="246">
          
          
          <code class="ruby">      needs_upload_docs = !task_definition.upload_requirements.empty?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="247">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="248">
          
          
          <code class="ruby">      # check if we actually have this task... if not must be false.</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="249">
          
          
          <code class="ruby">      if needs_upload_docs &amp;&amp; project.has_task_for_task_definition?(task_definition)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="250">
          
          
          <code class="ruby">        task = project.task_for_task_definition(task_definition)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="251">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="252">
          
          
          <code class="ruby">        # return the details as json</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="253">
          
          
          <code class="ruby">        {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="254">
          
          
          <code class="ruby">          has_pdf: task.has_pdf,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="255">
          
          
          <code class="ruby">          submission_date: task.submission_date,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="256">
          
          
          <code class="ruby">          processing_pdf: task.processing_pdf?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="257">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="258">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="259">
          
          
          <code class="ruby">        {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="260">
          
          
          <code class="ruby">          has_pdf: false,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="261">
          
          
          <code class="ruby">          processing_pdf: false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="262">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="263">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="264">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="265">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="266">
          <span class="hits">1</span>
          
          <code class="ruby">    desc &#39;Get the files associated with a submission&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="267">
          <span class="hits">1</span>
          
          <code class="ruby">    params do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="268">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :id, type: Integer, desc: &#39;The project id to locate&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="269">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :task_definition_id, type: Integer, desc: &#39;The id of the task definition of the task to get the files from&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="270">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="271">
          <span class="hits">1</span>
          
          <code class="ruby">    get &#39;/projects/:id/task_def_id/:task_definition_id/submission_files&#39; do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="272">
          
          
          <code class="ruby">      # Get the project and task_definition based on uploaded details.</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="273">
          
          
          <code class="ruby">      project = Project.find(params[:id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="274">
          
          
          <code class="ruby">      task_definition = project.unit.task_definitions.find(params[:task_definition_id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="275">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="276">
          
          
          <code class="ruby">      # check the user can put this task</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="277">
          
          
          <code class="ruby">      error!(error: &#39;You do not have permission to read submissions for this project.&#39;) unless authorise? current_user, project, :get_submission</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="278">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="279">
          
          
          <code class="ruby">      # Get the actual task...</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="280">
          
          
          <code class="ruby">      task = project.task_for_task_definition(task_definition)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="281">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="282">
          
          
          <code class="ruby">      # Find the file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="283">
          
          
          <code class="ruby">      file_loc = FileHelper.zip_file_path_for_done_task(task)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="284">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="285">
          
          
          <code class="ruby">      if file_loc.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="286">
          
          
          <code class="ruby">        file_loc = Rails.root.join(&#39;public&#39;, &#39;resources&#39;, &#39;FileNotFound.pdf&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="287">
          
          
          <code class="ruby">        header[&#39;Content-Disposition&#39;] = &#39;attachment; filename=FileNotFound.pdf&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="288">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="289">
          
          
          <code class="ruby">        header[&#39;Content-Disposition&#39;] = &quot;attachment; filename=#{project.student.username}-#{task.task_definition.abbreviation}.zip&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="290">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="291">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="292">
          
          
          <code class="ruby">      # Set download headers...</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="293">
          
          
          <code class="ruby">      content_type &#39;application/octet-stream&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="294">
          
          
          <code class="ruby">      env[&#39;api.format&#39;] = :binary</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="295">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="296">
          
          
          <code class="ruby">      # Return the file data</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="297">
          
          
          <code class="ruby">      File.read(file_loc)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="298">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="299">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="300">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="0d1033d37baa6d3158f62d6dd254a737e7f237af">
  <div class="header">
    <h3>app/api/tutorials.rb</h3>
    <h4><span class="red">77.36 %</span> covered</h4>
    <div>
      <b>53</b> relevant lines. 
      <span class="green"><b>41</b> lines covered</span> and
      <span class="red"><b>12</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;grape&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">module Api</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  class Tutorials &lt; Grape::API</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">    helpers AuthenticationHelpers</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">    helpers AuthorisationHelpers</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">    before do</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="9">
          <span class="hits">3</span>
          
          <code class="ruby">      authenticated?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">    desc &#39;Update a tutorial&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">    params do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :id, type: Integer, desc: &#39;The user id to update&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :tutorial, type: Hash do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">        optional :abbreviation, type: String, desc: &#39;The tutorials code&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">        optional :meeting_location, type: String,   desc: &#39;The tutorials location&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">        optional :meeting_day, type: String, desc: &#39;Day of the tutorial&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">        optional :tutor_id, type: Integer, desc: &#39;Id of the tutor&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">        optional :meeting_time, type: String, desc: &#39;Time of the tutorial&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">    put &#39;/tutorials/:id&#39; do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">      tutorial = Tutorial.find(params[:id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">      tut_params = params[:tutorial]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">      # can only modify if current_user.id is same as :id provided</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">      # (i.e., user wants to update their own data) or if update_user token</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">      unless authorise? current_user, tutorial.unit, :add_tutorial</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">        error!({ error: &quot;Cannot update tutorial with id=#{params[:id]} - not authorised&quot; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">      tutorial_parameters = ActionController::Parameters.new(params)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">                                                        .require(:tutorial)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">                                                        .permit(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">                                                          :abbreviation,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">                                                          :meeting_location,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">                                                          :meeting_day,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">                                                          :meeting_time</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">                                                        )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">      if tut_params[:tutor_id]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">        tutor = User.find(tut_params[:tutor_id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">        tutorial.assign_tutor(tutor)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">      tutorial.update!(tutorial_parameters)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">      tutorial</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="50">
          <span class="hits">1</span>
          
          <code class="ruby">    desc &#39;Create tutorial&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="51">
          <span class="hits">1</span>
          
          <code class="ruby">    params do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="52">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :tutorial, type: Hash do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="53">
          <span class="hits">1</span>
          
          <code class="ruby">        requires :unit_id, type: Integer, desc: &#39;Id of the unit&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="54">
          <span class="hits">1</span>
          
          <code class="ruby">        requires :tutor_id, type: Integer, desc: &#39;Id of the tutor&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="55">
          <span class="hits">1</span>
          
          <code class="ruby">        requires :abbreviation, type: String, desc: &#39;The tutorials code&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="56">
          <span class="hits">1</span>
          
          <code class="ruby">        requires :meeting_location, type: String, desc: &#39;The tutorials location&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="57">
          <span class="hits">1</span>
          
          <code class="ruby">        requires :meeting_day, type: String, desc: &#39;Day of the tutorial&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="58">
          <span class="hits">1</span>
          
          <code class="ruby">        requires :meeting_time, type: String, desc: &#39;Time of the tutorial&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="61">
          <span class="hits">1</span>
          
          <code class="ruby">    post &#39;/tutorials&#39; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="62">
          <span class="hits">1</span>
          
          <code class="ruby">      tut_params = params[:tutorial]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="63">
          <span class="hits">1</span>
          
          <code class="ruby">      unit = Unit.find(tut_params[:unit_id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="65">
          <span class="hits">1</span>
          
          <code class="ruby">      unless authorise? current_user, unit, :add_tutorial</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="66">
          
          
          <code class="ruby">        error!({ error: &#39;Not authorised to create new tutorials&#39; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="69">
          <span class="hits">1</span>
          
          <code class="ruby">      tutor = User.find(tut_params[:tutor_id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="71">
          <span class="hits">1</span>
          
          <code class="ruby">      tutorial = unit.add_tutorial(tut_params[:meeting_day], tut_params[:meeting_time], tut_params[:meeting_location], tutor, tut_params[:abbreviation])</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="72">
          <span class="hits">1</span>
          
          <code class="ruby">      tutorial</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="75">
          <span class="hits">1</span>
          
          <code class="ruby">    desc &#39;Delete a tutorial&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="76">
          <span class="hits">1</span>
          
          <code class="ruby">    params do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="77">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :id, type: Integer, desc: &#39;The tutorial id to delete&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="79">
          <span class="hits">1</span>
          
          <code class="ruby">    delete &#39;/tutorials/:id&#39; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="80">
          <span class="hits">1</span>
          
          <code class="ruby">      tutorial = Tutorial.find(params[:id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="82">
          <span class="hits">1</span>
          
          <code class="ruby">      unless authorise? current_user, tutorial.unit, :add_tutorial</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="83">
          
          
          <code class="ruby">        error!({ error: &#39;Cannot delete tutorial - not authorised&#39; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="86">
          <span class="hits">1</span>
          
          <code class="ruby">      tutorial.destroy!</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="87">
          <span class="hits">1</span>
          
          <code class="ruby">      tutorial</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="4f47df35634135180eae3a31364b5be64589c69d">
  <div class="header">
    <h3>app/api/unit_roles.rb</h3>
    <h4><span class="red">59.65 %</span> covered</h4>
    <div>
      <b>57</b> relevant lines. 
      <span class="green"><b>34</b> lines covered</span> and
      <span class="red"><b>23</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;grape&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">module Api</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  class UnitRoles &lt; Grape::API</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">    helpers AuthenticationHelpers</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">    helpers AuthorisationHelpers</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">    before do</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="9">
          <span class="hits">3</span>
          
          <code class="ruby">      authenticated?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">    desc &#39;Get unit roles for authenticated user&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">    params do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">      optional :unit_id, type: Integer, desc: &#39;Get user roles in indicated unit&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">    get &#39;/unit_roles&#39; do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">      return [] unless authorise? current_user, User, :act_tutor</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">      unit_roles = UnitRole.for_user current_user</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">      if params[:unit_id]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">        unit_roles = unit_roles.where(unit_id: params[:unit_id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">      ActiveModel::ArraySerializer.new(unit_roles.joins(:unit).select(&#39;unit_roles.*&#39;, &#39;units.start_date&#39;), each_serializer: UnitRoleSerializer)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">    desc &#39;Delete a unit role&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">    delete &#39;/unit_roles/:id&#39; do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">      unit_role = UnitRole.find(params[:id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">      unless (authorise? current_user, unit_role.unit, :employ_staff) || (authorise? current_user, User, :admin_units)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">        error!({ error: &quot;Couldn&#39;t find UnitRole with id=#{params[:id]}&quot; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">      unit_role.destroy</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="39">
          <span class="hits">1</span>
          
          <code class="ruby">    desc &quot;Get a unit_role&#39;s details&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="40">
          <span class="hits">1</span>
          
          <code class="ruby">    get &#39;/unit_roles/:id&#39; do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">      unit_role = UnitRole.find(params[:id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">      unless authorise? current_user, unit_role, :get</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">        error!({ error: &quot;Couldn&#39;t find UnitRole with id=#{params[:id]}&quot; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">      unit_role</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="50">
          <span class="hits">1</span>
          
          <code class="ruby">    desc &#39;Employ a user as a teaching role in a unit&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="51">
          <span class="hits">1</span>
          
          <code class="ruby">    params do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="52">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :unit_id, type: Integer, desc: &#39;The id of the unit to employ the staff for&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="53">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :user_id, type: Integer, desc: &#39;The id of the tutor&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="54">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :role, type: String, desc: &#39;The role for the staff member&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="56">
          <span class="hits">1</span>
          
          <code class="ruby">    post &#39;/unit_roles&#39; do</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="57">
          <span class="hits">2</span>
          
          <code class="ruby">      unit = Unit.find(params[:unit_id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="59">
          <span class="hits">2</span>
          
          <code class="ruby">      unless (authorise? current_user, unit, :employ_staff) || (authorise? current_user, User, :admin_units)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="60">
          
          
          <code class="ruby">        error!({ error: &quot;Couldn&#39;t find Unit with id=#{params[:id]}&quot; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="62">
          <span class="hits">2</span>
          
          <code class="ruby">      user = User.find(params[:user_id])</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="63">
          <span class="hits">2</span>
          
          <code class="ruby">      role = Role.with_name(params[:role])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="65">
          <span class="hits">2</span>
          
          <code class="ruby">      if role.nil?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="66">
          <span class="hits">1</span>
          
          <code class="ruby">        error!({ error: &quot;Couldn&#39;t find Role with name=#{params[:role]}&quot; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="69">
          <span class="hits">1</span>
          
          <code class="ruby">      if role == Role.student</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="70">
          
          
          <code class="ruby">        error!({ error: &#39;Enrol students as projects not unit roles&#39; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="73">
          <span class="hits">1</span>
          
          <code class="ruby">      unit.employ_staff(user, role)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="76">
          <span class="hits">1</span>
          
          <code class="ruby">    desc &#39;Update a role &#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="77">
          <span class="hits">1</span>
          
          <code class="ruby">    params do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="78">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :unit_role, type: Hash do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="79">
          <span class="hits">1</span>
          
          <code class="ruby">        requires :role_id, type: Integer, desc: &#39;The role to create with&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="82">
          <span class="hits">1</span>
          
          <code class="ruby">    put &#39;/unit_roles/:id&#39; do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="83">
          
          
          <code class="ruby">      unit_role = UnitRole.find_by(id: params[:id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="85">
          
          
          <code class="ruby">      unless (authorise? current_user, unit_role.unit, :employ_staff) || (authorise? current_user, User, :admin_units)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="86">
          
          
          <code class="ruby">        error!({ error: &quot;Couldn&#39;t find Unit with id=#{params[:id]}&quot; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="89">
          
          
          <code class="ruby">      unit_role_parameters = ActionController::Parameters.new(params)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby">                                                         .require(:unit_role)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby">                                                         .permit(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby">                                                           :role_id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby">                                                         )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="95">
          
          
          <code class="ruby">      if unit_role_parameters[:role_id] == Role.tutor.id &amp;&amp; unit_role.role == Role.convenor &amp;&amp; unit_role.unit.convenors.count == 1</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="96">
          
          
          <code class="ruby">        error!({ error: &#39;There must be at least one convenor for the unit&#39; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="99">
          
          
          <code class="ruby">      unit_role.update!(unit_role_parameters)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="100">
          
          
          <code class="ruby">      unit_role</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="d3457113caa011ee0d29ecdea29c851cbaf99775">
  <div class="header">
    <h3>app/api/units.rb</h3>
    <h4><span class="red">60.75 %</span> covered</h4>
    <div>
      <b>186</b> relevant lines. 
      <span class="green"><b>113</b> lines covered</span> and
      <span class="red"><b>73</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;grape&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;unit_serializer&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;mime-check-helpers&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;csv_helper&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">module Api</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">  class Units &lt; Grape::API</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">    helpers AuthenticationHelpers</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">    helpers AuthorisationHelpers</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">    helpers MimeCheckHelpers</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">    helpers CsvHelper</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">    before do</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="15">
          <span class="hits">7</span>
          
          <code class="ruby">      authenticated?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="17">
          <span class="hits">7</span>
          
          <code class="ruby">      if params[:unit]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">        for key in [ :start_date, :end_date ] do</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="19">
          <span class="hits">2</span>
          
          <code class="ruby">          if params[:unit][key].present?</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="20">
          <span class="hits">2</span>
          
          <code class="ruby">            date_val = DateTime.parse(params[:unit][key])</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="21">
          <span class="hits">2</span>
          
          <code class="ruby">            params[:unit][key] = date_val</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>
          
          <code class="ruby">    desc &#39;Get units related to the current user for admin purposes&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">    params do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">      optional :include_in_active, type: Boolean, desc: &#39;Include units that are not active&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>
          
          <code class="ruby">    get &#39;/units&#39; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">      unless authorise? current_user, User, :convene_units</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">        error!({ error: &#39;Unable to list units&#39; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">      # gets only the units the current user can &quot;see&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="37">
          <span class="hits">1</span>
          
          <code class="ruby">      units = Unit.for_user_admin current_user</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="39">
          <span class="hits">1</span>
          
          <code class="ruby">      units = units.where(&#39;active = true&#39;) unless params[:include_in_active]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="41">
          <span class="hits">1</span>
          
          <code class="ruby">      ActiveModel::ArraySerializer.new(units, each_serializer: ShallowUnitSerializer)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="44">
          <span class="hits">1</span>
          
          <code class="ruby">    desc &quot;Get a unit&#39;s details&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="45">
          <span class="hits">1</span>
          
          <code class="ruby">    get &#39;/units/:id&#39; do</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="46">
          <span class="hits">2</span>
          
          <code class="ruby">      unit = Unit.find(params[:id])</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="47">
          <span class="hits">2</span>
          
          <code class="ruby">      unless (authorise? current_user, unit, :get_unit) || (authorise? current_user, User, :admin_units)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">        error!({ error: &quot;Couldn&#39;t find Unit with id=#{params[:id]}&quot; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">      # Unit uses user from thread to limit exposure</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="53">
          <span class="hits">2</span>
          
          <code class="ruby">      Thread.current[:user] = current_user</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="54">
          <span class="hits">2</span>
          
          <code class="ruby">      unit</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="57">
          <span class="hits">1</span>
          
          <code class="ruby">    desc &#39;Update unit&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="58">
          <span class="hits">1</span>
          
          <code class="ruby">    params do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="59">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :id, type: Integer, desc: &#39;The unit id to update&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="60">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :unit, type: Hash do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="61">
          <span class="hits">1</span>
          
          <code class="ruby">        optional :name</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="62">
          <span class="hits">1</span>
          
          <code class="ruby">        optional :code</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="63">
          <span class="hits">1</span>
          
          <code class="ruby">        optional :description</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="64">
          <span class="hits">1</span>
          
          <code class="ruby">        optional :start_date</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="65">
          <span class="hits">1</span>
          
          <code class="ruby">        optional :end_date</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="66">
          <span class="hits">1</span>
          
          <code class="ruby">        optional :active</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="69">
          <span class="hits">1</span>
          
          <code class="ruby">    put &#39;/units/:id&#39; do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="70">
          
          
          <code class="ruby">      unit = Unit.find(params[:id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="71">
          
          
          <code class="ruby">      unless authorise? current_user, unit, :update</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="72">
          
          
          <code class="ruby">        error!({ error: &#39;Not authorised to update a unit&#39; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="74">
          
          
          <code class="ruby">      unit_parameters = ActionController::Parameters.new(params)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">                                                    .require(:unit)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">                                                    .permit(:name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">                                                            :code,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">                                                            :description,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">                                                            :start_date,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">                                                            :end_date,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby">                                                            :active)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="83">
          
          
          <code class="ruby">      unit.update!(unit_parameters)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="84">
          
          
          <code class="ruby">      unit_parameters</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="87">
          <span class="hits">1</span>
          
          <code class="ruby">    desc &#39;Create unit&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="88">
          <span class="hits">1</span>
          
          <code class="ruby">    params do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="89">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :unit, type: Hash do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="90">
          <span class="hits">1</span>
          
          <code class="ruby">        requires :name</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="91">
          <span class="hits">1</span>
          
          <code class="ruby">        requires :code</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="92">
          <span class="hits">1</span>
          
          <code class="ruby">        optional :description</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="93">
          <span class="hits">1</span>
          
          <code class="ruby">        optional :start_date</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="94">
          <span class="hits">1</span>
          
          <code class="ruby">        optional :end_date</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="97">
          <span class="hits">1</span>
          
          <code class="ruby">    post &#39;/units&#39; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="98">
          <span class="hits">1</span>
          
          <code class="ruby">      unless authorise? current_user, User, :create_unit</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="99">
          
          
          <code class="ruby">        error!({ error: &#39;Not authorised to create a unit&#39; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="102">
          <span class="hits">1</span>
          
          <code class="ruby">      unit_parameters = ActionController::Parameters.new(params)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby">                                                    .require(:unit)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby">                                                    .permit(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby">                                                      :name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby">                                                      :code,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby">                                                      :description,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby">                                                      :start_date,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby">                                                      :end_date</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby">                                                    )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="112">
          <span class="hits">1</span>
          
          <code class="ruby">      if unit_parameters[:description].nil?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="113">
          <span class="hits">1</span>
          
          <code class="ruby">        unit_parameters[:description] = unit_parameters[:name]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="115">
          <span class="hits">1</span>
          
          <code class="ruby">      if unit_parameters[:start_date].nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="116">
          
          
          <code class="ruby">        start_date = Date.parse(&#39;Monday&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="117">
          
          
          <code class="ruby">        delta = start_date &gt; Date.today ? 0 : 7</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="118">
          
          
          <code class="ruby">        unit_parameters[:start_date] = start_date + delta</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="120">
          <span class="hits">1</span>
          
          <code class="ruby">      if unit_parameters[:end_date].nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="121">
          
          
          <code class="ruby">        unit_parameters[:end_date] = unit_parameters[:start_date] + 16.weeks</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="124">
          <span class="hits">1</span>
          
          <code class="ruby">      unit = Unit.create!(unit_parameters)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="125">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="126">
          
          
          <code class="ruby">      # Employ current user as convenor</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="127">
          <span class="hits">1</span>
          
          <code class="ruby">      unit.employ_staff(current_user, Role.convenor)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="128">
          <span class="hits">1</span>
          
          <code class="ruby">      ShallowUnitSerializer.new(unit)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="129">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="130">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="131">
          <span class="hits">1</span>
          
          <code class="ruby">    desc &#39;Add a tutorial with the provided details to this unit&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="132">
          <span class="hits">1</span>
          
          <code class="ruby">    params do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="133">
          
          
          <code class="ruby">      # day, time, location, tutor_username, abbrev</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="134">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :tutorial, type: Hash do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="135">
          <span class="hits">1</span>
          
          <code class="ruby">        requires :day</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="136">
          <span class="hits">1</span>
          
          <code class="ruby">        requires :time</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="137">
          <span class="hits">1</span>
          
          <code class="ruby">        requires :location</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="138">
          <span class="hits">1</span>
          
          <code class="ruby">        requires :tutor_username</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="139">
          <span class="hits">1</span>
          
          <code class="ruby">        requires :abbrev</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="140">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="141">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="142">
          <span class="hits">1</span>
          
          <code class="ruby">    post &#39;/units/:id/tutorials&#39; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="143">
          <span class="hits">1</span>
          
          <code class="ruby">      unit = Unit.find(params[:id])</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="144">
          <span class="hits">1</span>
          
          <code class="ruby">      unless authorise? current_user, unit, :add_tutorial</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="145">
          
          
          <code class="ruby">        error!({ error: &#39;Not authorised to create a tutorial&#39; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="146">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="147">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="148">
          <span class="hits">1</span>
          
          <code class="ruby">      new_tutorial = params[:tutorial]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="149">
          <span class="hits">1</span>
          
          <code class="ruby">      tutor = User.find_by(username: new_tutorial[:tutor_username])</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="150">
          <span class="hits">1</span>
          
          <code class="ruby">      if tutor.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="151">
          
          
          <code class="ruby">        error!({ error: &quot;Couldn&#39;t find User with username=#{new_tutorial[:tutor_username]}&quot; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="152">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="153">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="154">
          <span class="hits">1</span>
          
          <code class="ruby">      result = unit.add_tutorial(new_tutorial[:day], new_tutorial[:time], new_tutorial[:location], tutor, new_tutorial[:abbrev])</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="155">
          <span class="hits">1</span>
          
          <code class="ruby">      if result.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="156">
          
          
          <code class="ruby">        error!({ error: &#39;Tutor username invalid (not a tutor for this unit)&#39; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="157">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="158">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="159">
          <span class="hits">1</span>
          
          <code class="ruby">      result</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="160">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="161">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="162">
          <span class="hits">1</span>
          
          <code class="ruby">    desc &#39;Download the tasks that are awaiting feedback for a unit&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="163">
          <span class="hits">1</span>
          
          <code class="ruby">    get &#39;/units/:id/feedback&#39; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="164">
          <span class="hits">1</span>
          
          <code class="ruby">      unit = Unit.find(params[:id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="165">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="166">
          <span class="hits">1</span>
          
          <code class="ruby">      unless authorise? current_user, unit, :provide_feedback</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="167">
          
          
          <code class="ruby">        error!({ error: &#39;Not authorised to provide feedback for this unit&#39; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="168">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="169">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="170">
          <span class="hits">1</span>
          
          <code class="ruby">      tasks = unit.tasks_awaiting_feedback(current_user)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="171">
          <span class="hits">1</span>
          
          <code class="ruby">      unit.tasks_as_hash(tasks)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="172">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="173">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="174">
          <span class="hits">1</span>
          
          <code class="ruby">    desc &#39;Download the tasks that should be listed under the task inbox&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="175">
          <span class="hits">1</span>
          
          <code class="ruby">    get &#39;/units/:id/tasks/inbox&#39; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="176">
          <span class="hits">1</span>
          
          <code class="ruby">      unit = Unit.find(params[:id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="177">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="178">
          <span class="hits">1</span>
          
          <code class="ruby">      unless authorise? current_user, unit, :provide_feedback</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="179">
          
          
          <code class="ruby">        error!({ error: &#39;Not authorised to provide feedback for this unit&#39; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="180">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="181">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="182">
          <span class="hits">1</span>
          
          <code class="ruby">      tasks = unit.tasks_for_task_inbox(current_user)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="183">
          <span class="hits">1</span>
          
          <code class="ruby">      unit.tasks_as_hash(tasks)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="184">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="185">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="186">
          <span class="hits">1</span>
          
          <code class="ruby">    desc &#39;Download the tasks that should be listed under the task inbox&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="187">
          <span class="hits">1</span>
          
          <code class="ruby">    get &#39;/units/:id/tasks/inbox&#39; do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="188">
          
          
          <code class="ruby">      unit = Unit.find(params[:id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="189">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="190">
          
          
          <code class="ruby">      unless authorise? current_user, unit, :provide_feedback</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="191">
          
          
          <code class="ruby">        error!({ error: &#39;Not authorised to provide feedback for this unit&#39; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="192">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="193">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="194">
          
          
          <code class="ruby">      tasks = unit.tasks_for_task_inbox</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="195">
          
          
          <code class="ruby">      unit.tasks_as_hash(tasks)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="196">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="197">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="198">
          <span class="hits">1</span>
          
          <code class="ruby">    desc &#39;Download the grades for a unit&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="199">
          <span class="hits">1</span>
          
          <code class="ruby">    get &#39;/units/:id/grades&#39; do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="200">
          
          
          <code class="ruby">      unit = Unit.find(params[:id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="201">
          
          
          <code class="ruby">      unless authorise? current_user, unit, :download_grades</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="202">
          
          
          <code class="ruby">        error!({ error: &#39;Not authorised to download grades for this unit&#39; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="203">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="204">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="205">
          
          
          <code class="ruby">      content_type &#39;application/octet-stream&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="206">
          
          
          <code class="ruby">      header[&#39;Content-Disposition&#39;] = &quot;attachment; filename=#{unit.code}-Students.csv &quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="207">
          
          
          <code class="ruby">      env[&#39;api.format&#39;] = :binary</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="208">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="209">
          
          
          <code class="ruby">      unit.student_grades_csv</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="210">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="211">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="212">
          <span class="hits">1</span>
          
          <code class="ruby">    desc &#39;Upload CSV of all the students in a unit&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="213">
          <span class="hits">1</span>
          
          <code class="ruby">    params do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="214">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :file, type: Rack::Multipart::UploadedFile, desc: &#39;CSV upload file.&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="215">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="216">
          <span class="hits">1</span>
          
          <code class="ruby">    post &#39;/csv/units/:id&#39; do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="217">
          
          
          <code class="ruby">      unit = Unit.find(params[:id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="218">
          
          
          <code class="ruby">      unless authorise? current_user, unit, :upload_csv</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="219">
          
          
          <code class="ruby">        error!({ error: &quot;Not authorised to upload CSV of students to #{unit.code}&quot; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="220">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="221">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="222">
          
          
          <code class="ruby">      ensure_csv!(params[:file][:tempfile])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="223">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="224">
          
          
          <code class="ruby">      # Actually import...</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="225">
          
          
          <code class="ruby">      unit.import_users_from_csv(params[:file][:tempfile])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="226">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="227">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="228">
          <span class="hits">1</span>
          
          <code class="ruby">    desc &#39;Upload CSV with the students to un-enrol from the unit&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="229">
          <span class="hits">1</span>
          
          <code class="ruby">    params do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="230">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :file, type: Rack::Multipart::UploadedFile, desc: &#39;CSV upload file.&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="231">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="232">
          <span class="hits">1</span>
          
          <code class="ruby">    post &#39;/csv/units/:id/withdraw&#39; do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="233">
          
          
          <code class="ruby">      # check mime is correct before uploading</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="234">
          
          
          <code class="ruby">      ensure_csv!(params[:file][:tempfile])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="235">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="236">
          
          
          <code class="ruby">      unit = Unit.find(params[:id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="237">
          
          
          <code class="ruby">      unless authorise? current_user, unit, :upload_csv</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="238">
          
          
          <code class="ruby">        error!({ error: &quot;Not authorised to upload CSV of students to #{unit.code}&quot; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="239">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="240">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="241">
          
          
          <code class="ruby">      # Actually withdraw...</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="242">
          
          
          <code class="ruby">      unit.unenrol_users_from_csv(params[:file][:tempfile])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="243">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="244">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="245">
          <span class="hits">1</span>
          
          <code class="ruby">    desc &#39;Download CSV of all students in this unit&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="246">
          <span class="hits">1</span>
          
          <code class="ruby">    get &#39;/csv/units/:id&#39; do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="247">
          
          
          <code class="ruby">      unit = Unit.find(params[:id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="248">
          
          
          <code class="ruby">      unless authorise? current_user, unit, :download_unit_csv</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="249">
          
          
          <code class="ruby">        error!({ error: &quot;Not authorised to download CSV of students enrolled in #{unit.code}&quot; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="250">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="251">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="252">
          
          
          <code class="ruby">      content_type &#39;application/octet-stream&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="253">
          
          
          <code class="ruby">      header[&#39;Content-Disposition&#39;] = &quot;attachment; filename=#{unit.code}-Students.csv &quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="254">
          
          
          <code class="ruby">      env[&#39;api.format&#39;] = :binary</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="255">
          
          
          <code class="ruby">      unit.export_users_to_csv</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="256">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="257">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="258">
          <span class="hits">1</span>
          
          <code class="ruby">    desc &#39;Download CSV of all student tasks in this unit&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="259">
          <span class="hits">1</span>
          
          <code class="ruby">    get &#39;/csv/units/:id/task_completion&#39; do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="260">
          
          
          <code class="ruby">      unit = Unit.find(params[:id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="261">
          
          
          <code class="ruby">      unless authorise? current_user, unit, :download_unit_csv</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="262">
          
          
          <code class="ruby">        error!({ error: &quot;Not authorised to download CSV of student tasks in #{unit.code}&quot; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="263">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="264">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="265">
          
          
          <code class="ruby">      content_type &#39;application/octet-stream&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="266">
          
          
          <code class="ruby">      header[&#39;Content-Disposition&#39;] = &quot;attachment; filename=#{unit.code}-TaskCompletion.csv &quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="267">
          
          
          <code class="ruby">      env[&#39;api.format&#39;] = :binary</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="268">
          
          
          <code class="ruby">      unit.task_completion_csv</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="269">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="270">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="271">
          <span class="hits">1</span>
          
          <code class="ruby">    desc &#39;Download the stats related to the number of students aiming for each grade&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="272">
          <span class="hits">1</span>
          
          <code class="ruby">    get &#39;/units/:id/stats/student_target_grade&#39; do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="273">
          
          
          <code class="ruby">      unit = Unit.find(params[:id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="274">
          
          
          <code class="ruby">      unless authorise? current_user, unit, :download_stats</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="275">
          
          
          <code class="ruby">        error!({ error: &quot;Not authorised to download stats of student tasks in #{unit.code}&quot; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="276">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="277">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="278">
          
          
          <code class="ruby">      unit.student_target_grade_stats</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="279">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="280">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="281">
          <span class="hits">1</span>
          
          <code class="ruby">    desc &#39;Download stats related to the status of students with tasks&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="282">
          <span class="hits">1</span>
          
          <code class="ruby">    get &#39;/units/:id/stats/task_status_pct&#39; do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="283">
          
          
          <code class="ruby">      unit = Unit.find(params[:id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="284">
          
          
          <code class="ruby">      unless authorise? current_user, unit, :download_stats</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="285">
          
          
          <code class="ruby">        error!({ error: &quot;Not authorised to download stats of student tasks in #{unit.code}&quot; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="286">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="287">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="288">
          
          
          <code class="ruby">      unit.task_status_stats</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="289">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="290">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="291">
          <span class="hits">1</span>
          
          <code class="ruby">    desc &#39;Download stats related to the number of completed tasks&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="292">
          <span class="hits">1</span>
          
          <code class="ruby">    get &#39;/units/:id/stats/task_completion_stats&#39; do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="293">
          
          
          <code class="ruby">      unit = Unit.find(params[:id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="294">
          
          
          <code class="ruby">      unless authorise? current_user, unit, :download_stats</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="295">
          
          
          <code class="ruby">        error!({ error: &quot;Not authorised to download stats of student tasks in #{unit.code}&quot; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="296">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="297">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="298">
          
          
          <code class="ruby">      unit.student_task_completion_stats</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="299">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="300">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="301">
          <span class="hits">1</span>
          
          <code class="ruby">    desc &#39;Download stats related to the number of tasks assessed by each tutor&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="302">
          <span class="hits">1</span>
          
          <code class="ruby">    get &#39;/csv/units/:id/tutor_assessments&#39; do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="303">
          
          
          <code class="ruby">      unit = Unit.find(params[:id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="304">
          
          
          <code class="ruby">      unless authorise? current_user, unit, :download_stats</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="305">
          
          
          <code class="ruby">        error!({ error: &quot;Not authorised to download stats of statistics for #{unit.code}&quot; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="306">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="307">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="308">
          
          
          <code class="ruby">      content_type &#39;application/octet-stream&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="309">
          
          
          <code class="ruby">      header[&#39;Content-Disposition&#39;] = &quot;attachment; filename=#{unit.code}-TutorAssessments.csv &quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="310">
          
          
          <code class="ruby">      env[&#39;api.format&#39;] = :binary</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="311">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="312">
          
          
          <code class="ruby">      unit.tutor_assessment_csv</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="313">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="314">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="315">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="8d70df213d126e0f49d50f91ee51694b35f1733a">
  <div class="header">
    <h3>app/api/users.rb</h3>
    <h4><span class="red">74.07 %</span> covered</h4>
    <div>
      <b>108</b> relevant lines. 
      <span class="green"><b>80</b> lines covered</span> and
      <span class="red"><b>28</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;grape&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;mime-check-helpers&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">module Api</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  class Users &lt; Grape::API</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">    helpers AuthenticationHelpers</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">    helpers AuthorisationHelpers</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">    helpers MimeCheckHelpers</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">    before do</code>
        </li>
      
        <li class="covered" data-hits="38" data-linenumber="11">
          <span class="hits">38</span>
          
          <code class="ruby">      authenticated?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">    desc &#39;Get the list of users&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">    get &#39;/users&#39; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">      unless authorise? current_user, User, :list_users</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">        error!({ error: &#39;Cannot list users - not authorised&#39; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">      @users = User.all</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">    desc &#39;Get user&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">    get &#39;/users/:id&#39;, requirements: { id: /[0-9]*/ } do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">      user = User.find(params[:id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">      unless (user.id == current_user.id) || (authorise? current_user, User, :admin_users)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">        error!({ error: &quot;Cannot find User with id #{params[:id]}&quot; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">      user</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">    desc &#39;Get convenors&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="33">
          <span class="hits">1</span>
          
          <code class="ruby">    get &#39;/users/convenors&#39; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="34">
          <span class="hits">1</span>
          
          <code class="ruby">      unless authorise? current_user, User, :convene_units</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">        error!({ error: &#39;Cannot list convenors - not authorised&#39; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="37">
          <span class="hits">1</span>
          
          <code class="ruby">      @user_roles = User.convenors</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="40">
          <span class="hits">1</span>
          
          <code class="ruby">    desc &#39;Get tutors&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="41">
          <span class="hits">1</span>
          
          <code class="ruby">    get &#39;/users/tutors&#39; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="42">
          <span class="hits">1</span>
          
          <code class="ruby">      unless authorise? current_user, User, :convene_units</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">        error!({ error: &#39;Cannot list tutors - not authorised&#39; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="45">
          <span class="hits">1</span>
          
          <code class="ruby">      @user_roles = User.tutors</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="48">
          <span class="hits">1</span>
          
          <code class="ruby">    desc &#39;Update a user&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="49">
          <span class="hits">1</span>
          
          <code class="ruby">    params do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="50">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :id, type: Integer, desc: &#39;The user id to update&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="51">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :user, type: Hash do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="52">
          <span class="hits">1</span>
          
          <code class="ruby">        optional :first_name, type: String, desc: &#39;New first name for user&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="53">
          <span class="hits">1</span>
          
          <code class="ruby">        optional :last_name, type: String, desc: &#39;New last name for user&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="54">
          <span class="hits">1</span>
          
          <code class="ruby">        optional :email, type: String, desc: &#39;New email address for user&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="55">
          <span class="hits">1</span>
          
          <code class="ruby">        optional :student_id, type: String, desc: &#39;New student_id for user&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="56">
          <span class="hits">1</span>
          
          <code class="ruby">        optional :nickname, type: String, desc: &#39;New nickname for user&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="57">
          <span class="hits">1</span>
          
          <code class="ruby">        optional :system_role, type: String, desc: &#39;New role for user [Admin, Convenor, Tutor, Student]&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="58">
          <span class="hits">1</span>
          
          <code class="ruby">        optional :receive_task_notifications, type: Boolean, desc: &#39;Allow user to be sent task notifications&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="59">
          <span class="hits">1</span>
          
          <code class="ruby">        optional :receive_portfolio_notifications, type: Boolean, desc: &#39;Allow user to be sent portfolio notifications&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="60">
          <span class="hits">1</span>
          
          <code class="ruby">        optional :receive_feedback_notifications, type: Boolean, desc: &#39;Allow user to be sent feedback notifications&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="61">
          <span class="hits">1</span>
          
          <code class="ruby">        optional :opt_in_to_research, type: Boolean, desc: &#39;Allow user to opt in to research conducted by Doubtfire&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="62">
          <span class="hits">1</span>
          
          <code class="ruby">        optional :has_run_first_time_setup, type: Boolean, desc: &#39;Whether or not user has run first-time setup&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="65">
          <span class="hits">1</span>
          
          <code class="ruby">    put &#39;/users/:id&#39; do</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="66">
          <span class="hits">7</span>
          
          <code class="ruby">      change_self = (params[:id] == current_user.id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="68">
          <span class="hits">7</span>
          
          <code class="ruby">      params[:receive_portfolio_notifications] = true if params.key?(:receive_portfolio_notifications) &amp;&amp; params[:receive_portfolio_notifications].nil?</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="69">
          <span class="hits">7</span>
          
          <code class="ruby">      params[:receive_portfolio_notifications] = true if params.key?(:receive_feedback_notifications) &amp;&amp; params[:receive_feedback_notifications].nil?</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="70">
          <span class="hits">7</span>
          
          <code class="ruby">      params[:receive_portfolio_notifications] = true if params.key?(:receive_task_notifications) &amp;&amp; params[:receive_task_notifications].nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">      # can only modify if current_user.id is same as :id provided</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">      # (i.e., user wants to update their own data) or if update_user token</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="74">
          <span class="hits">7</span>
          
          <code class="ruby">      if change_self || (authorise? current_user, User, :update_user)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="76">
          <span class="hits">7</span>
          
          <code class="ruby">        user = User.find(params[:id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="78">
          <span class="hits">7</span>
          
          <code class="ruby">        user_parameters = ActionController::Parameters.new(params)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">                                                      .require(:user)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">                                                      .permit(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby">                                                        :first_name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">                                                        :last_name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby">                                                        :email,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">                                                        :student_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">                                                        :nickname,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby">                                                        :receive_task_notifications,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby">                                                        :receive_portfolio_notifications,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">                                                        :receive_feedback_notifications,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby">                                                        :opt_in_to_research,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby">                                                        :has_run_first_time_setup</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby">                                                      )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="93">
          <span class="hits">7</span>
          
          <code class="ruby">        user.role = Role.student if user.role.nil?</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="94">
          <span class="hits">7</span>
          
          <code class="ruby">        old_role = user.role</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby">        # have to translate the system_role -&gt; role</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby">        # note we only let user_parameters role if we&#39;re actually *changing* the role</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby">        # (i.e., not passing in the *same* role)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby">        #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby">        # You cannot change your own permissions</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby">        #</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="102">
          <span class="hits">7</span>
          
          <code class="ruby">        if !change_self &amp;&amp; params[:user][:system_role] &amp;&amp; old_role.id != Role.with_name(params[:user][:system_role]).id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="103">
          
          
          <code class="ruby">          user_parameters[:role] = params[:user][:system_role]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby">        #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby">        # Only allow change of role if current user has permissions to demote/promote the user to the new role</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby">        #</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="109">
          <span class="hits">7</span>
          
          <code class="ruby">        if user_parameters[:role]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby">          # work out if promoting or demoting</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="111">
          
          
          <code class="ruby">          new_role = Role.with_name(user_parameters[:role])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="113">
          
          
          <code class="ruby">          if new_role.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="114">
          
          
          <code class="ruby">            error!({ error: &quot;No such role name #{user_parameters[:role]}&quot; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="116">
          
          
          <code class="ruby">          action = new_role.id &gt; old_role.id ? :promote_user : :demote_user</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby">          # current user not authorised to peform action with new role?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="119">
          
          
          <code class="ruby">          unless authorise? current_user, User, action, User.get_change_role_perm_fn, [ old_role.to_sym, new_role.to_sym ]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="120">
          
          
          <code class="ruby">            error!({ error: &quot;Not authorised to #{action} user with id=#{params[:id]} to #{new_role.name}&quot; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby">          # update :role to actual Role object rather than String type</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="123">
          
          
          <code class="ruby">          user_parameters[:role] = new_role</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="125">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="126">
          
          
          <code class="ruby">        # Update changes made to user</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="127">
          <span class="hits">7</span>
          
          <code class="ruby">        user.update!(user_parameters)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="128">
          <span class="hits">1</span>
          
          <code class="ruby">        user</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="129">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="130">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="131">
          
          
          <code class="ruby">        error!({ error: &quot;Cannot modify user with id=#{params[:id]} - not authorised&quot; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="132">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="133">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="134">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="135">
          <span class="hits">1</span>
          
          <code class="ruby">    desc &#39;Create user&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="136">
          <span class="hits">1</span>
          
          <code class="ruby">    params do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="137">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :user, type: Hash do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="138">
          <span class="hits">1</span>
          
          <code class="ruby">        requires :first_name, type: String, desc: &#39;New first name for user&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="139">
          <span class="hits">1</span>
          
          <code class="ruby">        requires :last_name, type: String, desc: &#39;New last name for user&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="140">
          <span class="hits">1</span>
          
          <code class="ruby">        requires :email, type: String, desc: &#39;New email address for user&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="141">
          <span class="hits">1</span>
          
          <code class="ruby">        optional :student_id, type: String, desc: &#39;New student_id for user&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="142">
          <span class="hits">1</span>
          
          <code class="ruby">        requires :username, type: String,   desc: &#39;New username for user&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="143">
          <span class="hits">1</span>
          
          <code class="ruby">        requires :nickname, type: String,   desc: &#39;New nickname for user&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="144">
          <span class="hits">1</span>
          
          <code class="ruby">        requires :system_role, type: String, desc: &#39;New system role for user [Admin, Convenor, Tutor, Student]&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="145">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="146">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="147">
          <span class="hits">1</span>
          
          <code class="ruby">    post &#39;/users&#39; do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="148">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="149">
          
          
          <code class="ruby">      # Only admins and convenors can create users</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="150">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="151">
          <span class="hits">18</span>
          
          <code class="ruby">      unless authorise? current_user, User, :create_user</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="152">
          
          
          <code class="ruby">        error!({ error: &#39;Not authorised to create new users&#39; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="153">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="154">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="155">
          <span class="hits">18</span>
          
          <code class="ruby">      user_parameters = ActionController::Parameters.new(params)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="156">
          
          
          <code class="ruby">                                                    .require(:user)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="157">
          
          
          <code class="ruby">                                                    .permit(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="158">
          
          
          <code class="ruby">                                                      :first_name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="159">
          
          
          <code class="ruby">                                                      :last_name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="160">
          
          
          <code class="ruby">                                                      :student_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="161">
          
          
          <code class="ruby">                                                      :email,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="162">
          
          
          <code class="ruby">                                                      :username,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby">                                                      :nickname</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="164">
          
          
          <code class="ruby">                                                    )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="165">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="166">
          
          
          <code class="ruby">      # have to translate the system_role -&gt; role</code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="167">
          <span class="hits">18</span>
          
          <code class="ruby">      user_parameters[:role] = params[:user][:system_role]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="168">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="169">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="170">
          
          
          <code class="ruby">      # Give new user their new role</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="171">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="172">
          <span class="hits">18</span>
          
          <code class="ruby">      new_role = Role.with_name(user_parameters[:role])</code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="173">
          <span class="hits">18</span>
          
          <code class="ruby">      if new_role.nil?</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="174">
          <span class="hits">3</span>
          
          <code class="ruby">        error!({ error: &quot;No such role name #{user_parameters[:role]}&quot; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="175">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="176">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="177">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="178">
          
          
          <code class="ruby">      # Check permission to create user with this role</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="179">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="180">
          <span class="hits">15</span>
          
          <code class="ruby">      unless authorise? current_user, User, :create_user, User.get_change_role_perm_fn, [ :nil, new_role.name.downcase.to_sym ]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="181">
          
          
          <code class="ruby">        error!({ error: &quot;Not authorised to create new users with role #{new_role.name}&quot; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="182">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="183">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="184">
          
          
          <code class="ruby">      # update :role to actual Role object rather than String type</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="185">
          <span class="hits">15</span>
          
          <code class="ruby">      user_parameters[:role] = new_role</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="186">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="187">
          <span class="hits">15</span>
          
          <code class="ruby">      logger.info &quot;#{current_user.username}: Created new user #{user_parameters[:username]} with role #{new_role.name}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="188">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="189">
          <span class="hits">15</span>
          
          <code class="ruby">      user = User.create!(user_parameters)</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="190">
          <span class="hits">4</span>
          
          <code class="ruby">      user</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="191">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="192">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="193">
          <span class="hits">1</span>
          
          <code class="ruby">    desc &#39;Upload CSV of users&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="194">
          <span class="hits">1</span>
          
          <code class="ruby">    params do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="195">
          <span class="hits">1</span>
          
          <code class="ruby">      requires :file, type: Rack::Multipart::UploadedFile, desc: &#39;CSV upload file.&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="196">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="197">
          <span class="hits">1</span>
          
          <code class="ruby">    post &#39;/csv/users&#39; do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="198">
          
          
          <code class="ruby">      # check mime is correct before uploading</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="199">
          
          
          <code class="ruby">      ensure_csv!(params[:file][:tempfile])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="200">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="201">
          
          
          <code class="ruby">      unless authorise? current_user, User, :upload_csv</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="202">
          
          
          <code class="ruby">        error!({ error: &#39;Not authorised to upload CSV of users&#39; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="203">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="204">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="205">
          
          
          <code class="ruby">      # Actually import...</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="206">
          
          
          <code class="ruby">      User.import_from_csv(current_user, params[:file][:tempfile])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="207">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="208">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="209">
          <span class="hits">1</span>
          
          <code class="ruby">    desc &#39;Download CSV of all users&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="210">
          <span class="hits">1</span>
          
          <code class="ruby">    get &#39;/csv/users&#39; do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="211">
          
          
          <code class="ruby">      unless authorise? current_user, User, :download_system_csv</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="212">
          
          
          <code class="ruby">        error!({ error: &#39;Not authorised to download CSV of all users&#39; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="213">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="214">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="215">
          
          
          <code class="ruby">      content_type &#39;application/octet-stream&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="216">
          
          
          <code class="ruby">      header[&#39;Content-Disposition&#39;] = &#39;attachment; filename=doubtfire_users.csv &#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="217">
          
          
          <code class="ruby">      env[&#39;api.format&#39;] = :binary</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="218">
          
          
          <code class="ruby">      User.export_to_csv</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="219">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="220">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="221">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="e614753115f01fa413a4ffc71f3a088f8fa604ef">
  <div class="header">
    <h3>app/controllers/application_controller.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>2</b> relevant lines. 
      <span class="green"><b>2</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class ApplicationController &lt; ActionController::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  protect_from_forgery</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">  # private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">  # rescue_from CanCan::AccessDenied do |exception|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">  #   redirect_to root_url, alert:  exception.message</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">  # end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="f7f045879d13ff6b3ee34777e93f20bd318f6db0">
  <div class="header">
    <h3>app/controllers/lecture_resource_downloads_controller.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>31</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>31</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="missed" data-hits="0" data-linenumber="1">
          
          
          <code class="ruby">require &#39;grape&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">class LectureResourceDownloadsController &lt; ApplicationController</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">  include AuthenticationHelpers</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">  include AuthorisationHelpers</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">  class MyException &lt; RuntimeError</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">    attr_reader :status</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">    def initialize(status)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">      @status = status</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">  def error!(message, status = options[:default_status], _headers = {}, _backtrace = [])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">    raise MyException.new(status), message</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">  # desc &quot;Retrieve all task sheets, and resources for a unit&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">  def index</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">    unless authenticated?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">      error!({ error: &quot;Not authorised to download task sheets and resources for unit &#39;#{params[:id]}&#39;&quot; }, 401)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">    unit = Unit.find(params[:id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">    unless authorise? current_user, unit, :get_unit</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">      error!({ error: &quot;Not authorised to download resources for unit &#39;#{params[:id]}&#39;&quot; }, 401)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">    output_zip = unit.get_task_resources_zip</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">    error!({ error: &#39;No files to download&#39; }, 403) if output_zip.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">    download_id = &quot;#{Time.new.strftime(&#39;%Y-%m-%d %H:%m:%S&#39;)}-resources-#{unit.code}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">    download_id.gsub! /[\\\/]/, &#39;-&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">    download_id = FileHelper.sanitized_filename(download_id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">    send_file output_zip.path, content_type: &#39;application/octet-stream&#39;, disposition: &quot;attachment; filename=#{download_id}.zip&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">  rescue MyException =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">    render json: e.message, status: e.status</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="d406371c7b079ec497132ddbd6bab709299b4dfd">
  <div class="header">
    <h3>app/controllers/portfolio_downloads_controller.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>33</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>33</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="missed" data-hits="0" data-linenumber="1">
          
          
          <code class="ruby">require &#39;grape&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">class PortfolioDownloadsController &lt; ApplicationController</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">  include AuthenticationHelpers</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">  include AuthorisationHelpers</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">  include LogHelper</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">  class MyException &lt; RuntimeError</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">    attr_reader :status</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">    def initialize(status)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">      @status = status</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">  def error!(message, status = options[:default_status], _headers = {}, _backtrace = [])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">    raise MyException.new(status), message</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">  # desc &quot;Retrieve portfolios for a unit&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">  def index</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">    unless authenticated?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">      error!({ error: &quot;Not authorised to download portfolios for unit &#39;#{params[:id]}&#39;&quot; }, 401)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">    unit = Unit.find(params[:id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">    unless authorise? current_user, unit, :provide_feedback</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">      error!({ error: &quot;Not authorised to download portfolios for unit &#39;#{params[:id]}&#39;&quot; }, 401)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">    output_zip = unit.get_portfolio_zip(current_user)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">    error!({ error: &#39;No files to download&#39; }, 403) if output_zip.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">    # Set download headers...</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">    # content_type &quot;application/octet-stream&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">    download_id = &quot;#{Time.new.strftime(&#39;%Y-%m-%d %H:%m:%S&#39;)}-portfolios-#{unit.code}-#{current_user.username}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">    download_id.gsub! /[\\\/]/, &#39;-&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">    download_id = FileHelper.sanitized_filename(download_id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">    # header[&#39;Content-Disposition&#39;] = &quot;attachment; filename=#{download_id}.zip&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">    # env[&#39;api.format&#39;] = :binary</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">    logger.debug &quot;Downloading portfolios from #{output_zip.path}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">    # out = File.open(output_zip.path, &quot;rb&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">    # output_zip.unlink</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">    # response_body = out.read</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">    # File.binread output_zip.path</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">    # sending_file = true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">    send_file output_zip.path, content_type: &#39;application/octet-stream&#39;, disposition: &quot;attachment; filename=#{download_id}.zip&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">  rescue MyException =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby">    render json: e.message, status: e.status</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="55">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="56">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="894e845701f7f082eb42024fb5ddb0fbeb0da523">
  <div class="header">
    <h3>app/controllers/task_downloads_controller.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>35</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>35</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="missed" data-hits="0" data-linenumber="1">
          
          
          <code class="ruby">require &#39;grape&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">class TaskDownloadsController &lt; ApplicationController</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">  include AuthenticationHelpers</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">  include AuthorisationHelpers</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">  include LogHelper</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">  class MyException &lt; RuntimeError</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">    attr_reader :status</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">    def initialize(status)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">      @status = status</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">  def error!(message, status = options[:default_status], _headers = {}, _backtrace = [])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">    raise MyException.new(status), message</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">  # desc &quot;Retrieve tasks for a unit&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">  def index</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">    unless authenticated?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">      error!({ error: &quot;Not authorised to download tasks for unit &#39;#{params[:id]}&#39;&quot; }, 401)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">    unit = Unit.find(params[:id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">    unless authorise? current_user, unit, :provide_feedback</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">      error!({ error: &quot;Not authorised to download tasks for unit &#39;#{params[:id]}&#39;&quot; }, 401)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">    td = unit.task_definitions.find(params[:task_def_id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">    output_zip = unit.get_task_submissions_zip(current_user, td)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">    error!({ error: &#39;No files to download&#39; }, 403) if output_zip.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">    # Set download headers...</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">    # content_type &quot;application/octet-stream&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">    download_id = &quot;#{Time.new.strftime(&#39;%Y-%m-%d %H:%m:%S&#39;)}-#{unit.code}-#{td.abbreviation}-#{current_user.username}-files&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">    download_id.gsub! /[\\\/]/, &#39;-&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">    download_id = FileHelper.sanitized_filename(download_id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">    # header[&#39;Content-Disposition&#39;] = &quot;attachment; filename=#{download_id}.zip&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">    # env[&#39;api.format&#39;] = :binary</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">    logger.debug &quot;Downloading task for #{td.abbreviation} from #{output_zip.path}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">    send_file output_zip.path, content_type: &#39;application/octet-stream&#39;, disposition: &quot;attachment; filename=#{download_id}.zip&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="49">
          
          
          <code class="ruby">    output_zip.close</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">  rescue MyException =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">    render json: e.message, status: e.status</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="b70a6919b2ed8160d73c419c861fa725e99b4c9a">
  <div class="header">
    <h3>app/controllers/task_submission_pdfs_controller.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>35</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>35</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="missed" data-hits="0" data-linenumber="1">
          
          
          <code class="ruby">require &#39;grape&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">class TaskSubmissionPdfsController &lt; ApplicationController</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">  include AuthenticationHelpers</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">  include AuthorisationHelpers</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">  include LogHelper</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">  class MyException &lt; RuntimeError</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">    attr_reader :status</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">    def initialize(status)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">      @status = status</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">  def error!(message, status = options[:default_status], _headers = {}, _backtrace = [])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">    raise MyException.new(status), message</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">  # desc &quot;Retrieve student PDFs for a unit&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">  def index</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">    unless authenticated?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">      error!({ error: &quot;Not authorised to download student PDFs for unit &#39;#{params[:id]}&#39;&quot; }, 401)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">    unit = Unit.find(params[:id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">    unless authorise? current_user, unit, :provide_feedback</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">      error!({ error: &quot;Not authorised to download  student PDFs for unit &#39;#{params[:id]}&#39;&quot; }, 401)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">    td = unit.task_definitions.find(params[:task_def_id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">    output_zip = unit.get_task_submissions_pdf_zip(current_user, td)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">    error!({ error: &#39;No files to download&#39; }, 403) if output_zip.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">    # Set download headers...</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">    # content_type &quot;application/octet-stream&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">    download_id = &quot;#{Time.new.strftime(&#39;%Y-%m-%d %H:%m:%S&#39;)}-#{unit.code}-#{td.abbreviation}-#{current_user.username}-pdfs&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">    download_id.gsub! /[\\\/]/, &#39;-&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">    download_id = FileHelper.sanitized_filename(download_id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">    # header[&#39;Content-Disposition&#39;] = &quot;attachment; filename=#{download_id}.zip&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">    # env[&#39;api.format&#39;] = :binary</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">    logger.debug &quot;Downloading task for #{td.abbreviation} from #{output_zip.path}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">    send_file output_zip.path, content_type: &#39;application/octet-stream&#39;, disposition: &quot;attachment; filename=#{download_id}.zip&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="49">
          
          
          <code class="ruby">    output_zip.close</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">  rescue MyException =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">    render json: e.message, status: e.status</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="6d796a0da7713ee1930a1eef67f5ae56ca4daace">
  <div class="header">
    <h3>app/helpers/application_helper.rb</h3>
    <h4><span class="red">42.86 %</span> covered</h4>
    <div>
      <b>7</b> relevant lines. 
      <span class="green"><b>3</b> lines covered</span> and
      <span class="red"><b>4</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">module ApplicationHelper</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  def application_reference_date</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby">    @application_reference_date ||=</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">      if Doubtfire::Application.config.respond_to?(:application_reference_date)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">        Time.zone.parse(Doubtfire::Application.config.reference_date)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">        Time.zone.now</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">  def lesc(text)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">    LatexToPdf.escape_latex(text)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="f62e847bc864983a6f7b3442ac54f5ec83afd7dc">
  <div class="header">
    <h3>app/helpers/authentication_helpers.rb</h3>
    <h4><span class="green">92.0 %</span> covered</h4>
    <div>
      <b>25</b> relevant lines. 
      <span class="green"><b>23</b> lines covered</span> and
      <span class="red"><b>2</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"># The AuthenticationHelpers include functions to check if the user</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"># is authenticated and to fetch the current user.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"># This is used by the grape api.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">module AuthenticationHelpers</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  def warden</code>
        </li>
      
        <li class="covered" data-hits="157" data-linenumber="9">
          <span class="hits">157</span>
          
          <code class="ruby">    env[&#39;warden&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">  module_function</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">  # Checks if the requested user is authenticated.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">  # Reads details from the params fetched from the caller context.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">  def authenticated?</code>
        </li>
      
        <li class="covered" data-hits="59" data-linenumber="19">
          <span class="hits">59</span>
          
          <code class="ruby">    user_by_token = User.find_by_auth_token(params[:auth_token]) if params &amp;&amp; params[:auth_token]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">    # Check warden -- authenticate using DB or LDAP etc.</code>
        </li>
      
        <li class="covered" data-hits="59" data-linenumber="21">
          <span class="hits">59</span>
          
          <code class="ruby">    return true if warden.authenticated?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">    # Check user by token</code>
        </li>
      
        <li class="covered" data-hits="59" data-linenumber="23">
          <span class="hits">59</span>
          
          <code class="ruby">    if params[:auth_token] &amp;&amp; user_by_token &amp;&amp; user_by_token.auth_token_expiry</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">      # Non-expired token</code>
        </li>
      
        <li class="covered" data-hits="47" data-linenumber="25">
          <span class="hits">47</span>
          
          <code class="ruby">      return true if user_by_token.auth_token_expiry &gt; Time.zone.now</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">      # Time out this token</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">      error!({ error: &#39;Authentication token expired.&#39; }, 419)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">      # Add random delay then fail</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="30">
          <span class="hits">12</span>
          
          <code class="ruby">      sleep((200 + rand(200)) / 1000.0)</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="31">
          <span class="hits">12</span>
          
          <code class="ruby">      error!({ error: &#39;Could not authenticate with token. Token invalid.&#39; }, 419)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">  # Get the current user either from warden or from the token</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="38">
          <span class="hits">1</span>
          
          <code class="ruby">  def current_user</code>
        </li>
      
        <li class="covered" data-hits="98" data-linenumber="39">
          <span class="hits">98</span>
          
          <code class="ruby">    warden.user || User.find_by_auth_token(params[:auth_token])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">  # Add the required auth_token to each of the routes for the provided</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">  # Grape::API.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="46">
          <span class="hits">1</span>
          
          <code class="ruby">  def add_auth_to(service)</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="47">
          <span class="hits">15</span>
          
          <code class="ruby">    service.routes.each do |route|</code>
        </li>
      
        <li class="covered" data-hits="96" data-linenumber="48">
          <span class="hits">96</span>
          
          <code class="ruby">      options = route.instance_variable_get(&#39;@options&#39;)</code>
        </li>
      
        <li class="covered" data-hits="96" data-linenumber="49">
          <span class="hits">96</span>
          
          <code class="ruby">      next if options[:params][&#39;auth_token&#39;]</code>
        </li>
      
        <li class="covered" data-hits="96" data-linenumber="50">
          <span class="hits">96</span>
          
          <code class="ruby">      options[:params][&#39;auth_token&#39;] = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">        required: true,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">        type:     &#39;String&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">        desc:     &#39;Authentication token&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">  # Returns true iff using AAF devise auth strategy</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="61">
          <span class="hits">1</span>
          
          <code class="ruby">  def aaf_auth?</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="62">
          <span class="hits">13</span>
          
          <code class="ruby">    Doubtfire::Application.config.auth_method == :aaf</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">  # Returns true iff using LDAP devise auth strategy</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="68">
          <span class="hits">1</span>
          
          <code class="ruby">  def ldap_auth?</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="69">
          <span class="hits">10</span>
          
          <code class="ruby">    Doubtfire::Application.config.auth_method == :ldap</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">  # Returns true iff using database devise auth strategy</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="75">
          <span class="hits">1</span>
          
          <code class="ruby">  def db_auth?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="76">
          
          
          <code class="ruby">    Doubtfire::Application.config.auth_method == :database</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="11586388c30c6c9e654ecc551adffdfdf03f5931">
  <div class="header">
    <h3>app/helpers/authorisation_helpers.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>13</b> relevant lines. 
      <span class="green"><b>13</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">module AuthorisationHelpers</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  def get_permission_hash(role, perm_hash, _other)</code>
        </li>
      
        <li class="covered" data-hits="46" data-linenumber="3">
          <span class="hits">46</span>
          
          <code class="ruby">    perm_hash[role] unless perm_hash.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">  # Authorises if the user can perform an action on the object</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">  def authorise?(user, object, action, perm_get_fn = method(:get_permission_hash), other = nil)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">    # Can pass in instance or class</code>
        </li>
      
        <li class="covered" data-hits="61" data-linenumber="11">
          <span class="hits">61</span>
          
          <code class="ruby">    obj_class = object.class == Class ? object : object.class</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="61" data-linenumber="13">
          <span class="hits">61</span>
          
          <code class="ruby">    role_obj = object.role_for(user)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="61" data-linenumber="15">
          <span class="hits">61</span>
          
          <code class="ruby">    return false if role_obj.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="61" data-linenumber="17">
          <span class="hits">61</span>
          
          <code class="ruby">    role = role_obj.to_sym</code>
        </li>
      
        <li class="covered" data-hits="61" data-linenumber="18">
          <span class="hits">61</span>
          
          <code class="ruby">    perm_hash = obj_class.permissions</code>
        </li>
      
        <li class="covered" data-hits="61" data-linenumber="19">
          <span class="hits">61</span>
          
          <code class="ruby">    perms = perm_get_fn.call(role, perm_hash, other)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">    # No permissions, default to false authorise, else check if the action</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">    # is in the permissions hash</code>
        </li>
      
        <li class="covered" data-hits="61" data-linenumber="23">
          <span class="hits">61</span>
          
          <code class="ruby">    perms.nil? ? false : perms.include?(action)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="26">
          <span class="hits">1</span>
          
          <code class="ruby">  module_function :get_permission_hash</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>
          
          <code class="ruby">  module_function :authorise?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="d8ff462429709007b4927004d583f8b63315d80b">
  <div class="header">
    <h3>app/helpers/csv_helper.rb</h3>
    <h4><span class="red">26.32 %</span> covered</h4>
    <div>
      <b>19</b> relevant lines. 
      <span class="green"><b>5</b> lines covered</span> and
      <span class="red"><b>14</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">module CsvHelper</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  def csv_date_to_date(date)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">    return if date.nil? || date.empty?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">    date = date.strip</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">    if date !~ /20\d\d\-\d{1,2}\-\d{1,2}$/ # Matches YYYY-mm-dd by default</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">      if date =~ /\d{1,2}\-\d{1,2}\-20\d\d/ # Matches dd-mm-YYYY</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">        date = date.split(&#39;-&#39;).reverse.join(&#39;-&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">      elsif date =~ /\d{1,2}\/\d{1,2}\/20\d\d$/ # Matches dd/mm/YYYY</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">        date = date.split(&#39;/&#39;).reverse.join(&#39;-&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">      elsif date =~ /\d{1,2}\/\d{1,2}\/\d\d$/ # Matches dd/mm/YY</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">        date = &quot;20#{date.split(&#39;/&#39;).reverse.join(&#39;-&#39;)}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">      elsif date =~ /\d{1,2}\-\d{1,2}\-\d\d$/ # Matches dd-mm-YY</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">        date = &quot;20#{date.split(&#39;-&#39;).reverse.join(&#39;-&#39;)}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">      elsif date =~ /\d{1,2}\-\d{1,2}\-\d\d \d\d:\d\d:\d\d$/ # Matches dd-mm-YY hh:mm:ss</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">        date = date.split(&#39; &#39;).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">        date = &quot;20#{date.split(&#39;-&#39;).reverse.join(&#39;-&#39;)}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">      elsif date =~ /\d{1,2}\/\d{1,2}\/\d\d [\d:]+$/ # Matches dd/mm/YY 00:00:00</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">        date = date.split(&#39; &#39;).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">        date = &quot;20#{date.split(&#39;/&#39;).reverse.join(&#39;-&#39;)}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">    Date.parse(date)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>
          
          <code class="ruby">  def missing_headers(row, headers)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">    headers - row.to_hash.keys</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">  module_function :csv_date_to_date</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="33">
          <span class="hits">1</span>
          
          <code class="ruby">  module_function :missing_headers</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="a175b5576a84efcd5ecf50e290f1fbc03d6ec0b5">
  <div class="header">
    <h3>app/helpers/db_helpers.rb</h3>
    <h4><span class="red">30.0 %</span> covered</h4>
    <div>
      <b>10</b> relevant lines. 
      <span class="green"><b>3</b> lines covered</span> and
      <span class="red"><b>7</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">module DbHelpers</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  def db_concat(*args)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">    env = ENV[&#39;RAILS_ENV&#39;] || &#39;development&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">    adapter = ActiveRecord::Base.configurations[env][&#39;adapter&#39;].to_sym</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">    args.map! { |arg| arg.class == Symbol ? arg.to_s : arg }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">    case adapter</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">    when :mysql, :mysql2</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">      &quot;CONCAT(#{args.join(&#39;,&#39;)})&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">    when :sqlserver</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">      args.join(&#39;+&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">      args.join(&#39;||&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">  module_function :db_concat</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="678b1178790f1aca9dd9e4b615f5ad151a8930a3">
  <div class="header">
    <h3>app/helpers/doubtfire_logger.rb</h3>
    <h4><span class="red">60.0 %</span> covered</h4>
    <div>
      <b>10</b> relevant lines. 
      <span class="green"><b>6</b> lines covered</span> and
      <span class="red"><b>4</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class DoubtfireLogger &lt; ActiveSupport::Logger</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby">  # By default, nil is provided</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">  # Arguments match:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">  #   1. logdev - filename or IO object (STDOUT or STDERR)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">  #   2. shift_age - number of files to keep, or age (e.g., monthly)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">  #   3. shift_size - maximum log file size (only used when shift_age)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">  #                   is a number</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">  # Rails.logger initialises these as nil, so we will do the same</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">  @@logger = DoubtfireLogger.new(Doubtfire::Application.config.paths[&#39;log&#39;].first)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">  # Singleton logger returned</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.logger</code>
        </li>
      
        <li class="covered" data-hits="42" data-linenumber="17">
          <span class="hits">42</span>
          
          <code class="ruby">    @@logger</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">  # Override fatal and error to puts to the console</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">  # as well as log using Rails</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">  def fatal(msg)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">    puts msg</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">    super(msg)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">  def error(msg)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">    puts msg</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">    super(msg)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="4c6715f7912a828087ba329d8521f39b10e64559">
  <div class="header">
    <h3>app/helpers/file_helper.rb</h3>
    <h4><span class="red">43.05 %</span> covered</h4>
    <div>
      <b>223</b> relevant lines. 
      <span class="green"><b>96</b> lines covered</span> and
      <span class="red"><b>127</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;zip&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;tmpdir&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">module FileHelper</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  extend LogHelper</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  extend TimeoutHelper</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">  extend MimeCheckHelpers</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">  # Test if a file should be accepted based on an expected kind</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">  # - file is passed the file uploaded to Doubtfire (a hash with all relevant data about the file)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">  def accept_file(file, name, kind)</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="14">
          <span class="hits">5</span>
          
          <code class="ruby">    valid = true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="16">
          <span class="hits">5</span>
          
          <code class="ruby">    case kind</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">    when &#39;image&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">      accept = [&#39;image/png&#39;, &#39;image/gif&#39;, &#39;image/bmp&#39;, &#39;image/tiff&#39;, &#39;image/jpeg&#39;, &#39;image/x-ms-bmp&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">    when &#39;code&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">      accept = [&#39;text/x-pascal&#39;, &#39;text/x-c&#39;, &#39;text/x-c++&#39;, &#39;text/plain&#39;, &#39;text/&#39;, &#39;application/javascript, text/html&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">                &#39;text/css&#39;, &#39;text/x-ruby&#39;, &#39;text/coffeescript&#39;, &#39;text/x-scss&#39;, &#39;application/json&#39;, &#39;text/xml&#39;, &#39;application/xml&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">                &#39;text/x-yaml&#39;, &#39;application/xml&#39;, &#39;text/x-typescript&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">    when &#39;document&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">      accept = [ # -- one day&quot;application/vnd.openxmlformats-officedocument.wordprocessingml.document&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">        # --&quot;application/msword&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">        &#39;application/pdf&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">      ]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">      valid = pdf_valid? file.tempfile.path</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">    when &#39;audio&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="30">
          <span class="hits">1</span>
          
          <code class="ruby">      accept = [&#39;audio/&#39;, &#39;video/webm&#39;, &#39;application/ogg&#39;, &#39;application/octet-stream&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">    when &#39;comment_attachment&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">      accept = [&#39;audio/&#39;, &#39;video/webm&#39;, &#39;application/ogg&#39;, &#39;image/&#39;, &#39;application/pdf&#39;, &#39;application/octet-stream&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">    when &#39;video&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">      accept = [&#39;video/mp4&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">      logger.error &quot;Unknown type &#39;#{kind}&#39; provided for &#39;#{name}&#39;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">      return false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="40">
          <span class="hits">5</span>
          
          <code class="ruby">    mime_in_list?(file.tempfile.path, accept) &amp;&amp; valid</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">  # Sanitize the passed in paths, and ensure each part is valid</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">  # Will kill things like ../ etc or spaces in paths</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="47">
          <span class="hits">1</span>
          
          <code class="ruby">  def sanitized_path(*paths)</code>
        </li>
      
        <li class="covered" data-hits="137" data-linenumber="48">
          <span class="hits">137</span>
          
          <code class="ruby">    safe_paths = paths.map do |path_name|</code>
        </li>
      
        <li class="covered" data-hits="216" data-linenumber="49">
          <span class="hits">216</span>
          
          <code class="ruby">      path_name.strip.tap do |name|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">        # Finally, replace all non alphanumeric, underscore</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">        # or periods with underscore</code>
        </li>
      
        <li class="covered" data-hits="216" data-linenumber="52">
          <span class="hits">216</span>
          
          <code class="ruby">        name.gsub! /[^\w\-]/, &#39;_&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="137" data-linenumber="56">
          <span class="hits">137</span>
          
          <code class="ruby">    File.join(safe_paths)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">  # Sanitize the passed in filename -- should not include any path details</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="62">
          <span class="hits">1</span>
          
          <code class="ruby">  def sanitized_filename(filename)</code>
        </li>
      
        <li class="covered" data-hits="66" data-linenumber="63">
          <span class="hits">66</span>
          
          <code class="ruby">    filename.strip.tap do |name|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">      # NOTE: File.basename doesn&#39;t work right with Windows paths on Unix</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">      # get only the filename, not the whole path</code>
        </li>
      
        <li class="covered" data-hits="66" data-linenumber="66">
          <span class="hits">66</span>
          
          <code class="ruby">      name.sub! /\A.*(\\|\/)/, &#39;&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">      # Finally, replace all non alphanumeric, underscore</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">      # or periods with underscore</code>
        </li>
      
        <li class="covered" data-hits="66" data-linenumber="69">
          <span class="hits">66</span>
          
          <code class="ruby">      name.gsub! /[^\w\.\-]/, &#39;_&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="73">
          <span class="hits">1</span>
          
          <code class="ruby">  def task_file_dir_for_unit(unit, create = true)</code>
        </li>
      
        <li class="covered" data-hits="66" data-linenumber="74">
          <span class="hits">66</span>
          
          <code class="ruby">    file_server = Doubtfire::Application.config.student_work_dir</code>
        </li>
      
        <li class="covered" data-hits="66" data-linenumber="75">
          <span class="hits">66</span>
          
          <code class="ruby">    dst = &quot;#{file_server}/&quot; # trust the server config and passed in type for paths</code>
        </li>
      
        <li class="covered" data-hits="66" data-linenumber="76">
          <span class="hits">66</span>
          
          <code class="ruby">    dst &lt;&lt; sanitized_path(&quot;#{unit.code}-#{unit.id}&quot;, &#39;TaskFiles&#39;) &lt;&lt; &#39;/&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="66" data-linenumber="78">
          <span class="hits">66</span>
          
          <code class="ruby">    FileUtils.mkdir_p dst if create &amp;&amp; (!Dir.exist? dst)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="66" data-linenumber="80">
          <span class="hits">66</span>
          
          <code class="ruby">    dst</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="83">
          <span class="hits">1</span>
          
          <code class="ruby">  def student_group_work_dir(type, group_submission, task = nil, create = false)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="84">
          
          
          <code class="ruby">    return nil unless group_submission</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="86">
          
          
          <code class="ruby">    file_server = Doubtfire::Application.config.student_work_dir</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="87">
          
          
          <code class="ruby">    dst = &quot;#{file_server}/&quot; # trust the server config and passed in type for paths</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="89">
          
          
          <code class="ruby">    group = group_submission.group</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="90">
          
          
          <code class="ruby">    return nil unless group</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="91">
          
          
          <code class="ruby">    unit = group.unit</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="93">
          
          
          <code class="ruby">    if type == :pdf</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="94">
          
          
          <code class="ruby">      dst &lt;&lt; sanitized_path(&quot;#{unit.code}-#{unit.id}&quot;, &quot;Group-#{group.id}&quot;, type.to_s) &lt;&lt; &#39;/&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby">    elsif type == :done</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="96">
          
          
          <code class="ruby">      dst &lt;&lt; sanitized_path(&quot;#{unit.code}-#{unit.id}&quot;, &quot;Group-#{group.id}&quot;, type.to_s, group_submission.id.to_s) &lt;&lt; &#39;/&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby">    elsif type == :plagarism</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="98">
          
          
          <code class="ruby">      dst &lt;&lt; sanitized_path(&quot;#{unit.code}-#{unit.id}&quot;, &quot;Group-#{group.id}&quot;, type.to_s, group_submission.id.to_s) &lt;&lt; &#39;/&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby">    else # new and in_process -- just have task id -- will link to group when done etc.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby">      # Add task id to dst if we want task</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="101">
          
          
          <code class="ruby">      raise &#39;Unable to locate file!&#39; if task.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="102">
          
          
          <code class="ruby">      dst &lt;&lt; &quot;#{type}/#{task.id}/&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="105">
          
          
          <code class="ruby">    FileUtils.mkdir_p(dst) if create</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="106">
          
          
          <code class="ruby">    dst</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby">  # Generates a path for storing student work</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby">  # type = [:new, :in_process, :done, :pdf, :plagarism]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="113">
          <span class="hits">1</span>
          
          <code class="ruby">  def student_work_dir(type = nil, task = nil, create = true)</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="114">
          <span class="hits">8</span>
          
          <code class="ruby">    if task &amp;&amp; task.group_task?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="115">
          
          
          <code class="ruby">      dst = student_group_work_dir type, task.group_submission, task</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="117">
          <span class="hits">8</span>
          
          <code class="ruby">      file_server = Doubtfire::Application.config.student_work_dir</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="118">
          <span class="hits">8</span>
          
          <code class="ruby">      dst = &quot;#{file_server}/&quot; # trust the server config and passed in type for paths</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="120">
          <span class="hits">8</span>
          
          <code class="ruby">      if !(type.nil? || task.nil?)</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="121">
          <span class="hits">8</span>
          
          <code class="ruby">        if type == :pdf</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="122">
          
          
          <code class="ruby">          dst &lt;&lt; sanitized_path(&quot;#{task.project.unit.code}-#{task.project.unit.id}&quot;, task.project.student.username.to_s, type.to_s) &lt;&lt; &#39;/&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby">        elsif type == :done</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="124">
          <span class="hits">3</span>
          
          <code class="ruby">          dst &lt;&lt; sanitized_path(&quot;#{task.project.unit.code}-#{task.project.unit.id}&quot;, task.project.student.username.to_s, type.to_s, task.id.to_s) &lt;&lt; &#39;/&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="125">
          
          
          <code class="ruby">        elsif type == :plagarism</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="126">
          
          
          <code class="ruby">          dst &lt;&lt; sanitized_path(&quot;#{task.project.unit.code}-#{task.project.unit.id}&quot;, task.project.student.username.to_s, type.to_s, task.id.to_s) &lt;&lt; &#39;/&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby">        elsif type == :comment</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="128">
          <span class="hits">2</span>
          
          <code class="ruby">          dst &lt;&lt; sanitized_path(&quot;#{task.project.unit.code}-#{task.project.unit.id}&quot;, task.project.student.username.to_s, type.to_s) &lt;&lt; &#39;/&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="129">
          
          
          <code class="ruby">        else # new and in_process -- just have task id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="130">
          
          
          <code class="ruby">          # Add task id to dst if we want task</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="131">
          <span class="hits">3</span>
          
          <code class="ruby">          dst &lt;&lt; &quot;#{type}/#{task.id}/&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="132">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="133">
          
          
          <code class="ruby">      elsif !type.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="134">
          
          
          <code class="ruby">        if [:in_process, :new].include? type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="135">
          
          
          <code class="ruby">          # Add task id to dst if we want task</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="136">
          
          
          <code class="ruby">          dst &lt;&lt; &quot;#{type}/&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="138">
          
          
          <code class="ruby">          raise &#39;Error in request to student work directory&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="139">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="140">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="141">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="142">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="143">
          
          
          <code class="ruby">    # Create current dst directory should it not exist</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="144">
          <span class="hits">8</span>
          
          <code class="ruby">    FileUtils.mkdir_p(dst) if create</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="145">
          <span class="hits">8</span>
          
          <code class="ruby">    dst</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="146">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="147">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="148">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="149">
          
          
          <code class="ruby">  # Generates a path for storing student portfolios</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="150">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="151">
          <span class="hits">1</span>
          
          <code class="ruby">  def student_portfolio_dir(project, create = true)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="152">
          
          
          <code class="ruby">    file_server = Doubtfire::Application.config.student_work_dir</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="153">
          
          
          <code class="ruby">    dst = &quot;#{file_server}/portfolio/&quot; # trust the server config and passed in type for paths</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="154">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="155">
          
          
          <code class="ruby">    dst &lt;&lt; sanitized_path(&quot;#{project.unit.code}-#{project.unit.id}&quot;, project.student.username.to_s)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="156">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="157">
          
          
          <code class="ruby">    # Create current dst directory should it not exist</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="158">
          
          
          <code class="ruby">    FileUtils.mkdir_p(dst) if create</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="159">
          
          
          <code class="ruby">    dst</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="160">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="161">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="162">
          <span class="hits">1</span>
          
          <code class="ruby">  def comment_attachment_path(task_comment, attachment_extension)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="163">
          <span class="hits">2</span>
          
          <code class="ruby">    &quot;#{File.join( student_work_dir(:comment, task_comment.task), &quot;#{task_comment.id.to_s}#{attachment_extension}&quot;)}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="164">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="165">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="166">
          <span class="hits">1</span>
          
          <code class="ruby">  def compress_image(path)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="167">
          
          
          <code class="ruby">    return true if File.size?(path) &lt; 500_000</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="168">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="169">
          
          
          <code class="ruby">    compress_folder = File.join(Dir.tmpdir, &#39;doubtfire&#39;, &#39;compress&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="170">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="171">
          
          
          <code class="ruby">    FileUtils.mkdir compress_folder unless File.directory? compress_folder</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="172">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="173">
          
          
          <code class="ruby">    tmp_file = File.join(compress_folder, &quot;#{File.dirname(path).split(File::Separator).last}-file#{File.extname(path)}&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="174">
          
          
          <code class="ruby">    logger.debug &quot;File helper has started compressing #{path} to #{tmp_file}...&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="175">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="176">
          
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="177">
          
          
          <code class="ruby">      exec = &quot;convert -delete 1--1 -quiet -strip -density 72 -quality 85% -resize 2048x2048\\&gt; \</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="178">
          
          
          <code class="ruby">              \&quot;#{path}\&quot; \</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="179">
          
          
          <code class="ruby">              \&quot;#{tmp_file}\&quot; &gt;&gt;/dev/null 2&gt;&gt;/dev/null&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="180">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="181">
          
          
          <code class="ruby">      did_compress = system_try_within 40, &#39;compressing image using convert&#39;, exec</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="182">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="183">
          
          
          <code class="ruby">      FileUtils.mv tmp_file, path if did_compress</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="184">
          
          
          <code class="ruby">    ensure</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="185">
          
          
          <code class="ruby">      FileUtils.rm tmp_file if File.exist? tmp_file</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="186">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="187">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="188">
          
          
          <code class="ruby">    did_compress</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="189">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="190">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="191">
          <span class="hits">1</span>
          
          <code class="ruby">  def compress_image_to_dest(source, dest)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="192">
          <span class="hits">1</span>
          
          <code class="ruby">    exec = &quot;convert -delete 1--1 -quiet -strip -density 72 -quality 85% -resize 2048x2048\\&gt; \</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="193">
          
          
          <code class="ruby">            \&quot;#{source}\&quot; \</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="194">
          
          
          <code class="ruby">            \&quot;#{dest}\&quot; &gt;&gt;/dev/null 2&gt;&gt;/dev/null&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="195">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="196">
          <span class="hits">1</span>
          
          <code class="ruby">    did_compress = system_try_within 40, &#39;compressing image using convert&#39;, exec</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="197">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="198">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="199">
          <span class="hits">1</span>
          
          <code class="ruby">  def compress_pdf(path, max_size = 2_500_000)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="200">
          
          
          <code class="ruby">    # trusting path... as it needs to be replaced</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="201">
          
          
          <code class="ruby">    logger.debug &quot;Compressing PDF #{path} (#{File.size?(path)} bytes) using GhostScript&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="202">
          
          
          <code class="ruby">    # only compress things over max_size -- defaults to 2.5mb</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="203">
          
          
          <code class="ruby">    return if File.size?(path) &lt; max_size</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="204">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="205">
          
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="206">
          
          
          <code class="ruby">      tmp_file = File.join(Dir.tmpdir, &#39;doubtfire&#39;, &#39;compress&#39;, &quot;#{File.dirname(path).split(File::Separator).last}-file.pdf&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="207">
          
          
          <code class="ruby">      FileUtils.mkdir_p(File.join(Dir.tmpdir, &#39;doubtfire&#39;, &#39;compress&#39;))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="208">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="209">
          
          
          <code class="ruby">      exec = &quot;gs -sDEVICE=pdfwrite \</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="210">
          
          
          <code class="ruby">                 -dCompatibilityLevel=1.3 \</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="211">
          
          
          <code class="ruby">                 -dDetectDuplicateImages=true \</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="212">
          
          
          <code class="ruby">                 -dPDFSETTINGS=/screen \</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="213">
          
          
          <code class="ruby">                 -dNOPAUSE \</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="214">
          
          
          <code class="ruby">                 -dBATCH \</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="215">
          
          
          <code class="ruby">                 -dQUIET \</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="216">
          
          
          <code class="ruby">                 -sOutputFile=\&quot;#{tmp_file}\&quot; \</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="217">
          
          
          <code class="ruby">                 \&quot;#{path}\&quot; \</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="218">
          
          
          <code class="ruby">                 &gt;&gt;/dev/null 2&gt;&gt;/dev/null&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="219">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="220">
          
          
          <code class="ruby">      # try with ghostscript</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="221">
          
          
          <code class="ruby">      did_compress = system_try_within 30, &#39;compressing PDF using ghostscript&#39;, exec</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="222">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="223">
          
          
          <code class="ruby">      unless did_compress</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="224">
          
          
          <code class="ruby">        logger.info &quot;Failed to compress PDF #{path} using GhostScript. Trying with convert&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="225">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="226">
          
          
          <code class="ruby">        exec = &quot;convert \&quot;#{path}\&quot; \</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="227">
          
          
          <code class="ruby">                -compress Zip \</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="228">
          
          
          <code class="ruby">                \&quot;#{tmp_file}\&quot; \</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="229">
          
          
          <code class="ruby">                &gt;&gt;/dev/null 2&gt;&gt;/dev/null&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="230">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="231">
          
          
          <code class="ruby">        # try with convert</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="232">
          
          
          <code class="ruby">        did_compress = system_try_within 40, &#39;compressing PDF using convert&#39;, exec</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="233">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="234">
          
          
          <code class="ruby">        unless did_compress</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="235">
          
          
          <code class="ruby">          logger.error &quot;Failed to compress PDF #{path} using convert. Cannot compress this PDF. Command was:\n\t#{exec}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="236">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="237">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="238">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="239">
          
          
          <code class="ruby">      FileUtils.mv tmp_file, path if did_compress</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="240">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="241">
          
          
          <code class="ruby">    rescue =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="242">
          
          
          <code class="ruby">      logger.error &quot;Failed to compress PDF #{path}. Rescued with error:\n\t#{e.message}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="243">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="244">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="245">
          
          
          <code class="ruby">    FileUtils.rm tmp_file if File.exist? tmp_file</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="246">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="247">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="248">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="249">
          
          
          <code class="ruby">  # Move files between stages - new -&gt; in process -&gt; done</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="250">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="251">
          <span class="hits">1</span>
          
          <code class="ruby">  def move_files(from_path, to_path)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="252">
          
          
          <code class="ruby">    # move into the new dir - and mv files to the in_process_dir</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="253">
          
          
          <code class="ruby">    pwd = FileUtils.pwd</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="254">
          
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="255">
          
          
          <code class="ruby">      FileUtils.mkdir_p(to_path) unless Dir.exist? to_path</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="256">
          
          
          <code class="ruby">      Dir.chdir(from_path)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="257">
          
          
          <code class="ruby">      FileUtils.mv Dir.glob(&#39;*&#39;), to_path, force: true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="258">
          
          
          <code class="ruby">      Dir.chdir(to_path)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="259">
          
          
          <code class="ruby">      begin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="260">
          
          
          <code class="ruby">        # remove from_path as files are now &quot;in process&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="261">
          
          
          <code class="ruby">        FileUtils.rm_r(from_path)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="262">
          
          
          <code class="ruby">      rescue</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="263">
          
          
          <code class="ruby">        logger.warn &quot;failed to rm #{from_path}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="264">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="265">
          
          
          <code class="ruby">    ensure</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="266">
          
          
          <code class="ruby">      if FileUtils.pwd != pwd</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="267">
          
          
          <code class="ruby">        if Dir.exist? pwd</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="268">
          
          
          <code class="ruby">          FileUtils.chdir(pwd)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="269">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="270">
          
          
          <code class="ruby">          FileUtils.chdir(student_work_dir)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="271">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="272">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="273">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="274">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="275">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="276">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="277">
          
          
          <code class="ruby">  # Tests if a PDF is valid / corrupt</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="278">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="279">
          <span class="hits">1</span>
          
          <code class="ruby">  def pdf_valid?(filename)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="280">
          
          
          <code class="ruby">    # Scan last 1024 bytes for the EOF mark</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="281">
          <span class="hits">1</span>
          
          <code class="ruby">    return false unless File.exist? filename</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="282">
          <span class="hits">1</span>
          
          <code class="ruby">    File.open(filename) do |f|</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="283">
          <span class="hits">1</span>
          
          <code class="ruby">      f.seek -4096, IO::SEEK_END unless f.size &lt;= 4096</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="284">
          <span class="hits">1</span>
          
          <code class="ruby">      f.read.include? &#39;%%EOF&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="285">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="286">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="287">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="288">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="289">
          
          
          <code class="ruby">  # Copy a PDF into place</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="290">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="291">
          <span class="hits">1</span>
          
          <code class="ruby">  def copy_pdf(file, dest_path)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="292">
          
          
          <code class="ruby">    if pdf_valid? file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="293">
          
          
          <code class="ruby">      compress_pdf(file)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="294">
          
          
          <code class="ruby">      FileUtils.cp file, dest_path</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="295">
          
          
          <code class="ruby">      true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="296">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="297">
          
          
          <code class="ruby">      false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="298">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="299">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="300">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="301">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="302">
          
          
          <code class="ruby">  # Read the file and return its contents as a string</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="303">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="304">
          <span class="hits">1</span>
          
          <code class="ruby">  def read_file_to_str(filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="305">
          
          
          <code class="ruby">    result = &#39;&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="306">
          
          
          <code class="ruby">    f = File.open(filename, &#39;r&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="307">
          
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="308">
          
          
          <code class="ruby">      f.each_line do |line|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="309">
          
          
          <code class="ruby">        result += line</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="310">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="311">
          
          
          <code class="ruby">    ensure</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="312">
          
          
          <code class="ruby">      f.close unless f.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="313">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="314">
          
          
          <code class="ruby">    result</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="315">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="316">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="317">
          <span class="hits">1</span>
          
          <code class="ruby">  def path_to_plagarism_html(match_link)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="318">
          
          
          <code class="ruby">    to_dir = student_work_dir(:plagarism, match_link.task)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="319">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="320">
          
          
          <code class="ruby">    File.join(to_dir, &quot;link_#{match_link.other_task.id}.html&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="321">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="322">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="323">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="324">
          
          
          <code class="ruby">  # Save the passed in html to a file.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="325">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="326">
          <span class="hits">1</span>
          
          <code class="ruby">  def save_plagiarism_html(match_link, html)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="327">
          
          
          <code class="ruby">    File.open(path_to_plagarism_html(match_link), &#39;w&#39;) do |out_file|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="328">
          
          
          <code class="ruby">      out_file.puts html</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="329">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="330">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="331">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="332">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="333">
          
          
          <code class="ruby">  # Delete the html for a plagarism link</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="334">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="335">
          <span class="hits">1</span>
          
          <code class="ruby">  def delete_plagarism_html(match_link)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="336">
          
          
          <code class="ruby">    rm_file = path_to_plagarism_html(match_link)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="337">
          
          
          <code class="ruby">    if File.exist? rm_file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="338">
          
          
          <code class="ruby">      FileUtils.rm(rm_file)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="339">
          
          
          <code class="ruby">      to_dir = student_work_dir(:plagarism, match_link.task)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="340">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="341">
          
          
          <code class="ruby">      FileUtils.rm_rf(to_dir) if Dir[File.join(to_dir, &#39;*.html&#39;)].count.zero?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="342">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="343">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="344">
          
          
          <code class="ruby">    self</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="345">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="346">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="347">
          <span class="hits">1</span>
          
          <code class="ruby">  def delete_group_submission(group_submission)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="348">
          
          
          <code class="ruby">    pdf_file = PortfolioEvidence.final_pdf_path_for_group_submission(group_submission)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="349">
          
          
          <code class="ruby">    logger.debug &quot;Deleting group submission PDF file #{pdf_file}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="350">
          
          
          <code class="ruby">    FileUtils.rm pdf_file if File.exist? pdf_file</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="351">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="352">
          
          
          <code class="ruby">    done_file = zip_file_path_for_group_done_task(group_submission)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="353">
          
          
          <code class="ruby">    FileUtils.rm done_file if File.exist? done_file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="354">
          
          
          <code class="ruby">    self</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="355">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="356">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="357">
          <span class="hits">1</span>
          
          <code class="ruby">  def zip_file_path_for_group_done_task(group_submission)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="358">
          
          
          <code class="ruby">    zip_file = &quot;#{student_group_work_dir(:done, group_submission)[0..-2]}.zip&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="359">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="360">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="361">
          <span class="hits">1</span>
          
          <code class="ruby">  def zip_file_path_for_done_task(task)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="362">
          
          
          <code class="ruby">    zip_file = &quot;#{student_work_dir(:done, task, false)[0..-2]}.zip&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="363">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="364">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="365">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="366">
          
          
          <code class="ruby">  # Compress the done files for a student - includes cover page and work uploaded</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="367">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="368">
          <span class="hits">1</span>
          
          <code class="ruby">  def compress_done_files(task)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="369">
          
          
          <code class="ruby">    task_dir = student_work_dir(:done, task, false)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="370">
          
          
          <code class="ruby">    zip_file = zip_file_path_for_done_task(task)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="371">
          
          
          <code class="ruby">    return if zip_file.nil? || (!Dir.exist? task_dir)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="372">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="373">
          
          
          <code class="ruby">    FileUtils.rm(zip_file) if File.exist? zip_file</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="374">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="375">
          
          
          <code class="ruby">    input_files = Dir.entries(task_dir).select { |f| (f =~ /^\d{3}\.(cover|document|code|image)/).zero? }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="376">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="377">
          
          
          <code class="ruby">    Zip::File.open(zip_file, Zip::File::CREATE) do |zip|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="378">
          
          
          <code class="ruby">      zip.mkdir task.id.to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="379">
          
          
          <code class="ruby">      input_files.each do |in_file|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="380">
          
          
          <code class="ruby">        zip.add &quot;#{task.id}/#{in_file}&quot;, &quot;#{task_dir}#{in_file}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="381">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="382">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="383">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="384">
          
          
          <code class="ruby">    FileUtils.rm_rf(task_dir)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="385">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="386">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="387">
          <span class="hits">1</span>
          
          <code class="ruby">  def write_entries_to_zip(entries, disk_root_path, zip_root_path, path, zip)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="388">
          
          
          <code class="ruby">    entries.each do |e|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="389">
          
          
          <code class="ruby">      # puts &quot;Adding entry #{e}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="390">
          
          
          <code class="ruby">      file_path = path == &#39;&#39; ? e : File.join(path, e)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="391">
          
          
          <code class="ruby">      zip_file_path = zip_root_path == &#39;&#39; ? file_path : File.join(zip_root_path, file_path)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="392">
          
          
          <code class="ruby">      disk_file_path = File.join(disk_root_path, file_path)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="393">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="394">
          
          
          <code class="ruby">      if File.directory? disk_file_path</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="395">
          
          
          <code class="ruby">        # puts &quot;Making dir: #{zip_file_path} for #{disk_file_path}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="396">
          
          
          <code class="ruby">        zip.mkdir(zip_file_path)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="397">
          
          
          <code class="ruby">        subdir = (Dir.entries(disk_file_path) - %w(. ..))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="398">
          
          
          <code class="ruby">        # puts &quot;subdir: #{subdir}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="399">
          
          
          <code class="ruby">        write_entries_to_zip(subdir, disk_root_path, zip_root_path, file_path, zip)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="400">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="401">
          
          
          <code class="ruby">        # puts &quot;Adding file: #{disk_file_path} -- #{File.exists? disk_file_path}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="402">
          
          
          <code class="ruby">        zip.get_output_stream(zip_file_path) do |f|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="403">
          
          
          <code class="ruby">          f.puts(File.open(disk_file_path, &#39;rb&#39;).read)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="404">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="405">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="406">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="407">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="408">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="409">
          <span class="hits">1</span>
          
          <code class="ruby">  def recursively_add_dir_to_zip(zip, dir, zip_root_path)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="410">
          
          
          <code class="ruby">    entries = Dir.entries(dir) - %w(. ..)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="411">
          
          
          <code class="ruby">    zip.mkdir(zip_root_path)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="412">
          
          
          <code class="ruby">    write_entries_to_zip(entries, dir, zip_root_path, &#39;&#39;, zip)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="413">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="414">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="415">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="416">
          
          
          <code class="ruby">  # Extract the files from the zip file for this tasks, and replace in new so that it is created</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="417">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="418">
          <span class="hits">1</span>
          
          <code class="ruby">  def move_compressed_task_to_new(task)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="419">
          
          
          <code class="ruby">    # student_work_dir(:new, task) # create task dir</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="420">
          
          
          <code class="ruby">    task.extract_file_from_done student_work_dir(:new), &#39;*&#39;, -&gt;(_task, to_path, name) { &quot;#{to_path}#{name}&quot; }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="421">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="422">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="423">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="424">
          
          
          <code class="ruby">  # Ensure that the contents of a file appear to be valid UTF8, on retry convert to ASCII to ensure</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="425">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="426">
          <span class="hits">1</span>
          
          <code class="ruby">  def ensure_utf8_code(output_filename, force_ascii)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="427">
          
          
          <code class="ruby">    # puts &quot;Converting #{output_filename} to utf8&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="428">
          
          
          <code class="ruby">    tmp_filename = Dir::Tmpname.create( [ &quot;new&quot;, &quot;.code&quot; ] ) { }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="429">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="430">
          
          
          <code class="ruby">    # Convert to utf8 from read encoding</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="431">
          
          
          <code class="ruby">    if force_ascii</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="432">
          
          
          <code class="ruby">      `iconv -c -t ascii &quot;#{output_filename}&quot; &gt; &quot;#{tmp_filename}&quot;`</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="433">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="434">
          
          
          <code class="ruby">      `iconv -c -t UTF-8 &quot;#{output_filename}&quot; &gt; &quot;#{tmp_filename}&quot;`</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="435">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="436">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="437">
          
          
          <code class="ruby">    # Move into place</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="438">
          
          
          <code class="ruby">    FileUtils.mv(tmp_filename, output_filename)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="439">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="440">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="441">
          
          
          <code class="ruby">  # Export functions as module functions</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="442">
          <span class="hits">1</span>
          
          <code class="ruby">  module_function :accept_file</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="443">
          <span class="hits">1</span>
          
          <code class="ruby">  module_function :sanitized_path</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="444">
          <span class="hits">1</span>
          
          <code class="ruby">  module_function :sanitized_filename</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="445">
          <span class="hits">1</span>
          
          <code class="ruby">  module_function :task_file_dir_for_unit</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="446">
          <span class="hits">1</span>
          
          <code class="ruby">  module_function :student_group_work_dir</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="447">
          <span class="hits">1</span>
          
          <code class="ruby">  module_function :student_work_dir</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="448">
          <span class="hits">1</span>
          
          <code class="ruby">  module_function :student_portfolio_dir</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="449">
          <span class="hits">1</span>
          
          <code class="ruby">  module_function :comment_attachment_path</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="450">
          <span class="hits">1</span>
          
          <code class="ruby">  module_function :compress_image</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="451">
          <span class="hits">1</span>
          
          <code class="ruby">  module_function :compress_image_to_dest</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="452">
          <span class="hits">1</span>
          
          <code class="ruby">  module_function :compress_pdf</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="453">
          <span class="hits">1</span>
          
          <code class="ruby">  module_function :move_files</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="454">
          <span class="hits">1</span>
          
          <code class="ruby">  module_function :pdf_valid?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="455">
          <span class="hits">1</span>
          
          <code class="ruby">  module_function :copy_pdf</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="456">
          <span class="hits">1</span>
          
          <code class="ruby">  module_function :read_file_to_str</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="457">
          <span class="hits">1</span>
          
          <code class="ruby">  module_function :path_to_plagarism_html</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="458">
          <span class="hits">1</span>
          
          <code class="ruby">  module_function :save_plagiarism_html</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="459">
          <span class="hits">1</span>
          
          <code class="ruby">  module_function :delete_plagarism_html</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="460">
          <span class="hits">1</span>
          
          <code class="ruby">  module_function :delete_group_submission</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="461">
          <span class="hits">1</span>
          
          <code class="ruby">  module_function :zip_file_path_for_group_done_task</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="462">
          <span class="hits">1</span>
          
          <code class="ruby">  module_function :zip_file_path_for_done_task</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="463">
          <span class="hits">1</span>
          
          <code class="ruby">  module_function :compress_done_files</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="464">
          <span class="hits">1</span>
          
          <code class="ruby">  module_function :move_compressed_task_to_new</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="465">
          <span class="hits">1</span>
          
          <code class="ruby">  module_function :recursively_add_dir_to_zip</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="466">
          <span class="hits">1</span>
          
          <code class="ruby">  module_function :write_entries_to_zip</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="467">
          <span class="hits">1</span>
          
          <code class="ruby">  module_function :ensure_utf8_code</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="468">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="ab98b97adbb651c679d0fee480de13cf9bc9003d">
  <div class="header">
    <h3>app/helpers/log_helper.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>5</b> relevant lines. 
      <span class="green"><b>5</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;doubtfire_logger&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"># A universal logger</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">module LogHelper</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">  # Logger function returns the singleton logger</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">  def logger</code>
        </li>
      
        <li class="covered" data-hits="41" data-linenumber="11">
          <span class="hits">41</span>
          
          <code class="ruby">    DoubtfireLogger.logger</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">  # Export functions as module functions</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">  module_function :logger</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="48ae01723f16f085934910f5b27509261e976d06">
  <div class="header">
    <h3>app/helpers/mime-check-helpers.rb</h3>
    <h4><span class="red">56.67 %</span> covered</h4>
    <div>
      <b>30</b> relevant lines. 
      <span class="green"><b>17</b> lines covered</span> and
      <span class="red"><b>13</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># getting file MIME types</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;filemagic&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">module MimeCheckHelpers</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  extend LogHelper</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">  def mime_type(file_path)</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="8">
          <span class="hits">6</span>
          
          <code class="ruby">    fm = FileMagic.new(FileMagic::MAGIC_MIME)</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="9">
          <span class="hits">6</span>
          
          <code class="ruby">    fm.file(file_path)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">  def excel_to_csv(file, extn)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">    ss = Roo::Spreadsheet.open(file, extension: extn)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">    File.unlink(file)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">    File.write(file, ss.sheet(ss.sheets.first).to_csv)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">  def ensure_csv!(file_path)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">    file_path = file_path.path if file_path.is_a?(Tempfile)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">    type = mime_type(file_path)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">    # check mime is correct before uploading</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">    accept = [&#39;text/&#39;, &#39;text/plain&#39;, &#39;text/csv&#39;, &#39;application/vnd.ms-excel&#39;, &#39;application/vnd.openxmlformats-officedocument.spreadsheetml.sheet&#39;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">    unless type.start_with?(*accept)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">      error!({ error: &quot;File given is not a csv file - detected #{type}&quot; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">    # Convert xls files to csv...</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">    if type.start_with? &#39;application/vnd.ms-excel&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">      excel_to_csv file_path, :xls</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">    elsif type.start_with? &#39;application/vnd.openxmlformats-officedocument.spreadsheetml.sheet&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">      excel_to_csv file_path, :xlsx</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="37">
          <span class="hits">1</span>
          
          <code class="ruby">  def mime_in_list?(file, type_list)</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="38">
          <span class="hits">6</span>
          
          <code class="ruby">    type = mime_type(file)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">    # check mime is correct before uploading</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="41">
          <span class="hits">6</span>
          
          <code class="ruby">    type.start_with?(*type_list)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="44">
          <span class="hits">1</span>
          
          <code class="ruby">  def check_mime_against_list!(file, expect, type_list)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="45">
          <span class="hits">1</span>
          
          <code class="ruby">    unless mime_in_list?(file, type_list)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">      error!({ error: &quot;File given is not a #{expect} file - detected #{mime_type}&quot; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="50">
          <span class="hits">1</span>
          
          <code class="ruby">  module_function :ensure_csv!</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="51">
          <span class="hits">1</span>
          
          <code class="ruby">  module_function :check_mime_against_list!</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="52">
          <span class="hits">1</span>
          
          <code class="ruby">  module_function :mime_in_list?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="53">
          <span class="hits">1</span>
          
          <code class="ruby">  module_function :mime_type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="cf0ff7ed81eb0a82a2363a983af26afbc2be9e1e">
  <div class="header">
    <h3>app/helpers/timeout_helper.rb</h3>
    <h4><span class="green">92.86 %</span> covered</h4>
    <div>
      <b>14</b> relevant lines. 
      <span class="green"><b>13</b> lines covered</span> and
      <span class="red"><b>1</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">module TimeoutHelper</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  extend LogHelper</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">  # Timeout operation</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">  # Usage:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">  #   try_within 30, &quot;doing the thing&quot; do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">  #     long_operation()</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">  #   end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">  def try_within(sec, timeout_message = &#39;operation&#39;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="14">
          <span class="hits">2</span>
          
          <code class="ruby">      Timeout::timeout(sec) { yield }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">    rescue</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">      logger.error &quot;Timeout when #{timeout_message} after #{sec}s&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">  # Timeout system call</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">  # Usage:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">  #   system_try_within 30, &quot;doing the thing&quot;, &quot;gs do.pdf the.pdf thing.pdf&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="26">
          <span class="hits">1</span>
          
          <code class="ruby">  def system_try_within(sec, timeout_message, command)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">    # shell script to kill command after timeout</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">    timeout_exec = Rails.root.join(&#39;lib&#39;, &#39;shell&#39;, &#39;timeout.sh&#39;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">    result = false</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="30">
          <span class="hits">1</span>
          
          <code class="ruby">    try_within sec, timeout_message do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>
          
          <code class="ruby">      result = system &quot;#{timeout_exec} -t #{sec} nice -n 10 #{command}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="33">
          <span class="hits">1</span>
          
          <code class="ruby">    result</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">  # Export functions as module functions</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="37">
          <span class="hits">1</span>
          
          <code class="ruby">  module_function :try_within</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="38">
          <span class="hits">1</span>
          
          <code class="ruby">  module_function :system_try_within</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="628cd95164a8d3cb9f794f3af7cbed0995669036">
  <div class="header">
    <h3>app/mailers/convenor_contact_mailer.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>14</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>14</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="missed" data-hits="0" data-linenumber="1">
          
          
          <code class="ruby">class ConvenorContactMailer &lt; ActionMailer::Base</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">  def request_project_membership(user, _convenor, unit, _first_name, _last_name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">    @doubtfire_product_name = Doubtfire::Application.config.institution[:product_name]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">    </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">    institution_email_domain = Doubtfire::Application.config.institution[:email_domain]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">    admin_emails = User.admins.map(&amp;:email)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">    user_email = &quot;#{user.username}@#{institution_email_domain}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">    mail to: admin_emails,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">         from: user_email,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">         subject: &quot;[#{@doubtfire_product_name}] Please add #{user.username} to #{unit.name}&quot;,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">         body: &quot;The following user wishes to be added to #{unit.name} on &quot; \</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">               &quot;#{@doubtfire_product_name}:\n\nUsername: #{user.username}\nEmail: #{user_email}\n&quot; \</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">               &quot;Name: #{user.name}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="d6f41f97ddc570e7512c459ab8f42eb785015c3e">
  <div class="header">
    <h3>app/mailers/notifications_mailer.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>73</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>73</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="missed" data-hits="0" data-linenumber="1">
          
          
          <code class="ruby">class NotificationsMailer &lt; ActionMailer::Base</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">  def add_general</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">    @doubtfire_host = Doubtfire::Application.config.institution[:host]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">    @doubtfire_product_name = Doubtfire::Application.config.institution[:product_name]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">    @unsubscribe_url = &quot;https://#{@doubtfire_host}/#/home?notifications&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">  def weekly_staff_summary(unit_role, summary_stats)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">    return nil if unit_role.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">    add_general</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">    @staff = unit_role.user</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">    @unit_role = unit_role</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">    @unit = summary_stats[:unit]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">    @data = summary_stats[:staff][unit_role]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">    @convenor = @unit.main_convenor</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">    @summary_stats = summary_stats</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">    email_with_name = %(&quot;#{@staff.name}&quot; &lt;#{@staff.email}&gt;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">    convenor_email = %(&quot;#{@convenor.name}&quot; &lt;#{@convenor.email}&gt;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">    subject = &quot;#{@unit.name}: Weekly Summary&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">    mail(to: email_with_name, from: convenor_email, subject: subject)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">  def weekly_student_summary(project, summary_stats, did_revert_to_pass)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">    return nil if project.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">    add_general</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">    </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">    @student = project.student</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">    @project = project</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">    @tutor = project.main_tutor</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">    @summary_stats = summary_stats</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">    @did_revert_to_pass = did_revert_to_pass</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">    @engagements = @project.task_engagements.where(&quot;task_engagements.engagement_time &gt;= :start AND task_engagements.engagement_time &lt; :end&quot;, start: summary_stats[:week_start], end: summary_stats[:week_end])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">    @engagements_count = @engagements.count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">    @student_engagements = @engagements.select { |e| [TaskStatus.not_started.name, TaskStatus.need_help.name, TaskStatus.working_on_it.name, TaskStatus.ready_to_mark.name].include? e.engagement  }.count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">    @staff_engagements = @engagements.select { |e| [TaskStatus.complete.name, TaskStatus.do_not_resubmit.name, TaskStatus.redo.name, TaskStatus.discuss.name, TaskStatus.demonstrate.name, TaskStatus.fail.name].include? e.engagement  }.count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">    @task_states = project.tasks.joins(:task_status).select(&quot;count(tasks.id) as number, task_statuses.name as status&quot;).group(&quot;task_statuses.name&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="49">
          
          
          <code class="ruby">    @received_comments = project.comments.where(&quot;recipient_id = :student_id AND task_comments.created_at &gt; :start&quot;, student_id: @student.id, start: Time.zone.today - 7.days).count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">    @sent_comments = project.comments.where(&quot;user_id = :student_id AND task_comments.created_at &gt; :start&quot;, student_id: @student.id, start: Time.zone.today - 7.days).count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">    @top_tasks = project.top_tasks</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">    @overdue_top = @top_tasks.select {|tt| tt[:reason] == :overdue}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby">    @soon_top = @top_tasks.select {|tt| tt[:reason] == :soon}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="55">
          
          
          <code class="ruby">    @ahead_top = @top_tasks.select {|tt| tt[:reason] == :ahead}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="57">
          
          
          <code class="ruby">    email_with_name = %(&quot;#{@student.name}&quot; &lt;#{@student.email}&gt;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="58">
          
          
          <code class="ruby">    tutor_email = %(&quot;#{@tutor.name}&quot; &lt;#{@tutor.email}&gt;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="59">
          
          
          <code class="ruby">    subject = &quot;#{project.unit.name}: Weekly Summary&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="61">
          
          
          <code class="ruby">    mail(to: email_with_name, from: tutor_email, subject: subject)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="62">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="64">
          
          
          <code class="ruby">  def top_task_desc(tt)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="65">
          
          
          <code class="ruby">    &quot;#{tt[:task_definition].abbreviation} - #{tt[:task_definition].name} #{&quot;- which you need to discuss with your tutor&quot; if tt[:status] == :discuss}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="66">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="68">
          
          
          <code class="ruby">  def were_was(num)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="69">
          
          
          <code class="ruby">    if num == 1 </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="70">
          
          
          <code class="ruby">        &quot;was&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="71">
          
          
          <code class="ruby">    else </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="72">
          
          
          <code class="ruby">        &quot;were&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="73">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="74">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="76">
          
          
          <code class="ruby">  def are_is(num)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="77">
          
          
          <code class="ruby">    if num == 1 </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="78">
          
          
          <code class="ruby">        &quot;is&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="79">
          
          
          <code class="ruby">    else </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="80">
          
          
          <code class="ruby">        &quot;are&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="81">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="82">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="84">
          
          
          <code class="ruby">  def this_these(num)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="85">
          
          
          <code class="ruby">    if num == 1 </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="86">
          
          
          <code class="ruby">        &quot;this&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="87">
          
          
          <code class="ruby">    else </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="88">
          
          
          <code class="ruby">        &quot;these&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="89">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="90">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="92">
          
          
          <code class="ruby">  helper_method :top_task_desc</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="93">
          
          
          <code class="ruby">  helper_method :were_was</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="94">
          
          
          <code class="ruby">  helper_method :are_is</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="95">
          
          
          <code class="ruby">  helper_method :this_these</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="96">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="e23d12fabe8998103d305afda644c8af56fea046">
  <div class="header">
    <h3>app/mailers/portfolio_evidence_mailer.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>69</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>69</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="missed" data-hits="0" data-linenumber="1">
          
          
          <code class="ruby">class PortfolioEvidenceMailer &lt; ActionMailer::Base</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">  def add_general</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">    @doubtfire_host = Doubtfire::Application.config.institution[:host]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">    @doubtfire_product_name = Doubtfire::Application.config.institution[:product_name]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">    @unsubscribe_url = &quot;https://#{@doubtfire_host}/#/home?notifications&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">  def task_pdf_failed(project, tasks)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">    return nil if project.nil? || tasks.nil? || tasks.length.zero?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">    add_general</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">    @student = project.student</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">    @project = project</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">    @tasks = tasks.sort_by { |t| t.task_definition.abbreviation }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">    @tutor = project.main_tutor</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">    @convenor = project.main_convenor</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">    email_with_name = %(&quot;#{@student.name}&quot; &lt;#{@student.email}&gt;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">    tutor_email = %(&quot;#{@tutor.name}&quot; &lt;#{@tutor.email}&gt;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">    subject = &quot;#{project.unit.name}: Task PDFs ready to view&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">    mail(to: email_with_name, from: tutor_email, subject: subject)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">  def task_pdf_ready_message(project, tasks)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">    return nil if project.nil? || tasks.nil? || tasks.length.zero?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">    add_general</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">    @student = project.student</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">    @project = project</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">    @tasks = tasks.sort_by { |t| t.task_definition.abbreviation }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">    @tutor = project.main_tutor</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">    @convenor = project.main_convenor</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">    email_with_name = %(&quot;#{@student.name}&quot; &lt;#{@student.email}&gt;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">    tutor_email = %(&quot;#{@tutor.name}&quot; &lt;#{@tutor.email}&gt;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">    subject = &quot;#{project.unit.name}: Task PDFs ready to view&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">    mail(to: email_with_name, from: tutor_email, subject: subject)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">  def task_feedback_ready(project, tasks)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">    return nil if project.nil? || tasks.nil? || tasks.length.zero?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">    add_general</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">    @student = project.student</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">    @project = project</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">    @tasks = tasks.sort_by { |t| t.task_definition.abbreviation }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">    @tutor = project.main_tutor</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="49">
          
          
          <code class="ruby">    @has_comments = !@tasks.select { |t| t.is_last_comment_by?(@tutor) }.empty?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">    return nil if @tutor.nil? || @student.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">    email_with_name = %(&quot;#{@student.name}&quot; &lt;#{@student.email}&gt;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">    tutor_email = %(&quot;#{@tutor.name}&quot; &lt;#{@tutor.email}&gt;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby">    subject = &quot;#{project.unit.name}: Feedback ready to review&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="55">
          
          
          <code class="ruby">    mail(to: email_with_name, from: tutor_email, subject: subject)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="56">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="58">
          
          
          <code class="ruby">  def portfolio_ready(project)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="59">
          
          
          <code class="ruby">    return nil if project.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="61">
          
          
          <code class="ruby">    add_general</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="63">
          
          
          <code class="ruby">    @student = project.student</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="64">
          
          
          <code class="ruby">    @project = project</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="65">
          
          
          <code class="ruby">    @convenor = project.unit.convenors.first.user</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="67">
          
          
          <code class="ruby">    email_with_name = %(&quot;#{@student.name}&quot; &lt;#{@student.email}&gt;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="68">
          
          
          <code class="ruby">    convenor_email = %(&quot;#{@convenor.name}&quot; &lt;#{@convenor.email}&gt;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="69">
          
          
          <code class="ruby">    subject = &quot;#{project.unit.name}: Portfolio ready to review&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="70">
          
          
          <code class="ruby">    mail(to: email_with_name, from: convenor_email, subject: subject)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="71">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="73">
          
          
          <code class="ruby">  def portfolio_failed(project)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="74">
          
          
          <code class="ruby">    return nil if project.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="76">
          
          
          <code class="ruby">    add_general</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">    </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="78">
          
          
          <code class="ruby">    @student = project.student</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="79">
          
          
          <code class="ruby">    @project = project</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="80">
          
          
          <code class="ruby">    @convenor = project.unit.convenors.first.user</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="82">
          
          
          <code class="ruby">    email_with_name = %(&quot;#{@student.name}&quot; &lt;#{@student.email}&gt;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="83">
          
          
          <code class="ruby">    convenor_email = %(&quot;#{@convenor.name}&quot; &lt;#{@convenor.email}&gt;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="84">
          
          
          <code class="ruby">    subject = &quot;#{project.unit.name}: Portfolio failed to compile&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="85">
          
          
          <code class="ruby">    mail(to: email_with_name, from: convenor_email, subject: subject)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="86">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="87">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="7c46a085effbe3cbe115c6d08237455ebd04b9a4">
  <div class="header">
    <h3>app/models/badge.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>3</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>3</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="missed" data-hits="0" data-linenumber="1">
          
          
          <code class="ruby">class Badge &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2">
          
          
          <code class="ruby">  belongs_to :sub_task_definitions</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="28db7d56c23f1330818532a265e0e725a2289796">
  <div class="header">
    <h3>app/models/comments_read_receipts.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>5</b> relevant lines. 
      <span class="green"><b>5</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class CommentsReadReceipts &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :user, presence: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :task_comment, presence: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :task_comment</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :user</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="87382f76ecb1bd41e2a22efd559c504f3d39fa07">
  <div class="header">
    <h3>app/models/group.rb</h3>
    <h4><span class="red">28.45 %</span> covered</h4>
    <div>
      <b>116</b> relevant lines. 
      <span class="green"><b>33</b> lines covered</span> and
      <span class="red"><b>83</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class Group &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  include LogHelper</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :group_set</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :tutorial</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :group_memberships</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :group_submissions</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :projects, -&gt; { where(&#39;group_memberships.active = :value and projects.enrolled = true&#39;, value: true) }, through: :group_memberships</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :past_projects, -&gt; { where(&#39;group_memberships.active = :value&#39;, value: false) }, through: :group_memberships, source: &#39;project&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">  has_one :unit, through: :group_set</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">  has_one :tutor, through: :tutorial</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :name, presence: true, allow_nil: false</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :number, presence: true, allow_nil: false</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :group_set, presence: true, allow_nil: false</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :tutorial, presence: true, allow_nil: false</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">  validates_associated :group_memberships</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :number, uniqueness: { scope: :group_set,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">                                 message: &#39;must be unique within the set of groups&#39; }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :name, uniqueness: { scope: :group_set,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">                                 message: &#39;must be unique within the set of groups&#39; }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">  validate :must_be_in_same_tutorial, if: :limit_members_to_tutorial?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">  before_destroy :ensure_no_submissions</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>
          
          <code class="ruby">  def active_group_members</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">    group_memberships.where(active: true)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>
          
          <code class="ruby">  def has_active_group_members?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">    active_group_members.present?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">  # Permissions around group data</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="38">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.permissions</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">    # What can students do with groups?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">    student_role_permissions = [</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">      :get_members</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">    ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">    # What can tutors do with groups?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">    tutor_role_permissions = [</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">      :get_members,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">      :manage_group</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">    ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">    # What can convenors do with groups?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="49">
          
          
          <code class="ruby">    convenor_role_permissions = [</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">      :get_members,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">      :manage_group</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">    ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">    # What can nil users do with groups?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby">    nil_role_permissions = [</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">    ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">    # Return permissions hash</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">    {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">      convenor: convenor_role_permissions,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">      tutor: tutor_role_permissions,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">      student: student_role_permissions,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">      nil: nil_role_permissions</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="64">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="67">
          <span class="hits">1</span>
          
          <code class="ruby">  def ensure_no_submissions</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="68">
          
          
          <code class="ruby">    return true if group_submissions.count.zero?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="69">
          
          
          <code class="ruby">    errors[:base] &lt;&lt; &#39;Cannot delete group while it has submissions.&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="70">
          
          
          <code class="ruby">    false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="73">
          <span class="hits">1</span>
          
          <code class="ruby">  def specific_permission_hash(role, perm_hash, _other)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="74">
          
          
          <code class="ruby">    result = perm_hash[role] unless perm_hash.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="75">
          
          
          <code class="ruby">    if result &amp;&amp; role == :student</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="76">
          
          
          <code class="ruby">      result &lt;&lt; :manage_group if group_set.allow_students_to_manage_groups</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="78">
          
          
          <code class="ruby">    result</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="81">
          <span class="hits">1</span>
          
          <code class="ruby">  def role_for(user)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="82">
          
          
          <code class="ruby">    result = unit.role_for(user)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="83">
          
          
          <code class="ruby">    if result == Role.student</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="84">
          
          
          <code class="ruby">      result = nil unless has_user user</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="87">
          
          
          <code class="ruby">    result</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="90">
          <span class="hits">1</span>
          
          <code class="ruby">  def has_user(user)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="91">
          
          
          <code class="ruby">    projects.where(&#39;user_id = :user_id&#39;, user_id: user.id).count == 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="94">
          <span class="hits">1</span>
          
          <code class="ruby">  def add_member(project)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="95">
          
          
          <code class="ruby">    gm = project.group_membership_for_groupset(group_set)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="97">
          
          
          <code class="ruby">    if gm.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="98">
          
          
          <code class="ruby">      gm = GroupMembership.create(group: self, project: project)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="100">
          
          
          <code class="ruby">      gm = GroupMembership.find(gm.id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="101">
          
          
          <code class="ruby">      gm.group = self</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="104">
          
          
          <code class="ruby">    gm.active = true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="105">
          
          
          <code class="ruby">    gm.save!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="107">
          
          
          <code class="ruby">    gm</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="110">
          <span class="hits">1</span>
          
          <code class="ruby">  def remove_member(project)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="111">
          
          
          <code class="ruby">    gm = group_memberships.where(project: project).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="112">
          
          
          <code class="ruby">    gm.active = false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="113">
          
          
          <code class="ruby">    gm.save</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="114">
          
          
          <code class="ruby">    self</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby">  # check if the project is the same as the current submission</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="120">
          <span class="hits">1</span>
          
          <code class="ruby">  def __different_project_composition__(contributors, gs)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="121">
          
          
          <code class="ruby">    logger.debug &#39;Starting checks&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="122">
          
          
          <code class="ruby">    contributors.each do |contrib|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="123">
          
          
          <code class="ruby">      logger.debug &quot;-- Checking #{contrib}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="124">
          
          
          <code class="ruby">      return true unless gs.projects.include? contrib[:project]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="125">
          
          
          <code class="ruby">      return true unless contrib[:pct].to_i &gt; 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="126">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="127">
          
          
          <code class="ruby">    logger.debug &quot;Checking #{contributors.count} == #{gs.projects.count}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="128">
          
          
          <code class="ruby">    contributors.count != gs.projects.count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="129">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="130">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="132">
          
          
          <code class="ruby">  # The submitter task is the user who submitted this group task.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="133">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="134">
          
          
          <code class="ruby">  # Creates a Group Submission</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="135">
          
          
          <code class="ruby">  # Locates other group members, and link to this submission.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="136">
          
          
          <code class="ruby">  #   - contributors contains [ {project: ..., pct: ... } ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="138">
          <span class="hits">1</span>
          
          <code class="ruby">  def create_submission(submitter_task, notes, contributors)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="139">
          
          
          <code class="ruby">    total = 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="140">
          
          
          <code class="ruby">    # check all members are in the same group</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="141">
          
          
          <code class="ruby">    contributors.each do |contrib|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="142">
          
          
          <code class="ruby">      project = contrib[:project]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="143">
          
          
          <code class="ruby">      pct = contrib[:pct].to_i</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="144">
          
          
          <code class="ruby">      pts = contrib[:pts].to_i</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="145">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="146">
          
          
          <code class="ruby">      if pct &lt; 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="147">
          
          
          <code class="ruby">        contrib[:pct] = 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="148">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="149">
          
          
          <code class="ruby">        total += pct</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="150">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="151">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="152">
          
          
          <code class="ruby">      contrib[:pts] = 0 unless pts &gt; 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="153">
          
          
          <code class="ruby">      contrib[:pts] = 5 unless pts &lt; 5</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="154">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="155">
          
          
          <code class="ruby">      raise &#39;Not all contributions were from team members.&#39; unless projects.include? project</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="156">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="157">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="158">
          
          
          <code class="ruby">    # check for all group members</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="159">
          
          
          <code class="ruby">    raise &#39;Contributions missing for some group members&#39; unless projects.count == contributors.count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="160">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="161">
          
          
          <code class="ruby">    # check pct</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="162">
          
          
          <code class="ruby">    raise &#39;Contribution percentages are insufficient.&#39; unless total &gt;= 90</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="163">
          
          
          <code class="ruby">    raise &#39;Contribution percentages are excessive.&#39; unless total &lt;= 110</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="164">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="165">
          
          
          <code class="ruby">    # check group task</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="166">
          
          
          <code class="ruby">    raise &#39;Group submission only allowed for group tasks.&#39; unless submitter_task.task_definition.group_set</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="167">
          
          
          <code class="ruby">    raise &#39;Group submission for wrong group for unit.&#39; unless submitter_task.task_definition.group_set == group_set</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="168">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="169">
          
          
          <code class="ruby">    old_gs = submitter_task.group_submission</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="170">
          
          
          <code class="ruby">    gs = old_gs</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="171">
          
          
          <code class="ruby">    if gs.nil? || __different_project_composition__(contributors, gs)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="172">
          
          
          <code class="ruby">      gs = GroupSubmission.create</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="173">
          
          
          <code class="ruby">      gs.task_definition = submitter_task.task_definition</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="174">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="175">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="176">
          
          
          <code class="ruby">    gs.group = self</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="177">
          
          
          <code class="ruby">    gs.notes = notes</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="178">
          
          
          <code class="ruby">    gs.submitted_by_project = submitter_task.project</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="179">
          
          
          <code class="ruby">    gs.save!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="180">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="181">
          
          
          <code class="ruby">    contributors.each do |contrib|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="182">
          
          
          <code class="ruby">      project = contrib[:project]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="183">
          
          
          <code class="ruby">      task = project.matching_task submitter_task</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="184">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="185">
          
          
          <code class="ruby">      if contrib[:pct].to_i &gt; 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="186">
          
          
          <code class="ruby">        task.group_submission = gs</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="187">
          
          
          <code class="ruby">        task.contribution_pct = contrib[:pct]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="188">
          
          
          <code class="ruby">        task.contribution_pts = contrib[:pts]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="189">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="190">
          
          
          <code class="ruby">      task.save</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="191">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="192">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="193">
          
          
          <code class="ruby">    if old_gs</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="194">
          
          
          <code class="ruby">      old_gs.reload</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="195">
          
          
          <code class="ruby">      old_gs.destroy! if old_gs.projects.count.zero?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="196">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="197">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="198">
          
          
          <code class="ruby">    # ensure that original task is reloaded... update will have effected a different object</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="199">
          
          
          <code class="ruby">    submitter_task.reload</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="200">
          
          
          <code class="ruby">    gs</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="201">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="202">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="203">
          <span class="hits">1</span>
          
          <code class="ruby">  def limit_members_to_tutorial?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="204">
          
          
          <code class="ruby">    group_set.keep_groups_in_same_class</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="205">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="206">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="207">
          <span class="hits">1</span>
          
          <code class="ruby">  def must_be_in_same_tutorial</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="208">
          
          
          <code class="ruby">    if limit_members_to_tutorial?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="209">
          
          
          <code class="ruby">      unless all_members_in_tutorial?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="210">
          
          
          <code class="ruby">        errors.add(:members, &quot;must all be in the group&#39;s tutorial&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="211">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="212">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="213">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="214">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="215">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="216">
          
          
          <code class="ruby">  # Check if all members are in this groups tutorial</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="217">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="218">
          <span class="hits">1</span>
          
          <code class="ruby">  def all_members_in_tutorial?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="219">
          
          
          <code class="ruby">    group_memberships.each do |member|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="220">
          
          
          <code class="ruby">      return false unless !member.active || member.in_group_tutorial?(tutorial)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="221">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="222">
          
          
          <code class="ruby">    true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="223">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="224">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="f085e67a49f9f6d8a37f4980a6426da20859c519">
  <div class="header">
    <h3>app/models/group_membership.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>18</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>18</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"># Records which students are in this group... used to determine the related students on submission</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">class GroupMembership &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">  include LogHelper</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">  belongs_to :group</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">  belongs_to :project</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">  has_one :group_set, through: :group</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">  validate :must_be_in_same_tutorial, if: :restricted_to_tutorial?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">  def restricted_to_tutorial?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">    active &amp;&amp; group_set.keep_groups_in_same_class</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">  def must_be_in_same_tutorial</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">    if active &amp;&amp; !in_group_tutorial?(group.tutorial)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">      errors.add(:group, &quot;requires all students to be in the #{group.tutorial.abbreviation} tutorial&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">  def in_group_tutorial?(tutorial)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">    project.tutorial == tutorial</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="bc8e9ab21d0a14335f1e80195cb7645d0153f1eb">
  <div class="header">
    <h3>app/models/group_set.rb</h3>
    <h4><span class="red">39.13 %</span> covered</h4>
    <div>
      <b>23</b> relevant lines. 
      <span class="green"><b>9</b> lines covered</span> and
      <span class="red"><b>14</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class GroupSet &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :unit</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :groups, dependent: :destroy</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  validates_associated :groups</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  validate :must_be_in_same_tutorial, if: :keep_groups_in_same_class</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">  # Permissions around group set data</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.permissions</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">    # What can students do with group sets?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">    student_role_permissions = [</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">      :get_groups</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">    ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">    # What can tutors do with group sets?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">    tutor_role_permissions = [</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">      :get_groups,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">      :join_group,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">      :create_group</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">    ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">    # What can convenors do with group sets?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">    convenor_role_permissions = [</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">      :get_groups,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">      :join_group,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">      :create_group</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">    ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">    # What can nil users do with group sets?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">    nil_role_permissions = [</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">    ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">    # Return permissions hash</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">    {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">      convenor: convenor_role_permissions,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">      tutor: tutor_role_permissions,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">      student: student_role_permissions,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">      nil: nil_role_permissions</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="42">
          <span class="hits">1</span>
          
          <code class="ruby">  def specific_permission_hash(role, perm_hash, _other)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">    result = perm_hash[role] unless perm_hash.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">    if result &amp;&amp; role == :student</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">      result &lt;&lt; :create_group if allow_students_to_create_groups</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">      result &lt;&lt; :join_group if allow_students_to_manage_groups</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">    result</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="51">
          <span class="hits">1</span>
          
          <code class="ruby">  delegate :role_for, to: :unit</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="53">
          <span class="hits">1</span>
          
          <code class="ruby">  def must_be_in_same_tutorial</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby">    if keep_groups_in_same_class</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="55">
          
          
          <code class="ruby">      groups.each do |grp|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="56">
          
          
          <code class="ruby">        unless grp.all_members_in_tutorial?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="57">
          
          
          <code class="ruby">          errors.add(:groups, &quot;exist where some members are not in the group&#39;s tutorial&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="839aed3fd9e420e38c44d5b9ca3fd0f128e74a7f">
  <div class="header">
    <h3>app/models/group_submission.rb</h3>
    <h4><span class="red">40.63 %</span> covered</h4>
    <div>
      <b>32</b> relevant lines. 
      <span class="green"><b>13</b> lines covered</span> and
      <span class="red"><b>19</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"># Tracks each group&#39;s submissions.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">class GroupSubmission &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  include LogHelper</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :group</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :task_definition</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :tasks, dependent: :nullify</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :projects, through: :tasks</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :submitted_by_project, class_name: &#39;Project&#39;, foreign_key: &#39;submitted_by_project_id&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">  # Ensure file is also deleted</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">  before_destroy do |group_submission|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">    logger.debug &quot;Deleting group submission #{group_submission.id}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">      FileHelper.delete_group_submission(group_submission)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">      # also remove evidence from group members</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">      tasks.each do |t|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">        t.portfolio_evidence = null</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">        t.save</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">    rescue =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">      logger.error &quot;Failed to delete group submission #{group_submission.id}. Error: #{e.message}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>
          
          <code class="ruby">  def propagate_transition(initial_task, trigger, by_user, quality)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">    tasks.each do |task|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">      next if [TaskStatus.complete.id, TaskStatus.do_not_resubmit.id, TaskStatus.fail.id].include? task.task_status_id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">      if task != initial_task</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">        task.trigger_transition(trigger: trigger, by_user: by_user, group_transition: true, quality: quality)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="40">
          <span class="hits">1</span>
          
          <code class="ruby">  def propagate_grade(initial_task, new_grade, ui)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">    tasks.each do |task|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">      if task != initial_task</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">        task.grade_task new_grade, ui, grading_group = true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="48">
          <span class="hits">1</span>
          
          <code class="ruby">  def propogate_alignments_from_submission(alignments)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="49">
          
          
          <code class="ruby">    tasks.each do |task|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">      task.create_alignments_from_submission(alignments)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="54">
          <span class="hits">1</span>
          
          <code class="ruby">  def submitter_task</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="55">
          
          
          <code class="ruby">    result = tasks.where(project: submitted_by_project).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="56">
          
          
          <code class="ruby">    return result unless result.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="58">
          
          
          <code class="ruby">    tasks.first</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="61">
          <span class="hits">1</span>
          
          <code class="ruby">  delegate :processing_pdf?, to: :submitter_task</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="97b73fc72eeb1ea3f4d0e556e47037d4d477ba9e">
  <div class="header">
    <h3>app/models/learning_outcome.rb</h3>
    <h4><span class="red">27.03 %</span> covered</h4>
    <div>
      <b>37</b> relevant lines. 
      <span class="green"><b>10</b> lines covered</span> and
      <span class="red"><b>27</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class LearningOutcome &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  include ApplicationHelper</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :unit</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :learning_outcome_task_links, dependent: :destroy # links to learning outcomes</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :related_task_definitions, -&gt; { where(&#39;learning_outcome_task_links.task_id is NULL&#39;) }, through: :learning_outcome_task_links, source: :task_definition # only link staff relations</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :abbreviation, uniqueness: { scope: :unit_id } # outcome names within a unit must be unique</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :description, length: { maximum: 4095, allow_blank: true }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.csv_header</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">    %w(unit_code ilo_number abbreviation name description)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">  def add_csv_row(row)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">    row &lt;&lt; [unit.code, ilo_number, abbreviation, name, description]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.create_from_csv(unit, row, result)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">    unit_code = row[&#39;unit_code&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">    if unit_code != unit.code</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">      result[:ignored] &lt;&lt; { row: row, message: &quot;Invalid unit code. #{unit_code} does not match #{unit.code}&quot; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">      return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">    ilo_number = row[&#39;ilo_number&#39;].to_i</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">    abbr = row[&#39;abbreviation&#39;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">    if abbr.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">      result[:errors] &lt;&lt; { row: row, message: &#39;Missing abbreviation&#39; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">      return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">    name = row[&#39;name&#39;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">    if name.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">      result[:errors] &lt;&lt; { row: row, message: &#39;Missing name&#39; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">      return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">    description = row[&#39;description&#39;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">    if description.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">      result[:errors] &lt;&lt; { row: row, message: &#39;Missing description&#39; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">      return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">    outcome = LearningOutcome.find_or_create_by(unit_id: unit.id, abbreviation: abbr) do |outcome|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="49">
          
          
          <code class="ruby">      outcome.name = name</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">      outcome.description = description</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">      outcome.ilo_number = ilo_number</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby">    outcome.save!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">    result[:success] &lt;&lt; if outcome.new_record?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="57">
          
          
          <code class="ruby">                          { row: row, message: &quot;Outcome #{abbr} created for unit&quot; }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">                        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="59">
          
          
          <code class="ruby">                          { row: row, message: &quot;Outcome #{abbr} updated for unit&quot; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="60">
          
          
          <code class="ruby">                        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="3cae1fac280f9e74d9be0ebb5d6e4607455830de">
  <div class="header">
    <h3>app/models/learning_outcome_task_link.rb</h3>
    <h4><span class="red">47.62 %</span> covered</h4>
    <div>
      <b>21</b> relevant lines. 
      <span class="green"><b>10</b> lines covered</span> and
      <span class="red"><b>11</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class LearningOutcomeTaskLink &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :task_definition</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :task</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :learning_outcome</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :task_definition, presence: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :learning_outcome, presence: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  validate :ensure_relations_unique</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :rating, numericality: { greater_than_or_equal_to: 0, less_than_or_equal_to: 5 }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">  def ensure_relations_unique</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">    return if learning_outcome.nil? || task_definition.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">    if id.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">      related_links = LearningOutcomeTaskLink.where(&#39;task_definition_id = :task_definition_id AND learning_outcome_id = :learning_outcome_id&#39;, my_id: id, task_definition_id: task_definition.id, learning_outcome_id: learning_outcome.id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">      related_links = LearningOutcomeTaskLink.where(&#39;id != :my_id AND task_definition_id = :task_definition_id AND learning_outcome_id = :learning_outcome_id&#39;, my_id: id, task_definition_id: task_definition.id, learning_outcome_id: learning_outcome.id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">    if task.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">      errors.add(:task_definition, &#39;already linked to this learning outcome&#39;) if related_links.where(&#39;task_id is NULL&#39;).count &gt; 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">      errors.add(:task, &#39;already linked to this learning outcome&#39;) if related_links.where(&#39;task_id = :task_id&#39;, task_id: task.id).count &gt; 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.export_task_alignment_to_csv(unit, source)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">    CSV.generate do |row|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">      row &lt;&lt; %w(unit_code learning_outcome task_abbr rating description)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">      source.task_outcome_alignments.each do |align|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">        row &lt;&lt; [unit.code, align.learning_outcome.abbreviation, align.task_definition.abbreviation, align.rating, align.description]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="d81977c32f5db4bce2263b487accaba1688da1be">
  <div class="header">
    <h3>app/models/login.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>3</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>3</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="missed" data-hits="0" data-linenumber="1">
          
          
          <code class="ruby">class Login &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2">
          
          
          <code class="ruby">  belongs_to :user</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="65d163891fdaa0fcb2e8af157d1859c64d2246da">
  <div class="header">
    <h3>app/models/plagiarism_match_link.rb</h3>
    <h4><span class="red">40.63 %</span> covered</h4>
    <div>
      <b>32</b> relevant lines. 
      <span class="green"><b>13</b> lines covered</span> and
      <span class="red"><b>19</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class PlagiarismMatchLink &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  include LogHelper</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :task</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :other_task, class_name: &#39;Task&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">  # Ensure file is also deleted</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">  before_destroy do |match_link|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">      if match_link.task.group_task?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">        other_tasks = match_link.task.group_submission.tasks.select { |t| t.id != match_link.task.id }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">        other_tasks_using_file = other_tasks.select { |t| t.plagiarism_match_links.where(other_task_id: match_link.other_task_id).count &gt; 0 }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">        FileHelper.delete_plagarism_html(match_link) unless other_tasks_using_file.count &gt; 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">      else # individual... so can delete file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">        FileHelper.delete_plagarism_html(match_link)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">    rescue =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">      logger.error &quot;Error deleting match link for task #{match_link.task.id}. Error: #{e.message}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">  after_destroy do |match_link|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">    match_link.other_party.destroy if match_link.other_party</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">    match_link.task.recalculate_max_similar_pct</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">  # TODO: Remove once max_pct_similar is deleted</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">  # #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">  # # Update task&#39;s cache of pct similar</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">  # #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">  # after_save do | match_link |</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">  #   task = match_link.task</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">  #   if (not match_link.dismissed) &amp;&amp; task.max_pct_similar &lt; match_link.pct</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">  #     task.max_pct_similar = match_link.pct</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">  #     task.save</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">  #   end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">  # end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="42">
          <span class="hits">1</span>
          
          <code class="ruby">  def other_party</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">    PlagiarismMatchLink.where(task_id: other_task.id, other_task_id: task.id).first</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="46">
          <span class="hits">1</span>
          
          <code class="ruby">  def other_student</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">    other_task.student</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="50">
          <span class="hits">1</span>
          
          <code class="ruby">  def other_tutor</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">    other_task.project.main_tutor</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="54">
          <span class="hits">1</span>
          
          <code class="ruby">  delegate :student, to: :task</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="56">
          <span class="hits">1</span>
          
          <code class="ruby">  def tutor</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="57">
          
          
          <code class="ruby">    task.project.main_tutor</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="60">
          <span class="hits">1</span>
          
          <code class="ruby">  def tutorial</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="61">
          
          
          <code class="ruby">    if task.project.tutorial.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="62">
          
          
          <code class="ruby">      &#39;None&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="64">
          
          
          <code class="ruby">      task.project.tutorial.abbreviation</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="68">
          <span class="hits">1</span>
          
          <code class="ruby">  def other_tutorial</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="69">
          
          
          <code class="ruby">    if other_task.project.tutorial.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="70">
          
          
          <code class="ruby">      &#39;None&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="72">
          
          
          <code class="ruby">      other_task.project.tutorial.abbreviation</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="78cd237b694da1f663c10a29b7298bab9069f5dc">
  <div class="header">
    <h3>app/models/portfolio_evidence.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>65</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>65</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="missed" data-hits="0" data-linenumber="1">
          
          
          <code class="ruby">class PortfolioEvidence</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2">
          
          
          <code class="ruby">  include FileHelper</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">  include LogHelper</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">  def self.logger</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">    LogHelper.logger</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">  def self.sanitized_path(*paths)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">    FileHelper.sanitized_path *paths</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">  def self.sanitized_filename(filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">    FileHelper.sanitized_filename(filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">  def self.student_work_dir(type = nil, task = nil, create = true)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">    FileHelper.student_work_dir(type, task, create)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">  # Process enqueued pdfs in each folder of the :new directory</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">  # into PDF files</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">  def self.process_new_to_pdf</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">    done = {}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">    errors = {}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">    # For each folder in new (i.e., queued folders to process) that matches appropriate name</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">    new_root_dir = Dir.entries(student_work_dir(:new)).select do |f|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">      # rubocop:disable Style/NumericPredicate</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">      (f =~ /^\d+$/) == 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">      # rubocop:enable Style/NumericPredicate</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">    new_root_dir.each do |folder_id|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">      task = Task.find(folder_id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">      add_error = lambda do |message|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">        logger.error &quot;Failed to process folder_id = #{folder_id}. #{message}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">        if task</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">          task.add_text_comment task.project.main_tutor, &quot;**Automated Comment**: Something went wrong with your submission. Check the files and resubmit this task. #{message}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">          task.trigger_transition trigger: &#39;fix&#39;, by_user: task.project.main_tutor</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">          errors[task.project] = [] if errors[task.project].nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">          errors[task.project] &lt;&lt; task</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">      begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">        logger.info &quot;creating pdf for task #{task.id}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">        success = task.convert_submission_to_pdf</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby">        if success</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="55">
          
          
          <code class="ruby">          done[task.project] = [] if done[task.project].nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="56">
          
          
          <code class="ruby">          done[task.project] &lt;&lt; task</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="57">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="58">
          
          
          <code class="ruby">          add_error.call(&#39;Failed to convert your submission to pdf.&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="59">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="60">
          
          
          <code class="ruby">      rescue Exception =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="61">
          
          
          <code class="ruby">        add_error.call(e.message.to_s)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="62">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="63">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">    # Remove email of task notification success - only email on fail</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">    # done.each do |project, tasks|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">    #   logger.info &quot;checking email for project #{project.id}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">    #   if project.student.receive_task_notifications</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">    #     logger.info &quot;emailing task notification to #{project.student.name}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">    #     PortfolioEvidenceMailer.task_pdf_ready_message(project, tasks).deliver</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">    #   end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">    # end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="74">
          
          
          <code class="ruby">    errors.each do |project, tasks|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="75">
          
          
          <code class="ruby">      logger.info &quot;checking email for project #{project.id}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="76">
          
          
          <code class="ruby">      if project.student.receive_task_notifications</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="77">
          
          
          <code class="ruby">        logger.info &quot;emailing task notification to #{project.student.name}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="78">
          
          
          <code class="ruby">        PortfolioEvidenceMailer.task_pdf_failed(project, tasks).deliver</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="79">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="80">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="81">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="83">
          
          
          <code class="ruby">  def self.final_pdf_path_for_group_submission(group_submission)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="84">
          
          
          <code class="ruby">    File.join(</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="85">
          
          
          <code class="ruby">      FileHelper.student_group_work_dir(:pdf, group_submission, task = nil, create = true),</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="86">
          
          
          <code class="ruby">      sanitized_filename(</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="87">
          
          
          <code class="ruby">        sanitized_path(&quot;#{group_submission.task_definition.abbreviation}-#{group_submission.id}&quot;) + &#39;.pdf&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="88">
          
          
          <code class="ruby">      )</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="89">
          
          
          <code class="ruby">    )</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="90">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="92">
          
          
          <code class="ruby">  def self.recreate_task_pdf(task)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="93">
          
          
          <code class="ruby">    task.move_done_to_new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="94">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="95">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="b1064dba5d6e902308ec66611b299f922764c943">
  <div class="header">
    <h3>app/models/progress.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>34</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>34</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="missed" data-hits="0" data-linenumber="1">
          
          
          <code class="ruby">class Progress</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2">
          
          
          <code class="ruby">  include Comparable</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">  PROGRESS_TYPES = [</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">    :ahead,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">    :on_track,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">    :behind,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">    :danger,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">    :doomed</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">  ].freeze</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">  attr_reader :progress, :weight</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">  def &lt;=&gt;(other)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">    weight &lt;=&gt; other.weight</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">  def initialize(progress_sym)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">    @progress = progress_sym</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">    @weight = case progress</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">              when :doomed</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">                0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">              when :danger</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">                1</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">              when :behind</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">                2</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">              when :on_track</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">                3</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">              when :ahead</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">                4</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">              else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">                -1</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">              end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">  def self.types</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">    PROGRESS_TYPES</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="d969ced2b9a105997a944f292037a4033450227a">
  <div class="header">
    <h3>app/models/project.rb</h3>
    <h4><span class="red">33.41 %</span> covered</h4>
    <div>
      <b>455</b> relevant lines. 
      <span class="green"><b>152</b> lines covered</span> and
      <span class="red"><b>303</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class Float</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  def signif(signs)</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="3">
          <span class="hits">5</span>
          
          <code class="ruby">    Float(&quot;%.#{signs}f&quot; % self)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">class Fixnum</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  def signif(signs)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">    Float(&quot;%.#{signs}f&quot; % self)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">class Project &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">  include ApplicationHelper</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">  include LogHelper</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :unit</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :tutorial</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :user</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">  # has_one :user, through: :student</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :tasks, dependent: :destroy # Destroying a project will also nuke all of its tasks</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :group_memberships, dependent: :destroy</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :groups, -&gt; { where(&#39;group_memberships.active = :value&#39;, value: true) }, through: :group_memberships</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="26">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :past_groups, -&gt; { where(&#39;group_memberships.active = :value&#39;, value: false) }, through: :group_memberships, source: &#39;group&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :task_engagements, through: :tasks</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :comments, through: :tasks</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="30">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :learning_outcome_task_links, through: :tasks</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">  validate :must_be_in_group_tutorials</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="33">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :grade_rationale, length: { maximum: 4095, allow_blank: true }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">  # Permissions around project data</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="38">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.permissions</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">    # What can students do with projects?</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="40">
          <span class="hits">4</span>
          
          <code class="ruby">    student_role_permissions = [</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">      :get,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">      :change_tutorial,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">      :make_submission,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">      :get_submission,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">      :apply_extension,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">      :change</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">    ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">    # What can tutors do with projects?</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="49">
          <span class="hits">4</span>
          
          <code class="ruby">    tutor_role_permissions = [</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">      :get,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">      :trigger_week_end,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">      :change_tutorial,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">      :make_submission,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">      :get_submission,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">      :apply_extension,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">      :change,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">      :assess</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">    ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">    # What can convenors do with projects?</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="60">
          <span class="hits">4</span>
          
          <code class="ruby">    convenor_role_permissions = [</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">      :apply_extension</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">    ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">    # What can nil users do with projects?</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="64">
          <span class="hits">4</span>
          
          <code class="ruby">    nil_role_permissions = [</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">    ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">    # Return permissions hash</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">    {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">      student: student_role_permissions,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">      tutor: tutor_role_permissions,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">      nil: nil_role_permissions</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="73">
          <span class="hits">4</span>
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="76">
          <span class="hits">1</span>
          
          <code class="ruby">  def role_for(user)</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="77">
          <span class="hits">4</span>
          
          <code class="ruby">    user_role(user)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="80">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :with_progress, lambda { |progress_types|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="81">
          
          
          <code class="ruby">    where(progress: progress_types) unless progress_types.blank?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">  }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="84">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.for_user(user, include_inactive)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="85">
          
          
          <code class="ruby">    if include_inactive</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="86">
          
          
          <code class="ruby">      where(&#39;projects.user_id = :user_id&#39;, user_id: user.id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="88">
          
          
          <code class="ruby">      active_projects.where(&#39;projects.user_id = :user_id&#39;, user_id: user.id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="92">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.active_projects</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="93">
          
          
          <code class="ruby">    joins(:unit).where(enrolled: true).where(&#39;units.active = TRUE&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="96">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.for_unit_role(unit_role)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="97">
          
          
          <code class="ruby">    active_projects.where(unit_id: unit_role.unit_id) if unit_role.is_teacher?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby">  # Check to see if the student has a valid tutorial</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="103">
          <span class="hits">1</span>
          
          <code class="ruby">  def must_be_in_group_tutorials</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="104">
          
          
          <code class="ruby">    groups.each do |g|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="105">
          
          
          <code class="ruby">      next unless g.limit_members_to_tutorial?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="106">
          
          
          <code class="ruby">      next unless tutorial != g.tutorial</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="107">
          
          
          <code class="ruby">      if g.group_set.allow_students_to_manage_groups</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby">        # leave group</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="109">
          
          
          <code class="ruby">        g.remove_member(self)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="111">
          
          
          <code class="ruby">        errors.add(:groups, &quot;require you to be in tutorial #{g.tutorial.abbreviation}&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="112">
          
          
          <code class="ruby">        break</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="117">
          <span class="hits">1</span>
          
          <code class="ruby">  def log_details</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="118">
          <span class="hits">9</span>
          
          <code class="ruby">    &quot;#{id} - #{student.name} (#{student.username}) #{unit.code}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="121">
          <span class="hits">1</span>
          
          <code class="ruby">  def task_outcome_alignments</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="122">
          
          
          <code class="ruby">    learning_outcome_task_links</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="125">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="126">
          
          
          <code class="ruby">  # Returns the email of the tutor, or the convenor if there is no tutor</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="128">
          <span class="hits">1</span>
          
          <code class="ruby">  def tutor_email</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="129">
          
          
          <code class="ruby">    tutor = main_tutor</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="130">
          
          
          <code class="ruby">    if tutor</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="131">
          
          
          <code class="ruby">      tutor.email</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="132">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="133">
          
          
          <code class="ruby">      unit.convenor_email</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="134">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="135">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="136">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="138">
          
          
          <code class="ruby">  # All &quot;discuss&quot; and &quot;demonstrate&quot; become complete</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="139">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="140">
          <span class="hits">1</span>
          
          <code class="ruby">  def trigger_week_end(by_user)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="141">
          
          
          <code class="ruby">    discuss_and_demonstrate_tasks.each { |task| task.trigger_transition(trigger: &#39;complete&#39;, by_user: by_user, bulk: true, quality: task.quality_pts) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="142">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="143">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="144">
          <span class="hits">1</span>
          
          <code class="ruby">  def start</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="145">
          <span class="hits">2</span>
          
          <code class="ruby">    update_attribute(:started, true)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="146">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="147">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="148">
          <span class="hits">1</span>
          
          <code class="ruby">  def student</code>
        </li>
      
        <li class="covered" data-hits="34" data-linenumber="149">
          <span class="hits">34</span>
          
          <code class="ruby">    user</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="150">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="151">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="152">
          <span class="hits">1</span>
          
          <code class="ruby">  def main_tutor</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="153">
          <span class="hits">7</span>
          
          <code class="ruby">    if tutorial</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="154">
          <span class="hits">7</span>
          
          <code class="ruby">      result = tutorial.tutor</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="155">
          <span class="hits">7</span>
          
          <code class="ruby">      result = main_convenor if result.nil?</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="156">
          <span class="hits">7</span>
          
          <code class="ruby">      result</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="157">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="158">
          
          
          <code class="ruby">      main_convenor</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="159">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="160">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="161">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="162">
          <span class="hits">1</span>
          
          <code class="ruby">  def main_convenor</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="163">
          
          
          <code class="ruby">    unit.main_convenor</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="164">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="165">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="166">
          <span class="hits">1</span>
          
          <code class="ruby">  def tutorial_abbr</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="167">
          
          
          <code class="ruby">    tutorial.abbreviation unless tutorial.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="168">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="169">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="170">
          <span class="hits">1</span>
          
          <code class="ruby">  def user_role(user)</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="171">
          <span class="hits">5</span>
          
          <code class="ruby">    if user == student then :student</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="172">
          <span class="hits">2</span>
          
          <code class="ruby">    elsif user == main_tutor then :tutor</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="173">
          
          
          <code class="ruby">    elsif user.nil? then nil</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="174">
          
          
          <code class="ruby">    elsif unit.tutors.where(id: user.id).count != 0 then :tutor</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="175">
          
          
          <code class="ruby">    else nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="176">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="177">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="178">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="179">
          <span class="hits">1</span>
          
          <code class="ruby">  def active?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="180">
          
          
          <code class="ruby">    unit.active</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="181">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="182">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="183">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="184">
          
          
          <code class="ruby">  # Get a string representation of the Target Grade</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="185">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="186">
          <span class="hits">1</span>
          
          <code class="ruby">  def target_grade_desc</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="187">
          
          
          <code class="ruby">    case target_grade</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="188">
          
          
          <code class="ruby">    when 1</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="189">
          
          
          <code class="ruby">      &#39;Credit&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="190">
          
          
          <code class="ruby">    when 2</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="191">
          
          
          <code class="ruby">      &#39;Distinction&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="192">
          
          
          <code class="ruby">    when 3</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="193">
          
          
          <code class="ruby">      &#39;High Distinction&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="194">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="195">
          
          
          <code class="ruby">      &#39;Pass&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="196">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="197">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="198">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="199">
          <span class="hits">1</span>
          
          <code class="ruby">  def reference_date</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="200">
          
          
          <code class="ruby">    if application_reference_date &gt; unit.end_date</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="201">
          
          
          <code class="ruby">      unit.end_date</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="202">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="203">
          
          
          <code class="ruby">      application_reference_date</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="204">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="205">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="206">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="207">
          <span class="hits">1</span>
          
          <code class="ruby">  def task_details_for_shallow_serializer(user)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="208">
          
          
          <code class="ruby">    tasks</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="209">
          
          
          <code class="ruby">      .joins(:task_status)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="210">
          
          
          <code class="ruby">      .joins(&quot;LEFT JOIN task_comments ON task_comments.task_id = tasks.id&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="211">
          
          
          <code class="ruby">      .joins(&quot;LEFT JOIN comments_read_receipts crr ON crr.task_comment_id = task_comments.id AND crr.user_id = #{user.id}&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="212">
          
          
          <code class="ruby">      .select(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="213">
          
          
          <code class="ruby">        &#39;SUM(case when crr.user_id is null AND NOT task_comments.id is null then 1 else 0 end) as number_unread&#39;, &#39;project_id&#39;, &#39;tasks.id as id&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="214">
          
          
          <code class="ruby">        &#39;task_definition_id&#39;, &#39;task_statuses.id as status_id&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="215">
          
          
          <code class="ruby">        &#39;completion_date&#39;, &#39;times_assessed&#39;, &#39;submission_date&#39;, &#39;portfolio_evidence&#39;, &#39;tasks.grade as grade&#39;, &#39;quality_pts&#39;, &#39;include_in_portfolio&#39;, &#39;grade&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="216">
          
          
          <code class="ruby">      )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="217">
          
          
          <code class="ruby">      .group(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="218">
          
          
          <code class="ruby">        &#39;task_statuses.id&#39;, &#39;tasks.project_id&#39;, &#39;tasks.id&#39;, &#39;task_definition_id&#39;, &#39;status_id&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="219">
          
          
          <code class="ruby">        &#39;completion_date&#39;, &#39;times_assessed&#39;, &#39;submission_date&#39;, &#39;portfolio_evidence&#39;, &#39;grade&#39;, &#39;quality_pts&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="220">
          
          
          <code class="ruby">        &#39;include_in_portfolio&#39;, &#39;grade&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="221">
          
          
          <code class="ruby">      )</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="222">
          
          
          <code class="ruby">      .map do |r|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="223">
          
          
          <code class="ruby">        t = Task.find(r.id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="224">
          
          
          <code class="ruby">        {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="225">
          
          
          <code class="ruby">          id: r.id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="226">
          
          
          <code class="ruby">          status: TaskStatus.find(r.status_id).status_key,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="227">
          
          
          <code class="ruby">          task_definition_id: r.task_definition_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="228">
          
          
          <code class="ruby">          include_in_portfolio: r.include_in_portfolio,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="229">
          
          
          <code class="ruby">          pct_similar: t.pct_similar,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="230">
          
          
          <code class="ruby">          similar_to_count: t.similar_to_count,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="231">
          
          
          <code class="ruby">          similar_to_dismissed_count: t.similar_to_dismissed_count,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="232">
          
          
          <code class="ruby">          times_assessed: r.times_assessed,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="233">
          
          
          <code class="ruby">          grade: r.grade,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="234">
          
          
          <code class="ruby">          quality_pts: r.quality_pts,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="235">
          
          
          <code class="ruby">          num_new_comments: r.number_unread,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="236">
          
          
          <code class="ruby">          extensions: t.extensions,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="237">
          
          
          <code class="ruby">          due_date: t.due_date</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="238">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="239">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="240">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="241">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="242">
          <span class="hits">1</span>
          
          <code class="ruby">  def assigned_tasks</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="243">
          <span class="hits">1</span>
          
          <code class="ruby">    tasks.joins(:task_definition).where(&#39;task_definitions.target_grade &lt;= :target&#39;, target: target_grade)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="244">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="245">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="246">
          <span class="hits">1</span>
          
          <code class="ruby">  def portfolio_tasks</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="247">
          
          
          <code class="ruby">    # Get assigned tasks that are included in the portfolio</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="248">
          
          
          <code class="ruby">    tasks = self.tasks.joins(:task_definition).order(&#39;task_definitions.target_date, task_definitions.abbreviation&#39;).where(&#39;tasks.include_in_portfolio = TRUE&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="249">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="250">
          
          
          <code class="ruby">    # Remove the tasks that are not aligned... if there are ILOs</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="251">
          
          
          <code class="ruby">    unless unit.learning_outcomes.empty?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="252">
          
          
          <code class="ruby">      tasks = tasks.select { |t| t.learning_outcome_task_links.count &gt; 0 }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="253">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="254">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="255">
          
          
          <code class="ruby">    # Now select the tasks that and have a PDF... cant include the others...</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="256">
          
          
          <code class="ruby">    portfolio_tasks = tasks.select(&amp;:has_pdf)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="257">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="258">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="259">
          <span class="hits">1</span>
          
          <code class="ruby">  def target_grade=(value)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="260">
          
          
          <code class="ruby">    self[:target_grade] = value</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="261">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="262">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="263">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="264">
          
          
          <code class="ruby">  # Get task_definitions and status for the current student for all tasks that are &lt;= the target</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="265">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="266">
          <span class="hits">1</span>
          
          <code class="ruby">  def task_definitions_and_status(target)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="267">
          
          
          <code class="ruby">    assigned_task_defs_for_grade(target).</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="268">
          
          
          <code class="ruby">      order(&quot;start_date ASC, abbreviation ASC&quot;).</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="269">
          
          
          <code class="ruby">      map { |td|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="270">
          
          
          <code class="ruby">          if has_task_for_task_definition? td </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="271">
          
          
          <code class="ruby">            task = task_for_task_definition(td)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="272">
          
          
          <code class="ruby">            {task_definition: td, task: task, status: task.status } </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="273">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="274">
          
          
          <code class="ruby">            {task_definition: td, task: nil, status: :not_started } </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="275">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="276">
          
          
          <code class="ruby">        }.</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="277">
          
          
          <code class="ruby">      select { |r| [:not_started, :redo, :need_help, :working_on_it, :fix_and_resubmit, :demonstrate, :discuss].include? r[:status] }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="278">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="279">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="280">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="281">
          
          
          <code class="ruby">  # Calculate a list of the top 5 task definitions the student should focus on,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="282">
          
          
          <code class="ruby">  # in order of priority with reason.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="283">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="284">
          <span class="hits">1</span>
          
          <code class="ruby">  def top_tasks</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="285">
          
          
          <code class="ruby">    result = []</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="286">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="287">
          
          
          <code class="ruby">    to_target = lambda { |ts| ts[:task].nil? ? ts[:task_definition].target_date : ts[:task].due_date }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="288">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="289">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="290">
          
          
          <code class="ruby">    # Get list of tasks that could be top tasks...</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="291">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="292">
          
          
          <code class="ruby">    task_states = task_definitions_and_status(target_grade)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="293">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="294">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="295">
          
          
          <code class="ruby">    # Start with overdue...</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="296">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="297">
          
          
          <code class="ruby">    overdue_tasks = task_states.select { |ts| to_target.call(ts) &lt; Time.zone.today }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="298">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="299">
          
          
          <code class="ruby">    grades = [ &quot;Pass&quot;, &quot;Credit&quot;, &quot;Distinction&quot;, &quot;High Distinction&quot; ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="300">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="301">
          
          
          <code class="ruby">    for i in 0..3</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="302">
          
          
          <code class="ruby">      graded_tasks = overdue_tasks.select { |ts| ts[:task_definition].target_grade == i  }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="303">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="304">
          
          
          <code class="ruby">      graded_tasks.each do |ts|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="305">
          
          
          <code class="ruby">        result &lt;&lt; { task_definition: ts[:task_definition], status: ts[:status], reason: :overdue }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="306">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="307">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="308">
          
          
          <code class="ruby">      return result.slice(0..4) if result.count &gt;= 5</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="309">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="310">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="311">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="312">
          
          
          <code class="ruby">    # Add in soon tasks...</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="313">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="314">
          
          
          <code class="ruby">    soon_tasks = task_states.select { |ts| to_target.call(ts) &gt;= Time.zone.today &amp;&amp; to_target.call(ts) &lt; Time.zone.today + 7.days }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="315">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="316">
          
          
          <code class="ruby">    for i in 0..3</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="317">
          
          
          <code class="ruby">      graded_tasks = soon_tasks.select { |ts| ts[:task_definition].target_grade == i  }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="318">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="319">
          
          
          <code class="ruby">      graded_tasks.each do |ts|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="320">
          
          
          <code class="ruby">        result &lt;&lt; { task_definition: ts[:task_definition], status: ts[:status], reason: :soon }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="321">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="322">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="323">
          
          
          <code class="ruby">      return result.slice(0..4) if result.count &gt;= 5</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="324">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="325">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="326">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="327">
          
          
          <code class="ruby">    # Add in ahead tasks...</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="328">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="329">
          
          
          <code class="ruby">    ahead_tasks = task_states.select { |ts| to_target.call(ts) &gt;= Time.zone.today + 7.days }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="330">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="331">
          
          
          <code class="ruby">    for i in 0..3</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="332">
          
          
          <code class="ruby">      graded_tasks = ahead_tasks.select { |ts| ts[:task_definition].target_grade == i  }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="333">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="334">
          
          
          <code class="ruby">      graded_tasks.each do |ts|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="335">
          
          
          <code class="ruby">        result &lt;&lt; { task_definition: ts[:task_definition], status: ts[:status], reason: :ahead }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="336">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="337">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="338">
          
          
          <code class="ruby">      return result.slice(0..4) if result.count &gt;= 5</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="339">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="340">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="341">
          
          
          <code class="ruby">    result.slice(0..4)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="342">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="343">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="344">
          <span class="hits">1</span>
          
          <code class="ruby">  def should_revert_to_pass</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="345">
          
          
          <code class="ruby">    return false unless self.target_grade &gt; 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="346">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="347">
          
          
          <code class="ruby">    to_target = lambda { |ts| ts[:task].nil? ? ts[:task_definition].target_date.to_date : ts[:task].due_date.to_date }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="348">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="349">
          
          
          <code class="ruby">    task_states = task_definitions_and_status(0)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="350">
          
          
          <code class="ruby">    overdue_tasks = task_states.select { |ts| to_target.call(ts) &lt; Time.zone.today }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="351">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="352">
          
          
          <code class="ruby">    # More than 2 pass tasks overdue</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="353">
          
          
          <code class="ruby">    return false unless overdue_tasks.count &gt; 2</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="354">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="355">
          
          
          <code class="ruby">    # Oldest is more than 2 weeks past target</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="356">
          
          
          <code class="ruby">    return false unless (Time.zone.today - to_target.call(overdue_tasks.first)).to_i &gt;= 14</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="357">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="358">
          
          
          <code class="ruby">    return true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="359">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="360">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="361">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="362">
          
          
          <code class="ruby">  # Calculate and return the burndown chart data</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="363">
          
          
          <code class="ruby">  # returns four lines:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="364">
          
          
          <code class="ruby">  # - projected based on previous work marked as at least &quot;ready to assessess&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="365">
          
          
          <code class="ruby">  # - target based on task definitions</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="366">
          
          
          <code class="ruby">  # - done based on work marked as at least &quot;ready to assess&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="367">
          
          
          <code class="ruby">  # - complete based on work signed off as complete</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="368">
          <span class="hits">1</span>
          
          <code class="ruby">  def burndown_chart_data</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="369">
          
          
          <code class="ruby">    # Create buckets by week</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="370">
          
          
          <code class="ruby">    result = [ ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="371">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="372">
          
          
          <code class="ruby">    # Get the weeks between start and end date as an array</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="373">
          
          
          <code class="ruby">    # dates = unit.start_date.to_date.step(unit.end_date.to_date + 1.week, step=7).to_a</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="374">
          
          
          <code class="ruby">    dates = unit.start_date.to_date.step(unit.end_date.to_date + 3.week, 7).to_a</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="375">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="376">
          
          
          <code class="ruby">    # Setup the dictionaries to contain the keys and values</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="377">
          
          
          <code class="ruby">    # key = series name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="378">
          
          
          <code class="ruby">    # values = array of [ x, y ] values</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="379">
          
          
          <code class="ruby">    projected_results = { key: &#39;Projected&#39;, values: [] }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="380">
          
          
          <code class="ruby">    target_task_results = { key: &#39;Target&#39;, values: [] }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="381">
          
          
          <code class="ruby">    done_task_results = { key: &#39;To Submit&#39;, values: [] }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="382">
          
          
          <code class="ruby">    complete_task_results = { key: &#39;To Complete&#39;, values: [] }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="383">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="384">
          
          
          <code class="ruby">    result.push(target_task_results)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="385">
          
          
          <code class="ruby">    result.push(projected_results)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="386">
          
          
          <code class="ruby">    result.push(done_task_results)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="387">
          
          
          <code class="ruby">    result.push(complete_task_results)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="388">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="389">
          
          
          <code class="ruby">    # Get the target task from the unit&#39;s task definitions</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="390">
          
          
          <code class="ruby">    target_tasks = assigned_task_defs</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="391">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="392">
          
          
          <code class="ruby">    return if target_tasks.count == 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="393">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="394">
          
          
          <code class="ruby">    # get total value of all tasks assigned to this project</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="395">
          
          
          <code class="ruby">    total = target_tasks.map { |td| td.weighting.to_f }.inject(:+)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="396">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="397">
          
          
          <code class="ruby">    # last done task date</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="398">
          
          
          <code class="ruby">    if ready_or_complete_tasks.empty?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="399">
          
          
          <code class="ruby">      last_target_date = unit.start_date</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="400">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="401">
          
          
          <code class="ruby">      last_target_date = ready_or_complete_tasks.sort { |a, b| a.due_date &lt;=&gt; b.due_date }.last.due_date</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="402">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="403">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="404">
          
          
          <code class="ruby">    # today is used to determine when to stop adding done tasks</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="405">
          
          
          <code class="ruby">    today = reference_date</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="406">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="407">
          
          
          <code class="ruby">    # Actual tasks</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="408">
          
          
          <code class="ruby">    my_tasks = tasks</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="409">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="410">
          
          
          <code class="ruby">    # Get the tasks currently marked as done (or ready to mark)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="411">
          
          
          <code class="ruby">    done_tasks = tasks_in_submitted_status</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="412">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="413">
          
          
          <code class="ruby">    # use weekly completion rate to determine projected progress</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="414">
          
          
          <code class="ruby">    completion_rate = weekly_completion_rate</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="415">
          
          
          <code class="ruby">    projected_remaining = total</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="416">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="417">
          
          
          <code class="ruby">    # Track which values to add</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="418">
          
          
          <code class="ruby">    add_target = true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="419">
          
          
          <code class="ruby">    add_projected = true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="420">
          
          
          <code class="ruby">    add_done = true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="421">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="422">
          
          
          <code class="ruby">    # Iterate over the dates</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="423">
          
          
          <code class="ruby">    dates.each do |date|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="424">
          
          
          <code class="ruby">      # get the target values - those from the task definitions</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="425">
          
          
          <code class="ruby">      target_val = [ date.to_datetime.to_i,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="426">
          
          
          <code class="ruby">                     target_tasks.select { |task_def| (tasks.where(task_definition: task_def).empty? ? task_def.target_date : tasks.where(task_definition: task_def).first.due_date ) &gt; date }.map { |task_def| task_def.weighting.to_f }.inject(:+)]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="427">
          
          
          <code class="ruby">      # get the done values - those done up to today, or the end of the unit</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="428">
          
          
          <code class="ruby">      done_val = [ date.to_datetime.to_i,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="429">
          
          
          <code class="ruby">                   done_tasks.select { |task| task.submission_date.present? &amp;&amp; task.submission_date &lt;= date }.map { |task| task.task_definition.weighting.to_f }.inject(:+)]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="430">
          
          
          <code class="ruby">      # get the completed values - those signed off</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="431">
          
          
          <code class="ruby">      complete_val = [ date.to_datetime.to_i,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="432">
          
          
          <code class="ruby">                       completed_tasks.select { |task| task.completion_date &lt;= date }.map { |task| task.task_definition.weighting.to_f }.inject(:+)]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="433">
          
          
          <code class="ruby">      # projected value is based on amount done</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="434">
          
          
          <code class="ruby">      projected_val = [ date.to_datetime.to_i, projected_remaining / total ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="435">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="436">
          
          
          <code class="ruby">      # add one week&#39;s worth of completion data</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="437">
          
          
          <code class="ruby">      projected_remaining -= completion_rate</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="438">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="439">
          
          
          <code class="ruby">      # if target value then its the %remaining only</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="440">
          
          
          <code class="ruby">      target_val[1].nil? ? (target_val[1] = 0) : (target_val[1] /= total)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="441">
          
          
          <code class="ruby">      # if no done value then value is 100%, otherwise remaining is the total - %done</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="442">
          
          
          <code class="ruby">      done_val[1] = (done_val[1].nil? ? 1 : (total - done_val[1]) / total)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="443">
          
          
          <code class="ruby">      complete_val[1].nil? ? (complete_val[1] = 1) : (complete_val[1] = (total - complete_val[1]) / total)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="444">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="445">
          
          
          <code class="ruby">      # add target, done and projected if appropriate</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="446">
          
          
          <code class="ruby">      target_task_results[:values].push target_val if add_target</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="447">
          
          
          <code class="ruby">      if add_done</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="448">
          
          
          <code class="ruby">        done_task_results[:values].push done_val</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="449">
          
          
          <code class="ruby">        complete_task_results[:values].push complete_val</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="450">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="451">
          
          
          <code class="ruby">      projected_results[:values].push projected_val if add_projected</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="452">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="453">
          
          
          <code class="ruby">      # stop adding the target values once zero target value is reached</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="454">
          
          
          <code class="ruby">      add_target = false if add_target &amp;&amp; target_val[1] == 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="455">
          
          
          <code class="ruby">      # stop adding the done tasks once past date - (add once for tasks done this week, hence after adding)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="456">
          
          
          <code class="ruby">      add_done = false if add_done &amp;&amp; date &gt; today</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="457">
          
          
          <code class="ruby">      # stop adding projected values once projected is complete</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="458">
          
          
          <code class="ruby">      add_projected = false if add_projected &amp;&amp; projected_val[1] &lt;= 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="459">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="460">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="461">
          
          
          <code class="ruby">    result</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="462">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="463">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="464">
          <span class="hits">1</span>
          
          <code class="ruby">  def projected_end_date</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="465">
          
          
          <code class="ruby">    return unit.end_date if rate_of_completion == 0.0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="466">
          
          
          <code class="ruby">    (remaining_tasks_weight / rate_of_completion).ceil.days.since reference_date</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="467">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="468">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="469">
          <span class="hits">1</span>
          
          <code class="ruby">  def weeks_elapsed(date = nil)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="470">
          
          
          <code class="ruby">    (days_elapsed(date) / 7.0).ceil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="471">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="472">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="473">
          <span class="hits">1</span>
          
          <code class="ruby">  def days_elapsed(date = nil)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="474">
          
          
          <code class="ruby">    date ||= reference_date</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="475">
          
          
          <code class="ruby">    (date - unit.start_date).to_i / 1.day</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="476">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="477">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="478">
          <span class="hits">1</span>
          
          <code class="ruby">  def rate_of_completion(date = nil)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="479">
          
          
          <code class="ruby">    # Return a completion rate of 0.0 if the project is yet to have commenced</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="480">
          
          
          <code class="ruby">    return 0.0 if !commenced? || completed_tasks.empty?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="481">
          
          
          <code class="ruby">    date ||= reference_date</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="482">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="483">
          
          
          <code class="ruby">    # TODO: Might make sense to take in the resolution (i.e. days, weeks), rather</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="484">
          
          
          <code class="ruby">    # than just assuming days</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="485">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="486">
          
          
          <code class="ruby">    # If on the first day (i.e. a day has not yet passed, but the project</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="487">
          
          
          <code class="ruby">    # has commenced), force days elapsed to be 1 to avoid divide by zero</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="488">
          
          
          <code class="ruby">    days = days_elapsed(date)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="489">
          
          
          <code class="ruby">    days = 1 if days_elapsed(date) &lt; 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="490">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="491">
          
          
          <code class="ruby">    completed_tasks_weight / days.to_f</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="492">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="493">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="494">
          <span class="hits">1</span>
          
          <code class="ruby">  def weekly_completion_rate(date = nil)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="495">
          
          
          <code class="ruby">    # Return a completion rate of 0.0 if the project is yet to have commenced</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="496">
          
          
          <code class="ruby">    return 0.0 if ready_or_complete_tasks.empty?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="497">
          
          
          <code class="ruby">    date ||= reference_date</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="498">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="499">
          
          
          <code class="ruby">    weeks = weeks_elapsed(date)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="500">
          
          
          <code class="ruby">    # Ensure at least one week</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="501">
          
          
          <code class="ruby">    weeks = 1 if weeks &lt; 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="502">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="503">
          
          
          <code class="ruby">    completed_tasks_weight / weeks.to_f</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="504">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="505">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="506">
          <span class="hits">1</span>
          
          <code class="ruby">  def completed_tasks</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="507">
          
          
          <code class="ruby">    assigned_tasks.select(&amp;:complete?)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="508">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="509">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="510">
          <span class="hits">1</span>
          
          <code class="ruby">  def ready_to_mark_tasks</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="511">
          
          
          <code class="ruby">    assigned_tasks.select(&amp;:ready_to_mark?)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="512">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="513">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="514">
          <span class="hits">1</span>
          
          <code class="ruby">  def ready_or_complete_tasks</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="515">
          
          
          <code class="ruby">    assigned_tasks.select(&amp;:ready_or_complete?)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="516">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="517">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="518">
          <span class="hits">1</span>
          
          <code class="ruby">  def tasks_in_submitted_status</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="519">
          
          
          <code class="ruby">    assigned_tasks.select(&amp;:submitted_status?)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="520">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="521">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="522">
          <span class="hits">1</span>
          
          <code class="ruby">  def discuss_and_demonstrate_tasks</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="523">
          
          
          <code class="ruby">    tasks.select(&amp;:discuss_or_demonstrate?)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="524">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="525">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="526">
          <span class="hits">1</span>
          
          <code class="ruby">  def partially_completed_tasks</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="527">
          
          
          <code class="ruby">    # TODO: Should probably have a better definition</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="528">
          
          
          <code class="ruby">    # of partially complete than just &#39;fix&#39; tasks</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="529">
          
          
          <code class="ruby">    assigned_tasks.select { |task| task.fix_and_resubmit? || task.do_not_resubmit? }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="530">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="531">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="532">
          <span class="hits">1</span>
          
          <code class="ruby">  def completed?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="533">
          
          
          <code class="ruby">    # TODO: Have a status flag on the project instead</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="534">
          
          
          <code class="ruby">    assigned_tasks.all?(&amp;:complete?)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="535">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="536">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="537">
          <span class="hits">1</span>
          
          <code class="ruby">  def incomplete_tasks</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="538">
          
          
          <code class="ruby">    assigned_tasks.select { |task| !task.complete? }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="539">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="540">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="541">
          <span class="hits">1</span>
          
          <code class="ruby">  def percentage_complete</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="542">
          
          
          <code class="ruby">    completed_tasks.empty? ? 0.0 : (completed_tasks_weight / total_task_weight) * 100</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="543">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="544">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="545">
          <span class="hits">1</span>
          
          <code class="ruby">  def remaining_tasks_weight</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="546">
          
          
          <code class="ruby">    incomplete_tasks.empty? ? 0.0 : incomplete_tasks.map { |task| task.task_definition.weighting }.inject(:+)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="547">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="548">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="549">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="550">
          
          
          <code class="ruby">  # get the weight of all tasks completed or marked as ready to assess</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="551">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="552">
          <span class="hits">1</span>
          
          <code class="ruby">  def completed_tasks_weight</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="553">
          
          
          <code class="ruby">    ready_or_complete_tasks.empty? ? 0.0 : ready_or_complete_tasks.map { |task| task.task_definition.weighting }.inject(:+)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="554">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="555">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="556">
          <span class="hits">1</span>
          
          <code class="ruby">  def partially_completed_tasks_weight</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="557">
          
          
          <code class="ruby">    # Award half for partially completed tasks</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="558">
          
          
          <code class="ruby">    # TODO: Should probably make this a project-by-project option</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="559">
          
          
          <code class="ruby">    partially_complete = partially_completed_tasks</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="560">
          
          
          <code class="ruby">    partially_complete.empty? ? 0.0 : partially_complete.map { |task| task.task_definition.weighting / 2.to_f }.inject(:+)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="561">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="562">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="563">
          <span class="hits">1</span>
          
          <code class="ruby">  def task_units_completed</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="564">
          
          
          <code class="ruby">    completed_tasks_weight + partially_completed_tasks_weight</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="565">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="566">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="567">
          <span class="hits">1</span>
          
          <code class="ruby">  def convert_hash_to_pct(hash, total)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="568">
          
          
          <code class="ruby">    hash.each { |key, value| hash[key] = (hash[key] &lt; 0.01 ? 0.0 : (value / total).signif(2)) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="569">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="570">
          
          
          <code class="ruby">    total = 0.0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="571">
          
          
          <code class="ruby">    hash.each { |_key, value| total += value }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="572">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="573">
          
          
          <code class="ruby">    if total != 1.0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="574">
          
          
          <code class="ruby">      dif = 1.0 - total</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="575">
          
          
          <code class="ruby">      hash.each do |key, value|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="576">
          
          
          <code class="ruby">        if value &gt; 0.0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="577">
          
          
          <code class="ruby">          hash[key] = (hash[key] + dif).signif(2)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="578">
          
          
          <code class="ruby">          break</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="579">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="580">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="581">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="582">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="583">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="584">
          
          
          <code class="ruby">  # Calculate the task stats text to send progress data back to the client</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="585">
          
          
          <code class="ruby">  # Total task counts must contain an array of the cummulative task counts (with none being 0)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="586">
          
          
          <code class="ruby">  # Project task counts is an object with fail_count, complete_count etc for each status</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="587">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.create_task_stats_from(total_task_counts, project_task_counts, target_grade)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="588">
          <span class="hits">1</span>
          
          <code class="ruby">    red_pct = ((project_task_counts.fail_count + project_task_counts.do_not_resubmit_count + project_task_counts.time_exceeded_count) / total_task_counts[target_grade]).signif(2)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="589">
          <span class="hits">1</span>
          
          <code class="ruby">    orange_pct = ((project_task_counts.redo_count + project_task_counts.need_help_count + project_task_counts.fix_and_resubmit_count) / total_task_counts[target_grade]).signif(2)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="590">
          <span class="hits">1</span>
          
          <code class="ruby">    green_pct = ((project_task_counts.discuss_count + project_task_counts.demonstrate_count + project_task_counts.complete_count) / total_task_counts[target_grade]).signif(2)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="591">
          <span class="hits">1</span>
          
          <code class="ruby">    blue_pct = (project_task_counts.ready_to_mark_count / total_task_counts[target_grade]).signif(2)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="592">
          <span class="hits">1</span>
          
          <code class="ruby">    grey_pct = (1 - red_pct - orange_pct - green_pct - blue_pct).signif(2)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="593">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="594">
          <span class="hits">1</span>
          
          <code class="ruby">    order_scale = green_pct * 100 + blue_pct * 100 + orange_pct * 10 - red_pct</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="595">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="596">
          
          
          <code class="ruby">    {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="597">
          
          
          <code class="ruby">      red_pct: red_pct,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="598">
          
          
          <code class="ruby">      grey_pct: grey_pct,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="599">
          
          
          <code class="ruby">      orange_pct: orange_pct,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="600">
          
          
          <code class="ruby">      blue_pct: blue_pct,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="601">
          
          
          <code class="ruby">      green_pct: green_pct,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="602">
          
          
          <code class="ruby">      order_scale: order_scale</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="603">
          <span class="hits">1</span>
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="604">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="605">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="606">
          <span class="hits">1</span>
          
          <code class="ruby">  def task_stats</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="607">
          <span class="hits">1</span>
          
          <code class="ruby">    task_count = [0, 1, 2, 3].map do |e|</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="608">
          <span class="hits">4</span>
          
          <code class="ruby">      unit.task_definitions.where(&quot;target_grade &lt;= #{e}&quot;).count + 0.0</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="609">
          <span class="hits">4</span>
          
          <code class="ruby">    end.map { |e| e == 0 ? 1 : e }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="610">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="611">
          <span class="hits">1</span>
          
          <code class="ruby">    result = assigned_tasks</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="612">
          
          
          <code class="ruby">        .group(&#39;project_id&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="613">
          
          
          <code class="ruby">        .select(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="614">
          
          
          <code class="ruby">          &#39;project_id&#39;,</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="615">
          <span class="hits">12</span>
          
          <code class="ruby">          *TaskStatus.all.map { |s| &quot;SUM(CASE WHEN tasks.task_status_id = #{s.id} THEN 1 ELSE 0 END) AS #{s.status_key}_count&quot; }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="616">
          
          
          <code class="ruby">        )</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="617">
          <span class="hits">1</span>
          
          <code class="ruby">        .map do |t| Project.create_task_stats_from(task_count, t, target_grade) end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="618">
          
          
          <code class="ruby">        .first</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="619">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="620">
          <span class="hits">1</span>
          
          <code class="ruby">    if result.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="621">
          
          
          <code class="ruby">      {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="622">
          
          
          <code class="ruby">        red_pct: 0,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="623">
          
          
          <code class="ruby">        grey_pct: 1,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="624">
          
          
          <code class="ruby">        orange_pct: 0,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="625">
          
          
          <code class="ruby">        blue_pct: 0,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="626">
          
          
          <code class="ruby">        green_pct: 0,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="627">
          
          
          <code class="ruby">        order_scale: 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="628">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="629">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="630">
          <span class="hits">1</span>
          
          <code class="ruby">      result</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="631">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="632">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="633">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="634">
          <span class="hits">1</span>
          
          <code class="ruby">  def assigned_task_defs_for_grade(target)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="635">
          
          
          <code class="ruby">    unit.task_definitions.where(&#39;target_grade &lt;= :grade&#39;, grade: target)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="636">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="637">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="638">
          <span class="hits">1</span>
          
          <code class="ruby">  def assigned_task_defs</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="639">
          
          
          <code class="ruby">    assigned_task_defs_for_grade target_grade</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="640">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="641">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="642">
          <span class="hits">1</span>
          
          <code class="ruby">  def total_task_weight</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="643">
          
          
          <code class="ruby">    assigned_task_defs.map(&amp;:weighting).inject(:+)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="644">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="645">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="646">
          <span class="hits">1</span>
          
          <code class="ruby">  def remaining_days</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="647">
          
          
          <code class="ruby">    (unit.end_date - reference_date).to_i / 1.day</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="648">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="649">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="650">
          <span class="hits">1</span>
          
          <code class="ruby">  def in_progress?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="651">
          
          
          <code class="ruby">    commenced? &amp;&amp; !concluded?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="652">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="653">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="654">
          <span class="hits">1</span>
          
          <code class="ruby">  def commenced?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="655">
          
          
          <code class="ruby">    application_reference_date &gt;= unit.start_date</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="656">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="657">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="658">
          <span class="hits">1</span>
          
          <code class="ruby">  def concluded?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="659">
          
          
          <code class="ruby">    application_reference_date &gt; unit.end_date</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="660">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="661">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="662">
          <span class="hits">1</span>
          
          <code class="ruby">  def last_task_completed</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="663">
          
          
          <code class="ruby">    completed_tasks.sort_by(&amp;:completion_date).last</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="664">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="665">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="666">
          <span class="hits">1</span>
          
          <code class="ruby">  def task_completion_csv</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="667">
          
          
          <code class="ruby">    all_tasks = unit.task_definitions_by_grade</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="668">
          
          
          <code class="ruby">    [</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="669">
          
          
          <code class="ruby">      student.username,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="670">
          
          
          <code class="ruby">      student.name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="671">
          
          
          <code class="ruby">      target_grade_desc,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="672">
          
          
          <code class="ruby">      student.email,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="673">
          
          
          <code class="ruby">      portfolio_status,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="674">
          
          
          <code class="ruby">      tutorial ? tutorial.abbreviation : &#39;&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="675">
          
          
          <code class="ruby">      main_tutor.name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="676">
          
          
          <code class="ruby">    ] +</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="677">
          
          
          <code class="ruby">      unit.group_sets.map do |gs|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="678">
          
          
          <code class="ruby">        grp = group_for_groupset(gs)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="679">
          
          
          <code class="ruby">        grp ? grp.name : nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="680">
          
          
          <code class="ruby">      end +</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="681">
          
          
          <code class="ruby">      all_tasks.map do |td|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="682">
          
          
          <code class="ruby">        task = tasks.where(task_definition_id: td.id).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="683">
          
          
          <code class="ruby">        if task</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="684">
          
          
          <code class="ruby">          status = task.task_status.name</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="685">
          
          
          <code class="ruby">          grade = task.grade_desc</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="686">
          
          
          <code class="ruby">          stars = task.quality_pts</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="687">
          
          
          <code class="ruby">          people = task.contribution_pts</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="688">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="689">
          
          
          <code class="ruby">          status = TaskStatus.not_started.name</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="690">
          
          
          <code class="ruby">          grade = nil</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="691">
          
          
          <code class="ruby">          stars = nil</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="692">
          
          
          <code class="ruby">          people = nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="693">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="694">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="695">
          
          
          <code class="ruby">        result = [status]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="696">
          
          
          <code class="ruby">        result &lt;&lt; grade if td.is_graded?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="697">
          
          
          <code class="ruby">        result &lt;&lt; stars if td.has_stars?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="698">
          
          
          <code class="ruby">        result &lt;&lt; people if td.is_group_task?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="699">
          
          
          <code class="ruby">        result</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="700">
          
          
          <code class="ruby">      end.flatten</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="701">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="702">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="703">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="704">
          
          
          <code class="ruby">  # Portfolio production code</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="705">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="706">
          <span class="hits">1</span>
          
          <code class="ruby">  def portfolio_temp_path</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="707">
          
          
          <code class="ruby">    portfolio_dir = FileHelper.student_portfolio_dir(self, false)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="708">
          
          
          <code class="ruby">    portfolio_tmp_dir = File.join(portfolio_dir, &#39;tmp&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="709">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="710">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="711">
          <span class="hits">1</span>
          
          <code class="ruby">  def portfolio_tmp_file_name(dict)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="712">
          
          
          <code class="ruby">    extn = File.extname(dict[:name])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="713">
          
          
          <code class="ruby">    name = File.basename(dict[:name], extn)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="714">
          
          
          <code class="ruby">    name = name.tr(&#39;.&#39;, &#39;_&#39;) + extn</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="715">
          
          
          <code class="ruby">    FileHelper.sanitized_filename(&quot;#{dict[:idx].to_s.rjust(3, &#39;0&#39;)}-#{dict[:kind]}-#{name}&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="716">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="717">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="718">
          <span class="hits">1</span>
          
          <code class="ruby">  def portfolio_tmp_file_path(dict)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="719">
          
          
          <code class="ruby">    File.join(portfolio_temp_path, portfolio_tmp_file_name(dict))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="720">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="721">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="722">
          <span class="hits">1</span>
          
          <code class="ruby">  def move_to_portfolio(file, name, kind)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="723">
          
          
          <code class="ruby">    # get path to portfolio dir</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="724">
          
          
          <code class="ruby">    # get path to tmp folder where file parts will be stored</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="725">
          
          
          <code class="ruby">    portfolio_tmp_dir = portfolio_temp_path</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="726">
          
          
          <code class="ruby">    FileUtils.mkdir_p(portfolio_tmp_dir)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="727">
          
          
          <code class="ruby">    result = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="728">
          
          
          <code class="ruby">      kind: kind,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="729">
          
          
          <code class="ruby">      name: file.filename</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="730">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="731">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="732">
          
          
          <code class="ruby">    # copy up the learning summary report as first -- otherwise use files to determine idx</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="733">
          
          
          <code class="ruby">    if name == &#39;LearningSummaryReport&#39; &amp;&amp; kind == &#39;document&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="734">
          
          
          <code class="ruby">      result[:idx] = 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="735">
          
          
          <code class="ruby">      result[:name] = &#39;LearningSummaryReport.pdf&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="736">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="737">
          
          
          <code class="ruby">      Dir.chdir(portfolio_tmp_dir)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="738">
          
          
          <code class="ruby">      files = Dir.glob(&#39;*&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="739">
          
          
          <code class="ruby">      idx = files.map { |a_file| a_file.split(&#39;-&#39;).first.to_i }.max</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="740">
          
          
          <code class="ruby">      if idx.nil? || idx &lt; 1</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="741">
          
          
          <code class="ruby">        idx = 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="742">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="743">
          
          
          <code class="ruby">        idx += 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="744">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="745">
          
          
          <code class="ruby">      result[:idx] = idx</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="746">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="747">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="748">
          
          
          <code class="ruby">    dest_file = portfolio_tmp_file_name(result)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="749">
          
          
          <code class="ruby">    FileUtils.cp file.tempfile.path, File.join(portfolio_tmp_dir, dest_file)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="750">
          
          
          <code class="ruby">    result</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="751">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="752">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="753">
          <span class="hits">1</span>
          
          <code class="ruby">  def portfolio_files(ensure_valid = false, force_ascii = false)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="754">
          
          
          <code class="ruby">    # get path to portfolio dir</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="755">
          
          
          <code class="ruby">    portfolio_tmp_dir = portfolio_temp_path</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="756">
          
          
          <code class="ruby">    return [] unless Dir.exist? portfolio_tmp_dir</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="757">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="758">
          
          
          <code class="ruby">    result = []</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="759">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="760">
          
          
          <code class="ruby">    Dir.chdir(portfolio_tmp_dir)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="761">
          
          
          <code class="ruby">    files = Dir.glob(&#39;*&#39;).select { |f| (f =~ /^\d{3}\-(cover|document|code|image)/) == 0 }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="762">
          
          
          <code class="ruby">    files.each do |file|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="763">
          
          
          <code class="ruby">      parts = file.split(&#39;-&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="764">
          
          
          <code class="ruby">      idx = parts[0].to_i</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="765">
          
          
          <code class="ruby">      kind = parts[1]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="766">
          
          
          <code class="ruby">      name = parts.drop(2).join(&#39;-&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="767">
          
          
          <code class="ruby">      result &lt;&lt; { kind: kind, name: name, idx: idx }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="768">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="769">
          
          
          <code class="ruby">      FileHelper.ensure_utf8_code(file, force_ascii) if ensure_valid &amp;&amp; kind == &quot;code&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="770">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="771">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="772">
          
          
          <code class="ruby">    result</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="773">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="774">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="775">
          
          
          <code class="ruby">  # Remove a file from the portfolio tmp folder</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="776">
          <span class="hits">1</span>
          
          <code class="ruby">  def remove_portfolio_file(idx, kind, name)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="777">
          
          
          <code class="ruby">    # get path to portfolio dir</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="778">
          
          
          <code class="ruby">    portfolio_tmp_dir = portfolio_temp_path</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="779">
          
          
          <code class="ruby">    return unless Dir.exist? portfolio_tmp_dir</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="780">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="781">
          
          
          <code class="ruby">    # the file is in the students portfolio tmp dir</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="782">
          
          
          <code class="ruby">    rm_file = File.join(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="783">
          
          
          <code class="ruby">      portfolio_tmp_dir,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="784">
          
          
          <code class="ruby">      FileHelper.sanitized_filename(&quot;#{idx.to_s.rjust(3, &#39;0&#39;)}-#{kind}-#{name}&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="785">
          
          
          <code class="ruby">    )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="786">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="787">
          
          
          <code class="ruby">    # try to remove the file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="788">
          
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="789">
          
          
          <code class="ruby">      FileUtils.rm rm_file if File.exist? rm_file</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="790">
          
          
          <code class="ruby">    rescue</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="791">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="792">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="793">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="794">
          <span class="hits">1</span>
          
          <code class="ruby">  def portfolio_path</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="795">
          
          
          <code class="ruby">    File.join(FileHelper.student_portfolio_dir(self, true), FileHelper.sanitized_filename(&quot;#{student.username}-portfolio.pdf&quot;))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="796">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="797">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="798">
          <span class="hits">1</span>
          
          <code class="ruby">  def has_portfolio</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="799">
          
          
          <code class="ruby">    (!portfolio_production_date.nil?) &amp;&amp; portfolio_available</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="800">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="801">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="802">
          <span class="hits">1</span>
          
          <code class="ruby">  def portfolio_status</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="803">
          
          
          <code class="ruby">    if has_portfolio</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="804">
          
          
          <code class="ruby">      &#39;YES&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="805">
          
          
          <code class="ruby">    elsif compile_portfolio</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="806">
          
          
          <code class="ruby">      &#39;in process&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="807">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="808">
          
          
          <code class="ruby">      &#39;no&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="809">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="810">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="811">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="812">
          <span class="hits">1</span>
          
          <code class="ruby">  def portfolio_available</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="813">
          
          
          <code class="ruby">    (File.exist? portfolio_path) &amp;&amp; !compile_portfolio</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="814">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="815">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="816">
          <span class="hits">1</span>
          
          <code class="ruby">  def remove_portfolio</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="817">
          
          
          <code class="ruby">    portfolio = portfolio_path</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="818">
          
          
          <code class="ruby">    FileUtils.mv portfolio, &quot;#{portfolio}.old&quot; if File.exist?(portfolio)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="819">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="820">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="821">
          <span class="hits">1</span>
          
          <code class="ruby">  def recalculate_max_similar_pct</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="822">
          
          
          <code class="ruby">    # self.max_pct_similar = tasks.sort { |t1, t2|  t1.max_pct_similar &lt;=&gt; t2.max_pct_similar }.last.max_pct_similar</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="823">
          
          
          <code class="ruby">    # self.save</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="824">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="825">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="826">
          <span class="hits">1</span>
          
          <code class="ruby">  def matching_task(other_task)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="827">
          
          
          <code class="ruby">    task_for_task_definition(other_task.task_definition)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="828">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="829">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="830">
          <span class="hits">1</span>
          
          <code class="ruby">  def has_task_for_task_definition?(td)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="831">
          
          
          <code class="ruby">    !tasks.where(task_definition: td).first.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="832">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="833">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="834">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="835">
          
          
          <code class="ruby">  # Get the status of a task, without creating it if it does not exist...</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="836">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="837">
          <span class="hits">1</span>
          
          <code class="ruby">  def status_for_task_definition(td)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="838">
          
          
          <code class="ruby">    if has_task_for_task_definition? td</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="839">
          
          
          <code class="ruby">      task_for_task_definition(td).status</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="840">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="841">
          
          
          <code class="ruby">      :not_started</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="842">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="843">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="844">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="845">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="846">
          
          
          <code class="ruby">  # Get the task for the requested definition. This will create the</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="847">
          
          
          <code class="ruby">  # task if the task does not exist for this project.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="848">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="849">
          <span class="hits">1</span>
          
          <code class="ruby">  def task_for_task_definition(td)</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="850">
          <span class="hits">5</span>
          
          <code class="ruby">    logger.debug &quot;Finding task #{td.abbreviation} for project #{log_details}&quot;</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="851">
          <span class="hits">5</span>
          
          <code class="ruby">    result = tasks.where(task_definition: td).first</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="852">
          <span class="hits">5</span>
          
          <code class="ruby">    if result.nil?</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="853">
          <span class="hits">4</span>
          
          <code class="ruby">      begin</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="854">
          <span class="hits">4</span>
          
          <code class="ruby">        result = Task.create!(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="855">
          
          
          <code class="ruby">          task_definition_id: td.id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="856">
          
          
          <code class="ruby">          project_id: id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="857">
          
          
          <code class="ruby">          task_status_id: 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="858">
          
          
          <code class="ruby">        )</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="859">
          <span class="hits">4</span>
          
          <code class="ruby">        logger.info &quot;Created task #{result.id} - #{td.abbreviation} for project #{log_details}&quot;</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="860">
          <span class="hits">4</span>
          
          <code class="ruby">        result.save</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="861">
          <span class="hits">4</span>
          
          <code class="ruby">        tasks.push result</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="862">
          
          
          <code class="ruby">      rescue</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="863">
          
          
          <code class="ruby">        result = tasks.where(task_definition: td).first</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="864">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="865">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="866">
          <span class="hits">5</span>
          
          <code class="ruby">    result</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="867">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="868">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="869">
          <span class="hits">1</span>
          
          <code class="ruby">  def group_for_groupset(gs)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="870">
          
          
          <code class="ruby">    groups.where(group_set: gs).first</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="871">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="872">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="873">
          <span class="hits">1</span>
          
          <code class="ruby">  def group_membership_for_groupset(gs)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="874">
          
          
          <code class="ruby">    group_memberships.joins(:group).where(&#39;groups.group_set_id = :id&#39;, id: gs).first</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="875">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="876">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="877">
          <span class="hits">1</span>
          
          <code class="ruby">  def export_task_alignment_to_csv</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="878">
          
          
          <code class="ruby">    LearningOutcomeTaskLink.export_task_alignment_to_csv(unit, self)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="879">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="880">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="881">
          <span class="hits">1</span>
          
          <code class="ruby">  class ProjectAppController &lt; ApplicationController</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="882">
          <span class="hits">1</span>
          
          <code class="ruby">    attr_accessor :student</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="883">
          <span class="hits">1</span>
          
          <code class="ruby">    attr_accessor :project</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="884">
          <span class="hits">1</span>
          
          <code class="ruby">    attr_accessor :base_path</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="885">
          <span class="hits">1</span>
          
          <code class="ruby">    attr_accessor :image_path</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="886">
          <span class="hits">1</span>
          
          <code class="ruby">    attr_accessor :learning_summary_report</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="887">
          <span class="hits">1</span>
          
          <code class="ruby">    attr_accessor :ordered_tasks</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="888">
          <span class="hits">1</span>
          
          <code class="ruby">    attr_accessor :portfolio_tasks</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="889">
          <span class="hits">1</span>
          
          <code class="ruby">    attr_accessor :task_defs</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="890">
          <span class="hits">1</span>
          
          <code class="ruby">    attr_accessor :outcomes</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="891">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="892">
          <span class="hits">1</span>
          
          <code class="ruby">    def init(project, is_retry)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="893">
          
          
          <code class="ruby">      @student = project.student</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="894">
          
          
          <code class="ruby">      @project = project</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="895">
          
          
          <code class="ruby">      @learning_summary_report = project.learning_summary_report_path</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="896">
          
          
          <code class="ruby">      @files = project.portfolio_files(true, is_retry)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="897">
          
          
          <code class="ruby">      @base_path = project.portfolio_temp_path</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="898">
          
          
          <code class="ruby">      @image_path = Rails.root.join(&#39;public&#39;, &#39;assets&#39;, &#39;images&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="899">
          
          
          <code class="ruby">      @ordered_tasks = project.tasks.joins(:task_definition).order(&#39;task_definitions.start_date, task_definitions.abbreviation&#39;).where(&quot;task_definitions.target_grade &lt;= #{project.target_grade}&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="900">
          
          
          <code class="ruby">      @portfolio_tasks = project.portfolio_tasks</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="901">
          
          
          <code class="ruby">      @task_defs = project.unit.task_definitions.order(:start_date)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="902">
          
          
          <code class="ruby">      @outcomes = project.unit.learning_outcomes.order(:ilo_number)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="903">
          
          
          <code class="ruby">      @institution_name = Doubtfire::Application.config.institution[:name]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="904">
          
          
          <code class="ruby">      @doubtfire_product_name = Doubtfire::Application.config.institution[:product_name]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="905">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="906">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="907">
          <span class="hits">1</span>
          
          <code class="ruby">    def make_pdf</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="908">
          
          
          <code class="ruby">      render_to_string(template: &#39;/portfolio/portfolio_pdf.pdf.erb&#39;, layout: true)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="909">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="910">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="911">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="912">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="913">
          
          
          <code class="ruby">  # Return the path to the student&#39;s learning summary report.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="914">
          
          
          <code class="ruby">  # This returns nil if there is no learning summary report.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="915">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="916">
          <span class="hits">1</span>
          
          <code class="ruby">  def learning_summary_report_path</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="917">
          
          
          <code class="ruby">    portfolio_tmp_dir = portfolio_temp_path</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="918">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="919">
          
          
          <code class="ruby">    return nil unless Dir.exist? portfolio_tmp_dir</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="920">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="921">
          
          
          <code class="ruby">    filename = &quot;#{portfolio_tmp_dir}/000-document-LearningSummaryReport.pdf&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="922">
          
          
          <code class="ruby">    return nil unless File.exist? filename</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="923">
          
          
          <code class="ruby">    filename</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="924">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="925">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="926">
          <span class="hits">1</span>
          
          <code class="ruby">  def create_portfolio</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="927">
          
          
          <code class="ruby">    return false unless compile_portfolio</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="928">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="929">
          
          
          <code class="ruby">    self.compile_portfolio = false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="930">
          
          
          <code class="ruby">    save!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="931">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="932">
          
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="933">
          
          
          <code class="ruby">      pac = ProjectAppController.new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="934">
          
          
          <code class="ruby">      pac.init(self, false)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="935">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="936">
          
          
          <code class="ruby">      begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="937">
          
          
          <code class="ruby">        pdf_text = pac.make_pdf</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="938">
          
          
          <code class="ruby">      rescue =&gt; e</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="939">
          
          
          <code class="ruby">        # Try again... with convert to ascii</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="940">
          
          
          <code class="ruby">        pac2 = ProjectAppController.new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="941">
          
          
          <code class="ruby">        pac2.init(self, true)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="942">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="943">
          
          
          <code class="ruby">        pdf_text = pac2.make_pdf</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="944">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="945">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="946">
          
          
          <code class="ruby">      File.open(portfolio_path, &#39;w&#39;) do |fout|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="947">
          
          
          <code class="ruby">        fout.puts pdf_text</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="948">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="949">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="950">
          
          
          <code class="ruby">      logger.info &quot;Created portfolio at #{portfolio_path} - #{log_details}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="951">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="952">
          
          
          <code class="ruby">      self.portfolio_production_date = Time.zone.now</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="953">
          
          
          <code class="ruby">      save</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="954">
          
          
          <code class="ruby">      return true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="955">
          
          
          <code class="ruby">    rescue =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="956">
          
          
          <code class="ruby">      logger.error &quot;Failed to convert portfolio to PDF - #{log_details} -\nError: #{e.message}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="957">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="958">
          
          
          <code class="ruby">      log_file = e.message.scan(/\/.*\.log/).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="959">
          
          
          <code class="ruby">      if log_file &amp;&amp; File.exist?(log_file)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="960">
          
          
          <code class="ruby">        begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="961">
          
          
          <code class="ruby">          puts &quot;--- Latex Log ---\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="962">
          
          
          <code class="ruby">          puts File.read(log_file)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="963">
          
          
          <code class="ruby">          puts &quot;---    End    ---\n\n&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="964">
          
          
          <code class="ruby">        rescue</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="965">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="966">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="967">
          
          
          <code class="ruby">      return false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="968">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="969">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="970">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="971">
          <span class="hits">1</span>
          
          <code class="ruby">  def send_weekly_status_email ( summary_stats, middle_of_unit )</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="972">
          
          
          <code class="ruby">    did_revert_to_pass = false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="973">
          
          
          <code class="ruby">    if middle_of_unit &amp;&amp; should_revert_to_pass &amp;&amp; ! has_portfolio</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="974">
          
          
          <code class="ruby">      self.target_grade = 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="975">
          
          
          <code class="ruby">      save</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="976">
          
          
          <code class="ruby">      did_revert_to_pass = true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="977">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="978">
          
          
          <code class="ruby">      summary_stats[:revert_count] = summary_stats[:revert_count] + 1</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="979">
          
          
          <code class="ruby">      summary_stats[:revert][main_tutor] &lt;&lt; self</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="980">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="981">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="982">
          
          
          <code class="ruby">    return unless student.receive_feedback_notifications</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="983">
          
          
          <code class="ruby">    return if has_portfolio &amp;&amp; ! middle_of_unit</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="984">
          
          
          <code class="ruby">    NotificationsMailer.weekly_student_summary(self, summary_stats, did_revert_to_pass).deliver_now</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="985">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="986">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="a35a3538b419ef463052fdaebd3fbd0e5b696ee4">
  <div class="header">
    <h3>app/models/role.rb</h3>
    <h4><span class="yellow">83.87 %</span> covered</h4>
    <div>
      <b>31</b> relevant lines. 
      <span class="green"><b>26</b> lines covered</span> and
      <span class="red"><b>5</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class Role &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">  # Override find to ensure that role objects are cached - these do not change</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.find(id)</code>
        </li>
      
        <li class="covered" data-hits="338" data-linenumber="7">
          <span class="hits">338</span>
          
          <code class="ruby">    Rails.cache.fetch(&quot;roles/#{id}&quot;, expires_in: 12.hours) do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">      super</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.student</code>
        </li>
      
        <li class="covered" data-hits="35" data-linenumber="14">
          <span class="hits">35</span>
          
          <code class="ruby">    Role.find(student_id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.tutor</code>
        </li>
      
        <li class="covered" data-hits="65" data-linenumber="18">
          <span class="hits">65</span>
          
          <code class="ruby">    Role.find(tutor_id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.convenor</code>
        </li>
      
        <li class="covered" data-hits="140" data-linenumber="22">
          <span class="hits">140</span>
          
          <code class="ruby">    Role.find(convenor_id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.admin</code>
        </li>
      
        <li class="covered" data-hits="81" data-linenumber="26">
          <span class="hits">81</span>
          
          <code class="ruby">    Role.find(admin_id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">  def to_sym</code>
        </li>
      
        <li class="covered" data-hits="57" data-linenumber="30">
          <span class="hits">57</span>
          
          <code class="ruby">    name.downcase.to_sym</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">  # Checks to see if the role returned by aaf is tutor, returns student if</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">  # it is anything else.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="37">
          <span class="hits">1</span>
          
          <code class="ruby">  if AuthenticationHelpers.aaf_auth?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">    def self.aaf_affiliation_to_role_id(affiliation)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">      affiliation.include?(&#39;staff&#39;) ? Role.tutor.id : Role.student.id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">  # Helpers to get the role id&#39;s:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">  # - These could be made into DB queries, but these values should not change</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="47">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.student_id</code>
        </li>
      
        <li class="covered" data-hits="35" data-linenumber="48">
          <span class="hits">35</span>
          
          <code class="ruby">    1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="51">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.tutor_id</code>
        </li>
      
        <li class="covered" data-hits="67" data-linenumber="52">
          <span class="hits">67</span>
          
          <code class="ruby">    2</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="55">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.convenor_id</code>
        </li>
      
        <li class="covered" data-hits="143" data-linenumber="56">
          <span class="hits">143</span>
          
          <code class="ruby">    3</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="59">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.admin_id</code>
        </li>
      
        <li class="covered" data-hits="85" data-linenumber="60">
          <span class="hits">85</span>
          
          <code class="ruby">    4</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="63">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.with_name(name)</code>
        </li>
      
        <li class="covered" data-hits="20" data-linenumber="64">
          <span class="hits">20</span>
          
          <code class="ruby">    case name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">    when /[Aa]dmin/</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="66">
          <span class="hits">15</span>
          
          <code class="ruby">      admin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">    when /[Cc]onvenor/</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="68">
          
          
          <code class="ruby">      convenor</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">    when /[Tt]utor/</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="70">
          <span class="hits">1</span>
          
          <code class="ruby">      tutor</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">    when /[Ss]tudent/</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="72">
          
          
          <code class="ruby">      student</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="c0bc6c1b67d3ae45a199f965c5f50ce5fe67d9c9">
  <div class="header">
    <h3>app/models/sub_task.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>4</b> relevant lines. 
      <span class="green"><b>4</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class SubTask &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  include ApplicationHelper</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">  # Model associations</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :sub_task_definition</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :task</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="19b7bd4c0d2afa41bc6be942bf9cbfaf437954e5">
  <div class="header">
    <h3>app/models/sub_task_definition.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>4</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>4</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="missed" data-hits="0" data-linenumber="1">
          
          
          <code class="ruby">class SubTaskDefinition &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby">  # Model associations</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">  has_many :sub_tasks, dependent: :destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">  has_many :badges, dependent: :destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="114665aaf43e5bf235b9ed95cd21eda064911063">
  <div class="header">
    <h3>app/models/task.rb</h3>
    <h4><span class="red">43.19 %</span> covered</h4>
    <div>
      <b>514</b> relevant lines. 
      <span class="green"><b>222</b> lines covered</span> and
      <span class="red"><b>292</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class Task &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  include ApplicationHelper</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  include LogHelper</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">  # Permissions around task data</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.permissions</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">    # What can students do with tasks?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">    student_role_permissions = [</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">      :get,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">      :put,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">      :get_submission,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">      :make_submission,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">      :delete_own_comment</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">    ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">    # What can tutors do with tasks?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">    tutor_role_permissions = [</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">      :get,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">      :put,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">      :get_submission,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">      :make_submission,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">      :delete_other_comment,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">      :delete_own_comment,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">      :view_plagiarism,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">      :delete_plagiarism</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">    ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">    # What can convenors do with tasks?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">    convenor_role_permissions = [</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">      :get,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">      :get_submission,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">      :make_submission,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">      :delete_other_comment,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">      :delete_own_comment,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">      :view_plagiarism,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">      :delete_plagiarism</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">    ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">    # What can nil users do with tasks?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">    nil_role_permissions = [</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">    ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">    # Return permissions hash</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">    {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">      student: student_role_permissions,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">      tutor: tutor_role_permissions,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">      convenor: convenor_role_permissions,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">      nil: nil_role_permissions</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="49">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="52">
          <span class="hits">1</span>
          
          <code class="ruby">  def role_for(user)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="53">
          <span class="hits">1</span>
          
          <code class="ruby">    project_role = project.user_role(user)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="54">
          <span class="hits">1</span>
          
          <code class="ruby">    return project_role unless project_role.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="55">
          
          
          <code class="ruby">    logger.debug &quot;Getting role for user #{user.id unless user.nil?}: #{task_definition.abbreviation} #{task_definition.group_set}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">    # check for group member</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="57">
          
          
          <code class="ruby">    if group_task?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="58">
          
          
          <code class="ruby">      logger.debug &#39;Checking group&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="59">
          
          
          <code class="ruby">      if group &amp;&amp; group.has_user(user)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="60">
          
          
          <code class="ruby">        return :group_member</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">        return nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">  # Delete action - before dependent association</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="68">
          <span class="hits">1</span>
          
          <code class="ruby">  before_destroy :delete_associated_files</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">  # Model associations</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="71">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :task_definition       # Foreign key</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="72">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :project               # Foreign key</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="73">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :task_status           # Foreign key</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="74">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :group_submission</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="76">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :sub_tasks, dependent: :destroy</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="77">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :comments, class_name: &#39;TaskComment&#39;, dependent: :destroy, inverse_of: :task</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="78">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :plagiarism_match_links, class_name: &#39;PlagiarismMatchLink&#39;, dependent: :destroy, inverse_of: :task</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="79">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :reverse_plagiarism_match_links, class_name: &#39;PlagiarismMatchLink&#39;, dependent: :destroy, inverse_of: :other_task, foreign_key: &#39;other_task_id&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="80">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :learning_outcome_task_links, dependent: :destroy # links to learning outcomes</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="81">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :learning_outcomes, through: :learning_outcome_task_links</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="82">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :task_engagements</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="83">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :task_submissions</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="85">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :task_definition_id, uniqueness: { scope: :project,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby">                                               message: &#39;must be unique within the project&#39; }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="88">
          <span class="hits">1</span>
          
          <code class="ruby">  validate :must_have_quality_pts, if: :for_task_with_quality?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="90">
          <span class="hits">1</span>
          
          <code class="ruby">  validate :extensions_must_end_with_due_date, if: :has_requested_extension?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="92">
          <span class="hits">1</span>
          
          <code class="ruby">  def for_task_with_quality?</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="93">
          <span class="hits">15</span>
          
          <code class="ruby">    task_definition.max_quality_pts.positive?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="96">
          <span class="hits">1</span>
          
          <code class="ruby">  def has_requested_extension?</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="97">
          <span class="hits">15</span>
          
          <code class="ruby">    extensions &gt; extensions_was &amp;&amp; extensions &gt; 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="100">
          <span class="hits">1</span>
          
          <code class="ruby">  def must_have_quality_pts</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="101">
          <span class="hits">3</span>
          
          <code class="ruby">    if quality_pts.nil? || quality_pts &lt; -1 || quality_pts &gt; task_definition.max_quality_pts</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="102">
          
          
          <code class="ruby">      errors.add(:quality_pts, &quot;must be between 0 and #{task_definition.max_quality_pts}&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby">  # Ensure that extensions do not exceed the defined due date</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="107">
          <span class="hits">1</span>
          
          <code class="ruby">  def extensions_must_end_with_due_date</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby">    # First check the raw extension date - but allow it to be up to a week later in case due date and target date are on different days</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="109">
          
          
          <code class="ruby">    if raw_extension_date.to_date - 7.days &gt;= task_definition.due_date.to_date</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="110">
          
          
          <code class="ruby">      errors.add(:extensions, &quot;have exceeded deadline for task. Work must be submitted within current timeframe. Work submitted after current due date will be assessed in the portfolio&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="114">
          <span class="hits">1</span>
          
          <code class="ruby">  def all_comments</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="115">
          
          
          <code class="ruby">    if group_submission.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="116">
          
          
          <code class="ruby">      comments</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="118">
          
          
          <code class="ruby">      TaskComment.joins(:task).where(&#39;tasks.group_submission_id = :id&#39;, id: group_submission.id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="122">
          <span class="hits">1</span>
          
          <code class="ruby">  def mark_comments_as_read(user, comments)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="123">
          
          
          <code class="ruby">    comments.each do |comment|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="124">
          
          
          <code class="ruby">      comment.mark_as_read(user, unit)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="125">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="126">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="128">
          <span class="hits">1</span>
          
          <code class="ruby">  def mark_comments_as_unread(user, comments)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="129">
          
          
          <code class="ruby">    comments.each do |comment|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="130">
          
          
          <code class="ruby">      comment.mark_as_unread(user)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="132">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="133">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="134">
          <span class="hits">1</span>
          
          <code class="ruby">  def current_plagiarism_match_links</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="135">
          
          
          <code class="ruby">    plagiarism_match_links.where(dismissed: false)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="136">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="138">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.for_unit(unit_id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="139">
          
          
          <code class="ruby">    Task.joins(:project).where(&#39;projects.unit_id = :unit_id&#39;, unit_id: unit_id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="140">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="141">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="142">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.for_user(user)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="143">
          
          
          <code class="ruby">    Task.joins(:project).where(&#39;projects.user_id = ?&#39;, user.id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="144">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="145">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="146">
          <span class="hits">1</span>
          
          <code class="ruby">  delegate :unit, to: :project</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="147">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="148">
          <span class="hits">1</span>
          
          <code class="ruby">  delegate :student, to: :project</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="149">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="150">
          <span class="hits">1</span>
          
          <code class="ruby">  delegate :upload_requirements, to: :task_definition</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="151">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="152">
          <span class="hits">1</span>
          
          <code class="ruby">  def processing_pdf?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="153">
          
          
          <code class="ruby">    if group_task? &amp;&amp; group_submission</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="154">
          
          
          <code class="ruby">      File.exist? File.join(FileHelper.student_work_dir(:new), group_submission.submitter_task.id.to_s)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="155">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="156">
          
          
          <code class="ruby">      File.exist? File.join(FileHelper.student_work_dir(:new), id.to_s)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="157">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="158">
          
          
          <code class="ruby">    # portfolio_evidence == nil &amp;&amp; ready_to_mark?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="159">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="160">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="161">
          
          
          <code class="ruby">  # Get the raw extension date - with extensions representing weeks</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="162">
          <span class="hits">1</span>
          
          <code class="ruby">  def raw_extension_date</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="163">
          
          
          <code class="ruby">    target_date + extensions.weeks</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="164">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="165">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="166">
          
          
          <code class="ruby">  # Get the adjusted extension date, which ensures it is never past the due date</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="167">
          <span class="hits">1</span>
          
          <code class="ruby">  def extension_date</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="168">
          
          
          <code class="ruby">    result = raw_extension_date</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="169">
          
          
          <code class="ruby">    return task_definition.due_date if result &gt; task_definition.due_date</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="170">
          
          
          <code class="ruby">    return result</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="171">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="172">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="173">
          
          
          <code class="ruby">  # The student can apply for an extension if the current extension date is</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="174">
          
          
          <code class="ruby">  # before the task&#39;s due date</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="175">
          <span class="hits">1</span>
          
          <code class="ruby">  def can_apply_for_extension?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="176">
          
          
          <code class="ruby">    raw_extension_date &lt; task_definition.due_date</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="177">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="178">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="179">
          
          
          <code class="ruby">  # Applying for an extension will </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="180">
          <span class="hits">1</span>
          
          <code class="ruby">  def apply_for_extension</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="181">
          
          
          <code class="ruby">    self.extensions = self.extensions + 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="182">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="183">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="184">
          
          
          <code class="ruby">  # delegate :due_date, to: :task_definition</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="185">
          <span class="hits">1</span>
          
          <code class="ruby">  def due_date</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="186">
          <span class="hits">2</span>
          
          <code class="ruby">    return target_date if extensions == 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="187">
          
          
          <code class="ruby">    return extension_date</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="188">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="189">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="190">
          <span class="hits">1</span>
          
          <code class="ruby">  delegate :target_date, to: :task_definition</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="191">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="192">
          <span class="hits">1</span>
          
          <code class="ruby">  def complete?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="193">
          <span class="hits">1</span>
          
          <code class="ruby">    status == :complete</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="194">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="195">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="196">
          <span class="hits">1</span>
          
          <code class="ruby">  def discuss_or_demonstrate?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="197">
          <span class="hits">1</span>
          
          <code class="ruby">    status == :discuss || status == :demonstrate</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="198">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="199">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="200">
          <span class="hits">1</span>
          
          <code class="ruby">  def discuss?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="201">
          
          
          <code class="ruby">    status == :discuss</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="202">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="203">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="204">
          <span class="hits">1</span>
          
          <code class="ruby">  def demonstrate?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="205">
          
          
          <code class="ruby">    status == :demonstrate</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="206">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="207">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="208">
          <span class="hits">1</span>
          
          <code class="ruby">  def fail?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="209">
          <span class="hits">1</span>
          
          <code class="ruby">    status == :fail</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="210">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="211">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="212">
          <span class="hits">1</span>
          
          <code class="ruby">  def task_submission_closed?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="213">
          
          
          <code class="ruby">    complete? || discuss_or_demonstrate? || do_not_resubmit? || fail?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="214">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="215">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="216">
          <span class="hits">1</span>
          
          <code class="ruby">  def ready_to_mark?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="217">
          
          
          <code class="ruby">    status == :ready_to_mark</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="218">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="219">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="220">
          <span class="hits">1</span>
          
          <code class="ruby">  def ready_or_complete?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="221">
          <span class="hits">1</span>
          
          <code class="ruby">    [:complete, :discuss, :demonstrate, :ready_to_mark].include? status</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="222">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="223">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="224">
          <span class="hits">1</span>
          
          <code class="ruby">  def submitted_status?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="225">
          
          
          <code class="ruby">    ! [:working_on_it, :not_started, :fix_and_resubmit, :redo, :need_help].include? status</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="226">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="227">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="228">
          <span class="hits">1</span>
          
          <code class="ruby">  def fix_and_resubmit?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="229">
          
          
          <code class="ruby">    status == :fix_and_resubmit</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="230">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="231">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="232">
          <span class="hits">1</span>
          
          <code class="ruby">  def do_not_resubmit?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="233">
          <span class="hits">1</span>
          
          <code class="ruby">    status == :do_not_resubmit</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="234">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="235">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="236">
          <span class="hits">1</span>
          
          <code class="ruby">  def redo?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="237">
          
          
          <code class="ruby">    status == :redo</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="238">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="239">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="240">
          <span class="hits">1</span>
          
          <code class="ruby">  def need_help?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="241">
          
          
          <code class="ruby">    status == :need_help</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="242">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="243">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="244">
          <span class="hits">1</span>
          
          <code class="ruby">  def working_on_it?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="245">
          
          
          <code class="ruby">    status == :working_on_it</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="246">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="247">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="248">
          <span class="hits">1</span>
          
          <code class="ruby">  def reviewable?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="249">
          
          
          <code class="ruby">    has_pdf &amp;&amp; (ready_to_mark? || need_help?)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="250">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="251">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="252">
          <span class="hits">1</span>
          
          <code class="ruby">  def status</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="253">
          <span class="hits">7</span>
          
          <code class="ruby">    task_status.status_key</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="254">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="255">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="256">
          <span class="hits">1</span>
          
          <code class="ruby">  def has_pdf</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="257">
          
          
          <code class="ruby">    !portfolio_evidence.nil? &amp;&amp; File.exist?(portfolio_evidence) &amp;&amp; !processing_pdf?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="258">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="259">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="260">
          <span class="hits">1</span>
          
          <code class="ruby">  def log_details</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="261">
          
          
          <code class="ruby">    &quot;#{id} - #{project.student.username}, #{project.unit.code}, #{task_definition.abbreviation}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="262">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="263">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="264">
          <span class="hits">1</span>
          
          <code class="ruby">  def group_task?</code>
        </li>
      
        <li class="covered" data-hits="26" data-linenumber="265">
          <span class="hits">26</span>
          
          <code class="ruby">    !group_submission.nil? || !task_definition.group_set.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="266">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="267">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="268">
          <span class="hits">1</span>
          
          <code class="ruby">  def group</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="269">
          
          
          <code class="ruby">    return nil unless group_task?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="270">
          
          
          <code class="ruby">    # Cannot use group submission as group may change after submission</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="271">
          
          
          <code class="ruby">    # need to locate group via unit&#39;s groups</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="272">
          
          
          <code class="ruby">    project.groups.where(group_set_id: task_definition.group_set_id).first</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="273">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="274">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="275">
          <span class="hits">1</span>
          
          <code class="ruby">  def ensured_group_submission</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="276">
          
          
          <code class="ruby">    return nil unless group_task?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="277">
          
          
          <code class="ruby">    return group_submission unless group_submission.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="278">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="279">
          
          
          <code class="ruby">    group.create_submission self, &#39;&#39;, group.projects.map { |proj| { project: proj, pct: 100 / group.projects.count } }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="280">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="281">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="282">
          <span class="hits">1</span>
          
          <code class="ruby">  def trigger_transition(trigger: &#39;&#39;, by_user: nil, bulk: false, group_transition: false, quality: 1)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="283">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="284">
          
          
          <code class="ruby">    # Ensure that assessor is allowed to update the task in the indicated way</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="285">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="286">
          <span class="hits">1</span>
          
          <code class="ruby">    role = role_for(by_user)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="287">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="288">
          <span class="hits">1</span>
          
          <code class="ruby">    return nil if role.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="289">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="290">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="291">
          
          
          <code class="ruby">    # Ensure that only staff can change from staff assigned status if</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="292">
          
          
          <code class="ruby">    # this is a restricted task</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="293">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="294">
          
          
          <code class="ruby">    return nil if [ :student, :group_member ].include?(role) &amp;&amp;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="295">
          <span class="hits">1</span>
          
          <code class="ruby">                  task_definition.restrict_status_updates &amp;&amp;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="296">
          
          
          <code class="ruby">                  task_status.in?(TaskStatus.staff_assigned_statuses)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="297">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="298">
          
          
          <code class="ruby">    # Protect closed states from student changes</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="299">
          <span class="hits">1</span>
          
          <code class="ruby">    return nil if [ :student, :group_member ].include?(role) &amp;&amp; task_submission_closed?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="300">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="301">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="302">
          
          
          <code class="ruby">    # State transitions based upon the trigger</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="303">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="304">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="305">
          <span class="hits">1</span>
          
          <code class="ruby">    status = TaskStatus.status_for_name(trigger)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="306">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="307">
          <span class="hits">1</span>
          
          <code class="ruby">    case status</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="308">
          
          
          <code class="ruby">    when nil</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="309">
          
          
          <code class="ruby">      return nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="310">
          
          
          <code class="ruby">    when TaskStatus.ready_to_mark</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="311">
          <span class="hits">1</span>
          
          <code class="ruby">      submit</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="312">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="313">
          <span class="hits">1</span>
          
          <code class="ruby">      if due_date &lt; Time.zone.now</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="314">
          <span class="hits">1</span>
          
          <code class="ruby">        assess TaskStatus.time_exceeded, by_user</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="315">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="316">
          
          
          <code class="ruby">    when TaskStatus.not_started, TaskStatus.need_help, TaskStatus.working_on_it</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="317">
          
          
          <code class="ruby">      engage status</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="318">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="319">
          
          
          <code class="ruby">      # Only tutors can perform these actions</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="320">
          
          
          <code class="ruby">      if role == :tutor</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="321">
          
          
          <code class="ruby">        if task_definition.max_quality_pts &gt; 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="322">
          
          
          <code class="ruby">          case status</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="323">
          
          
          <code class="ruby">          when TaskStatus.complete, TaskStatus.discuss, TaskStatus.demonstrate</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="324">
          
          
          <code class="ruby">            update(quality_pts: quality)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="325">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="326">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="327">
          
          
          <code class="ruby">        assess status, by_user</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="328">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="329">
          
          
          <code class="ruby">        # Attempt to move to tutor state by non-tutor</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="330">
          
          
          <code class="ruby">        return nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="331">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="332">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="333">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="334">
          
          
          <code class="ruby">    # if this is a status change of a group task -- and not already doing group update</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="335">
          <span class="hits">1</span>
          
          <code class="ruby">    if !group_transition &amp;&amp; group_task?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="336">
          
          
          <code class="ruby">      logger.debug &quot;Group task transition for #{group_submission} set to status #{trigger} (id=#{id})&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="337">
          
          
          <code class="ruby">      unless [ TaskStatus.working_on_it, TaskStatus.need_help ].include? task_status</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="338">
          
          
          <code class="ruby">        ensured_group_submission.propagate_transition self, trigger, by_user, quality</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="339">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="340">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="341">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="342">
          <span class="hits">1</span>
          
          <code class="ruby">    true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="343">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="344">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="345">
          <span class="hits">1</span>
          
          <code class="ruby">  def grade_desc</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="346">
          
          
          <code class="ruby">    case grade</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="347">
          
          
          <code class="ruby">    when -1</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="348">
          
          
          <code class="ruby">      &#39;Fail&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="349">
          
          
          <code class="ruby">    when 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="350">
          
          
          <code class="ruby">      &#39;Pass&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="351">
          
          
          <code class="ruby">    when 1</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="352">
          
          
          <code class="ruby">      &#39;Credit&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="353">
          
          
          <code class="ruby">    when 2</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="354">
          
          
          <code class="ruby">      &#39;Distinction&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="355">
          
          
          <code class="ruby">    when 3</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="356">
          
          
          <code class="ruby">      &#39;High Distinction&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="357">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="358">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="359">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="360">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="361">
          
          
          <code class="ruby">  # Tries to grade the task if it is a graded task</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="362">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="363">
          <span class="hits">1</span>
          
          <code class="ruby">  def grade_task(new_grade, ui = nil, grading_group = false)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="364">
          
          
          <code class="ruby">    raise_error = lambda do |message|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="365">
          
          
          <code class="ruby">      ui.error!({ &#39;error&#39; =&gt; message }, 403) unless ui.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="366">
          
          
          <code class="ruby">      raise message</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="367">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="368">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="369">
          
          
          <code class="ruby">    grade_map = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="370">
          
          
          <code class="ruby">      &#39;f&#39;  =&gt; -1,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="371">
          
          
          <code class="ruby">      &#39;p&#39;  =&gt; 0,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="372">
          
          
          <code class="ruby">      &#39;c&#39;  =&gt; 1,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="373">
          
          
          <code class="ruby">      &#39;d&#39;  =&gt; 2,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="374">
          
          
          <code class="ruby">      &#39;hd&#39; =&gt; 3</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="375">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="376">
          
          
          <code class="ruby">    if task_definition.is_graded</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="377">
          
          
          <code class="ruby">      if new_grade.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="378">
          
          
          <code class="ruby">        raise_error.call(&quot;No grade was supplied for a graded task (task id #{id})&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="379">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="380">
          
          
          <code class="ruby">        # validate (and convert if need be) new_grade</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="381">
          
          
          <code class="ruby">        unless new_grade.is_a?(String) || new_grade.is_a?(Integer)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="382">
          
          
          <code class="ruby">          raise_error.call(&quot;New grade supplied to task is not a string or integer (task id #{id})&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="383">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="384">
          
          
          <code class="ruby">        if new_grade.is_a?(String)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="385">
          
          
          <code class="ruby">          if grade_map.keys.include?(new_grade.downcase)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="386">
          
          
          <code class="ruby">            # convert string representation to integer representation</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="387">
          
          
          <code class="ruby">            new_grade = grade_map[new_grade]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="388">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="389">
          
          
          <code class="ruby">            raise_error.call(&quot;New grade supplied to task is not an invalid string - expects one of {p|c|d|hd} (task id #{id})&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="390">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="391">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="392">
          
          
          <code class="ruby">        unless new_grade.is_a?(Integer) &amp;&amp; grade_map.values.include?(new_grade.to_i)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="393">
          
          
          <code class="ruby">          raise_error.call(&quot;New grade supplied to task is not an invalid integer - expects one of {0|1|2|3} (task id #{id})&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="394">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="395">
          
          
          <code class="ruby">        # propagate new grade to all OTHER group members</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="396">
          
          
          <code class="ruby">        if group_task? &amp;&amp; !grading_group</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="397">
          
          
          <code class="ruby">          logger.debug &quot;Grading a group submission to grade #{new_grade}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="398">
          
          
          <code class="ruby">          ensured_group_submission.propagate_grade self, new_grade, ui</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="399">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="400">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="401">
          
          
          <code class="ruby">        # now update this task... (may be group task or individual...)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="402">
          
          
          <code class="ruby">        logger.debug &quot;Grading task #{id} in a group submission to grade #{new_grade}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="403">
          
          
          <code class="ruby">        update(grade: new_grade)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="404">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="405">
          
          
          <code class="ruby">    elsif grade?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="406">
          
          
          <code class="ruby">      raise_error.call(&quot;Grade was supplied for a non-graded task (task id #{id})&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="407">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="408">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="409">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="410">
          <span class="hits">1</span>
          
          <code class="ruby">  def assess(task_status, assessor, assess_date = Time.zone.now)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="411">
          
          
          <code class="ruby">    # Set the task&#39;s status to the assessment outcome status</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="412">
          
          
          <code class="ruby">    # and flag it as no longer awaiting signoff</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="413">
          <span class="hits">1</span>
          
          <code class="ruby">    self.task_status = task_status</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="414">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="415">
          
          
          <code class="ruby">    # Ensure it has a submission date</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="416">
          <span class="hits">1</span>
          
          <code class="ruby">    self.submission_date = assess_date if submission_date.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="417">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="418">
          
          
          <code class="ruby">    # Set the assessment date and update the times assessed</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="419">
          <span class="hits">1</span>
          
          <code class="ruby">    if assessment_date.nil? || assessment_date &lt; submission_date</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="420">
          
          
          <code class="ruby">      # only a new assessment if it was submitted after last assessment</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="421">
          <span class="hits">1</span>
          
          <code class="ruby">      self.times_assessed += 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="422">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="423">
          <span class="hits">1</span>
          
          <code class="ruby">    self.assessment_date = assess_date</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="424">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="425">
          
          
          <code class="ruby">    # Set the completion date of the task if it&#39;s been completed</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="426">
          <span class="hits">1</span>
          
          <code class="ruby">    if ready_or_complete?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="427">
          
          
          <code class="ruby">      self.completion_date = assess_date if completion_date.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="428">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="429">
          <span class="hits">1</span>
          
          <code class="ruby">      self.completion_date = nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="430">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="431">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="432">
          
          
          <code class="ruby">    # Save the task</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="433">
          <span class="hits">1</span>
          
          <code class="ruby">    if save!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="434">
          
          
          <code class="ruby">      # If a task has been completed, that means the project</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="435">
          
          
          <code class="ruby">      # has definitely started</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="436">
          <span class="hits">1</span>
          
          <code class="ruby">      project.start</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="437">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="438">
          <span class="hits">1</span>
          
          <code class="ruby">      TaskEngagement.create!(task: self, engagement_time: Time.zone.now, engagement: task_status.name)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="439">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="440">
          
          
          <code class="ruby">      # Grab the submission for the task if the user made one</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="441">
          <span class="hits">1</span>
          
          <code class="ruby">      submission = TaskSubmission.where(task_id: id).order(:submission_time).reverse_order.first</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="442">
          
          
          <code class="ruby">      # Prepare the attributes of the submission</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="443">
          <span class="hits">1</span>
          
          <code class="ruby">      submission_attributes = { task: self, assessment_time: assess_date, assessor: assessor, outcome: task_status.name }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="444">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="445">
          
          
          <code class="ruby">      # Create or update the submission depending on whether one was made</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="446">
          <span class="hits">1</span>
          
          <code class="ruby">      if submission.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="447">
          
          
          <code class="ruby">        submission_attributes[:submission_time] = assess_date</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="448">
          
          
          <code class="ruby">        submission = TaskSubmission.create! submission_attributes</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="449">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="450">
          <span class="hits">1</span>
          
          <code class="ruby">        submission.update_attributes submission_attributes</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="451">
          <span class="hits">1</span>
          
          <code class="ruby">        submission.save</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="452">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="453">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="454">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="455">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="456">
          <span class="hits">1</span>
          
          <code class="ruby">  def engage(engagement_status)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="457">
          
          
          <code class="ruby">    self.task_status = engagement_status</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="458">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="459">
          
          
          <code class="ruby">    if save!</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="460">
          
          
          <code class="ruby">      TaskEngagement.create!(task: self, engagement_time: Time.zone.now, engagement: task_status.name)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="461">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="462">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="463">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="464">
          <span class="hits">1</span>
          
          <code class="ruby">  def submit(submit_date = Time.zone.now)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="465">
          <span class="hits">1</span>
          
          <code class="ruby">    self.task_status      = TaskStatus.ready_to_mark</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="466">
          <span class="hits">1</span>
          
          <code class="ruby">    self.submission_date  = submit_date</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="467">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="468">
          <span class="hits">1</span>
          
          <code class="ruby">    if save!</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="469">
          <span class="hits">1</span>
          
          <code class="ruby">      project.start</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="470">
          <span class="hits">1</span>
          
          <code class="ruby">      TaskEngagement.create!(task: self, engagement_time: Time.zone.now, engagement: task_status.name)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="471">
          <span class="hits">1</span>
          
          <code class="ruby">      submission = TaskSubmission.where(task_id: id).order(:submission_time).reverse_order.first</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="472">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="473">
          <span class="hits">1</span>
          
          <code class="ruby">      if submission.nil?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="474">
          <span class="hits">1</span>
          
          <code class="ruby">        TaskSubmission.create!(task: self, submission_time: submit_date)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="475">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="476">
          
          
          <code class="ruby">        if (!submission.submission_time.nil?) &amp;&amp; submit_date &lt; submission.submission_time + 1.hour &amp;&amp; submission.assessor.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="477">
          
          
          <code class="ruby">          # update old submission if within time window</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="478">
          
          
          <code class="ruby">          submission.submission_time = submit_date</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="479">
          
          
          <code class="ruby">          submission.save!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="480">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="481">
          
          
          <code class="ruby">          TaskSubmission.create!(task: self, submission_time: submit_date)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="482">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="483">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="484">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="485">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="486">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="487">
          <span class="hits">1</span>
          
          <code class="ruby">  def assessed?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="488">
          
          
          <code class="ruby">    redo? ||</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="489">
          
          
          <code class="ruby">      fix_and_resubmit? ||</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="490">
          
          
          <code class="ruby">      do_not_resubmit? ||</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="491">
          
          
          <code class="ruby">      fail? ||</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="492">
          
          
          <code class="ruby">      complete?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="493">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="494">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="495">
          <span class="hits">1</span>
          
          <code class="ruby">  def weight</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="496">
          
          
          <code class="ruby">    task_definition.weighting.to_f</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="497">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="498">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="499">
          <span class="hits">1</span>
          
          <code class="ruby">  def add_text_comment(user, text)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="500">
          <span class="hits">1</span>
          
          <code class="ruby">    text.strip!</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="501">
          <span class="hits">1</span>
          
          <code class="ruby">    return nil if user.nil? || text.nil? || text.empty?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="502">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="503">
          <span class="hits">1</span>
          
          <code class="ruby">    lc = comments.last</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="504">
          <span class="hits">1</span>
          
          <code class="ruby">    return if lc &amp;&amp; lc.user == user &amp;&amp; lc.comment == text</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="505">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="506">
          <span class="hits">1</span>
          
          <code class="ruby">    ensured_group_submission if group_task?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="507">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="508">
          <span class="hits">1</span>
          
          <code class="ruby">    comment = TaskComment.create</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="509">
          <span class="hits">1</span>
          
          <code class="ruby">    comment.task = self</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="510">
          <span class="hits">1</span>
          
          <code class="ruby">    comment.user = user</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="511">
          <span class="hits">1</span>
          
          <code class="ruby">    comment.comment = text</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="512">
          <span class="hits">1</span>
          
          <code class="ruby">    comment.content_type = :text</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="513">
          <span class="hits">1</span>
          
          <code class="ruby">    comment.recipient = user == project.student ? project.main_tutor : project.student</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="514">
          <span class="hits">1</span>
          
          <code class="ruby">    comment.save!</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="515">
          <span class="hits">1</span>
          
          <code class="ruby">    comment</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="516">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="517">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="518">
          <span class="hits">1</span>
          
          <code class="ruby">  def add_comment_with_attachment(user, tempfile)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="519">
          <span class="hits">1</span>
          
          <code class="ruby">    ensured_group_submission if group_task?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="520">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="521">
          <span class="hits">1</span>
          
          <code class="ruby">    comment = TaskComment.create</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="522">
          <span class="hits">1</span>
          
          <code class="ruby">    comment.task = self</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="523">
          <span class="hits">1</span>
          
          <code class="ruby">    comment.user = user</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="524">
          <span class="hits">1</span>
          
          <code class="ruby">    if FileHelper.accept_file(tempfile, &quot;comment attachment audio test&quot;, &quot;audio&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="525">
          
          
          <code class="ruby">      comment.content_type = :audio</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="526">
          
          
          <code class="ruby">    elsif FileHelper.accept_file(tempfile, &quot;comment attachment image test&quot;, &quot;image&quot;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="527">
          <span class="hits">1</span>
          
          <code class="ruby">      comment.content_type = :image</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="528">
          
          
          <code class="ruby">    elsif FileHelper.accept_file(tempfile, &quot;comment attachment pdf&quot;, &quot;document&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="529">
          
          
          <code class="ruby">      comment.content_type = :pdf</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="530">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="531">
          
          
          <code class="ruby">      raise &quot;Unknown comment attachment type&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="532">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="533">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="534">
          <span class="hits">1</span>
          
          <code class="ruby">    comment.recipient = user == project.student ? project.main_tutor : project.student</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="535">
          <span class="hits">1</span>
          
          <code class="ruby">    raise &quot;Error attaching uploaded file.&quot; unless comment.add_attachment(tempfile)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="536">
          <span class="hits">1</span>
          
          <code class="ruby">    comment.save!</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="537">
          <span class="hits">1</span>
          
          <code class="ruby">    comment</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="538">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="539">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="540">
          <span class="hits">1</span>
          
          <code class="ruby">  def last_comment</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="541">
          
          
          <code class="ruby">    all_comments.last</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="542">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="543">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="544">
          <span class="hits">1</span>
          
          <code class="ruby">  def last_comment_by(user)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="545">
          
          
          <code class="ruby">    result = all_comments.where(user: user).last</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="546">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="547">
          
          
          <code class="ruby">    return &#39;&#39; if result.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="548">
          
          
          <code class="ruby">    result.comment</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="549">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="550">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="551">
          <span class="hits">1</span>
          
          <code class="ruby">  def has_comment_by(user)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="552">
          
          
          <code class="ruby">    !last_comment_by(user).empty?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="553">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="554">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="555">
          <span class="hits">1</span>
          
          <code class="ruby">  def is_last_comment_by?(user)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="556">
          
          
          <code class="ruby">    last_comment = all_comments.last</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="557">
          
          
          <code class="ruby">    return false if last_comment.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="558">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="559">
          
          
          <code class="ruby">    last_comment.user == user</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="560">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="561">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="562">
          <span class="hits">1</span>
          
          <code class="ruby">  def last_comment_not_by(user)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="563">
          
          
          <code class="ruby">    result = all_comments.where(&#39;user_id != :id&#39;, id: user.id).last</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="564">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="565">
          
          
          <code class="ruby">    return &#39;&#39; if result.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="566">
          
          
          <code class="ruby">    result.comment</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="567">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="568">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="569">
          
          
          <code class="ruby">  # Indicates what is the largest % similarity is for this task</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="570">
          <span class="hits">1</span>
          
          <code class="ruby">  def pct_similar</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="571">
          
          
          <code class="ruby">    if current_plagiarism_match_links.order(pct: :desc).first.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="572">
          
          
          <code class="ruby">      0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="573">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="574">
          
          
          <code class="ruby">      current_plagiarism_match_links.order(pct: :desc).first.pct</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="575">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="576">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="577">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="578">
          <span class="hits">1</span>
          
          <code class="ruby">  def similar_to_count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="579">
          
          
          <code class="ruby">    plagiarism_match_links.count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="580">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="581">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="582">
          <span class="hits">1</span>
          
          <code class="ruby">  def similar_to_dismissed_count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="583">
          
          
          <code class="ruby">    plagiarism_match_links.where(&#39;dismissed = TRUE&#39;).count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="584">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="585">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="586">
          <span class="hits">1</span>
          
          <code class="ruby">  def recalculate_max_similar_pct</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="587">
          
          
          <code class="ruby">    # TODO: Remove once max_pct_similar is deleted</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="588">
          
          
          <code class="ruby">    # self.max_pct_similar = pct_similar()</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="589">
          
          
          <code class="ruby">    # self.save</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="590">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="591">
          
          
          <code class="ruby">    # project.recalculate_max_similar_pct()</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="592">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="593">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="594">
          <span class="hits">1</span>
          
          <code class="ruby">  delegate :name, to: :task_definition</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="595">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="596">
          <span class="hits">1</span>
          
          <code class="ruby">  def student_work_dir(type, create = true)</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="597">
          <span class="hits">6</span>
          
          <code class="ruby">    if group_task?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="598">
          
          
          <code class="ruby">      # New submissions need to use the path of this task</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="599">
          
          
          <code class="ruby">      if type == :new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="600">
          
          
          <code class="ruby">        FileHelper.student_group_work_dir(type, group_submission, self, create)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="601">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="602">
          
          
          <code class="ruby">        FileHelper.student_group_work_dir(type, group_submission, group_submission.submitter_task, create)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="603">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="604">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="605">
          <span class="hits">6</span>
          
          <code class="ruby">      FileHelper.student_work_dir(type, self, create)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="606">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="607">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="608">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="609">
          <span class="hits">1</span>
          
          <code class="ruby">  def zip_file_path_for_done_task</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="610">
          <span class="hits">3</span>
          
          <code class="ruby">    if group_task?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="611">
          
          
          <code class="ruby">      if group_submission.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="612">
          
          
          <code class="ruby">        logger.warn(&quot;Missing group submission from task identified for task #{id}!&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="613">
          
          
          <code class="ruby">        &quot;#{Doubtfire::Application.config.student_work_dir}/#{FileHelper.sanitized_path(&quot;#{project.unit.code}-#{project.unit.id}&quot;, project.student.username.to_s, &#39;done&#39;, id.to_s)[0..-1]}.zip&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="614">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="615">
          
          
          <code class="ruby">        &quot;#{FileHelper.student_group_work_dir(:done, group_submission)[0..-2]}.zip&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="616">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="617">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="618">
          <span class="hits">3</span>
          
          <code class="ruby">      &quot;#{student_work_dir(:done, false)[0..-2]}.zip&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="619">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="620">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="621">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="622">
          <span class="hits">1</span>
          
          <code class="ruby">  def extract_file_from_done(to_path, pattern, name_fn)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="623">
          
          
          <code class="ruby">    zip_file = zip_file_path_for_done_task</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="624">
          
          
          <code class="ruby">    return false if zip_file.nil? || (!File.exist? zip_file)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="625">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="626">
          
          
          <code class="ruby">    Zip::File.open(zip_file) do |zip|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="627">
          
          
          <code class="ruby">      # Extract folders</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="628">
          
          
          <code class="ruby">      zip.each do |entry|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="629">
          
          
          <code class="ruby">        # Extract to file/directory/symlink</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="630">
          
          
          <code class="ruby">        logger.debug &quot;Extracting file from done: #{entry.name}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="631">
          
          
          <code class="ruby">        if entry.name_is_directory?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="632">
          
          
          <code class="ruby">          entry.extract(name_fn.call(self, to_path, entry.name)) { true }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="633">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="634">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="635">
          
          
          <code class="ruby">      zip.glob(&quot;**/#{pattern}&quot;).each do |entry|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="636">
          
          
          <code class="ruby">        entry.extract(name_fn.call(self, to_path, entry.name)) { true }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="637">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="638">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="639">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="640">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="641">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="642">
          
          
          <code class="ruby">  # Compress the done files for a student - includes cover page and work uploaded</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="643">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="644">
          <span class="hits">1</span>
          
          <code class="ruby">  def compress_new_to_done</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="645">
          
          
          <code class="ruby">    task_dir = student_work_dir(:new, false)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="646">
          
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="647">
          
          
          <code class="ruby">      # Ensure that this task is the submitter task for a  group_task... otherwise</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="648">
          
          
          <code class="ruby">      # remove this submission</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="649">
          
          
          <code class="ruby">      raise &quot;Multiple team member submissions received at the same time. Please ensure that only one member submits the task.&quot; if group_task? &amp;&amp; self != group_submission.submitter_task</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="650">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="651">
          
          
          <code class="ruby">      zip_file = zip_file_path_for_done_task</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="652">
          
          
          <code class="ruby">      return false if zip_file.nil? || (!Dir.exist? task_dir)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="653">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="654">
          
          
          <code class="ruby">      FileUtils.rm(zip_file) if File.exist? zip_file</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="655">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="656">
          
          
          <code class="ruby">      # compress image files</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="657">
          
          
          <code class="ruby">      image_files = Dir.entries(task_dir).select { |f| (f =~ /^\d{3}.(image)/) == 0 }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="658">
          
          
          <code class="ruby">      image_files.each do |img|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="659">
          
          
          <code class="ruby">        if File.extname(img) == &quot;.jpg&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="660">
          
          
          <code class="ruby">          raise &#39;Failed to compress an image. Ensure all images are valid.&#39; unless FileHelper.compress_image(&quot;#{task_dir}#{img}&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="661">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="662">
          
          
          <code class="ruby">          dest_file = &quot;#{task_dir}#{File.basename(img, &quot;.*&quot;)}.jpg&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="663">
          
          
          <code class="ruby">          raise &#39;Failed to compress an image. Ensure all images are valid.&#39; unless FileHelper.compress_image_to_dest(&quot;#{task_dir}#{img}&quot;, dest_file)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="664">
          
          
          <code class="ruby">          FileUtils.rm(&quot;#{task_dir}#{img}&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="665">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="666">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="667">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="668">
          
          
          <code class="ruby">      # copy all files into zip</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="669">
          
          
          <code class="ruby">      input_files = Dir.entries(task_dir).select { |f| (f =~ /^\d{3}.(cover|document|code|image)/) == 0 }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="670">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="671">
          
          
          <code class="ruby">      zip_dir = File.dirname(zip_file)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="672">
          
          
          <code class="ruby">      FileUtils.mkdir_p zip_dir unless Dir.exist? zip_dir</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="673">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="674">
          
          
          <code class="ruby">      Zip::File.open(zip_file, Zip::File::CREATE) do |zip|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="675">
          
          
          <code class="ruby">        zip.mkdir id.to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="676">
          
          
          <code class="ruby">        input_files.each do |in_file|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="677">
          
          
          <code class="ruby">          zip.add &quot;#{id}/#{in_file}&quot;, &quot;#{task_dir}#{in_file}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="678">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="679">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="680">
          
          
          <code class="ruby">    ensure</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="681">
          
          
          <code class="ruby">      FileUtils.rm_rf(task_dir)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="682">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="683">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="684">
          
          
          <code class="ruby">    true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="685">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="686">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="687">
          <span class="hits">1</span>
          
          <code class="ruby">  def clear_in_process</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="688">
          
          
          <code class="ruby">    in_process_dir = student_work_dir(:in_process, false)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="689">
          
          
          <code class="ruby">    if Dir.exist? in_process_dir</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="690">
          
          
          <code class="ruby">      Dir.chdir(FileUtils.student_work_dir) if FileUtils.pwd == in_process_dir</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="691">
          
          
          <code class="ruby">      FileUtils.rm_rf in_process_dir</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="692">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="693">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="694">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="695">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="696">
          
          
          <code class="ruby">  # Move folder over from done -&gt; new</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="697">
          
          
          <code class="ruby">  # Allowing task pdf to be recreated next time pdfs are generated</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="698">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="699">
          <span class="hits">1</span>
          
          <code class="ruby">  def move_done_to_new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="700">
          
          
          <code class="ruby">    done = student_work_dir(:done, false)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="701">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="702">
          
          
          <code class="ruby">    if Dir.exist? done</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="703">
          
          
          <code class="ruby">      new_task_dir = student_work_dir(:new, false)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="704">
          
          
          <code class="ruby">      FileUtils.mkdir_p(new_task_dir)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="705">
          
          
          <code class="ruby">      FileHelper.move_files(done, new_task_dir)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="706">
          
          
          <code class="ruby">      true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="707">
          
          
          <code class="ruby">    elsif FileHelper.move_compressed_task_to_new(self)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="708">
          
          
          <code class="ruby">      true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="709">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="710">
          
          
          <code class="ruby">      false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="711">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="712">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="713">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="714">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="715">
          
          
          <code class="ruby">  # Move folder over from new or done -&gt; in_process returns true on success</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="716">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="717">
          <span class="hits">1</span>
          
          <code class="ruby">  def move_files_to_in_process</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="718">
          
          
          <code class="ruby">    # find and clear out old dir</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="719">
          <span class="hits">1</span>
          
          <code class="ruby">    in_process_dir = student_work_dir(:in_process, false)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="720">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="721">
          <span class="hits">1</span>
          
          <code class="ruby">    return false if in_process_dir.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="722">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="723">
          <span class="hits">1</span>
          
          <code class="ruby">    if Dir.exist? in_process_dir</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="724">
          
          
          <code class="ruby">      pwd = FileUtils.pwd</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="725">
          
          
          <code class="ruby">      Dir.chdir(in_process_dir)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="726">
          
          
          <code class="ruby">      # move all files to the enq dir</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="727">
          
          
          <code class="ruby">      FileUtils.rm Dir.glob(&#39;*&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="728">
          
          
          <code class="ruby">      Dir.chdir(pwd)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="729">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="730">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="731">
          <span class="hits">1</span>
          
          <code class="ruby">    from_dir = student_work_dir(:new, false)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="732">
          <span class="hits">1</span>
          
          <code class="ruby">    if Dir.exist?(from_dir)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="733">
          
          
          <code class="ruby">      # save new files in done folder</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="734">
          
          
          <code class="ruby">      return false unless compress_new_to_done</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="735">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="736">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="737">
          <span class="hits">1</span>
          
          <code class="ruby">    zip_file = zip_file_path_for_done_task</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="738">
          <span class="hits">1</span>
          
          <code class="ruby">    if zip_file &amp;&amp; File.exist?(zip_file)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="739">
          
          
          <code class="ruby">      extract_file_from_done FileHelper.student_work_dir(:new), &#39;*&#39;, lambda { |_task, to_path, name|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="740">
          
          
          <code class="ruby">        &quot;#{to_path}#{name}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="741">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="742">
          
          
          <code class="ruby">      return false unless Dir.exist?(from_dir)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="743">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="744">
          <span class="hits">1</span>
          
          <code class="ruby">      return false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="745">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="746">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="747">
          
          
          <code class="ruby">    # Move files from new to in process</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="748">
          
          
          <code class="ruby">    FileHelper.move_files(from_dir, in_process_dir)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="749">
          
          
          <code class="ruby">    true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="750">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="751">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="752">
          <span class="hits">1</span>
          
          <code class="ruby">  def __output_filename__(in_dir, idx, type)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="753">
          
          
          <code class="ruby">    pwd = FileUtils.pwd</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="754">
          
          
          <code class="ruby">    Dir.chdir(in_dir)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="755">
          
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="756">
          
          
          <code class="ruby">      # Rename files with 000.type.* to 000-type-*</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="757">
          
          
          <code class="ruby">      result = Dir.glob(&quot;#{idx.to_s.rjust(3, &#39;0&#39;)}.#{type}.*&quot;).first</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="758">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="759">
          
          
          <code class="ruby">      if !result.nil? &amp;&amp; File.exist?(result)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="760">
          
          
          <code class="ruby">        FileUtils.mv result, &quot;#{idx.to_s.rjust(3, &#39;0&#39;)}-#{type}#{File.extname(result)}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="761">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="762">
          
          
          <code class="ruby">      result = Dir.glob(&quot;#{idx.to_s.rjust(3, &#39;0&#39;)}-#{type}.*&quot;).first</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="763">
          
          
          <code class="ruby">    ensure</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="764">
          
          
          <code class="ruby">      Dir.chdir(pwd)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="765">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="766">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="767">
          
          
          <code class="ruby">    return File.join(in_dir, result) unless result.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="768">
          
          
          <code class="ruby">    nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="769">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="770">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="771">
          <span class="hits">1</span>
          
          <code class="ruby">  def in_process_files_for_task(is_retry)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="772">
          
          
          <code class="ruby">    magic = FileMagic.new(FileMagic::MAGIC_MIME)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="773">
          
          
          <code class="ruby">    in_process_dir = student_work_dir(:in_process, false)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="774">
          
          
          <code class="ruby">    return [] unless Dir.exist? in_process_dir</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="775">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="776">
          
          
          <code class="ruby">    result = []</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="777">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="778">
          
          
          <code class="ruby">    idx = 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="779">
          
          
          <code class="ruby">    upload_requirements.each do |file_req|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="780">
          
          
          <code class="ruby">      output_filename = __output_filename__(in_process_dir, idx, file_req[&#39;type&#39;])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="781">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="782">
          
          
          <code class="ruby">      if output_filename.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="783">
          
          
          <code class="ruby">        idx += 1 # skip headers if present</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="784">
          
          
          <code class="ruby">        output_filename = __output_filename__(in_process_dir, idx, file_req[&#39;type&#39;])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="785">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="786">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="787">
          
          
          <code class="ruby">      if output_filename.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="788">
          
          
          <code class="ruby">        logger.error &quot;Error processing task #{log_details} - missing file #{file_req}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="789">
          
          
          <code class="ruby">        raise &quot;File `#{file_req[&#39;name&#39;]}` missing from submission.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="790">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="791">
          
          
          <code class="ruby">        result &lt;&lt; { path: output_filename, type: file_req[&#39;type&#39;] }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="792">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="793">
          
          
          <code class="ruby">        if file_req[&#39;type&#39;] == &#39;code&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="794">
          
          
          <code class="ruby">          FileHelper.ensure_utf8_code(output_filename, is_retry)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="795">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="796">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="797">
          
          
          <code class="ruby">        idx += 1 # next file index</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="798">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="799">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="800">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="801">
          
          
          <code class="ruby">    result</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="802">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="803">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="804">
          <span class="hits">1</span>
          
          <code class="ruby">  class TaskAppController &lt; ApplicationController</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="805">
          <span class="hits">1</span>
          
          <code class="ruby">    attr_accessor :task</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="806">
          <span class="hits">1</span>
          
          <code class="ruby">    attr_accessor :files</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="807">
          <span class="hits">1</span>
          
          <code class="ruby">    attr_accessor :base_path</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="808">
          <span class="hits">1</span>
          
          <code class="ruby">    attr_accessor :image_path</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="809">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="810">
          <span class="hits">1</span>
          
          <code class="ruby">    def init(task, is_retry)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="811">
          
          
          <code class="ruby">      @task = task</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="812">
          
          
          <code class="ruby">      @files = task.in_process_files_for_task(is_retry)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="813">
          
          
          <code class="ruby">      @base_path = task.student_work_dir(:in_process, false)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="814">
          
          
          <code class="ruby">      @image_path = Rails.root.join(&#39;public&#39;, &#39;assets&#39;, &#39;images&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="815">
          
          
          <code class="ruby">      @institution_name = Doubtfire::Application.config.institution[:name]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="816">
          
          
          <code class="ruby">      @doubtfire_product_name = Doubtfire::Application.config.institution[:product_name]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="817">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="818">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="819">
          <span class="hits">1</span>
          
          <code class="ruby">    def make_pdf</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="820">
          
          
          <code class="ruby">      render_to_string(template: &#39;/task/task_pdf.pdf.erb&#39;, layout: true)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="821">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="822">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="823">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="824">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.pygments_lang(extn)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="825">
          
          
          <code class="ruby">    extn = extn.downcase</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="826">
          
          
          <code class="ruby">    if %w(pas pp).include?(extn) then &#39;pas&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="827">
          
          
          <code class="ruby">    elsif [&#39;cs&#39;].include?(extn) then &#39;csharp&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="828">
          
          
          <code class="ruby">    elsif %w(c h idc).include?(extn) then &#39;c&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="829">
          
          
          <code class="ruby">    elsif [&#39;cpp&#39;, &#39;hpp&#39;, &#39;c++&#39;, &#39;h++&#39;, &#39;cc&#39;, &#39;cxx&#39;, &#39;cp&#39;].include?(extn) then &#39;cpp&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="830">
          
          
          <code class="ruby">    elsif [&#39;java&#39;].include?(extn) then &#39;java&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="831">
          
          
          <code class="ruby">    elsif %w(js json ts).include?(extn) then &#39;js&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="832">
          
          
          <code class="ruby">    elsif [&#39;html&#39;].include?(extn) then &#39;html&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="833">
          
          
          <code class="ruby">    elsif %w(css scss).include?(extn) then &#39;css&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="834">
          
          
          <code class="ruby">    elsif [&#39;rb&#39;].include?(extn) then &#39;ruby&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="835">
          
          
          <code class="ruby">    elsif [&#39;coffee&#39;].include?(extn) then &#39;coffeescript&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="836">
          
          
          <code class="ruby">    elsif %w(yaml yml).include?(extn) then &#39;yaml&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="837">
          
          
          <code class="ruby">    elsif [&#39;xml&#39;].include?(extn) then &#39;xml&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="838">
          
          
          <code class="ruby">    elsif [&#39;sql&#39;].include?(extn) then &#39;sql&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="839">
          
          
          <code class="ruby">    elsif [&#39;vb&#39;].include?(extn) then &#39;vbnet&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="840">
          
          
          <code class="ruby">    elsif [&#39;txt&#39;].include?(extn) then &#39;text&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="841">
          
          
          <code class="ruby">    elsif [&#39;py&#39;].include?(extn) then &#39;python&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="842">
          
          
          <code class="ruby">    else extn</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="843">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="844">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="845">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="846">
          <span class="hits">1</span>
          
          <code class="ruby">  def final_pdf_path</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="847">
          
          
          <code class="ruby">    if group_task?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="848">
          
          
          <code class="ruby">      return nil if group_submission.nil? || group_submission.task_definition.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="849">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="850">
          
          
          <code class="ruby">      File.join(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="851">
          
          
          <code class="ruby">        FileHelper.student_group_work_dir(:pdf, group_submission, task = nil, create = true),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="852">
          
          
          <code class="ruby">        FileHelper.sanitized_filename(FileHelper.sanitized_path(&quot;#{group_submission.task_definition.abbreviation}-#{group_submission.id}&quot;) + &#39;.pdf&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="853">
          
          
          <code class="ruby">      )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="854">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="855">
          
          
          <code class="ruby">      File.join(student_work_dir(:pdf), FileHelper.sanitized_filename(FileHelper.sanitized_path(&quot;#{task_definition.abbreviation}-#{id}&quot;) + &#39;.pdf&#39;))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="856">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="857">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="858">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="859">
          <span class="hits">1</span>
          
          <code class="ruby">  def convert_submission_to_pdf</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="860">
          <span class="hits">1</span>
          
          <code class="ruby">    return false unless move_files_to_in_process</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="861">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="862">
          
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="863">
          
          
          <code class="ruby">      tac = TaskAppController.new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="864">
          
          
          <code class="ruby">      tac.init(self, false)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="865">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="866">
          
          
          <code class="ruby">      begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="867">
          
          
          <code class="ruby">        pdf_text = tac.make_pdf</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="868">
          
          
          <code class="ruby">      rescue =&gt; e</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="869">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="870">
          
          
          <code class="ruby">        # Try again... with convert to ascii</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="871">
          
          
          <code class="ruby">        tac2 = TaskAppController.new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="872">
          
          
          <code class="ruby">        tac2.init(self, true)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="873">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="874">
          
          
          <code class="ruby">        begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="875">
          
          
          <code class="ruby">          pdf_text = tac2.make_pdf</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="876">
          
          
          <code class="ruby">        rescue =&gt; e2</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="877">
          
          
          <code class="ruby">          logger.error &quot;Failed to create PDF for task #{log_details}. Error: #{e.message}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="878">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="879">
          
          
          <code class="ruby">          log_file = e.message.scan(/\/.*\.log/).first</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="880">
          
          
          <code class="ruby">          # puts &quot;log file is ... #{log_file}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="881">
          
          
          <code class="ruby">          if log_file &amp;&amp; File.exist?(log_file)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="882">
          
          
          <code class="ruby">            # puts &quot;exists&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="883">
          
          
          <code class="ruby">            begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="884">
          
          
          <code class="ruby">              puts &quot;--- Latex Log ---\n&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="885">
          
          
          <code class="ruby">              puts File.read(log_file)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="886">
          
          
          <code class="ruby">              puts &quot;---    End    ---\n\n&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="887">
          
          
          <code class="ruby">            rescue</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="888">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="889">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="890">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="891">
          
          
          <code class="ruby">          raise &#39;Failed to convert your submission to PDF. Check code files submitted for invalid characters, that documents are valid pdfs, and that images are valid.&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="892">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="893">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="894">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="895">
          
          
          <code class="ruby">      if group_task?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="896">
          
          
          <code class="ruby">        group_submission.tasks.each do |t|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="897">
          
          
          <code class="ruby">          t.portfolio_evidence = final_pdf_path</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="898">
          
          
          <code class="ruby">          t.save</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="899">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="900">
          
          
          <code class="ruby">        reload</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="901">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="902">
          
          
          <code class="ruby">        self.portfolio_evidence = final_pdf_path</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="903">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="904">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="905">
          
          
          <code class="ruby">      File.open(portfolio_evidence, &#39;w&#39;) do |fout|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="906">
          
          
          <code class="ruby">        fout.puts pdf_text</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="907">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="908">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="909">
          
          
          <code class="ruby">      FileHelper.compress_pdf(portfolio_evidence)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="910">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="911">
          
          
          <code class="ruby">      save</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="912">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="913">
          
          
          <code class="ruby">      clear_in_process</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="914">
          
          
          <code class="ruby">      return true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="915">
          
          
          <code class="ruby">    rescue =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="916">
          
          
          <code class="ruby">      clear_in_process</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="917">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="918">
          
          
          <code class="ruby">      trigger_transition trigger: &#39;fix&#39;, by_user: project.main_tutor</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="919">
          
          
          <code class="ruby">      raise e</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="920">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="921">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="922">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="923">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="924">
          
          
          <code class="ruby">  # The student has uploaded new work...</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="925">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="926">
          <span class="hits">1</span>
          
          <code class="ruby">  def create_submission_and_trigger_state_change(user, propagate = true, contributions = nil, trigger = &#39;ready_to_mark&#39;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="927">
          <span class="hits">1</span>
          
          <code class="ruby">    if group_task? &amp;&amp; propagate</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="928">
          
          
          <code class="ruby">      if contributions.nil? # even distribution</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="929">
          
          
          <code class="ruby">        contribs = group.projects.map { |proj| { project: proj, pct: 100 / group.projects.count, pts: 3 } }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="930">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="931">
          
          
          <code class="ruby">        contribs = contributions.map { |data| { project: Project.find(data[:project_id]), pct: data[:pct].to_i, pts: data[:pts].to_i } }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="932">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="933">
          
          
          <code class="ruby">      group_submission = group.create_submission self, &quot;#{user.name} has submitted work&quot;, contribs</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="934">
          
          
          <code class="ruby">      group_submission.tasks.each { |t| t.create_submission_and_trigger_state_change(user, propagate = false) }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="935">
          
          
          <code class="ruby">      reload</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="936">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="937">
          <span class="hits">1</span>
          
          <code class="ruby">      self.file_uploaded_at = Time.zone.now</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="938">
          <span class="hits">1</span>
          
          <code class="ruby">      self.submission_date = Time.zone.now</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="939">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="940">
          
          
          <code class="ruby">      # This task is now ready to submit</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="941">
          <span class="hits">1</span>
          
          <code class="ruby">      unless discuss_or_demonstrate? || complete? || do_not_resubmit? || fail?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="942">
          <span class="hits">1</span>
          
          <code class="ruby">        trigger_transition trigger: trigger, by_user: user, group_transition: false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="943">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="944">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="945">
          
          
          <code class="ruby">      # Destroy the links to ensure we test new files</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="946">
          <span class="hits">1</span>
          
          <code class="ruby">      plagiarism_match_links.each(&amp;:destroy)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="947">
          <span class="hits">1</span>
          
          <code class="ruby">      reverse_plagiarism_match_links(&amp;:destroy)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="948">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="949">
          <span class="hits">1</span>
          
          <code class="ruby">      save</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="950">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="951">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="952">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="953">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="954">
          
          
          <code class="ruby">  # Create alignments on submission</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="955">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="956">
          <span class="hits">1</span>
          
          <code class="ruby">  def create_alignments_from_submission(alignments)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="957">
          
          
          <code class="ruby">    # Remove existing alignments no longer applicable</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="958">
          
          
          <code class="ruby">    LearningOutcomeTaskLink.where(task_id: id).delete_all()</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="959">
          
          
          <code class="ruby">    alignments.each do |alignment|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="960">
          
          
          <code class="ruby">      link = LearningOutcomeTaskLink.find_or_create_by(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="961">
          
          
          <code class="ruby">        task_definition_id: task_definition.id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="962">
          
          
          <code class="ruby">        learning_outcome_id: alignment[:ilo_id],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="963">
          
          
          <code class="ruby">        task_id: id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="964">
          
          
          <code class="ruby">      )</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="965">
          
          
          <code class="ruby">      link.rating = alignment[:rating]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="966">
          
          
          <code class="ruby">      link.description = alignment[:rationale]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="967">
          
          
          <code class="ruby">      link.save!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="968">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="969">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="970">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="971">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="972">
          
          
          <code class="ruby">  # Moves submission into place</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="973">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="974">
          <span class="hits">1</span>
          
          <code class="ruby">  def accept_submission(current_user, files, _student, ui, contributions, trigger, alignments)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="975">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="976">
          
          
          <code class="ruby">    # Ensure that each file in files has the following attributes:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="977">
          
          
          <code class="ruby">    # id, name, filename, type, tempfile</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="978">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="979">
          <span class="hits">1</span>
          
          <code class="ruby">    files.each do |file|</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="980">
          <span class="hits">1</span>
          
          <code class="ruby">      ui.error!({ &#39;error&#39; =&gt; &quot;Missing file data for &#39;#{file.name}&#39;&quot; }, 403) if file.id.nil? || file.name.nil? || file.filename.nil? || file.type.nil? || file.tempfile.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="981">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="982">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="983">
          
          
          <code class="ruby">    # Ensure group if group task</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="984">
          <span class="hits">1</span>
          
          <code class="ruby">    if group_task? &amp;&amp; group.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="985">
          
          
          <code class="ruby">      ui.error!({ &#39;error&#39; =&gt; &#39;You must be in a group to submit this task.&#39; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="986">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="987">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="988">
          
          
          <code class="ruby">    # Ensure not already submitted if group task</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="989">
          <span class="hits">1</span>
          
          <code class="ruby">    if group_task? &amp;&amp; group_submission &amp;&amp; group_submission.processing_pdf? &amp;&amp; group_submission.submitter_task != self</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="990">
          
          
          <code class="ruby">      ui.error!({ &#39;error&#39; =&gt; &quot;#{group_submission.submitter_task.project.student.name} has just submitted this task. Only one team member needs to submit this task, so check back soon to see what was uploaded.&quot; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="991">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="992">
          
          
          <code class="ruby">    # file.key            = &quot;file0&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="993">
          
          
          <code class="ruby">    # file.name           = front end name for file</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="994">
          
          
          <code class="ruby">    # file.tempfile.path  = actual file dir</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="995">
          
          
          <code class="ruby">    # file.filename       = their name for the file</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="996">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="997">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="998">
          
          
          <code class="ruby">    # Confirm subtype categories using filemagic</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="999">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="1000">
          <span class="hits">1</span>
          
          <code class="ruby">    files.each_with_index do |file, index|</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="1001">
          <span class="hits">1</span>
          
          <code class="ruby">      logger.debug &quot;Accepting submission (file #{index + 1} of #{files.length}) - checking file type for #{file.tempfile.path}&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="1002">
          <span class="hits">1</span>
          
          <code class="ruby">      unless FileHelper.accept_file(file, file.name, file.type)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1003">
          
          
          <code class="ruby">        ui.error!({ &#39;error&#39; =&gt; &quot;&#39;#{file.name}&#39; is not a valid #{file.type} file&quot; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1004">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1005">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="1006">
          <span class="hits">1</span>
          
          <code class="ruby">      if File.size(file.tempfile.path) &gt; 5_000_000</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1007">
          
          
          <code class="ruby">        ui.error!({ &#39;error&#39; =&gt; &quot;&#39;#{file.name}&#39; exceeds the 5MB file limit. Try compressing or reformat and submit again.&quot; }, 403)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1008">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1009">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1010">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="1011">
          <span class="hits">1</span>
          
          <code class="ruby">    create_submission_and_trigger_state_change(current_user, propagate = true, contributions = contributions, trigger = trigger)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1012">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="1013">
          <span class="hits">1</span>
          
          <code class="ruby">    unless alignments.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1014">
          
          
          <code class="ruby">      if group_task?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1015">
          
          
          <code class="ruby">        ensured_group_submission.propogate_alignments_from_submission(alignments)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1016">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1017">
          
          
          <code class="ruby">        create_alignments_from_submission(alignments)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1018">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1019">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1020">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1021">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1022">
          
          
          <code class="ruby">    # Create student submission folder (&lt;tmpdir&gt;/doubtfire/new/&lt;id&gt;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1023">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="1024">
          <span class="hits">1</span>
          
          <code class="ruby">    tmp_dir = File.join(Dir.tmpdir, &#39;doubtfire&#39;, &#39;new&#39;, id.to_s)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="1025">
          <span class="hits">1</span>
          
          <code class="ruby">    logger.debug &quot;Creating temporary directory for new submission at #{tmp_dir}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1026">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1027">
          
          
          <code class="ruby">    # ensure the dir exists</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="1028">
          <span class="hits">1</span>
          
          <code class="ruby">    FileUtils.mkdir_p(tmp_dir)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1029">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1030">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1031">
          
          
          <code class="ruby">    # Set portfolio_evidence to nil while it gets processed</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1032">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="1033">
          <span class="hits">1</span>
          
          <code class="ruby">    portfolio_evidence = nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1034">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="1035">
          <span class="hits">1</span>
          
          <code class="ruby">    files.each_with_index.map do |file, idx|</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="1036">
          <span class="hits">1</span>
          
          <code class="ruby">      output_filename = File.join(tmp_dir, &quot;#{idx.to_s.rjust(3, &#39;0&#39;)}-#{file.type}#{File.extname(file.filename).downcase}&quot;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="1037">
          <span class="hits">1</span>
          
          <code class="ruby">      FileUtils.cp file.tempfile.path, output_filename</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1038">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1039">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1040">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1041">
          
          
          <code class="ruby">    # Now copy over the temp directory over to the enqueued directory</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1042">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="1043">
          <span class="hits">1</span>
          
          <code class="ruby">    enqueued_dir = student_work_dir(:new, false)[0..-2]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1044">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="1045">
          <span class="hits">1</span>
          
          <code class="ruby">    logger.debug &quot;Moving submission evidence from #{tmp_dir} to #{enqueued_dir}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1046">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1047">
          
          
          <code class="ruby">    # Move files into place</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="1048">
          <span class="hits">1</span>
          
          <code class="ruby">    FileUtils.mv tmp_dir, enqueued_dir, :force =&gt; true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1049">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="1050">
          <span class="hits">1</span>
          
          <code class="ruby">    logger.debug &quot;Submission accepted! Status for task #{id} is now #{trigger}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1051">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1052">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="1053">
          <span class="hits">1</span>
          
          <code class="ruby">  private</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="1054">
          <span class="hits">1</span>
          
          <code class="ruby">    def delete_associated_files</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="1055">
          <span class="hits">1</span>
          
          <code class="ruby">      if group_submission &amp;&amp; group_submission.tasks.count &lt;= 1</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1056">
          
          
          <code class="ruby">        group_submission.destroy</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1057">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="1058">
          <span class="hits">1</span>
          
          <code class="ruby">        zip_file = zip_file_path_for_done_task()</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="1059">
          <span class="hits">1</span>
          
          <code class="ruby">        if zip_file &amp;&amp; File.exists?(zip_file)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1060">
          
          
          <code class="ruby">          FileUtils.rm zip_file</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1061">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="1062">
          <span class="hits">1</span>
          
          <code class="ruby">        if portfolio_evidence.present? &amp;&amp; File.exists?(portfolio_evidence)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1063">
          
          
          <code class="ruby">          FileUtils.rm portfolio_evidence</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1064">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1065">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1066">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1067">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="6903e6357a04a7edffb2648b7af49bee6f0d77b0">
  <div class="header">
    <h3>app/models/task_comment.rb</h3>
    <h4><span class="red">72.58 %</span> covered</h4>
    <div>
      <b>62</b> relevant lines. 
      <span class="green"><b>45</b> lines covered</span> and
      <span class="red"><b>17</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;tempfile&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">class TaskComment &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  include MimeCheckHelpers</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  include TimeoutHelper</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :task # Foreign key</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :user</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :recipient, class_name: &#39;User&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :comments_read_receipts, class_name: &#39;CommentsReadReceipts&#39;, dependent: :destroy, inverse_of: :task_comment</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :task, presence: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :user, presence: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :recipient, presence: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :comment, length: { minimum: 0, maximum: 4095, allow_blank: true }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">  def new_for?(user)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="20">
          <span class="hits">2</span>
          
          <code class="ruby">    CommentsReadReceipts.where(user: user, task_comment_id: self).empty?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">  def create_comment_read_receipt_entry(user)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="24">
          <span class="hits">2</span>
          
          <code class="ruby">    comment_read_receipt = CommentsReadReceipts.find_or_create_by(user: user, task_comment: self)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="25">
          <span class="hits">2</span>
          
          <code class="ruby">    comment_read_receipt.user = user</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="26">
          <span class="hits">2</span>
          
          <code class="ruby">    comment_read_receipt.task_comment = self</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="27">
          <span class="hits">2</span>
          
          <code class="ruby">    comment_read_receipt.save!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="30">
          <span class="hits">1</span>
          
          <code class="ruby">  def serialize(user)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">    {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">      id: self.id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">      comment: self.comment,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">      has_attachment: [&quot;audio&quot;, &quot;image&quot;, &quot;pdf&quot;].include?(self.content_type),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">      type: self.content_type || &quot;text&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">      is_new: self.new_for?(user),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">      author: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">        id: self.user.id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">        name: self.user.name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">        email: self.user.email</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">      },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">      recipient: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">        id: self.recipient.id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">        name: self.recipient.name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">        email: self.user.email</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">      },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">      created_at: self.created_at,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">      recipient_read_time: self.time_read_by(self.recipient),</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="49">
          <span class="hits">2</span>
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="52">
          <span class="hits">1</span>
          
          <code class="ruby">  def comment</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="53">
          <span class="hits">10</span>
          
          <code class="ruby">    return &quot;audio comment&quot; if content_type == &quot;audio&quot;</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="54">
          <span class="hits">10</span>
          
          <code class="ruby">    return &quot;image comment&quot; if content_type == &quot;image&quot;</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="55">
          <span class="hits">6</span>
          
          <code class="ruby">    return &quot;pdf document&quot; if content_type == &quot;pdf&quot;</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="56">
          <span class="hits">6</span>
          
          <code class="ruby">    super</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="59">
          <span class="hits">1</span>
          
          <code class="ruby">  def attachment_path</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="60">
          <span class="hits">2</span>
          
          <code class="ruby">    FileHelper.comment_attachment_path(self, self.attachment_extension)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="63">
          <span class="hits">1</span>
          
          <code class="ruby">  def attachment_file_name</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="64">
          
          
          <code class="ruby">    &quot;comment-#{id}#{attachment_extension}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="67">
          <span class="hits">1</span>
          
          <code class="ruby">  def add_attachment(file_upload)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="68">
          <span class="hits">1</span>
          
          <code class="ruby">    if content_type == &quot;audio&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">      # On upload all audio comments are converted to wav</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="70">
          
          
          <code class="ruby">      temp = Tempfile.new([&#39;comment&#39;,&#39;.wav&#39;])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="71">
          
          
          <code class="ruby">      return false unless system_try_within 20, &quot;Failed to process audio submission - timeout&quot;, &quot;ffmpeg -loglevel quiet -y -i #{file_upload.tempfile.path} -ac 1 -ar 16000 -sample_fmt s16 #{temp.path}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="72">
          
          
          <code class="ruby">      self.attachment_extension = &quot;.wav&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="73">
          
          
          <code class="ruby">      save</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="74">
          
          
          <code class="ruby">      FileUtils.mv temp.path, attachment_path</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">    elsif content_type == &quot;image&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="76">
          <span class="hits">1</span>
          
          <code class="ruby">      self.attachment_extension = &quot;.jpg&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="77">
          <span class="hits">1</span>
          
          <code class="ruby">      save</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="78">
          <span class="hits">1</span>
          
          <code class="ruby">      FileHelper.compress_image_to_dest(file_upload.tempfile.path, self.attachment_path)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="80">
          
          
          <code class="ruby">      self.attachment_extension = &quot;.pdf&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="81">
          
          
          <code class="ruby">      save</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="82">
          
          
          <code class="ruby">      FileHelper.compress_pdf(file_upload.tempfile.path)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="83">
          
          
          <code class="ruby">      FileUtils.mv file_upload.tempfile.path, attachment_path</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="86">
          <span class="hits">1</span>
          
          <code class="ruby">    file_upload.tempfile.unlink</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="88">
          <span class="hits">1</span>
          
          <code class="ruby">    true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="91">
          <span class="hits">1</span>
          
          <code class="ruby">  def attachment_mime_type</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="92">
          
          
          <code class="ruby">    if attachment_extension == &quot;.wav&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="93">
          
          
          <code class="ruby">      &quot;audio/wav; charset:binary&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="95">
          
          
          <code class="ruby">      mime_type(attachment_path)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="99">
          <span class="hits">1</span>
          
          <code class="ruby">  def remove_comment_read_entry(user)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="100">
          
          
          <code class="ruby">    CommentsReadReceipts.delete_all(user: user, task_comment: self)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="103">
          <span class="hits">1</span>
          
          <code class="ruby">  def mark_as_read(user, unit)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="104">
          <span class="hits">2</span>
          
          <code class="ruby">    if user == task.project.main_tutor</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="105">
          
          
          <code class="ruby">      unit.staff.each do |staff_member|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="106">
          
          
          <code class="ruby">        create_comment_read_receipt_entry(staff_member.user)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="109">
          <span class="hits">2</span>
          
          <code class="ruby">      create_comment_read_receipt_entry(user)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="113">
          <span class="hits">1</span>
          
          <code class="ruby">  def mark_as_unread(user)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="114">
          
          
          <code class="ruby">    remove_comment_read_entry(user)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="117">
          <span class="hits">1</span>
          
          <code class="ruby">  def time_read_by(user)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="118">
          <span class="hits">2</span>
          
          <code class="ruby">    read_reciept = CommentsReadReceipts.find_by(user: user, task_comment: self)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="119">
          <span class="hits">2</span>
          
          <code class="ruby">    read_reciept.created_at unless read_reciept.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="a2147f0eb4a3fbf8e748efc8aecf9978c3ff501c">
  <div class="header">
    <h3>app/models/task_definition.rb</h3>
    <h4><span class="red">44.8 %</span> covered</h4>
    <div>
      <b>250</b> relevant lines. 
      <span class="green"><b>112</b> lines covered</span> and
      <span class="red"><b>138</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;json&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">class TaskDefinition &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">  # Record triggers - before associations</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  after_update do |_td|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">    clear_related_plagiarism if plagiarism_checks.empty? &amp;&amp; has_plagiarism?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">  before_destroy :delete_associated_files</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">  after_update :move_files_on_abbreviation_change, if: :abbreviation_changed?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">  # Model associations</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :unit # Foreign key</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :group_set</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :tasks, dependent:  :destroy # Destroying a task definition will also nuke any instances</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :group_submissions, dependent: :destroy # Destroying a task definition will also nuke any group submissions</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :learning_outcome_task_links, dependent: :destroy # links to learning outcomes</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :learning_outcomes, -&gt; { where(&#39;learning_outcome_task_links.task_id is NULL&#39;) }, through: :learning_outcome_task_links # only link staff relations</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">  # Model validations/constraints</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :name, uniqueness: { scope:  :unit_id } # task definition names within a unit must be unique</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :abbreviation, uniqueness: { scope: :unit_id } # task definition names within a unit must be unique</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :target_grade, inclusion: { in: 0..3, message: &#39;%{value} is not a valid target grade&#39; }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="26">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :max_quality_pts, numericality: { greater_than_or_equal_to: 0, less_than_or_equal_to: 10, message: &#39;must be between 0 and 10&#39; }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :upload_requirements, length: { maximum: 4095, allow_blank: true }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">  validate :upload_requirements, :check_upload_requirements_format</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="30">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :plagiarism_checks, length: { maximum: 4095, allow_blank: true }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>
          
          <code class="ruby">  validate :plagiarism_checks, :check_plagiarism_format</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :description, length: { maximum: 4095, allow_blank: true }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="34">
          <span class="hits">1</span>
          
          <code class="ruby">  validate :ensure_no_submissions, if: :has_change_group_status?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="36">
          <span class="hits">1</span>
          
          <code class="ruby">  def has_change_group_status?</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="37">
          <span class="hits">2</span>
          
          <code class="ruby">    group_set_id != group_set_id_was</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="40">
          <span class="hits">1</span>
          
          <code class="ruby">  def ensure_no_submissions</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">    if tasks.where(&quot;submission_date IS NOT NULL&quot;).count() &gt; 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">      errors.add( :group_set, &quot;Unable to change group status of task as submissions exist&quot; )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="46">
          <span class="hits">1</span>
          
          <code class="ruby">  def move_files_on_abbreviation_change</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">    if File.exists? task_sheet_with_abbreviation(abbreviation_was)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">      FileUtils.mv(task_sheet_with_abbreviation(abbreviation_was), task_sheet())</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">    if File.exists? task_resources_with_abbreviation(abbreviation_was)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">      FileUtils.mv(task_resources_with_abbreviation(abbreviation_was), task_resources())</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="56">
          <span class="hits">1</span>
          
          <code class="ruby">  def plagiarism_checks</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">    # Read the JSON string in upload_requirements and convert into ruby objects</code>
        </li>
      
        <li class="covered" data-hits="36" data-linenumber="58">
          <span class="hits">36</span>
          
          <code class="ruby">    if self[&#39;plagiarism_checks&#39;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="59">
          
          
          <code class="ruby">      begin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">        # Parse into ruby objects</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="61">
          
          
          <code class="ruby">        JSON.parse(self[&#39;plagiarism_checks&#39;])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">      rescue</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">        # If this fails return the string - validation should then invalidate this object</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="64">
          
          
          <code class="ruby">        self[&#39;plagiarism_checks&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">      # If it was empty then return an empty array</code>
        </li>
      
        <li class="covered" data-hits="36" data-linenumber="68">
          <span class="hits">36</span>
          
          <code class="ruby">      JSON.parse(&#39;[]&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="72">
          <span class="hits">1</span>
          
          <code class="ruby">  def check_plagiarism_format()</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="73">
          <span class="hits">2</span>
          
          <code class="ruby">    json_data = self.plagiarism_checks</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">    </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">    # ensure we have a structure that is : [ { &quot;key&quot;: &quot;...&quot;, &quot;type&quot;: &quot;...&quot;, &quot;pattern&quot;: &quot;...&quot;}, { ... } ]</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="76">
          <span class="hits">2</span>
          
          <code class="ruby">    unless json_data.class == Array</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="77">
          
          
          <code class="ruby">      errors.add(:plagiarism_checks, &#39;is not in a valid format! Should be [ { &quot;key&quot;: &quot;...&quot;, &quot;type&quot;: &quot;...&quot;, &quot;pattern&quot;: &quot;...&quot;}, { ... } ]. Did not contain array.&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="78">
          
          
          <code class="ruby">      return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby">    # Loop through checks in the array</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="82">
          <span class="hits">2</span>
          
          <code class="ruby">    i = 0</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="83">
          <span class="hits">2</span>
          
          <code class="ruby">    for req in json_data do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">      # They must be json objects</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="85">
          
          
          <code class="ruby">      unless req.class == Hash</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="86">
          
          
          <code class="ruby">        errors.add(:plagiarism_checks, &quot;is not in a valid format! Should be [ { \&quot;key\&quot;: \&quot;...\&quot;, \&quot;type\&quot;: \&quot;...\&quot;, \&quot;pattern\&quot;: \&quot;...\&quot;}, { ... } ]. Array did not contain hashes for item #{i + 1}..&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="87">
          
          
          <code class="ruby">        return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby">      # They must have these keys...</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="91">
          
          
          <code class="ruby">      if (!req.key? &#39;key&#39;) || (!req.key? &#39;type&#39;) || (!req.key? &#39;pattern&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="92">
          
          
          <code class="ruby">        errors.add(:plagiarism_checks, &quot;is not in a valid format! Should be [ { \&quot;key\&quot;: \&quot;...\&quot;, \&quot;type\&quot;: \&quot;...\&quot;, \&quot;pattern\&quot;: \&quot;...\&quot;}, { ... } ]. Missing a key for item #{i + 1}.&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="93">
          
          
          <code class="ruby">        return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby">      # Validate the type (MOSS now, Turnitin later)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="97">
          
          
          <code class="ruby">      if (!req[&#39;type&#39;].match(/^moss /))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="98">
          
          
          <code class="ruby">        errors.add(:plagiarism_checks, &quot;does not have a valid type.&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="99">
          
          
          <code class="ruby">        return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby">      # Check patter to exclude any path separators</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="103">
          
          
          <code class="ruby">      if (req[&#39;pattern&#39;].match(/(\/)|([.][.])/))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="104">
          
          
          <code class="ruby">        errors.add(:plagiarism_checks, &quot; pattern contains invalid characters.&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="105">
          
          
          <code class="ruby">        return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby">      # Move to the next check</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="109">
          
          
          <code class="ruby">      i += 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="113">
          <span class="hits">1</span>
          
          <code class="ruby">  def plagiarism_checks=(req)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="114">
          
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="115">
          
          
          <code class="ruby">      json_data = if req.class == String</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby">          # get the ruby objects from the json data</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="117">
          
          
          <code class="ruby">          JSON.parse(req)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby">          # use the passed in objects</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="120">
          
          
          <code class="ruby">          req</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby">    rescue</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby">      # Not valid json!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby">      # Save what we have - validation should raise an error</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="125">
          
          
          <code class="ruby">      self[&#39;plagiarism_checks&#39;] = req</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="126">
          
          
          <code class="ruby">      return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="128">
          
          
          <code class="ruby">    </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="129">
          
          
          <code class="ruby">    # Cant process unless it is an array...</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="130">
          
          
          <code class="ruby">    unless json_data.class == Array</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby">      # Save what we have - validation should raise an error</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="132">
          
          
          <code class="ruby">      self[&#39;plagiarism_checks&#39;] = req</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="133">
          
          
          <code class="ruby">      return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="134">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="135">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="136">
          
          
          <code class="ruby">    # Loop through all items in json array</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="137">
          
          
          <code class="ruby">    i = 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="138">
          
          
          <code class="ruby">    for req in json_data do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="139">
          
          
          <code class="ruby">      unless req.class == Hash</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="140">
          
          
          <code class="ruby">        # Cant process if it is not an object - leave for validation to check</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="141">
          
          
          <code class="ruby">        next</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="142">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="143">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="144">
          
          
          <code class="ruby">      # Delete any other keys</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="145">
          
          
          <code class="ruby">      req.delete_if { |key, _value| !%w(key type pattern).include? key }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="146">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="147">
          
          
          <code class="ruby">      # Add in check key</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="148">
          
          
          <code class="ruby">      req[&#39;key&#39;] = &quot;check#{i}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="149">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="150">
          
          
          <code class="ruby">      i += 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="151">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="152">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="153">
          
          
          <code class="ruby">    # Save</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="154">
          
          
          <code class="ruby">    self[&#39;plagiarism_checks&#39;] = JSON.unparse(json_data)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="155">
          
          
          <code class="ruby">    self[&#39;plagiarism_checks&#39;] = &#39;[]&#39; if self[&#39;plagiarism_checks&#39;].nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="156">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="157">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="158">
          <span class="hits">1</span>
          
          <code class="ruby">  def upload_requirements</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="159">
          
          
          <code class="ruby">    # Read the JSON string in upload_requirements and convert into ruby objects</code>
        </li>
      
        <li class="covered" data-hits="39" data-linenumber="160">
          <span class="hits">39</span>
          
          <code class="ruby">    if self[&#39;upload_requirements&#39;]</code>
        </li>
      
        <li class="covered" data-hits="39" data-linenumber="161">
          <span class="hits">39</span>
          
          <code class="ruby">      begin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="162">
          
          
          <code class="ruby">        # convert to ruby objects</code>
        </li>
      
        <li class="covered" data-hits="39" data-linenumber="163">
          <span class="hits">39</span>
          
          <code class="ruby">        JSON.parse(self[&#39;upload_requirements&#39;])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="164">
          
          
          <code class="ruby">      rescue</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="165">
          
          
          <code class="ruby">        # Its not valid json - so return the string and validation should fail this object</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="166">
          
          
          <code class="ruby">        self[&#39;upload_requirements&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="167">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="168">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="169">
          
          
          <code class="ruby">      # Return an empty array as no requirements</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="170">
          
          
          <code class="ruby">      JSON.parse(&#39;[]&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="171">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="172">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="173">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="174">
          
          
          <code class="ruby">  # Validate the format of the upload requirements</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="175">
          <span class="hits">1</span>
          
          <code class="ruby">  def check_upload_requirements_format()</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="176">
          <span class="hits">2</span>
          
          <code class="ruby">    json_data = self.upload_requirements</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="177">
          
          
          <code class="ruby">    </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="178">
          
          
          <code class="ruby">    # ensure we have a structure that is : [ { &quot;key&quot;: &quot;...&quot;, &quot;name&quot;: &quot;...&quot;, &quot;type&quot;: &quot;...&quot;}, { ... } ]</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="179">
          <span class="hits">2</span>
          
          <code class="ruby">    unless json_data.class == Array</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="180">
          
          
          <code class="ruby">      errors.add(:upload_requirements, &#39;is not in a valid format! Should be [ { &quot;key&quot;: &quot;...&quot;, &quot;name&quot;: &quot;...&quot;, &quot;type&quot;: &quot;...&quot;}, { ... } ]. Did not contain array.&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="181">
          
          
          <code class="ruby">      return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="182">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="183">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="184">
          
          
          <code class="ruby">    # Checking each upload requirement - i used to index files and for user errors</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="185">
          <span class="hits">2</span>
          
          <code class="ruby">    i = 0</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="186">
          <span class="hits">2</span>
          
          <code class="ruby">    for req in json_data do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="187">
          
          
          <code class="ruby">      # Each requirement is a json object</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="188">
          <span class="hits">1</span>
          
          <code class="ruby">      unless req.class == Hash</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="189">
          
          
          <code class="ruby">        errors.add(:upload_requirements, &quot;is not in a valid format! Should be [ { \&quot;key\&quot;: \&quot;...\&quot;, \&quot;name\&quot;: \&quot;...\&quot;, \&quot;type\&quot;: \&quot;...\&quot;}, { ... } ]. Array did not contain hashes for item #{i + 1}..&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="190">
          
          
          <code class="ruby">        return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="191">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="192">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="193">
          
          
          <code class="ruby">      # Check we have the keys we need</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="194">
          <span class="hits">1</span>
          
          <code class="ruby">      if (!req.key? &#39;key&#39;) || (!req.key? &#39;name&#39;) || (!req.key? &#39;type&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="195">
          
          
          <code class="ruby">        errors.add(:upload_requirements, &quot;is not in a valid format! Should be [ { \&quot;key\&quot;: \&quot;...\&quot;, \&quot;name\&quot;: \&quot;...\&quot;, \&quot;type\&quot;: \&quot;...\&quot;}, { ... } ]. Missing a key for item #{i + 1}.&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="196">
          
          
          <code class="ruby">        return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="197">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="198">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="199">
          <span class="hits">1</span>
          
          <code class="ruby">      i += 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="200">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="201">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="202">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="203">
          <span class="hits">1</span>
          
          <code class="ruby">  def upload_requirements=(req)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="204">
          <span class="hits">2</span>
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="205">
          <span class="hits">2</span>
          
          <code class="ruby">      json_data = if req.class == String</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="206">
          
          
          <code class="ruby">          # get the ruby objects from the json data</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="207">
          
          
          <code class="ruby">          JSON.parse(req)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="208">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="209">
          
          
          <code class="ruby">          # use the passed in objects</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="210">
          <span class="hits">2</span>
          
          <code class="ruby">          req</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="211">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="212">
          
          
          <code class="ruby">    rescue</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="213">
          
          
          <code class="ruby">      # Not valid json</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="214">
          
          
          <code class="ruby">      # Save what we have - validation should raise an error</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="215">
          
          
          <code class="ruby">      self[&#39;upload_requirements&#39;] = req</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="216">
          
          
          <code class="ruby">      return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="217">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="218">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="219">
          
          
          <code class="ruby">    # cant process unless it is an array</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="220">
          <span class="hits">2</span>
          
          <code class="ruby">    unless json_data.class == Array</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="221">
          
          
          <code class="ruby">      self[&#39;upload_requirements&#39;] = req</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="222">
          
          
          <code class="ruby">      return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="223">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="224">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="225">
          
          
          <code class="ruby">    # Checking each upload requirement - i used to index files and for user errors</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="226">
          <span class="hits">2</span>
          
          <code class="ruby">    i = 0</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="227">
          <span class="hits">2</span>
          
          <code class="ruby">    for req in json_data do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="228">
          
          
          <code class="ruby">      # Cant process unless it is a hash</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="229">
          <span class="hits">1</span>
          
          <code class="ruby">      unless req.class == Hash</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="230">
          
          
          <code class="ruby">        next</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="231">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="232">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="233">
          
          
          <code class="ruby">      # Delete all other keys...</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="234">
          <span class="hits">4</span>
          
          <code class="ruby">      req.delete_if { |key, _value| !%w(key name type).include? key }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="235">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="236">
          
          
          <code class="ruby">      # Set the &#39;key&#39; to be the matching file</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="237">
          <span class="hits">1</span>
          
          <code class="ruby">      req[&#39;key&#39;] = &quot;file#{i}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="238">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="239">
          <span class="hits">1</span>
          
          <code class="ruby">      i += 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="240">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="241">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="242">
          
          
          <code class="ruby">    # Save</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="243">
          <span class="hits">2</span>
          
          <code class="ruby">    self[&#39;upload_requirements&#39;] = JSON.unparse(json_data)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="244">
          <span class="hits">2</span>
          
          <code class="ruby">    self[&#39;upload_requirements&#39;] = &#39;[]&#39; if self[&#39;upload_requirements&#39;].nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="245">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="246">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="247">
          <span class="hits">1</span>
          
          <code class="ruby">  def has_plagiarism?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="248">
          
          
          <code class="ruby">    PlagiarismMatchLink.joins(:task).where(&#39;tasks.task_definition_id&#39; =&gt; id).count &gt; 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="249">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="250">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="251">
          <span class="hits">1</span>
          
          <code class="ruby">  def clear_related_plagiarism</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="252">
          
          
          <code class="ruby">    # delete old plagiarism links</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="253">
          
          
          <code class="ruby">    logger.info &quot;Deleting old links for task definition #{id} - #{abbreviation}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="254">
          
          
          <code class="ruby">    PlagiarismMatchLink.joins(:task).where(&#39;tasks.task_definition_id&#39; =&gt; id).find_each do |plnk|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="255">
          
          
          <code class="ruby">      begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="256">
          
          
          <code class="ruby">        PlagiarismMatchLink.find(plnk.id).destroy!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="257">
          
          
          <code class="ruby">      rescue</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="258">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="259">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="260">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="261">
          
          
          <code class="ruby">    # TODO: Remove once max_pct_similar is deleted</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="262">
          
          
          <code class="ruby">    # # Reset the tasks % similar</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="263">
          
          
          <code class="ruby">    # logger.debug &quot;Clearing old task percent similar&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="264">
          
          
          <code class="ruby">    # tasks.where(&quot;tasks.max_pct_similar &gt; 0&quot;).each do |t|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="265">
          
          
          <code class="ruby">    #   t.max_pct_similar = 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="266">
          
          
          <code class="ruby">    #   t.save</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="267">
          
          
          <code class="ruby">    # end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="268">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="269">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="270">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.to_csv(task_definitions, options = {})</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="271">
          
          
          <code class="ruby">    CSV.generate(options) do |csv|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="272">
          
          
          <code class="ruby">      csv &lt;&lt; csv_columns</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="273">
          
          
          <code class="ruby">      task_definitions.each do |task_definition|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="274">
          
          
          <code class="ruby">        csv &lt;&lt; task_definition.to_csv_row</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="275">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="276">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="277">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="278">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="279">
          <span class="hits">1</span>
          
          <code class="ruby">  def start_week</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="280">
          
          
          <code class="ruby">    ((start_date - unit.start_date) / 1.week).floor</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="281">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="282">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="283">
          <span class="hits">1</span>
          
          <code class="ruby">  def start_day</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="284">
          
          
          <code class="ruby">    Date::ABBR_DAYNAMES[start_date.wday]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="285">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="286">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="287">
          <span class="hits">1</span>
          
          <code class="ruby">  def target_week</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="288">
          
          
          <code class="ruby">    ((target_date - unit.start_date) / 1.week).floor</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="289">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="290">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="291">
          <span class="hits">1</span>
          
          <code class="ruby">  def target_day</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="292">
          
          
          <code class="ruby">    Date::ABBR_DAYNAMES[target_date.wday]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="293">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="294">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="295">
          
          
          <code class="ruby">  # Override due date to return either the final date of the unit, or the set due date</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="296">
          <span class="hits">1</span>
          
          <code class="ruby">  def due_date</code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="297">
          <span class="hits">30</span>
          
          <code class="ruby">    return self[&#39;due_date&#39;] if self[&#39;due_date&#39;].present?</code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="298">
          <span class="hits">30</span>
          
          <code class="ruby">    return unit.end_date</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="299">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="300">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="301">
          <span class="hits">1</span>
          
          <code class="ruby">  def due_week</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="302">
          
          
          <code class="ruby">    if due_date</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="303">
          
          
          <code class="ruby">      ((due_date - unit.start_date) / 1.week).floor</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="304">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="305">
          
          
          <code class="ruby">      &#39;&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="306">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="307">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="308">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="309">
          <span class="hits">1</span>
          
          <code class="ruby">  def due_day</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="310">
          
          
          <code class="ruby">    if due_date</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="311">
          
          
          <code class="ruby">      Date::ABBR_DAYNAMES[due_date.wday]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="312">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="313">
          
          
          <code class="ruby">      &#39;&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="314">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="315">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="316">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="317">
          <span class="hits">1</span>
          
          <code class="ruby">  def to_csv_row</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="318">
          
          
          <code class="ruby">    TaskDefinition.csv_columns</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="319">
          
          
          <code class="ruby">                  .reject { |col| [:start_week, :start_day, :target_week, :target_day, :due_week, :due_day, :upload_requirements, :plagiarism_checks, :group_set].include? col }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="320">
          
          
          <code class="ruby">                  .map { |column| attributes[column.to_s] } +</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="321">
          
          
          <code class="ruby">      [ </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="322">
          
          
          <code class="ruby">        plagiarism_checks.to_json,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="323">
          
          
          <code class="ruby">        group_set.nil? ? &quot;&quot; : group_set.name, </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="324">
          
          
          <code class="ruby">        upload_requirements.to_json,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="325">
          
          
          <code class="ruby">        start_week, </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="326">
          
          
          <code class="ruby">        start_day, </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="327">
          
          
          <code class="ruby">        target_week, </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="328">
          
          
          <code class="ruby">        target_day, </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="329">
          
          
          <code class="ruby">        due_week, </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="330">
          
          
          <code class="ruby">        due_day </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="331">
          
          
          <code class="ruby">      ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="332">
          
          
          <code class="ruby">    # [target_date.strftime(&#39;%d-%m-%Y&#39;)] +</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="333">
          
          
          <code class="ruby">    # [ self[&#39;due_date&#39;].nil? ? &#39;&#39; : due_date.strftime(&#39;%d-%m-%Y&#39;)]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="334">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="335">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="336">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.csv_columns</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="337">
          
          
          <code class="ruby">    [:name, :abbreviation, :description, :weighting, :target_grade, :restrict_status_updates, :max_quality_pts, :is_graded, :plagiarism_warn_pct, :plagiarism_checks, :group_set, :upload_requirements, :start_week, :start_day, :target_week, :target_day, :due_week, :due_day]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="338">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="339">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="340">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.task_def_for_csv_row(unit, row)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="341">
          
          
          <code class="ruby">    return [nil, false, &#39;Abbreviation and name cannot be empty.&#39;] if row[:abbreviation].nil? || row[:name].nil? || row[:abbreviation].empty? || row[:name].empty?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="342">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="343">
          
          
          <code class="ruby">    new_task = false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="344">
          
          
          <code class="ruby">    abbreviation = row[:abbreviation].strip</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="345">
          
          
          <code class="ruby">    name = row[:name].strip</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="346">
          
          
          <code class="ruby">    target_date = unit.date_for_week_and_day row[:target_week].to_i, row[:target_day]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="347">
          
          
          <code class="ruby">    return [nil, false, &quot;Unable to determine target date for #{abbreviation} -- need week number, and day short text eg. &#39;Wed&#39;&quot;] if target_date.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="348">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="349">
          
          
          <code class="ruby">    start_date = unit.date_for_week_and_day row[:start_week].to_i, row[:start_day]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="350">
          
          
          <code class="ruby">    return [nil, false, &quot;Unable to determine start date for #{abbreviation} -- need week number, and day short text eg. &#39;Wed&#39;&quot;] if start_date.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="351">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="352">
          
          
          <code class="ruby">    due_date = unit.date_for_week_and_day row[:due_week].to_i, row[:due_day]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="353">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="354">
          
          
          <code class="ruby">    result = TaskDefinition.find_by(unit_id: unit.id, abbreviation: abbreviation)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="355">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="356">
          
          
          <code class="ruby">    result = TaskDefinition.find_by(unit_id: unit.id, name: name) if result.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="357">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="358">
          
          
          <code class="ruby">    if result.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="359">
          
          
          <code class="ruby">      # Remember creation triggers project task updates... so need correct weight</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="360">
          
          
          <code class="ruby">      result = TaskDefinition.find_or_create_by(unit_id: unit.id, name: name, abbreviation: abbreviation) do |td|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="361">
          
          
          <code class="ruby">        td.target_date = target_date</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="362">
          
          
          <code class="ruby">        td.start_date = start_date</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="363">
          
          
          <code class="ruby">        td.weighting = row[:weighting].to_i</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="364">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="365">
          
          
          <code class="ruby">      new_task = true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="366">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="367">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="368">
          
          
          <code class="ruby">    result.name                        = name</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="369">
          
          
          <code class="ruby">    result.unit_id                     = unit.id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="370">
          
          
          <code class="ruby">    result.abbreviation                = abbreviation</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="371">
          
          
          <code class="ruby">    result.description                 = row[:description]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="372">
          
          
          <code class="ruby">    result.weighting                   = row[:weighting].to_i</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="373">
          
          
          <code class="ruby">    result.target_grade                = row[:target_grade].to_i</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="374">
          
          
          <code class="ruby">    result.restrict_status_updates     = %w(Yes y Y yes true TRUE 1).include? row[:restrict_status_updates]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="375">
          
          
          <code class="ruby">    result.max_quality_pts             = row[:max_quality_pts].to_i</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="376">
          
          
          <code class="ruby">    result.is_graded                   = %w(Yes y Y yes true TRUE 1).include? row[:is_graded]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="377">
          
          
          <code class="ruby">    result.start_date                  = start_date</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="378">
          
          
          <code class="ruby">    result.target_date                 = target_date</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="379">
          
          
          <code class="ruby">    result.upload_requirements         = row[:upload_requirements]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="380">
          
          
          <code class="ruby">    result.due_date                    = due_date</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="381">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="382">
          
          
          <code class="ruby">    result.plagiarism_warn_pct         = row[:plagiarism_warn_pct]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="383">
          
          
          <code class="ruby">    result.plagiarism_checks           = row[:plagiarism_checks]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="384">
          
          
          <code class="ruby">    </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="385">
          
          
          <code class="ruby">    unless row[:group_set].present? </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="386">
          
          
          <code class="ruby">      result.group_set                   = unit.group_sets.where(name: row[:group_set]).first</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="387">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="388">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="389">
          
          
          <code class="ruby">    if result.valid? &amp;&amp; (row[:group_set].nil? || !result.group_set.nil?)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="390">
          
          
          <code class="ruby">      begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="391">
          
          
          <code class="ruby">        result.save</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="392">
          
          
          <code class="ruby">      rescue</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="393">
          
          
          <code class="ruby">        result.destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="394">
          
          
          <code class="ruby">        return [nil, false, &#39;Failed to save definition due to data error.&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="395">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="396">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="397">
          
          
          <code class="ruby">      if result.group_set.nil? &amp;&amp; !row[:group_set].nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="398">
          
          
          <code class="ruby">        return [nil, false, &quot;Unable to find groupset with name #{row[:group_set]} in unit.&quot;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="399">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="400">
          
          
          <code class="ruby">        return [nil, false, result.errors.full_messages.join(&#39;. &#39;)]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="401">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="402">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="403">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="404">
          
          
          <code class="ruby">    [result, new_task, new_task ? &quot;Added new task definition #{result.abbreviation}.&quot; : &quot;Updated existing task #{result.abbreviation}&quot; ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="405">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="406">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="407">
          <span class="hits">1</span>
          
          <code class="ruby">  def is_group_task?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="408">
          
          
          <code class="ruby">    !group_set.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="409">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="410">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="411">
          <span class="hits">1</span>
          
          <code class="ruby">  def has_task_resources?</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="412">
          <span class="hits">31</span>
          
          <code class="ruby">    File.exist? task_resources</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="413">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="414">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="415">
          <span class="hits">1</span>
          
          <code class="ruby">  def has_task_sheet?</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="416">
          <span class="hits">31</span>
          
          <code class="ruby">    File.exist? task_sheet</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="417">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="418">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="419">
          <span class="hits">1</span>
          
          <code class="ruby">  def is_graded?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="420">
          
          
          <code class="ruby">    is_graded</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="421">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="422">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="423">
          <span class="hits">1</span>
          
          <code class="ruby">  def has_stars?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="424">
          
          
          <code class="ruby">    max_quality_pts &gt; 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="425">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="426">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="427">
          <span class="hits">1</span>
          
          <code class="ruby">  def add_task_sheet(file)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="428">
          <span class="hits">1</span>
          
          <code class="ruby">    FileUtils.mv file, task_sheet</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="429">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="430">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="431">
          <span class="hits">1</span>
          
          <code class="ruby">  def remove_task_sheet()</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="432">
          <span class="hits">1</span>
          
          <code class="ruby">    if has_task_sheet?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="433">
          
          
          <code class="ruby">      FileUtils.rm task_sheet</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="434">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="435">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="436">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="437">
          <span class="hits">1</span>
          
          <code class="ruby">  def add_task_resources(file)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="438">
          <span class="hits">1</span>
          
          <code class="ruby">    FileUtils.mv file, task_resources</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="439">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="440">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="441">
          <span class="hits">1</span>
          
          <code class="ruby">  def remove_task_resources()</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="442">
          <span class="hits">1</span>
          
          <code class="ruby">    if has_task_resources?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="443">
          
          
          <code class="ruby">      FileUtils.rm task_resources</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="444">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="445">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="446">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="447">
          
          
          <code class="ruby">  # Get the path to the task sheet - using the current abbreviation</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="448">
          <span class="hits">1</span>
          
          <code class="ruby">  def task_sheet</code>
        </li>
      
        <li class="covered" data-hits="34" data-linenumber="449">
          <span class="hits">34</span>
          
          <code class="ruby">    task_sheet_with_abbreviation(abbreviation)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="450">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="451">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="452">
          <span class="hits">1</span>
          
          <code class="ruby">  def task_resources</code>
        </li>
      
        <li class="covered" data-hits="32" data-linenumber="453">
          <span class="hits">32</span>
          
          <code class="ruby">    task_resources_with_abbreviation(abbreviation)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="454">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="455">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="456">
          <span class="hits">1</span>
          
          <code class="ruby">  def related_tasks_with_files(consolidate_groups = true)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="457">
          
          
          <code class="ruby">    tasks_with_files = tasks.select(&amp;:has_pdf)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="458">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="459">
          
          
          <code class="ruby">    if is_group_task? &amp;&amp; consolidate_groups</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="460">
          
          
          <code class="ruby">      # group task so only select one member of each group</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="461">
          
          
          <code class="ruby">      seen_groups = []</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="462">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="463">
          
          
          <code class="ruby">      tasks_with_files = tasks_with_files.select do |t|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="464">
          
          
          <code class="ruby">        if t.group.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="465">
          
          
          <code class="ruby">          result = false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="466">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="467">
          
          
          <code class="ruby">          result = !seen_groups.include?(t.group)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="468">
          
          
          <code class="ruby">          seen_groups &lt;&lt; t.group if result</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="469">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="470">
          
          
          <code class="ruby">        result</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="471">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="472">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="473">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="474">
          
          
          <code class="ruby">    tasks_with_files</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="475">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="476">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="477">
          <span class="hits">1</span>
          
          <code class="ruby">  private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="478">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="479">
          <span class="hits">1</span>
          
          <code class="ruby">    def delete_associated_files()</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="480">
          <span class="hits">1</span>
          
          <code class="ruby">      remove_task_sheet()</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="481">
          <span class="hits">1</span>
          
          <code class="ruby">      remove_task_resources()</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="482">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="483">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="484">
          
          
          <code class="ruby">    # Calculate the path to the task sheet using the provided abbreviation</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="485">
          
          
          <code class="ruby">    # This allows the path to be calculated on abbreviation change to allow files to</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="486">
          
          
          <code class="ruby">    # be moved</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="487">
          <span class="hits">1</span>
          
          <code class="ruby">    def task_sheet_with_abbreviation(abbr)</code>
        </li>
      
        <li class="covered" data-hits="34" data-linenumber="488">
          <span class="hits">34</span>
          
          <code class="ruby">      task_path = FileHelper.task_file_dir_for_unit unit, create = true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="489">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="34" data-linenumber="490">
          <span class="hits">34</span>
          
          <code class="ruby">      result_with_sanitised_path = &quot;#{task_path}#{FileHelper.sanitized_path(abbr)}.pdf&quot;</code>
        </li>
      
        <li class="covered" data-hits="34" data-linenumber="491">
          <span class="hits">34</span>
          
          <code class="ruby">      result_with_sanitised_file = &quot;#{task_path}#{FileHelper.sanitized_filename(abbr)}.pdf&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="492">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="34" data-linenumber="493">
          <span class="hits">34</span>
          
          <code class="ruby">      if File.exist? result_with_sanitised_path</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="494">
          <span class="hits">4</span>
          
          <code class="ruby">        result_with_sanitised_path</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="495">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="496">
          <span class="hits">30</span>
          
          <code class="ruby">        result_with_sanitised_file</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="497">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="498">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="499">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="500">
          
          
          <code class="ruby">    # Calculate the path to the task sheet using the provided abbreviation</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="501">
          
          
          <code class="ruby">    # This allows the path to be calculated on abbreviation change to allow files to</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="502">
          
          
          <code class="ruby">    # be moved</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="503">
          <span class="hits">1</span>
          
          <code class="ruby">    def task_resources_with_abbreviation(abbr)</code>
        </li>
      
        <li class="covered" data-hits="32" data-linenumber="504">
          <span class="hits">32</span>
          
          <code class="ruby">      task_path = FileHelper.task_file_dir_for_unit unit, create = true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="505">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="32" data-linenumber="506">
          <span class="hits">32</span>
          
          <code class="ruby">      result_with_sanitised_path = &quot;#{task_path}#{FileHelper.sanitized_path(abbr)}.zip&quot;</code>
        </li>
      
        <li class="covered" data-hits="32" data-linenumber="507">
          <span class="hits">32</span>
          
          <code class="ruby">      result_with_sanitised_file = &quot;#{task_path}#{FileHelper.sanitized_filename(abbr)}.zip&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="508">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="32" data-linenumber="509">
          <span class="hits">32</span>
          
          <code class="ruby">      if File.exist? result_with_sanitised_path</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="510">
          <span class="hits">2</span>
          
          <code class="ruby">        result_with_sanitised_path</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="511">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="512">
          <span class="hits">30</span>
          
          <code class="ruby">        result_with_sanitised_file</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="513">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="514">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="515">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="fa432c23e3fcf893b9e3311965b7aff48ee098fb">
  <div class="header">
    <h3>app/models/task_engagement.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>2</b> relevant lines. 
      <span class="green"><b>2</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class TaskEngagement &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :task</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="5aeec9c9bd0581cafbc5d729f54153b23fc7c2e1">
  <div class="header">
    <h3>app/models/task_status.rb</h3>
    <h4><span class="red">55.93 %</span> covered</h4>
    <div>
      <b>59</b> relevant lines. 
      <span class="green"><b>33</b> lines covered</span> and
      <span class="red"><b>26</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"># The status</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"># - has a name and a description</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">class TaskStatus &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">  # Model associations</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :tasks</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">  # Override find to ensure that task status objects are cached - these do not change</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.find(id)</code>
        </li>
      
        <li class="covered" data-hits="128" data-linenumber="12">
          <span class="hits">128</span>
          
          <code class="ruby">    Rails.cache.fetch(&quot;task_statuses/#{id}&quot;, expires_in: 12.hours) do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">      super</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="19" data-linenumber="17">
          <span class="hits">19</span>
          
          <code class="ruby">  scope :not_started,       -&gt; { TaskStatus.find(1) }</code>
        </li>
      
        <li class="covered" data-hits="20" data-linenumber="18">
          <span class="hits">20</span>
          
          <code class="ruby">  scope :complete,          -&gt; { TaskStatus.find(2) }</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="19">
          <span class="hits">13</span>
          
          <code class="ruby">  scope :need_help,         -&gt; { TaskStatus.find(3) }</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="20">
          <span class="hits">10</span>
          
          <code class="ruby">  scope :working_on_it,     -&gt; { TaskStatus.find(4) }</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="21">
          <span class="hits">15</span>
          
          <code class="ruby">  scope :fix_and_resubmit,  -&gt; { TaskStatus.find(5) }</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="22">
          <span class="hits">5</span>
          
          <code class="ruby">  scope :do_not_resubmit,   -&gt; { TaskStatus.find(6) }</code>
        </li>
      
        <li class="covered" data-hits="14" data-linenumber="23">
          <span class="hits">14</span>
          
          <code class="ruby">  scope :redo,              -&gt; { TaskStatus.find(7) }</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="24">
          <span class="hits">11</span>
          
          <code class="ruby">  scope :discuss,           -&gt; { TaskStatus.find(8) }</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="25">
          <span class="hits">13</span>
          
          <code class="ruby">  scope :ready_to_mark,     -&gt; { TaskStatus.find(9) }</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="26">
          <span class="hits">9</span>
          
          <code class="ruby">  scope :demonstrate,       -&gt; { TaskStatus.find(10) }</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="27">
          <span class="hits">6</span>
          
          <code class="ruby">  scope :fail,              -&gt; { TaskStatus.find(11) }</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="28">
          <span class="hits">5</span>
          
          <code class="ruby">  scope :time_exceeded,     -&gt; { TaskStatus.find(12) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="30">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.status_for_name(name)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>
          
          <code class="ruby">    case name.downcase.strip</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">    when &#39;complete&#39;         then TaskStatus.complete</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">    when &#39;fix_and_resubmit&#39; then TaskStatus.fix_and_resubmit</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">    when &#39;fix and resubmit&#39; then TaskStatus.fix_and_resubmit</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">    when &#39;fix&#39;              then TaskStatus.fix_and_resubmit</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">    when &#39;f&#39;                then TaskStatus.fix</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">    when &#39;do_not_resubmit&#39;  then TaskStatus.do_not_resubmit</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">    when &#39;do not resubmit&#39;  then TaskStatus.do_not_resubmit</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">    when &#39;redo&#39;             then TaskStatus.redo</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">    when &#39;need_help&#39;        then TaskStatus.need_help</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">    when &#39;need help&#39;        then TaskStatus.need_help</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">    when &#39;working_on_it&#39;    then TaskStatus.working_on_it</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">    when &#39;working on it&#39;    then TaskStatus.working_on_it</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">    when &#39;discuss&#39;, &#39;d&#39;     then TaskStatus.discuss</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">    when &#39;demonstrate&#39;      then TaskStatus.demonstrate</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">    when &#39;demo&#39;             then TaskStatus.demonstrate</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">    when &#39;ready to mark&#39;    then TaskStatus.ready_to_mark</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="48">
          <span class="hits">1</span>
          
          <code class="ruby">    when &#39;ready_to_mark&#39;    then TaskStatus.ready_to_mark</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="49">
          
          
          <code class="ruby">    when &#39;rtm&#39;              then TaskStatus.ready_to_mark</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">    when &#39;fail&#39;             then TaskStatus.fail</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">    when &#39;not_started&#39;      then TaskStatus.not_started</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">    when &#39;not started&#39;      then TaskStatus.not_started</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">    when &#39;ns&#39;               then TaskStatus.not_started</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby">    when &#39;time exceeded&#39;    then TaskStatus.time_exceeded</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="55">
          
          
          <code class="ruby">    when &#39;time_exceeded&#39;    then TaskStatus.time_exceeded</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">    else nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="60">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.staff_assigned_statuses</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="61">
          
          
          <code class="ruby">    TaskStatus.where(&#39;id &gt; 4&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="64">
          <span class="hits">1</span>
          
          <code class="ruby">  def status_key</code>
        </li>
      
        <li class="covered" data-hits="19" data-linenumber="65">
          <span class="hits">19</span>
          
          <code class="ruby">    return :complete if self == TaskStatus.complete</code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="66">
          <span class="hits">18</span>
          
          <code class="ruby">    return :not_started if self == TaskStatus.not_started</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="67">
          <span class="hits">12</span>
          
          <code class="ruby">    return :fix_and_resubmit if self == TaskStatus.fix_and_resubmit</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="68">
          <span class="hits">11</span>
          
          <code class="ruby">    return :redo if self == TaskStatus.redo</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="69">
          <span class="hits">10</span>
          
          <code class="ruby">    return :need_help if self == TaskStatus.need_help</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="70">
          <span class="hits">9</span>
          
          <code class="ruby">    return :working_on_it if self == TaskStatus.working_on_it</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="71">
          <span class="hits">8</span>
          
          <code class="ruby">    return :discuss if self == TaskStatus.discuss</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="72">
          <span class="hits">7</span>
          
          <code class="ruby">    return :ready_to_mark if self == TaskStatus.ready_to_mark</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="73">
          <span class="hits">6</span>
          
          <code class="ruby">    return :demonstrate if self == TaskStatus.demonstrate</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="74">
          <span class="hits">5</span>
          
          <code class="ruby">    return :fail if self == TaskStatus.fail</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="75">
          <span class="hits">4</span>
          
          <code class="ruby">    return :do_not_resubmit if self == TaskStatus.do_not_resubmit</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="76">
          <span class="hits">3</span>
          
          <code class="ruby">    return :time_exceeded if self == TaskStatus.time_exceeded</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="77">
          
          
          <code class="ruby">    return :not_started</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="6df2ae2e99e1b951d2613ee7d4792c23ea0bb129">
  <div class="header">
    <h3>app/models/task_submission.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>3</b> relevant lines. 
      <span class="green"><b>3</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class TaskSubmission &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :task</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :assessor, class_name: &#39;User&#39;, foreign_key: &#39;assessor_id&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="1848017ad1c1865041806c37f40cc4a589d1309e">
  <div class="header">
    <h3>app/models/tutorial.rb</h3>
    <h4><span class="red">54.84 %</span> covered</h4>
    <div>
      <b>31</b> relevant lines. 
      <span class="green"><b>17</b> lines covered</span> and
      <span class="red"><b>14</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class Tutorial &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby">  # Model associations</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :unit # Foreign key</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :unit_role # Foreign key</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  has_one    :tutor, through: :unit_role, source: :user</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many   :projects, dependent: :nullify # Students</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many   :groups, dependent: :nullify</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :abbreviation, uniqueness: { scope: :unit,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">                                         message: &#39;must be unique within the unit&#39; }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.default</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">    tutorial = new</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">    tutorial.unit_role_id     = -1</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">    tutorial.meeting_day      = &#39;Enter a regular meeting day.&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">    tutorial.meeting_time     = &#39;Enter a regular meeting time.&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">    tutorial.meeting_location = &#39;Enter a location.&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">    tutorial</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.find_by_user(user)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">    Tutorial.joins(:tutor).where(&#39;user_id = :user_id&#39;, user_id: user.id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">  def tutor</code>
        </li>
      
        <li class="covered" data-hits="43" data-linenumber="29">
          <span class="hits">43</span>
          
          <code class="ruby">    result = UnitRole.find_by(id: unit_role_id)</code>
        </li>
      
        <li class="covered" data-hits="43" data-linenumber="30">
          <span class="hits">43</span>
          
          <code class="ruby">    result.user unless result.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="33">
          <span class="hits">1</span>
          
          <code class="ruby">  def name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">    # TODO: Will probably need to make this more flexible when</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">    # a tutorial is representing something other than a tutorial</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">    &quot;#{meeting_day} #{meeting_time} (#{meeting_location})&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="39">
          <span class="hits">1</span>
          
          <code class="ruby">  def change_tutor(new_tutor)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">    # Get the unit role for current tutor</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">    assign_tutor(new_tutor)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="44">
          <span class="hits">1</span>
          
          <code class="ruby">  def assign_tutor(tutor_user)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">    # Create a role for the user if they&#39;re not already a tutor</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">    # TODO: Move creation to UnitRole and pass it approriate params</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">    tutor_unit_role = UnitRole.find_by(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">      unit_id: unit_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">      user_id: tutor_user.id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">    )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">    if tutor_unit_role &amp;&amp; tutor_user.has_tutor_capability? &amp;&amp; (tutor_unit_role.role == Role.tutor || tutor_unit_role.role == Role.convenor)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">      self.unit_role = tutor_unit_role</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby">      save</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="56">
          
          
          <code class="ruby">    self</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="59">
          <span class="hits">1</span>
          
          <code class="ruby">  def num_students</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="60">
          <span class="hits">12</span>
          
          <code class="ruby">    projects.where(&#39;enrolled = true&#39;).count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="e9bef8bd548ebc37e74d79ed5c556d967949b969">
  <div class="header">
    <h3>app/models/unit.rb</h3>
    <h4><span class="red">14.27 %</span> covered</h4>
    <div>
      <b>953</b> relevant lines. 
      <span class="green"><b>136</b> lines covered</span> and
      <span class="red"><b>817</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;csv&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;bcrypt&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;json&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;moss_ruby&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;csv_helper&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">class Unit &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  include ApplicationHelper</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">  include FileHelper</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">  include LogHelper</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">  include MimeCheckHelpers</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">  include CsvHelper</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :description, length: { maximum: 4095, allow_blank: true }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">  # Permissions around unit data</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.permissions</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">    # What can students do with units?</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="20">
          <span class="hits">12</span>
          
          <code class="ruby">    student_role_permissions = [</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">      :get_unit</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">    ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">    # What can tutors do with units?</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="24">
          <span class="hits">12</span>
          
          <code class="ruby">    tutor_role_permissions = [</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">      :get_unit,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">      :get_students,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">      :enrol_student,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">      :provide_feedback,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">      :download_stats,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">      :download_unit_csv,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">      :download_grades</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">    ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">    # What can convenors do with units?</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="35">
          <span class="hits">12</span>
          
          <code class="ruby">    convenor_role_permissions = [</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">      :get_unit,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">      :get_students,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">      :enrol_student,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">      :upload_csv,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">      :download_unit_csv,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">      :update,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">      :employ_staff,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">      :add_tutorial,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">      :add_task_def,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">      :provide_feedback,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">      :change_project_enrolment,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">      :download_stats,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">      :download_grades</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">    ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">    # What can other users do with units?</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="52">
          <span class="hits">12</span>
          
          <code class="ruby">    nil_role_permissions = [</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">    ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">    # Return permissions hash</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">    {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">      student: student_role_permissions,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">      tutor: tutor_role_permissions,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">      convenor: convenor_role_permissions,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">      nil: nil_role_permissions</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="62">
          <span class="hits">12</span>
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="65">
          <span class="hits">1</span>
          
          <code class="ruby">  def role_for(user)</code>
        </li>
      
        <li class="covered" data-hits="74" data-linenumber="66">
          <span class="hits">74</span>
          
          <code class="ruby">    if convenors.where(&#39;unit_roles.user_id=:id&#39;, id: user.id).count == 1</code>
        </li>
      
        <li class="covered" data-hits="74" data-linenumber="67">
          <span class="hits">74</span>
          
          <code class="ruby">      Role.convenor</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="68">
          
          
          <code class="ruby">    elsif tutors.where(&#39;unit_roles.user_id=:id&#39;, id: user.id).count == 1</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="69">
          
          
          <code class="ruby">      Role.tutor</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="70">
          
          
          <code class="ruby">    elsif active_projects.where(&#39;projects.user_id=:id&#39;, id: user.id).count == 1</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="71">
          
          
          <code class="ruby">      Role.student</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="75">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :name, :description, :start_date, :end_date, presence: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">  # Model associations.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">  # When a Unit is destroyed, any TaskDefinitions, Tutorials, and ProjectConvenor instances will also be destroyed.</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="79">
          <span class="hits">15</span>
          
          <code class="ruby">  has_many :task_definitions, -&gt; { order &#39;start_date ASC, abbreviation ASC&#39; }, dependent: :destroy</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="80">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :projects, dependent: :destroy</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="81">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :tutorials, dependent: :destroy</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="82">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :unit_roles, dependent: :destroy</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="83">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :learning_outcomes, dependent: :destroy</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="84">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :tasks, through: :projects</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="85">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :group_sets, dependent: :destroy</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="86">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :task_engagements, through: :projects</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="87">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :comments, through: :projects</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="88">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :groups, through: :group_sets</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="90">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :learning_outcome_task_links, through: :task_definitions</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="92">
          <span class="hits">15</span>
          
          <code class="ruby">  has_many :convenors, -&gt; { joins(:role).where(&#39;roles.name = :role&#39;, role: &#39;Convenor&#39;) }, class_name: &#39;UnitRole&#39;</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="93">
          <span class="hits">3</span>
          
          <code class="ruby">  has_many :staff, -&gt;     { joins(:role).where(&#39;roles.name = :role_convenor or roles.name = :role_tutor&#39;, role_convenor: &#39;Convenor&#39;, role_tutor: &#39;Tutor&#39;) }, class_name: &#39;UnitRole&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="95">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :current,               -&gt; { current_for_date(Time.zone.now) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="96">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :current_for_date,      -&gt;(date) { where(&#39;start_date &lt;= ? AND end_date &gt;= ?&#39;, date, date) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="97">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :not_current,           -&gt; { not_current_for_date(Time.zone.now) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="98">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :not_current_for_date,  -&gt;(date) { where(&#39;start_date &gt; ? OR end_date &lt; ?&#39;, date, date) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="99">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :set_active,            -&gt; { where(&#39;active = ?&#39;, true) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="100">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :set_inactive,          -&gt; { where(&#39;active = ?&#39;, false) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="102">
          <span class="hits">1</span>
          
          <code class="ruby">  def ordered_ilos</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="103">
          
          
          <code class="ruby">    learning_outcomes.order(:ilo_number)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="106">
          <span class="hits">1</span>
          
          <code class="ruby">  def task_outcome_alignments</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="107">
          <span class="hits">2</span>
          
          <code class="ruby">    learning_outcome_task_links.where(&#39;task_id is NULL&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="110">
          <span class="hits">1</span>
          
          <code class="ruby">  def student_tasks</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="111">
          <span class="hits">6</span>
          
          <code class="ruby">    tasks.joins(:task_definition).where(&#39;projects.enrolled = TRUE AND projects.target_grade &gt;= task_definitions.target_grade&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="114">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.for_user_admin(user)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="115">
          <span class="hits">1</span>
          
          <code class="ruby">    if user.has_admin_capability?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="116">
          <span class="hits">1</span>
          
          <code class="ruby">      Unit.all</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="118">
          
          
          <code class="ruby">      Unit.joins(:unit_roles).where(&#39;unit_roles.user_id = :user_id and unit_roles.role_id = :convenor_role&#39;, user_id: user.id, convenor_role: Role.convenor.id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="122">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.default</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="123">
          
          
          <code class="ruby">    unit = new</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="125">
          
          
          <code class="ruby">    unit.name         = &#39;New Unit&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="126">
          
          
          <code class="ruby">    unit.description  = &#39;Enter a description for this unit.&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="127">
          
          
          <code class="ruby">    unit.start_date   = Date.today</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="128">
          
          
          <code class="ruby">    unit.end_date     = 13.weeks.from_now</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="129">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="130">
          
          
          <code class="ruby">    unit</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="132">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="133">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="134">
          
          
          <code class="ruby">  # Returns the tutors associated with this Unit</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="135">
          
          
          <code class="ruby">  # - includes convenor</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="136">
          <span class="hits">1</span>
          
          <code class="ruby">  def tutors</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="137">
          
          
          <code class="ruby">    User.teaching(self)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="138">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="139">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="140">
          <span class="hits">1</span>
          
          <code class="ruby">  def main_convenor</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="141">
          
          
          <code class="ruby">    convenors.first.user</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="142">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="143">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="144">
          <span class="hits">1</span>
          
          <code class="ruby">  def students</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="145">
          
          
          <code class="ruby">    projects</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="146">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="147">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="148">
          <span class="hits">1</span>
          
          <code class="ruby">  def student_query(limit_to_enrolled)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="149">
          
          
          <code class="ruby">    # Get the number of tasks for each grade... with 1 as minimum to avoid / 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="150">
          
          
          <code class="ruby">    task_count = [0, 1, 2, 3].map do |e|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="151">
          
          
          <code class="ruby">      task_definitions.where(&quot;target_grade &lt;= #{e}&quot;).count + 0.0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="152">
          
          
          <code class="ruby">    end.map { |e| e == 0 ? 1 : e }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="153">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="154">
          
          
          <code class="ruby">    q = projects</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="155">
          
          
          <code class="ruby">        .joins(:user)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="156">
          
          
          <code class="ruby">        .joins(&#39;LEFT OUTER JOIN tasks ON projects.id = tasks.project_id&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="157">
          
          
          <code class="ruby">        .joins(&#39;LEFT JOIN task_definitions ON tasks.task_definition_id = task_definitions.id&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="158">
          
          
          <code class="ruby">        .joins(&#39;LEFT OUTER JOIN plagiarism_match_links ON tasks.id = plagiarism_match_links.task_id&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="159">
          
          
          <code class="ruby">        .group(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="160">
          
          
          <code class="ruby">          &#39;projects.id&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="161">
          
          
          <code class="ruby">          &#39;projects.target_grade&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="162">
          
          
          <code class="ruby">          &#39;projects.enrolled&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby">          &#39;users.first_name&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="164">
          
          
          <code class="ruby">          &#39;users.last_name&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="165">
          
          
          <code class="ruby">          &#39;users.username&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="166">
          
          
          <code class="ruby">          &#39;users.email&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="167">
          
          
          <code class="ruby">          &#39;projects.tutorial_id&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="168">
          
          
          <code class="ruby">          &#39;projects.portfolio_production_date&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="169">
          
          
          <code class="ruby">          &#39;projects.compile_portfolio&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="170">
          
          
          <code class="ruby">          &#39;projects.grade&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="171">
          
          
          <code class="ruby">          &#39;projects.grade_rationale&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="172">
          
          
          <code class="ruby">        )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="173">
          
          
          <code class="ruby">        .select(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="174">
          
          
          <code class="ruby">          &#39;projects.id AS project_id&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="175">
          
          
          <code class="ruby">          &#39;projects.enrolled AS enrolled&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="176">
          
          
          <code class="ruby">          &#39;users.first_name AS first_name&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="177">
          
          
          <code class="ruby">          &#39;users.last_name AS last_name&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="178">
          
          
          <code class="ruby">          &#39;users.username AS student_id&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="179">
          
          
          <code class="ruby">          &#39;users.email AS student_email&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="180">
          
          
          <code class="ruby">          &#39;projects.target_grade AS target_grade&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="181">
          
          
          <code class="ruby">          &#39;projects.tutorial_id AS tutorial_id&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="182">
          
          
          <code class="ruby">          &#39;projects.compile_portfolio AS compile_portfolio&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="183">
          
          
          <code class="ruby">          &#39;projects.grade AS grade&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="184">
          
          
          <code class="ruby">          &#39;projects.grade_rationale AS grade_rationale&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="185">
          
          
          <code class="ruby">          &#39;projects.portfolio_production_date AS portfolio_production_date&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="186">
          
          
          <code class="ruby">          &#39;MAX(CASE WHEN plagiarism_match_links.dismissed = FALSE THEN plagiarism_match_links.pct ELSE 0 END) AS plagiarism_match_links_max_pct&#39;,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="187">
          
          
          <code class="ruby">          *TaskStatus.all.map { |s| &quot;SUM(CASE WHEN tasks.task_status_id = #{s.id} THEN 1 ELSE 0 END) AS #{s.status_key}_count&quot; }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="188">
          
          
          <code class="ruby">        )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="189">
          
          
          <code class="ruby">        .where(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="190">
          
          
          <code class="ruby">          &#39;projects.target_grade &gt;= task_definitions.target_grade OR (task_definitions.target_grade IS NULL)&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="191">
          
          
          <code class="ruby">        )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="192">
          
          
          <code class="ruby">        .order(&#39;users.first_name&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="193">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="194">
          
          
          <code class="ruby">    q = q.where(&#39;projects.enrolled = TRUE&#39;) if limit_to_enrolled</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="195">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="196">
          
          
          <code class="ruby">    q.map do |t|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="197">
          
          
          <code class="ruby">      {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="198">
          
          
          <code class="ruby">        project_id: t.project_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="199">
          
          
          <code class="ruby">        enrolled: t.enrolled,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="200">
          
          
          <code class="ruby">        first_name: t.first_name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="201">
          
          
          <code class="ruby">        last_name: t.last_name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="202">
          
          
          <code class="ruby">        student_id: t.student_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="203">
          
          
          <code class="ruby">        student_email: t.student_email,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="204">
          
          
          <code class="ruby">        student_name: &quot;#{t.first_name} #{t.last_name}&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="205">
          
          
          <code class="ruby">        target_grade: t.target_grade,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="206">
          
          
          <code class="ruby">        tutorial_id: t.tutorial_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="207">
          
          
          <code class="ruby">        compile_portfolio: t.compile_portfolio,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="208">
          
          
          <code class="ruby">        grade: t.grade,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="209">
          
          
          <code class="ruby">        grade_rationale: t.grade_rationale,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="210">
          
          
          <code class="ruby">        max_pct_copy: t.plagiarism_match_links_max_pct,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="211">
          
          
          <code class="ruby">        has_portfolio: !t.portfolio_production_date.nil?,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="212">
          
          
          <code class="ruby">        stats: Project.create_task_stats_from(task_count, t, t.target_grade)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="213">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="214">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="215">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="216">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="217">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="218">
          
          
          <code class="ruby">  # Last date/time of scan</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="219">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="220">
          <span class="hits">1</span>
          
          <code class="ruby">  def last_plagarism_scan</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="221">
          
          
          <code class="ruby">    if self[:last_plagarism_scan].nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="222">
          
          
          <code class="ruby">      DateTime.new(2000, 1, 1)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="223">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="224">
          
          
          <code class="ruby">      self[:last_plagarism_scan]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="225">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="226">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="227">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="228">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="229">
          
          
          <code class="ruby">  # Returns the email of the first convenor or the first administrator if there</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="230">
          
          
          <code class="ruby">  # are no convenors</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="231">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="232">
          <span class="hits">1</span>
          
          <code class="ruby">  def convenor_email</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="233">
          
          
          <code class="ruby">    convenor = convenors.first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="234">
          
          
          <code class="ruby">    if convenor</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="235">
          
          
          <code class="ruby">      convenor.user.email</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="236">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="237">
          
          
          <code class="ruby">      User.admins.first.email</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="238">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="239">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="240">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="241">
          <span class="hits">1</span>
          
          <code class="ruby">  def active_projects</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="242">
          <span class="hits">2</span>
          
          <code class="ruby">    projects.where(&#39;enrolled = true&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="243">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="244">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="245">
          
          
          <code class="ruby">  # Adds a staff member for a role in a unit</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="246">
          <span class="hits">1</span>
          
          <code class="ruby">  def employ_staff(user, role)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="247">
          <span class="hits">2</span>
          
          <code class="ruby">    old_role = unit_roles.where(&#39;user_id=:user_id&#39;, user_id: user.id).first</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="248">
          <span class="hits">2</span>
          
          <code class="ruby">    return old_role unless old_role.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="249">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="250">
          <span class="hits">1</span>
          
          <code class="ruby">    if (role != Role.student) &amp;&amp; user.has_tutor_capability?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="251">
          <span class="hits">1</span>
          
          <code class="ruby">      new_staff = UnitRole.new</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="252">
          <span class="hits">1</span>
          
          <code class="ruby">      new_staff.user_id = user.id</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="253">
          <span class="hits">1</span>
          
          <code class="ruby">      new_staff.unit_id = id</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="254">
          <span class="hits">1</span>
          
          <code class="ruby">      new_staff.role_id = role.id</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="255">
          <span class="hits">1</span>
          
          <code class="ruby">      new_staff.save!</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="256">
          <span class="hits">1</span>
          
          <code class="ruby">      new_staff</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="257">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="258">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="259">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="260">
          
          
          <code class="ruby">  # Adds a user to this project.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="261">
          <span class="hits">1</span>
          
          <code class="ruby">  def enrol_student(user, tutorial = nil)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="262">
          
          
          <code class="ruby">    tutorial_id = if tutorial.is_a?(Tutorial)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="263">
          
          
          <code class="ruby">                    tutorial.id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="264">
          
          
          <code class="ruby">                  else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="265">
          
          
          <code class="ruby">                    tutorial</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="266">
          
          
          <code class="ruby">                  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="267">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="268">
          
          
          <code class="ruby">    # Validates that a student is not already assigned to the unit</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="269">
          
          
          <code class="ruby">    existing_project = projects.where(&#39;user_id=:user_id&#39;, user_id: user.id).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="270">
          
          
          <code class="ruby">    if existing_project</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="271">
          
          
          <code class="ruby">      if existing_project.enrolled == false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="272">
          
          
          <code class="ruby">        existing_project.enrolled = true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="273">
          
          
          <code class="ruby">        # If they are part of the unit, update their tutorial if supplied</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="274">
          
          
          <code class="ruby">        existing_project.tutorial_id = tutorial_id unless tutorial_id.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="275">
          
          
          <code class="ruby">        existing_project.save</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="276">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="277">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="278">
          
          
          <code class="ruby">      return existing_project</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="279">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="280">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="281">
          
          
          <code class="ruby">    # Validates that the tutorial exists for the unit</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="282">
          
          
          <code class="ruby">    if !tutorial_id.nil? &amp;&amp; tutorials.where(&#39;id=:id&#39;, id: tutorial_id).count == 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="283">
          
          
          <code class="ruby">      return nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="284">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="285">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="286">
          
          
          <code class="ruby">    project = Project.create!(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="287">
          
          
          <code class="ruby">      user_id: user.id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="288">
          
          
          <code class="ruby">      unit_id: id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="289">
          
          
          <code class="ruby">      task_stats: &#39;0.0|1.0|0.0|0.0|0.0&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="290">
          
          
          <code class="ruby">    )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="291">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="292">
          
          
          <code class="ruby">    project.tutorial_id = tutorial_id unless tutorial_id.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="293">
          
          
          <code class="ruby">    project.save</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="294">
          
          
          <code class="ruby">    project</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="295">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="296">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="297">
          <span class="hits">1</span>
          
          <code class="ruby">  def tutorial_with_abbr(abbr)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="298">
          
          
          <code class="ruby">    tutorials.where(abbreviation: abbr).first</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="299">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="300">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="301">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="302">
          
          
          <code class="ruby">  # Imports users into a project from CSV file.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="303">
          
          
          <code class="ruby">  # Format: Unit Code, Student ID,First Name, Surname, email, tutorial</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="304">
          
          
          <code class="ruby">  # Expected columns: unit_code, username, first_name, last_name, email, tutorial</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="305">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="306">
          <span class="hits">1</span>
          
          <code class="ruby">  def import_users_from_csv(file)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="307">
          
          
          <code class="ruby">    tutorial_cache = {}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="308">
          
          
          <code class="ruby">    success = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="309">
          
          
          <code class="ruby">    errors = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="310">
          
          
          <code class="ruby">    ignored = []</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="311">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="312">
          
          
          <code class="ruby">    csv = CSV.new(File.read(file), headers: true,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="313">
          
          
          <code class="ruby">        header_converters: [-&gt;(i) { i.nil? ? &#39;&#39; : i }, :downcase, -&gt;(hdr) { hdr.strip unless hdr.nil? }],</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="314">
          
          
          <code class="ruby">        converters: [-&gt;(i) { i.nil? ? &#39;&#39; : i }, -&gt;(body) { body.encode!(&#39;UTF-8&#39;, &#39;binary&#39;, invalid: :replace, undef: :replace, replace: &#39;&#39;) unless body.nil? }]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="315">
          
          
          <code class="ruby">        )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="316">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="317">
          
          
          <code class="ruby">    # Read the header row to determine what kind of file it is</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="318">
          
          
          <code class="ruby">    if csv.header_row?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="319">
          
          
          <code class="ruby">      csv.shift</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="320">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="321">
          
          
          <code class="ruby">      errors &lt;&lt; {row: [], message: &quot;Header row missing&quot; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="322">
          
          
          <code class="ruby">      return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="323">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="324">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="325">
          
          
          <code class="ruby">    # Check if these headers should be processed by institution file or from DF format</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="326">
          
          
          <code class="ruby">    if Doubtfire::Application.config.institution_settings.are_headers_institution_users? csv.headers</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="327">
          
          
          <code class="ruby">      import_settings = Doubtfire::Application.config.institution_settings.user_import_settings_for(csv.headers)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="328">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="329">
          
          
          <code class="ruby">      # Settings include:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="330">
          
          
          <code class="ruby">      #   missing_headers_lambda - lambda to check if row is missing key data</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="331">
          
          
          <code class="ruby">      #   fetch_row_data_lambda - lambda to convert row from csv to required import data</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="332">
          
          
          <code class="ruby">      #   replace_existing_tutorial - boolean to indicate if tutorials in csv override ones in doubtfire</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="333">
          
          
          <code class="ruby">      import_settings = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="334">
          
          
          <code class="ruby">        missing_headers_lambda: -&gt;(row) {</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="335">
          
          
          <code class="ruby">          missing_headers(row, %w(unit_code username student_id first_name last_name email tutorial))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="336">
          
          
          <code class="ruby">        },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="337">
          
          
          <code class="ruby">        fetch_row_data_lambda: -&gt;(row, unit) {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="338">
          
          
          <code class="ruby">          {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="339">
          
          
          <code class="ruby">              unit_code:      row[&#39;unit_code&#39;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="340">
          
          
          <code class="ruby">              username:       row[&#39;username&#39;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="341">
          
          
          <code class="ruby">              student_id:     row[&#39;student_id&#39;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="342">
          
          
          <code class="ruby">              first_name:     row[&#39;first_name&#39;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="343">
          
          
          <code class="ruby">              nickname:       nil,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="344">
          
          
          <code class="ruby">              last_name:      row[&#39;last_name&#39;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="345">
          
          
          <code class="ruby">              email:          row[&#39;email&#39;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="346">
          
          
          <code class="ruby">              enrolled:       true,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="347">
          
          
          <code class="ruby">              tutorial_code:  row[&#39;tutorial&#39;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="348">
          
          
          <code class="ruby">          }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="349">
          
          
          <code class="ruby">        },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="350">
          
          
          <code class="ruby">        replace_existing_tutorial: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="351">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="352">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="353">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="354">
          
          
          <code class="ruby">    # Record changes ready to process - map on username to ensure only one option per user</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="355">
          
          
          <code class="ruby">    # enrol will override withdraw</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="356">
          
          
          <code class="ruby">    changes = {}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="357">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="358">
          
          
          <code class="ruby">    # Determine kind of file to process</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="359">
          
          
          <code class="ruby">    CSV.foreach(file, headers: true,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="360">
          
          
          <code class="ruby">                      header_converters: [-&gt;(i) { i.nil? ? &#39;&#39; : i }, :downcase, -&gt;(hdr) { hdr.strip unless hdr.nil? }],</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="361">
          
          
          <code class="ruby">                      converters: [-&gt;(i) { i.nil? ? &#39;&#39; : i }, -&gt;(body) { body.encode!(&#39;UTF-8&#39;, &#39;binary&#39;, invalid: :replace, undef: :replace, replace: &#39;&#39;) unless body.nil? }]) do |row|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="362">
          
          
          <code class="ruby">      </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="363">
          
          
          <code class="ruby">      missing = import_settings[:missing_headers_lambda].call(row)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="364">
          
          
          <code class="ruby">      if missing.count &gt; 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="365">
          
          
          <code class="ruby">        errors &lt;&lt; { row: row, message: &quot;Missing headers: #{missing.join(&#39;, &#39;)}&quot; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="366">
          
          
          <code class="ruby">        next</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="367">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="368">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="369">
          
          
          <code class="ruby">      begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="370">
          
          
          <code class="ruby">        row_data = import_settings[:fetch_row_data_lambda].call(row, self)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="371">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="372">
          
          
          <code class="ruby">        row_data[:row] = row</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="373">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="374">
          
          
          <code class="ruby">        if row_data[:username].nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="375">
          
          
          <code class="ruby">          ignored &lt;&lt; { row: row, message: &quot;Skipping row with missing username&quot; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="376">
          
          
          <code class="ruby">          next</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="377">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="378">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="379">
          
          
          <code class="ruby">        unit_code = row_data[:unit_code]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="380">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="381">
          
          
          <code class="ruby">        if unit_code != code</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="382">
          
          
          <code class="ruby">          ignored &lt;&lt; { row: row, message: &quot;Invalid unit code. #{unit_code} does not match #{code}&quot; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="383">
          
          
          <code class="ruby">          next</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="384">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="385">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="386">
          
          
          <code class="ruby">        # now record changes...</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="387">
          
          
          <code class="ruby">        username = row_data[:username].downcase</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="388">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="389">
          
          
          <code class="ruby">        # do we already have this user?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="390">
          
          
          <code class="ruby">        if changes.key? username</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="391">
          
          
          <code class="ruby">          if row_data[:enrolled] # they should be enrolled - record that... overriding anything else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="392">
          
          
          <code class="ruby">            # record previous row as ignored</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="393">
          
          
          <code class="ruby">            ignored &lt;&lt; { row: changes[username][:row], message: &quot;Skipping withdraw as also includes enrol&quot; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="394">
          
          
          <code class="ruby">            changes[username] = row_data</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="395">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="396">
          
          
          <code class="ruby">            # record this row as skipped</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="397">
          
          
          <code class="ruby">            ignored &lt;&lt; { row: row, message: &quot;Skipping withdraw as also includes enrol&quot; }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="398">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="399">
          
          
          <code class="ruby">        else #dont have the user so record them - will add to result when processed</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="400">
          
          
          <code class="ruby">          changes[username] = row_data</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="401">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="402">
          
          
          <code class="ruby">      rescue Exception =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="403">
          
          
          <code class="ruby">        errors &lt;&lt; { row: row, message: e.message }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="404">
          
          
          <code class="ruby">      end </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="405">
          
          
          <code class="ruby">    end # for each csv row</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="406">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="407">
          
          
          <code class="ruby">    # now apply the changes...</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="408">
          
          
          <code class="ruby">    changes.each do |key, row_data|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="409">
          
          
          <code class="ruby">      begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="410">
          
          
          <code class="ruby">        row = row_data[:row]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="411">
          
          
          <code class="ruby">        username = row_data[:username].downcase</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="412">
          
          
          <code class="ruby">        unit_code = row_data[:unit_code]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="413">
          
          
          <code class="ruby">        student_id = row_data[:student_id]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="414">
          
          
          <code class="ruby">        first_name = row_data[:first_name].nil? ? nil : row_data[:first_name].titleize</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="415">
          
          
          <code class="ruby">        last_name = row_data[:last_name].nil? ? nil : row_data[:last_name].titleize</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="416">
          
          
          <code class="ruby">        nickname = row_data[:nickname].nil? ? nil : row_data[:nickname].titleize</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="417">
          
          
          <code class="ruby">        email = row_data[:email]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="418">
          
          
          <code class="ruby">        tutorial_code = row_data[:tutorial_code]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="419">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="420">
          
          
          <code class="ruby">        # If either first or last name is nil... copy over the other component</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="421">
          
          
          <code class="ruby">        first_name = first_name || last_name</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="422">
          
          
          <code class="ruby">        last_name = last_name || first_name</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="423">
          
          
          <code class="ruby">        nickname = nickname || first_name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="424">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="425">
          
          
          <code class="ruby">        if !email =~ /\A([^@\s]+)@((?:[-a-z0-9]+\.)+[a-z]{2,})\z/i</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="426">
          
          
          <code class="ruby">          errors &lt;&lt; { row: row, message: &quot;Invalid email address (#{email})&quot; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="427">
          
          
          <code class="ruby">          next</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="428">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="429">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="430">
          
          
          <code class="ruby">        # Perform withdraw if needed...</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="431">
          
          
          <code class="ruby">        unless row_data[:enrolled]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="432">
          
          
          <code class="ruby">          # Find the user</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="433">
          
          
          <code class="ruby">          project_participant = User.where(username: username)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="434">
          
          
          <code class="ruby">          </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="435">
          
          
          <code class="ruby">          # If they dont exist... ignore</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="436">
          
          
          <code class="ruby">          if project_participant.nil? || project_participant.count == 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="437">
          
          
          <code class="ruby">            ignored &lt;&lt; { row: row, message: &quot;Ignoring student to withdraw, as not enrolled&quot; }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="438">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="439">
          
          
          <code class="ruby">            # Get the user&#39;s project</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="440">
          
          
          <code class="ruby">            user_project = projects.where(user_id: project_participant.first.id).first</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="441">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="442">
          
          
          <code class="ruby">            # If no project... then not enrolled</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="443">
          
          
          <code class="ruby">            if user_project.nil? || !user_project.enrolled</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="444">
          
          
          <code class="ruby">              ignored &lt;&lt; { row: row, message: &quot;Ignoring student to withdraw, as not enrolled&quot; }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="445">
          
          
          <code class="ruby">            else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="446">
          
          
          <code class="ruby">              # Withdraw...</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="447">
          
          
          <code class="ruby">              user_project.enrolled = false </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="448">
          
          
          <code class="ruby">              user_project.save</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="449">
          
          
          <code class="ruby">              success &lt;&lt; { row: row, message: &quot;Student was withdrawn&quot; }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="450">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="451">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="452">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="453">
          
          
          <code class="ruby">          # Move to next row as this was a withdraw...</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="454">
          
          
          <code class="ruby">          next</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="455">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="456">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="457">
          
          
          <code class="ruby">        # Is an enrolment... so first find the user</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="458">
          
          
          <code class="ruby">        project_participant = User.find_or_create_by(username: username) do |new_user|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="459">
          
          
          <code class="ruby">          new_user.first_name         = first_name</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="460">
          
          
          <code class="ruby">          new_user.last_name          = last_name</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="461">
          
          
          <code class="ruby">          new_user.student_id         = student_id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="462">
          
          
          <code class="ruby">          new_user.nickname           = nickname</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="463">
          
          
          <code class="ruby">          new_user.role_id            = Role.student_id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="464">
          
          
          <code class="ruby">          new_user.email              = email</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="465">
          
          
          <code class="ruby">          new_user.encrypted_password = BCrypt::Password.create(&#39;password&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="466">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="467">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="468">
          
          
          <code class="ruby">        # If new user then make sure they are saved</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="469">
          
          
          <code class="ruby">        unless project_participant.persisted?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="470">
          
          
          <code class="ruby">          project_participant.save</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="471">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="472">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="473">
          
          
          <code class="ruby">        #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="474">
          
          
          <code class="ruby">        # Only import if a valid user - or if save worked</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="475">
          
          
          <code class="ruby">        #</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="476">
          
          
          <code class="ruby">        if project_participant.persisted?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="477">
          
          
          <code class="ruby">          # Add in the student id if it was supplied...</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="478">
          
          
          <code class="ruby">          if (project_participant.student_id.nil? || project_participant.student_id.empty?) &amp;&amp; student_id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="479">
          
          
          <code class="ruby">            project_participant.student_id = student_id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="480">
          
          
          <code class="ruby">            project_participant.save!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="481">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="482">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="483">
          
          
          <code class="ruby">          # Now find the project for the user</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="484">
          
          
          <code class="ruby">          user_project = projects.where(user_id: project_participant.id).first</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="485">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="486">
          
          
          <code class="ruby">          # And find the tutorial for the user</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="487">
          
          
          <code class="ruby">          tutorial = tutorial_cache[tutorial_code] || tutorial_with_abbr(tutorial_code)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="488">
          
          
          <code class="ruby">          tutorial_cache[tutorial_code] ||= tutorial</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="489">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="490">
          
          
          <code class="ruby">          # Add the user to the project (if not already in there)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="491">
          
          
          <code class="ruby">          if user_project.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="492">
          
          
          <code class="ruby">            # Need to enrol user... can always set tutorial as does not already exist...</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="493">
          
          
          <code class="ruby">            if (!tutorial.nil?) </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="494">
          
          
          <code class="ruby">              # Use tutorial if we have it :)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="495">
          
          
          <code class="ruby">              enrol_student(project_participant, tutorial)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="496">
          
          
          <code class="ruby">              success &lt;&lt; { row: row, message: &#39;Enrolled student with tutorial.&#39; }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="497">
          
          
          <code class="ruby">            else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="498">
          
          
          <code class="ruby">              enrol_student(project_participant)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="499">
          
          
          <code class="ruby">              success &lt;&lt; { row: row, message: &#39;Enrolled student without tutorial.&#39; }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="500">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="501">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="502">
          
          
          <code class="ruby">            # update enrolment... if currently not enrolled</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="503">
          
          
          <code class="ruby">            changes = &#39;&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="504">
          
          
          <code class="ruby">            unless user_project.enrolled</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="505">
          
          
          <code class="ruby">              user_project.enrolled = true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="506">
          
          
          <code class="ruby">              user_project.save</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="507">
          
          
          <code class="ruby">              changes &lt;&lt; &#39;Changed enrolment.&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="508">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="509">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="510">
          
          
          <code class="ruby">            # replace tutorial if we are allowed... and it has changed</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="511">
          
          
          <code class="ruby">            if import_settings[:replace_existing_tutorial] || user_project.tutorial.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="512">
          
          
          <code class="ruby">              # check it has changed first...</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="513">
          
          
          <code class="ruby">              if user_project.tutorial != tutorial</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="514">
          
          
          <code class="ruby">                user_project.tutorial = tutorial</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="515">
          
          
          <code class="ruby">                user_project.save</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="516">
          
          
          <code class="ruby">                changes &lt;&lt; &#39;Changed tutorial. &#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="517">
          
          
          <code class="ruby">              end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="518">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="519">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="520">
          
          
          <code class="ruby">            # Get back to user with changes... if any</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="521">
          
          
          <code class="ruby">            if changes.empty?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="522">
          
          
          <code class="ruby">              ignored &lt;&lt; { row: row, message: &#39;No change.&#39; }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="523">
          
          
          <code class="ruby">            else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="524">
          
          
          <code class="ruby">              success &lt;&lt; { row: row, message: changes }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="525">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="526">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="527">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="528">
          
          
          <code class="ruby">          errors &lt;&lt; { row: row, message: &quot;Student record is invalid. #{project_participant.errors.full_messages.first}&quot; }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="529">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="530">
          
          
          <code class="ruby">      rescue Exception =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="531">
          
          
          <code class="ruby">        errors &lt;&lt; { row: row, message: e.message }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="532">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="533">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="534">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="535">
          
          
          <code class="ruby">    {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="536">
          
          
          <code class="ruby">      success: success,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="537">
          
          
          <code class="ruby">      ignored: ignored,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="538">
          
          
          <code class="ruby">      errors:  errors</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="539">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="540">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="541">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="542">
          
          
          <code class="ruby">  # Use the values in the CSV to set the enrolment of these</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="543">
          
          
          <code class="ruby">  # students to false for this unit.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="544">
          
          
          <code class="ruby">  # CSV should contain just the usernames to withdraw</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="545">
          <span class="hits">1</span>
          
          <code class="ruby">  def unenrol_users_from_csv(file)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="546">
          
          
          <code class="ruby">    logger.info &quot;Initiating withdraw of students from unit #{id} using CSV&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="547">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="548">
          
          
          <code class="ruby">    success = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="549">
          
          
          <code class="ruby">    errors = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="550">
          
          
          <code class="ruby">    ignored = []</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="551">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="552">
          
          
          <code class="ruby">    CSV.parse(file,                 headers: true,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="553">
          
          
          <code class="ruby">                                    header_converters: [-&gt;(i) { i.nil? ? &#39;&#39; : i }, :downcase, -&gt;(hdr) { hdr.strip unless hdr.nil? }],</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="554">
          
          
          <code class="ruby">                                    converters: [-&gt;(body) { body.encode!(&#39;UTF-8&#39;, &#39;binary&#39;, invalid: :replace, undef: :replace, replace: &#39;&#39;) unless body.nil? }]).each do |row|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="555">
          
          
          <code class="ruby">      # Make sure we&#39;re not looking at the header or an empty line</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="556">
          
          
          <code class="ruby">      next if row[0] =~ /(username)|(((unit)|(subject))_code)/</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="557">
          
          
          <code class="ruby">      # next if row[5] !~ /^LA\d/</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="558">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="559">
          
          
          <code class="ruby">      begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="560">
          
          
          <code class="ruby">        unit_code = row[&#39;unit_code&#39;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="561">
          
          
          <code class="ruby">        username  = row[&#39;username&#39;].downcase unless row[&#39;username&#39;].nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="562">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="563">
          
          
          <code class="ruby">        if unit_code != code</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="564">
          
          
          <code class="ruby">          ignored &lt;&lt; { row: row, message: &quot;Invalid unit code. #{unit_code} does not match #{code}&quot; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="565">
          
          
          <code class="ruby">          next</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="566">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="567">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="568">
          
          
          <code class="ruby">        project_participant = User.where(username: username)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="569">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="570">
          
          
          <code class="ruby">        unless project_participant</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="571">
          
          
          <code class="ruby">          errors &lt;&lt; { row: row, message: &quot;User #{username} not found&quot; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="572">
          
          
          <code class="ruby">          next</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="573">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="574">
          
          
          <code class="ruby">        unless project_participant.count == 1</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="575">
          
          
          <code class="ruby">          errors &lt;&lt; { row: row, message: &quot;User #{username} not found&quot; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="576">
          
          
          <code class="ruby">          next</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="577">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="578">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="579">
          
          
          <code class="ruby">        project_participant = project_participant.first</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="580">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="581">
          
          
          <code class="ruby">        user_project = projects.where(user_id: project_participant.id).first</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="582">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="583">
          
          
          <code class="ruby">        unless user_project</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="584">
          
          
          <code class="ruby">          ignored &lt;&lt; { row: row, message: &quot;User #{username} not enrolled in unit&quot; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="585">
          
          
          <code class="ruby">          next</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="586">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="587">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="588">
          
          
          <code class="ruby">        if user_project.enrolled</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="589">
          
          
          <code class="ruby">          user_project.enrolled = false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="590">
          
          
          <code class="ruby">          user_project.save</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="591">
          
          
          <code class="ruby">          success &lt;&lt; { row: row, message: &quot;User #{username} withdrawn from unit&quot; }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="592">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="593">
          
          
          <code class="ruby">          ignored &lt;&lt; { row: row, message: &quot;User #{username} not enrolled in unit&quot; }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="594">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="595">
          
          
          <code class="ruby">      rescue Exception =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="596">
          
          
          <code class="ruby">        errors &lt;&lt; { row: row, message: &quot;Unexpected error: #{e.message}&quot; }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="597">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="598">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="599">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="600">
          
          
          <code class="ruby">    {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="601">
          
          
          <code class="ruby">      success: success,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="602">
          
          
          <code class="ruby">      ignored: ignored,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="603">
          
          
          <code class="ruby">      errors:  errors</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="604">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="605">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="606">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="607">
          <span class="hits">1</span>
          
          <code class="ruby">  def export_users_to_csv</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="608">
          
          
          <code class="ruby">    CSV.generate do |row|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="609">
          
          
          <code class="ruby">      row &lt;&lt; %w(unit_code username student_id first_name last_name email tutorial)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="610">
          
          
          <code class="ruby">      active_projects.each do |project|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="611">
          
          
          <code class="ruby">        row &lt;&lt; [project.unit.code, project.student.username, project.student.student_id, project.student.first_name, project.student.last_name, project.student.email, project.tutorial_abbr]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="612">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="613">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="614">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="615">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="616">
          <span class="hits">1</span>
          
          <code class="ruby">  def export_learning_outcome_to_csv</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="617">
          
          
          <code class="ruby">    CSV.generate do |row|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="618">
          
          
          <code class="ruby">      row &lt;&lt; LearningOutcome.csv_header</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="619">
          
          
          <code class="ruby">      learning_outcomes.each do |outcome|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="620">
          
          
          <code class="ruby">        outcome.add_csv_row row</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="621">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="622">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="623">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="624">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="625">
          <span class="hits">1</span>
          
          <code class="ruby">  def import_outcomes_from_csv(file)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="626">
          
          
          <code class="ruby">    result = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="627">
          
          
          <code class="ruby">      success: [],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="628">
          
          
          <code class="ruby">      errors: [],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="629">
          
          
          <code class="ruby">      ignored: []</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="630">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="631">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="632">
          
          
          <code class="ruby">    CSV.parse(file,                 headers: true,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="633">
          
          
          <code class="ruby">                                    header_converters: [-&gt;(i) { i.nil? ? &#39;&#39; : i }, :downcase, -&gt;(hdr) { hdr.strip unless hdr.nil? }],</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="634">
          
          
          <code class="ruby">                                    converters: [-&gt;(body) { body.encode!(&#39;UTF-8&#39;, &#39;binary&#39;, invalid: :replace, undef: :replace, replace: &#39;&#39;) unless body.nil? }]).each do |row|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="635">
          
          
          <code class="ruby">      # Make sure we&#39;re not looking at the header or an empty line</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="636">
          
          
          <code class="ruby">      next if row[0] =~ /unit_code/</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="637">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="638">
          
          
          <code class="ruby">      begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="639">
          
          
          <code class="ruby">        LearningOutcome.create_from_csv(self, row, result)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="640">
          
          
          <code class="ruby">      rescue Exception =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="641">
          
          
          <code class="ruby">        result[:errors] &lt;&lt; { row: row, message: e.message.to_s }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="642">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="643">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="644">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="645">
          
          
          <code class="ruby">    result</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="646">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="647">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="648">
          <span class="hits">1</span>
          
          <code class="ruby">  def export_task_alignment_to_csv</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="649">
          
          
          <code class="ruby">    LearningOutcomeTaskLink.export_task_alignment_to_csv(self, self)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="650">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="651">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="652">
          
          
          <code class="ruby">  # Use the values in the CSV to setup task alignments</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="653">
          <span class="hits">1</span>
          
          <code class="ruby">  def import_task_alignment_from_csv(file, for_project)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="654">
          
          
          <code class="ruby">    success = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="655">
          
          
          <code class="ruby">    errors = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="656">
          
          
          <code class="ruby">    ignored = []</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="657">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="658">
          
          
          <code class="ruby">    CSV.parse(file,                 headers: true,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="659">
          
          
          <code class="ruby">                                    header_converters: [-&gt;(i) { i.nil? ? &#39;&#39; : i }, :downcase, -&gt;(hdr) { hdr.strip unless hdr.nil? }],</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="660">
          
          
          <code class="ruby">                                    converters: [-&gt;(body) { body.encode!(&#39;UTF-8&#39;, &#39;binary&#39;, invalid: :replace, undef: :replace, replace: &#39;&#39;) unless body.nil? }]).each do |row|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="661">
          
          
          <code class="ruby">      # Make sure we&#39;re not looking at the header or an empty line</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="662">
          
          
          <code class="ruby">      next if row[0] =~ /unit_code/</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="663">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="664">
          
          
          <code class="ruby">      begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="665">
          
          
          <code class="ruby">        unit_code = row[&#39;unit_code&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="666">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="667">
          
          
          <code class="ruby">        if unit_code != code</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="668">
          
          
          <code class="ruby">          ignored &lt;&lt; { row: row, message: &quot;Invalid unit code. #{unit_code} does not match #{code}&quot; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="669">
          
          
          <code class="ruby">          next</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="670">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="671">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="672">
          
          
          <code class="ruby">        outcome_abbr = row[&#39;learning_outcome&#39;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="673">
          
          
          <code class="ruby">        outcome = learning_outcomes.where(&#39;abbreviation = :abbr&#39;, abbr: outcome_abbr).first</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="674">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="675">
          
          
          <code class="ruby">        if outcome.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="676">
          
          
          <code class="ruby">          errors &lt;&lt; { row: row, message: &quot;Unable to locate learning outcome with abbreviation #{outcome_abbr}&quot; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="677">
          
          
          <code class="ruby">          next</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="678">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="679">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="680">
          
          
          <code class="ruby">        task_def_abbr = row[&#39;task_abbr&#39;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="681">
          
          
          <code class="ruby">        task_def = task_definitions.where(&#39;abbreviation = :abbr&#39;, abbr: task_def_abbr).first</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="682">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="683">
          
          
          <code class="ruby">        if task_def.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="684">
          
          
          <code class="ruby">          errors &lt;&lt; { row: row, message: &quot;Unable to locate task with abbreviation #{task_def_abbr}&quot; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="685">
          
          
          <code class="ruby">          next</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="686">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="687">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="688">
          
          
          <code class="ruby">        rating = row[&#39;rating&#39;].to_i</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="689">
          
          
          <code class="ruby">        description = row[&#39;description&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="690">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="691">
          
          
          <code class="ruby">        if for_project.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="692">
          
          
          <code class="ruby">          link = LearningOutcomeTaskLink.find_or_create_by(task_definition_id: task_def.id, learning_outcome_id: outcome.id, task_id: nil)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="693">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="694">
          
          
          <code class="ruby">          task = for_project.tasks.where(&#39;task_definition_id = :tdid&#39;, tdid: task_def.id).first</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="695">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="696">
          
          
          <code class="ruby">          if task.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="697">
          
          
          <code class="ruby">            errors &lt;&lt; { row: row, message: &quot;Unable to locate task related to #{task_def_abbr}&quot; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="698">
          
          
          <code class="ruby">            next</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="699">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="700">
          
          
          <code class="ruby">          link = LearningOutcomeTaskLink.find_or_create_by(task_definition_id: task_def.id, learning_outcome_id: outcome.id, task_id: task.id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="701">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="702">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="703">
          
          
          <code class="ruby">        link.rating = rating</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="704">
          
          
          <code class="ruby">        link.description = description</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="705">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="706">
          
          
          <code class="ruby">        link.save!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="707">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="708">
          
          
          <code class="ruby">        if link.new_record?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="709">
          
          
          <code class="ruby">          success &lt;&lt; { row: row, message: &quot;Link between task #{task_def.abbreviation} and outcome #{outcome.abbreviation} created for unit&quot; }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="710">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="711">
          
          
          <code class="ruby">          success &lt;&lt; { row: row, message: &quot;Link between task #{task_def.abbreviation} and outcome #{outcome.abbreviation} updated for unit&quot; }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="712">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="713">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="714">
          
          
          <code class="ruby">      rescue Exception =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="715">
          
          
          <code class="ruby">        errors &lt;&lt; { row: row, message: e.message.to_s }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="716">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="717">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="718">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="719">
          
          
          <code class="ruby">    {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="720">
          
          
          <code class="ruby">      success: success,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="721">
          
          
          <code class="ruby">      ignored: ignored,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="722">
          
          
          <code class="ruby">      errors:  errors</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="723">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="724">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="725">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="726">
          <span class="hits">1</span>
          
          <code class="ruby">  def import_groups_from_csv(group_set, file)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="727">
          
          
          <code class="ruby">    success = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="728">
          
          
          <code class="ruby">    errors = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="729">
          
          
          <code class="ruby">    ignored = []</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="730">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="731">
          
          
          <code class="ruby">    logger.info &quot;Starting import of group for #{group_set.name} for #{code}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="732">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="733">
          
          
          <code class="ruby">    CSV.parse(file,                 headers: true,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="734">
          
          
          <code class="ruby">                                    header_converters: [-&gt;(i) { i.nil? ? &#39;&#39; : i }, :downcase, -&gt;(hdr) { hdr.strip unless hdr.nil? }],</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="735">
          
          
          <code class="ruby">                                    converters: [-&gt;(body) { body.encode!(&#39;UTF-8&#39;, &#39;binary&#39;, invalid: :replace, undef: :replace, replace: &#39;&#39;) unless body.nil? }]).each do |row|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="736">
          
          
          <code class="ruby">      next if row[0] =~ /^(group_name)|(name)/ # Skip header</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="737">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="738">
          
          
          <code class="ruby">      begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="739">
          
          
          <code class="ruby">        missing = missing_headers(row, %w(group_name group_number username tutorial))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="740">
          
          
          <code class="ruby">        if missing.count &gt; 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="741">
          
          
          <code class="ruby">          errors &lt;&lt; { row: row, message: &quot;Missing headers: #{missing.join(&#39;, &#39;)}&quot; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="742">
          
          
          <code class="ruby">          next</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="743">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="744">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="745">
          
          
          <code class="ruby">        if row[&#39;username&#39;].nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="746">
          
          
          <code class="ruby">          ignored &lt;&lt; { row: row, message: &quot;Skipping row with missing username&quot; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="747">
          
          
          <code class="ruby">          next</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="748">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="749">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="750">
          
          
          <code class="ruby">        username = row[&#39;username&#39;].downcase.strip unless row[&#39;username&#39;].nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="751">
          
          
          <code class="ruby">        group_name = row[&#39;group_name&#39;].strip unless row[&#39;group_name&#39;].nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="752">
          
          
          <code class="ruby">        group_number = row[&#39;group_number&#39;].strip unless row[&#39;group_number&#39;].nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="753">
          
          
          <code class="ruby">        tutorial = row[&#39;tutorial&#39;].strip unless row[&#39;tutorial&#39;].nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="754">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="755">
          
          
          <code class="ruby">        user = User.where(username: username).first</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="756">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="757">
          
          
          <code class="ruby">        if user.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="758">
          
          
          <code class="ruby">          errors &lt;&lt; { row: row, message: &quot;Unable to find user #{username}&quot; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="759">
          
          
          <code class="ruby">          next</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="760">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="761">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="762">
          
          
          <code class="ruby">        project = students.where(&#39;user_id = :id&#39;, id: user.id).first</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="763">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="764">
          
          
          <code class="ruby">        if project.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="765">
          
          
          <code class="ruby">          errors &lt;&lt; { row: row, message: &quot;Student #{username} not found in unit&quot; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="766">
          
          
          <code class="ruby">          next</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="767">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="768">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="769">
          
          
          <code class="ruby">        grp = group_set.groups.find_or_create_by(name: group_name)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="770">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="771">
          
          
          <code class="ruby">        change = &#39;&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="772">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="773">
          
          
          <code class="ruby">        if grp.new_record?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="774">
          
          
          <code class="ruby">          tutorial = tutorial_with_abbr(tutorial)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="775">
          
          
          <code class="ruby">          if tutorial.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="776">
          
          
          <code class="ruby">            errors &lt;&lt; { row: row, message: &quot;Tutorial #{tutorial} not found&quot; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="777">
          
          
          <code class="ruby">            next</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="778">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="779">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="780">
          
          
          <code class="ruby">          change = &#39;Created new group. &#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="781">
          
          
          <code class="ruby">          grp.tutorial = tutorial</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="782">
          
          
          <code class="ruby">          grp.number = group_number</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="783">
          
          
          <code class="ruby">          grp.save!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="784">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="785">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="786">
          
          
          <code class="ruby">        begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="787">
          
          
          <code class="ruby">          grp.add_member(project)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="788">
          
          
          <code class="ruby">        rescue Exception =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="789">
          
          
          <code class="ruby">          errors &lt;&lt; { row: row, message: e.message }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="790">
          
          
          <code class="ruby">          next</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="791">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="792">
          
          
          <code class="ruby">        success &lt;&lt; { row: row, message: &quot;#{change}Added #{username} to #{grp.name}.&quot; }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="793">
          
          
          <code class="ruby">      rescue Exception =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="794">
          
          
          <code class="ruby">        errors &lt;&lt; { row: row, message: e.message }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="795">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="796">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="797">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="798">
          
          
          <code class="ruby">    {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="799">
          
          
          <code class="ruby">      success: success,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="800">
          
          
          <code class="ruby">      ignored: ignored,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="801">
          
          
          <code class="ruby">      errors:  errors</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="802">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="803">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="804">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="805">
          <span class="hits">1</span>
          
          <code class="ruby">  def export_groups_to_csv(group_set)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="806">
          
          
          <code class="ruby">    CSV.generate do |row|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="807">
          
          
          <code class="ruby">      row &lt;&lt; %w(group_name group_number username tutorial)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="808">
          
          
          <code class="ruby">      group_set.groups.each do |grp|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="809">
          
          
          <code class="ruby">        grp.projects.each do |project|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="810">
          
          
          <code class="ruby">          row &lt;&lt; [grp.name, grp.number, project.student.username, grp.tutorial.abbreviation]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="811">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="812">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="813">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="814">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="815">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="816">
          
          
          <code class="ruby">  # def import_tutorials_from_csv(file)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="817">
          
          
          <code class="ruby">  #   CSV.foreach(file) do |row|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="818">
          
          
          <code class="ruby">  #     next if row[0] =~ /Subject Code/ # Skip header</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="819">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="820">
          
          
          <code class="ruby">  #     class_type, abbrev, day, time, location, tutor_username = row[2..-1]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="821">
          
          
          <code class="ruby">  #     next if class_type !~ /Lab/</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="822">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="823">
          
          
          <code class="ruby">  #     add_tutorial(day, time, location, tutor_username, abbrev)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="824">
          
          
          <code class="ruby">  #   end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="825">
          
          
          <code class="ruby">  # end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="826">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="827">
          <span class="hits">1</span>
          
          <code class="ruby">  def add_tutorial(day, time, location, tutor, abbrev)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="828">
          <span class="hits">2</span>
          
          <code class="ruby">    tutor_role = unit_roles.where(&#39;user_id=:user_id&#39;, user_id: tutor.id).first</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="829">
          <span class="hits">2</span>
          
          <code class="ruby">    return nil if tutor_role.nil? || tutor_role.role == Role.student</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="830">
          <span class="hits">2</span>
          
          <code class="ruby">    Tutorial.create!(unit_id: id, abbreviation: abbrev) do |tutorial|</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="831">
          <span class="hits">2</span>
          
          <code class="ruby">      tutorial.meeting_day      = day</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="832">
          <span class="hits">2</span>
          
          <code class="ruby">      tutorial.meeting_time     = time</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="833">
          <span class="hits">2</span>
          
          <code class="ruby">      tutorial.meeting_location = location</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="834">
          <span class="hits">2</span>
          
          <code class="ruby">      tutorial.unit_role_id     = tutor_role.id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="835">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="836">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="837">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="838">
          <span class="hits">1</span>
          
          <code class="ruby">  def date_for_week_and_day(week, day)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="839">
          
          
          <code class="ruby">    return nil if week.nil? || day.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="840">
          
          
          <code class="ruby">    day_num = Date::ABBR_DAYNAMES.index day.titlecase</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="841">
          
          
          <code class="ruby">    return nil if day_num.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="842">
          
          
          <code class="ruby">    start_day_num = start_date.wday</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="843">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="844">
          
          
          <code class="ruby">    start_date + week.weeks + (day_num - start_day_num).days</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="845">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="846">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="847">
          <span class="hits">1</span>
          
          <code class="ruby">  def import_tasks_from_csv(file)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="848">
          
          
          <code class="ruby">    success = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="849">
          
          
          <code class="ruby">    errors = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="850">
          
          
          <code class="ruby">    ignored = []</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="851">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="852">
          
          
          <code class="ruby">    CSV.parse(file,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="853">
          
          
          <code class="ruby">              headers: true,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="854">
          
          
          <code class="ruby">              header_converters: [-&gt;(i) { i.nil? ? &#39;&#39; : i }, :downcase, -&gt;(hdr) { hdr.strip.tr(&#39; &#39;, &#39;_&#39;).to_sym unless hdr.nil? }],</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="855">
          
          
          <code class="ruby">              converters: [-&gt;(body) { body.encode!(&#39;UTF-8&#39;, &#39;binary&#39;, invalid: :replace, undef: :replace, replace: &#39;&#39;) unless body.nil? }]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="856">
          
          
          <code class="ruby">              ).each do |row|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="857">
          
          
          <code class="ruby">      next if row[0] =~ /^(Task Name)|(name)/ # Skip header</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="858">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="859">
          
          
          <code class="ruby">      begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="860">
          
          
          <code class="ruby">        missing = missing_headers(row, TaskDefinition.csv_columns)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="861">
          
          
          <code class="ruby">        if missing.count &gt; 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="862">
          
          
          <code class="ruby">          errors &lt;&lt; { row: row, message: &quot;Missing headers: #{missing.join(&#39;, &#39;)}&quot; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="863">
          
          
          <code class="ruby">          next</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="864">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="865">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="866">
          
          
          <code class="ruby">        task_definition, new_task, message = TaskDefinition.task_def_for_csv_row(self, row)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="867">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="868">
          
          
          <code class="ruby">        if task_definition.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="869">
          
          
          <code class="ruby">          errors &lt;&lt; { row: row, message: message }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="870">
          
          
          <code class="ruby">          next</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="871">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="872">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="873">
          
          
          <code class="ruby">        success &lt;&lt; { row: row, message: message }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="874">
          
          
          <code class="ruby">      rescue Exception =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="875">
          
          
          <code class="ruby">        errors &lt;&lt; { row: row, message: e.message }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="876">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="877">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="878">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="879">
          
          
          <code class="ruby">    {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="880">
          
          
          <code class="ruby">      success: success,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="881">
          
          
          <code class="ruby">      ignored: ignored,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="882">
          
          
          <code class="ruby">      errors:  errors</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="883">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="884">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="885">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="886">
          <span class="hits">1</span>
          
          <code class="ruby">  def task_definitions_csv</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="887">
          
          
          <code class="ruby">    TaskDefinition.to_csv(task_definitions)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="888">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="889">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="890">
          <span class="hits">1</span>
          
          <code class="ruby">  def task_definitions_by_grade</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="891">
          
          
          <code class="ruby">    # Need to search as relation is already ordered</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="892">
          
          
          <code class="ruby">    TaskDefinition.where(unit_id: id).order(&#39;target_grade ASC, start_date ASC, abbreviation ASC&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="893">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="894">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="895">
          <span class="hits">1</span>
          
          <code class="ruby">  def task_completion_csv(options = {})</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="896">
          
          
          <code class="ruby">    CSV.generate(options) do |csv|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="897">
          
          
          <code class="ruby">      csv &lt;&lt; [</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="898">
          
          
          <code class="ruby">        &#39;Student ID&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="899">
          
          
          <code class="ruby">        &#39;Student Name&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="900">
          
          
          <code class="ruby">        &#39;Target Grade&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="901">
          
          
          <code class="ruby">        &#39;Email&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="902">
          
          
          <code class="ruby">        &#39;Portfolio&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="903">
          
          
          <code class="ruby">        &#39;Tutorial&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="904">
          
          
          <code class="ruby">        &#39;Tutor&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="905">
          
          
          <code class="ruby">      ] +</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="906">
          
          
          <code class="ruby">             group_sets.map(&amp;:name) +</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="907">
          
          
          <code class="ruby">             task_definitions_by_grade.map do |task_definition|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="908">
          
          
          <code class="ruby">               result = [ task_definition.abbreviation ]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="909">
          
          
          <code class="ruby">               result &lt;&lt; &quot;#{task_definition.abbreviation} grade&quot; if task_definition.is_graded?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="910">
          
          
          <code class="ruby">               result &lt;&lt; &quot;#{task_definition.abbreviation} stars&quot; if task_definition.has_stars?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="911">
          
          
          <code class="ruby">               result &lt;&lt; &quot;#{task_definition.abbreviation} contribution&quot; if task_definition.is_group_task?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="912">
          
          
          <code class="ruby">               result</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="913">
          
          
          <code class="ruby">             end.flatten</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="914">
          
          
          <code class="ruby">      active_projects.each do |project|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="915">
          
          
          <code class="ruby">        csv &lt;&lt; project.task_completion_csv</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="916">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="917">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="918">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="919">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="920">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="921">
          
          
          <code class="ruby">  # Create a temp zip file with all student portfolios</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="922">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="923">
          <span class="hits">1</span>
          
          <code class="ruby">  def get_portfolio_zip(current_user)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="924">
          
          
          <code class="ruby">    # Get a temp file path</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="925">
          
          
          <code class="ruby">    filename = FileHelper.sanitized_filename(&quot;portfolios-#{code}-#{current_user.username}.zip&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="926">
          
          
          <code class="ruby">    result = Tempfile.new(filename)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="927">
          
          
          <code class="ruby">    # Create a new zip</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="928">
          
          
          <code class="ruby">    Zip::File.open(result.path, Zip::File::CREATE) do |zip|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="929">
          
          
          <code class="ruby">      active_projects.each do |project|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="930">
          
          
          <code class="ruby">        # Skip if no portfolio at this time...</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="931">
          
          
          <code class="ruby">        next unless project.portfolio_available</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="932">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="933">
          
          
          <code class="ruby">        # Add file to zip in grade folder</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="934">
          
          
          <code class="ruby">        src_path = project.portfolio_path</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="935">
          
          
          <code class="ruby">        if project.main_tutor</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="936">
          
          
          <code class="ruby">          dst_path = FileHelper.sanitized_path(project.target_grade_desc.to_s, &quot;#{project.student.username}-portfolio (#{project.main_tutor.name})&quot;) + &#39;.pdf&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="937">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="938">
          
          
          <code class="ruby">          dst_path = FileHelper.sanitized_path(project.target_grade_desc.to_s, &quot;#{project.student.username}-portfolio (no tutor)&quot;) + &#39;.pdf&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="939">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="940">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="941">
          
          
          <code class="ruby">        # copy into zip</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="942">
          
          
          <code class="ruby">        zip.add(dst_path, src_path)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="943">
          
          
          <code class="ruby">      end # active_projects</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="944">
          
          
          <code class="ruby">    end # zip</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="945">
          
          
          <code class="ruby">    result</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="946">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="947">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="948">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="949">
          
          
          <code class="ruby">  # Create a temp zip file with all student portfolios</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="950">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="951">
          <span class="hits">1</span>
          
          <code class="ruby">  def get_task_resources_zip</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="952">
          
          
          <code class="ruby">    # Get a temp file path</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="953">
          
          
          <code class="ruby">    filename = FileHelper.sanitized_filename(&quot;task-resources-#{code}.zip&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="954">
          
          
          <code class="ruby">    result = Tempfile.new(filename)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="955">
          
          
          <code class="ruby">    # Create a new zip</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="956">
          
          
          <code class="ruby">    Zip::File.open(result.path, Zip::File::CREATE) do |zip|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="957">
          
          
          <code class="ruby">      task_definitions.each do |td|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="958">
          
          
          <code class="ruby">        if td.has_task_sheet?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="959">
          
          
          <code class="ruby">          dst_path = FileHelper.sanitized_filename(td.abbreviation.to_s) + &#39;.pdf&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="960">
          
          
          <code class="ruby">          zip.add(dst_path, td.task_sheet)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="961">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="962">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="963">
          
          
          <code class="ruby">        if td.has_task_resources?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="964">
          
          
          <code class="ruby">          dst_path = FileHelper.sanitized_filename(td.abbreviation.to_s) + &#39;.zip&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="965">
          
          
          <code class="ruby">          zip.add(dst_path, td.task_resources)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="966">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="967">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="968">
          
          
          <code class="ruby">    end # zip</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="969">
          
          
          <code class="ruby">    result</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="970">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="971">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="972">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="973">
          
          
          <code class="ruby">  # Create a temp zip file with all submission PDFs for a task</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="974">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="975">
          <span class="hits">1</span>
          
          <code class="ruby">  def get_task_submissions_pdf_zip(current_user, td)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="976">
          
          
          <code class="ruby">    # Get a temp file path</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="977">
          
          
          <code class="ruby">    filename = FileHelper.sanitized_filename(&quot;submissions-#{code}-#{td.abbreviation}-#{current_user.username}-pdfs&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="978">
          
          
          <code class="ruby">    result = Tempfile.new([filename, &#39;.zip&#39;])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="979">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="980">
          
          
          <code class="ruby">    tasks_with_files = td.related_tasks_with_files</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="981">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="982">
          
          
          <code class="ruby">    # Create a new zip</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="983">
          
          
          <code class="ruby">    Zip::File.open(result.path, Zip::File::CREATE) do |zip|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="984">
          
          
          <code class="ruby">      Dir.mktmpdir do |dir|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="985">
          
          
          <code class="ruby">        # Extract all of the files...</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="986">
          
          
          <code class="ruby">        tasks_with_files.each do |task|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="987">
          
          
          <code class="ruby">          path_part = if td.is_group_task? &amp;&amp; task.group</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="988">
          
          
          <code class="ruby">                        task.group.name.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="989">
          
          
          <code class="ruby">                      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="990">
          
          
          <code class="ruby">                        task.student.username.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="991">
          
          
          <code class="ruby">                      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="992">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="993">
          
          
          <code class="ruby">          FileUtils.cp task.portfolio_evidence, File.join(dir, path_part.to_s) + &#39;.pdf&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="994">
          
          
          <code class="ruby">        end # each task</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="995">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="996">
          
          
          <code class="ruby">        # Copy files into zip</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="997">
          
          
          <code class="ruby">        zip_root_path = &quot;#{td.abbreviation}-pdfs&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="998">
          
          
          <code class="ruby">        FileHelper.recursively_add_dir_to_zip(zip, dir, zip_root_path)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="999">
          
          
          <code class="ruby">      end # mktmpdir</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1000">
          
          
          <code class="ruby">    end # zip</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1001">
          
          
          <code class="ruby">    result</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1002">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1003">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1004">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1005">
          
          
          <code class="ruby">  # Create a temp zip file with all submissions for a task</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1006">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="1007">
          <span class="hits">1</span>
          
          <code class="ruby">  def get_task_submissions_zip(current_user, td)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1008">
          
          
          <code class="ruby">    # Get a temp file path</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1009">
          
          
          <code class="ruby">    filename = FileHelper.sanitized_filename(&quot;submissions-#{code}-#{td.abbreviation}-#{current_user.username}-files.zip&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1010">
          
          
          <code class="ruby">    result = Tempfile.new(filename)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1011">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1012">
          
          
          <code class="ruby">    tasks_with_files = td.related_tasks_with_files</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1013">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1014">
          
          
          <code class="ruby">    # Create a new zip</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1015">
          
          
          <code class="ruby">    Zip::File.open(result.path, Zip::File::CREATE) do |zip|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1016">
          
          
          <code class="ruby">      Dir.mktmpdir do |dir|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1017">
          
          
          <code class="ruby">        # Extract all of the files...</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1018">
          
          
          <code class="ruby">        tasks_with_files.each do |task|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1019">
          
          
          <code class="ruby">          path_part = if td.is_group_task? &amp;&amp; task.group</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1020">
          
          
          <code class="ruby">                        task.group.name.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1021">
          
          
          <code class="ruby">                      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1022">
          
          
          <code class="ruby">                        task.student.username.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1023">
          
          
          <code class="ruby">                      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1024">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1025">
          
          
          <code class="ruby">          task.extract_file_from_done(dir, &#39;*&#39;,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1026">
          
          
          <code class="ruby">                                      -&gt;(_task, to_path, name) { File.join(to_path.to_s, path_part, name.to_s) }) # call</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1027">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1028">
          
          
          <code class="ruby">          FileUtils.mv Dir.glob(&quot;#{dir}/#{path_part}/#{task.id}/*&quot;), File.join(dir, path_part.to_s)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1029">
          
          
          <code class="ruby">          FileUtils.rm_r &quot;#{dir}/#{path_part}/#{task.id}&quot; if File.directory?(&quot;#{dir}/#{path_part}/#{task.id}&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1030">
          
          
          <code class="ruby">        end # each task</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1031">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1032">
          
          
          <code class="ruby">        # Copy files into zip</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1033">
          
          
          <code class="ruby">        zip_root_path = &quot;#{td.abbreviation}-submissions&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1034">
          
          
          <code class="ruby">        FileHelper.recursively_add_dir_to_zip(zip, dir, zip_root_path)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1035">
          
          
          <code class="ruby">      end # mktmpdir</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1036">
          
          
          <code class="ruby">    end # zip</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1037">
          
          
          <code class="ruby">    result</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1038">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1039">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1040">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1041">
          
          
          <code class="ruby">  # Create an ILO</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1042">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="1043">
          <span class="hits">1</span>
          
          <code class="ruby">  def add_ilo(name, desc, abbr)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1044">
          
          
          <code class="ruby">    next_num = learning_outcomes.count + 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1045">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1046">
          
          
          <code class="ruby">    LearningOutcome.create!(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1047">
          
          
          <code class="ruby">      unit_id: id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1048">
          
          
          <code class="ruby">      name: name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1049">
          
          
          <code class="ruby">      description: desc,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1050">
          
          
          <code class="ruby">      abbreviation: abbr,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1051">
          
          
          <code class="ruby">      ilo_number: next_num</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1052">
          
          
          <code class="ruby">    )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1053">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1054">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1055">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1056">
          
          
          <code class="ruby">  # Reorder ILO sequence numbers based on ILO update</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1057">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="1058">
          <span class="hits">1</span>
          
          <code class="ruby">  def move_ilo(ilo, new_num)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1059">
          
          
          <code class="ruby">    if ilo.ilo_number &lt; new_num</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1060">
          
          
          <code class="ruby">      logger.debug &quot;Moving ILOs up #{ilo.ilo_number} to #{new_num}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1061">
          
          
          <code class="ruby">      learning_outcomes.where(&quot;ilo_number &gt; #{ilo.ilo_number} and ilo_number &lt;= #{new_num}&quot;).find_each { |ilo| ilo.ilo_number -= 1; ilo.save }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1062">
          
          
          <code class="ruby">    elsif ilo.ilo_number &gt; new_num</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1063">
          
          
          <code class="ruby">      learning_outcomes.where(&quot;ilo_number &lt; #{ilo.ilo_number} and ilo_number &gt;= #{new_num}&quot;).find_each { |ilo| ilo.ilo_number += 1; ilo.save }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1064">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1065">
          
          
          <code class="ruby">    ilo.ilo_number = new_num</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1066">
          
          
          <code class="ruby">    ilo.save</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1067">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1068">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1069">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1070">
          
          
          <code class="ruby">  # Get all of the related tasks</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1071">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="1072">
          <span class="hits">1</span>
          
          <code class="ruby">  def tasks_for_definition(task_def)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1073">
          
          
          <code class="ruby">    tasks.where(task_definition_id: task_def.id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1074">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1075">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1076">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1077">
          
          
          <code class="ruby">  # Update the student&#39;s max_pct_similar for all of their tasks</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1078">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="1079">
          <span class="hits">1</span>
          
          <code class="ruby">  def update_student_max_pct_similar</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1080">
          
          
          <code class="ruby">    # TODO: Remove once max_pct_similar is deleted</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1081">
          
          
          <code class="ruby">    # projects.each do | p |</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1082">
          
          
          <code class="ruby">    #   p.max_pct_similar = p.tasks.maximum(:max_pct_similar)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1083">
          
          
          <code class="ruby">    #   p.save</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1084">
          
          
          <code class="ruby">    # end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1085">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1086">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="1087">
          <span class="hits">1</span>
          
          <code class="ruby">  def create_plagiarism_link(t1, t2, match)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1088">
          
          
          <code class="ruby">    plk1 = PlagiarismMatchLink.where(task_id: t1.id, other_task_id: t2.id).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1089">
          
          
          <code class="ruby">    plk2 = PlagiarismMatchLink.where(task_id: t2.id, other_task_id: t1.id).first</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1090">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1091">
          
          
          <code class="ruby">    if plk1.nil? || plk2.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1092">
          
          
          <code class="ruby">      # Delete old links between tasks</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1093">
          
          
          <code class="ruby">      plk1.destroy unless plk1.nil? ## will delete its pair</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1094">
          
          
          <code class="ruby">      plk2.destroy unless plk2.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1095">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1096">
          
          
          <code class="ruby">      plk1 = PlagiarismMatchLink.create do |plm|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1097">
          
          
          <code class="ruby">        plm.task = t1</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1098">
          
          
          <code class="ruby">        plm.other_task = t2</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1099">
          
          
          <code class="ruby">        plm.dismissed = false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1100">
          
          
          <code class="ruby">        plm.pct = match[0][:pct]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1101">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1102">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1103">
          
          
          <code class="ruby">      plk2 = PlagiarismMatchLink.create do |plm|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1104">
          
          
          <code class="ruby">        plm.task = t2</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1105">
          
          
          <code class="ruby">        plm.other_task = t1</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1106">
          
          
          <code class="ruby">        plm.dismissed = false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1107">
          
          
          <code class="ruby">        plm.pct = match[1][:pct]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1108">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1109">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1110">
          
          
          <code class="ruby">      # puts &quot;#{plk1.pct} != #{match[0][:pct]}, #{plk1.pct != match[0][:pct]}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1111">
          
          
          <code class="ruby">      # puts &quot;#{plk1.dismissed}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1112">
          
          
          <code class="ruby">      plk1.dismissed = false unless plk1.pct == match[0][:pct]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1113">
          
          
          <code class="ruby">      plk2.dismissed = false unless plk2.pct == match[1][:pct]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1114">
          
          
          <code class="ruby">      # puts &quot;#{plk1.dismissed}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1115">
          
          
          <code class="ruby">      plk1.pct = match[0][:pct]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1116">
          
          
          <code class="ruby">      plk2.pct = match[1][:pct]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1117">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1118">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1119">
          
          
          <code class="ruby">    plk1.plagiarism_report_url = match[0][:url]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1120">
          
          
          <code class="ruby">    plk2.plagiarism_report_url = match[1][:url]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1121">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1122">
          
          
          <code class="ruby">    plk1.save!</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1123">
          
          
          <code class="ruby">    plk2.save!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1124">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1125">
          
          
          <code class="ruby">    FileHelper.save_plagiarism_html(plk1, match[0][:html])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1126">
          
          
          <code class="ruby">    FileHelper.save_plagiarism_html(plk2, match[1][:html])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1127">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1128">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="1129">
          <span class="hits">1</span>
          
          <code class="ruby">  def update_plagiarism_stats</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1130">
          
          
          <code class="ruby">    moss_key = Doubtfire::Application.secrets.secret_key_moss</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1131">
          
          
          <code class="ruby">    raise &quot;No moss key set. Check ENV[&#39;DF_SECRET_KEY_MOSS&#39;] first.&quot; if moss_key.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1132">
          
          
          <code class="ruby">    moss = MossRuby.new(moss_key)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1133">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1134">
          
          
          <code class="ruby">    task_definitions.where(plagiarism_updated: true).find_each do |td|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1135">
          
          
          <code class="ruby">      td.plagiarism_updated = false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1136">
          
          
          <code class="ruby">      td.save</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1137">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1138">
          
          
          <code class="ruby">      # Get results</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1139">
          
          
          <code class="ruby">      url = td.plagiarism_report_url</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1140">
          
          
          <code class="ruby">      logger.debug &quot;Processing MOSS results #{url}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1141">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1142">
          
          
          <code class="ruby">      warn_pct = td.plagiarism_warn_pct</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1143">
          
          
          <code class="ruby">      warn_pct = 50 if warn_pct.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1144">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1145">
          
          
          <code class="ruby">      results = moss.extract_results(url, warn_pct, -&gt;(line) { puts line })</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1146">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1147">
          
          
          <code class="ruby">      # Use results</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1148">
          
          
          <code class="ruby">      results.each do |match|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1149">
          
          
          <code class="ruby">        next if match[0][:pct] &lt; warn_pct &amp;&amp; match[1][:pct] &lt; warn_pct</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1150">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1151">
          
          
          <code class="ruby">        task_id_1 = /.*\/(\d+)\/$/.match(match[0][:filename])[1]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1152">
          
          
          <code class="ruby">        task_id_2 = /.*\/(\d+)\/$/.match(match[1][:filename])[1]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1153">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1154">
          
          
          <code class="ruby">        t1 = Task.find(task_id_1)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1155">
          
          
          <code class="ruby">        t2 = Task.find(task_id_2)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1156">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1157">
          
          
          <code class="ruby">        if t1.nil? || t2.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1158">
          
          
          <code class="ruby">          logger.error &quot;Could not find tasks #{task_id_1} or #{task_id_2} for plagiarism stats check!&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1159">
          
          
          <code class="ruby">          next</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1160">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1161">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1162">
          
          
          <code class="ruby">        if td.group_set # its a group task</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1163">
          
          
          <code class="ruby">          g1_tasks = t1.group_submission.tasks</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1164">
          
          
          <code class="ruby">          g2_tasks = t2.group_submission.tasks</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1165">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1166">
          
          
          <code class="ruby">          g1_tasks.each do |gt1|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1167">
          
          
          <code class="ruby">            g2_tasks.each do |gt2|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1168">
          
          
          <code class="ruby">              create_plagiarism_link(gt1, gt2, match)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1169">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1170">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1171">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1172">
          
          
          <code class="ruby">        else # just link the individuals...</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1173">
          
          
          <code class="ruby">          create_plagiarism_link(t1, t2, match)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1174">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1175">
          
          
          <code class="ruby">      end # end of each result</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1176">
          
          
          <code class="ruby">    end # for each task definition where it needs to be updated</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1177">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1178">
          
          
          <code class="ruby">    # TODO: Remove once max_pct_similar is deleted</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1179">
          
          
          <code class="ruby">    # update_student_max_pct_similar()</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1180">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1181">
          
          
          <code class="ruby">    self.last_plagarism_scan = Time.zone.now</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1182">
          
          
          <code class="ruby">    save!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1183">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1184">
          
          
          <code class="ruby">    self</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1185">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1186">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1187">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1188">
          
          
          <code class="ruby">  # Extract all done files related to a task definition matching a pattern into a given directory.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1189">
          
          
          <code class="ruby">  # Returns an array of files</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1190">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="1191">
          <span class="hits">1</span>
          
          <code class="ruby">  def add_done_files_for_plagiarism_check_of(td, tmp_path, force, to_check)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1192">
          
          
          <code class="ruby">    tasks = tasks_for_definition(td)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1193">
          
          
          <code class="ruby">    tasks_with_files = td.related_tasks_with_files</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1194">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1195">
          
          
          <code class="ruby">    # check number of files, and they are new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1196">
          
          
          <code class="ruby">    if tasks_with_files.count &gt; 1 &amp;&amp; (tasks.where(&#39;tasks.file_uploaded_at &gt; ?&#39;, last_plagarism_scan).select(&amp;:has_pdf).count &gt; 0 || td.updated_at &gt; last_plagarism_scan || force)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1197">
          
          
          <code class="ruby">      td.plagiarism_checks.each do |check|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1198">
          
          
          <code class="ruby">        next if check[&#39;type&#39;].nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1199">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1200">
          
          
          <code class="ruby">        type_data = check[&#39;type&#39;].split(&#39; &#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1201">
          
          
          <code class="ruby">        next if type_data.nil? || (type_data.length != 2) || (type_data[0] != &#39;moss&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1202">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1203">
          
          
          <code class="ruby">        # extract files matching each pattern</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1204">
          
          
          <code class="ruby">        # -- each pattern</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1205">
          
          
          <code class="ruby">        check[&#39;pattern&#39;].split(&#39;|&#39;).each do |pattern|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1206">
          
          
          <code class="ruby">          tasks_with_files.each do |t|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1207">
          
          
          <code class="ruby">            t.extract_file_from_done(tmp_path, pattern, -&gt;(_task, to_path, name) { File.join(to_path.to_s, t.student.username.to_s, name.to_s) })</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1208">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1209">
          
          
          <code class="ruby">          MossRuby.add_file(to_check, &quot;**/#{pattern}&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1210">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1211">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1212">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1213">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1214">
          
          
          <code class="ruby">    self</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1215">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1216">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1217">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1218">
          
          
          <code class="ruby">  # Pass tasks on to plagarism detection software and setup links between students</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1219">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="1220">
          <span class="hits">1</span>
          
          <code class="ruby">  def check_plagiarism(force = false)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1221">
          
          
          <code class="ruby">    # Get each task...</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1222">
          
          
          <code class="ruby">    return unless active</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1223">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1224">
          
          
          <code class="ruby">    # need pwd to restore after cding into submission folder (so the files do not have full path)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1225">
          
          
          <code class="ruby">    pwd = FileUtils.pwd</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1226">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1227">
          
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1228">
          
          
          <code class="ruby">      logger.info &quot;Checking plagiarsm for unit #{code} - #{name} (id=#{id})&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1229">
          
          
          <code class="ruby">      task_definitions.each do |td|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1230">
          
          
          <code class="ruby">        next if td.plagiarism_checks.empty?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1231">
          
          
          <code class="ruby">        # Is there anything to check?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1232">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1233">
          
          
          <code class="ruby">        logger.debug &quot;Checking plagiarism for #{td.name} (id=#{td.id})&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1234">
          
          
          <code class="ruby">        tasks = tasks_for_definition(td)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1235">
          
          
          <code class="ruby">        tasks_with_files = tasks.select(&amp;:has_pdf)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1236">
          
          
          <code class="ruby">        next unless tasks_with_files.count &gt; 1 &amp;&amp; (tasks.where(&#39;tasks.file_uploaded_at &gt; ?&#39;, last_plagarism_scan).select(&amp;:has_pdf).count &gt; 0 || td.updated_at &gt; last_plagarism_scan || force)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1237">
          
          
          <code class="ruby">        # There are new tasks, check these</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1238">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1239">
          
          
          <code class="ruby">        logger.debug &#39;Contacting MOSS for new checks&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1240">
          
          
          <code class="ruby">        td.plagiarism_checks.each do |check|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1241">
          
          
          <code class="ruby">          next if check[&#39;type&#39;].nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1242">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1243">
          
          
          <code class="ruby">          type_data = check[&#39;type&#39;].split(&#39; &#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1244">
          
          
          <code class="ruby">          next if type_data.nil? || (type_data.length != 2) || (type_data[0] != &#39;moss&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1245">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1246">
          
          
          <code class="ruby">          # Create the MossRuby object</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1247">
          
          
          <code class="ruby">          moss_key = Doubtfire::Application.secrets.secret_key_moss</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1248">
          
          
          <code class="ruby">          raise &quot;No moss key set. Check ENV[&#39;DF_SECRET_KEY_MOSS&#39;] first.&quot; if moss_key.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1249">
          
          
          <code class="ruby">          moss = MossRuby.new(moss_key)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1250">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1251">
          
          
          <code class="ruby">          # Set options  -- the options will already have these default values</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1252">
          
          
          <code class="ruby">          moss.options[:max_matches] = 7</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1253">
          
          
          <code class="ruby">          moss.options[:directory_submission] = true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1254">
          
          
          <code class="ruby">          moss.options[:show_num_matches] = 500</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1255">
          
          
          <code class="ruby">          moss.options[:experimental_server] = false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1256">
          
          
          <code class="ruby">          moss.options[:comment] = &#39;&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1257">
          
          
          <code class="ruby">          moss.options[:language] = type_data[1]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1258">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1259">
          
          
          <code class="ruby">          tmp_path = File.join(Dir.tmpdir, &#39;doubtfire&#39;, &quot;check-#{id}-#{td.id}&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1260">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1261">
          
          
          <code class="ruby">          begin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1262">
          
          
          <code class="ruby">            # Create a file hash, with the files to be processed</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1263">
          
          
          <code class="ruby">            to_check = MossRuby.empty_file_hash</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1264">
          
          
          <code class="ruby">            add_done_files_for_plagiarism_check_of(td, tmp_path, force, to_check)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1265">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1266">
          
          
          <code class="ruby">            FileUtils.chdir(tmp_path)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1267">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1268">
          
          
          <code class="ruby">            # Get server to process files</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1269">
          
          
          <code class="ruby">            logger.debug &#39;Sending to MOSS...&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1270">
          
          
          <code class="ruby">            url = moss.check(to_check, -&gt;(line) { puts line })</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1271">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1272">
          
          
          <code class="ruby">            logger.info &quot;MOSS check for #{code} #{td.abbreviation} url: #{url}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1273">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1274">
          
          
          <code class="ruby">            td.plagiarism_report_url = url</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1275">
          
          
          <code class="ruby">            td.plagiarism_updated = true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1276">
          
          
          <code class="ruby">            td.save</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1277">
          
          
          <code class="ruby">          rescue =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1278">
          
          
          <code class="ruby">            logger.error &quot;Failed to check plagiarism for task #{td.name} (id=#{td.id}). Error: #{e.message}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1279">
          
          
          <code class="ruby">          ensure</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1280">
          
          
          <code class="ruby">            FileUtils.chdir(pwd)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1281">
          
          
          <code class="ruby">            FileUtils.rm_rf tmp_path</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1282">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1283">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1284">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1285">
          
          
          <code class="ruby">      self.last_plagarism_scan = Time.zone.now</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1286">
          
          
          <code class="ruby">      save!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1287">
          
          
          <code class="ruby">    ensure</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1288">
          
          
          <code class="ruby">      FileUtils.chdir(pwd) if FileUtils.pwd != pwd</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1289">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1290">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1291">
          
          
          <code class="ruby">    self</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1292">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1293">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="1294">
          <span class="hits">1</span>
          
          <code class="ruby">  def import_task_files_from_zip(zip_file)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1295">
          
          
          <code class="ruby">    task_path = FileHelper.task_file_dir_for_unit self, create = true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1296">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1297">
          
          
          <code class="ruby">    result = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1298">
          
          
          <code class="ruby">      success: [],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1299">
          
          
          <code class="ruby">      errors: [],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1300">
          
          
          <code class="ruby">      ignored: []</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1301">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1302">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1303">
          
          
          <code class="ruby">    Zip::File.open(zip_file) do |zip|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1304">
          
          
          <code class="ruby">      zip.each do |file|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1305">
          
          
          <code class="ruby">        next unless file.file? # Skip folders</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1306">
          
          
          <code class="ruby">        file_name = File.basename(file.name)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1307">
          
          
          <code class="ruby">        if (File.extname(file.name) == &#39;.pdf&#39;) || (File.extname(file.name) == &#39;.zip&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1308">
          
          
          <code class="ruby">          found = false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1309">
          
          
          <code class="ruby">          task_definitions.each do |td|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1310">
          
          
          <code class="ruby">            next unless /^#{td.abbreviation}/ =~ file_name</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1311">
          
          
          <code class="ruby">            file.extract (&quot;#{task_path}#{FileHelper.sanitized_filename(td.abbreviation)}#{File.extname(file.name)}&quot;) { true }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1312">
          
          
          <code class="ruby">            result[:success] &lt;&lt; { row: file.name, message: &quot;Added as task #{td.abbreviation}&quot; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1313">
          
          
          <code class="ruby">            found = true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1314">
          
          
          <code class="ruby">            break</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1315">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1316">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1317">
          
          
          <code class="ruby">          unless found</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1318">
          
          
          <code class="ruby">            result[:errors] &lt;&lt; { row: file.name, message: &#39;Unable to find a task with matching abbreviation.&#39; }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1319">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1320">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1321">
          
          
          <code class="ruby">          result[:ignored] &lt;&lt; { row: file.name, message: &#39;Unknown file type.&#39; }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1322">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1323">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1324">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1325">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1326">
          
          
          <code class="ruby">    result</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1327">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1328">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1329">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1330">
          
          
          <code class="ruby">  # Returns the task ids provided mapped to the number of unresolved</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1331">
          
          
          <code class="ruby">  # plagiarism detections</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1332">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="1333">
          <span class="hits">1</span>
          
          <code class="ruby">  def map_task_ids_to_similarity_count(task_ids)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1334">
          
          
          <code class="ruby">    PlagiarismMatchLink.where(&#39;task_id IN (?)&#39;, task_ids)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1335">
          
          
          <code class="ruby">                       .where(dismissed: false)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1336">
          
          
          <code class="ruby">                       .group(:task_id)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="1337">
          <span class="hits">2</span>
          
          <code class="ruby">                       .count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1338">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1339">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1340">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1341">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="1342">
          <span class="hits">1</span>
          
          <code class="ruby">  def tasks_as_hash(data)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="1343">
          <span class="hits">2</span>
          
          <code class="ruby">    task_ids = data.map(&amp;:task_id).uniq</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="1344">
          <span class="hits">2</span>
          
          <code class="ruby">    plagiarism_counts = map_task_ids_to_similarity_count(task_ids)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="1345">
          <span class="hits">2</span>
          
          <code class="ruby">    data.map do |t|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1346">
          
          
          <code class="ruby">      {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1347">
          
          
          <code class="ruby">        id: t.task_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1348">
          
          
          <code class="ruby">        project_id: t.project_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1349">
          
          
          <code class="ruby">        task_definition_id: t.task_definition_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1350">
          
          
          <code class="ruby">        tutorial_id: t.tutorial_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1351">
          
          
          <code class="ruby">        status: TaskStatus.find(t.status_id).status_key,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1352">
          
          
          <code class="ruby">        completion_date: t.completion_date,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1353">
          
          
          <code class="ruby">        submission_date: t.submission_date,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1354">
          
          
          <code class="ruby">        times_assessed: t.times_assessed,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1355">
          
          
          <code class="ruby">        grade: t.grade,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1356">
          
          
          <code class="ruby">        quality_pts: t.quality_pts,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1357">
          
          
          <code class="ruby">        num_new_comments: t.number_unread,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1358">
          
          
          <code class="ruby">        similar_to_count: plagiarism_counts[t.task_id]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1359">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1360">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1361">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1362">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1363">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1364">
          
          
          <code class="ruby">  # Return all tasks from the database for this unit and given user</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1365">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="1366">
          <span class="hits">1</span>
          
          <code class="ruby">  def get_all_tasks_for(user)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1367">
          
          
          <code class="ruby">    student_tasks</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1368">
          
          
          <code class="ruby">      .joins(:task_status)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1369">
          
          
          <code class="ruby">      .joins(&quot;LEFT JOIN task_comments ON task_comments.task_id = tasks.id&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1370">
          
          
          <code class="ruby">      .joins(&quot;LEFT JOIN comments_read_receipts crr ON crr.task_comment_id = task_comments.id AND crr.user_id = #{user.id}&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1371">
          
          
          <code class="ruby">      .select(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1372">
          
          
          <code class="ruby">        &#39;tasks.id&#39;, &#39;SUM(case when crr.user_id is null AND NOT task_comments.id is null then 1 else 0 end) as number_unread&#39;, &#39;project_id&#39;, &#39;tasks.id as task_id&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1373">
          
          
          <code class="ruby">        &#39;task_definition_id&#39;, &#39;task_definitions.start_date as start_date&#39;, &#39;projects.tutorial_id as tutorial_id&#39;, &#39;task_statuses.id as status_id&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1374">
          
          
          <code class="ruby">        &#39;completion_date&#39;, &#39;times_assessed&#39;, &#39;submission_date&#39;, &#39;portfolio_evidence&#39;, &#39;tasks.grade as grade&#39;, &#39;quality_pts&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1375">
          
          
          <code class="ruby">      )</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="1376">
          <span class="hits">4</span>
          
          <code class="ruby">      .group(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1377">
          
          
          <code class="ruby">        &#39;task_statuses.id&#39;, &#39;project_id&#39;, &#39;tutorial_id&#39;, &#39;tasks.id&#39;, &#39;task_definition_id&#39;, &#39;task_definitions.start_date&#39;, &#39;status_id&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1378">
          
          
          <code class="ruby">        &#39;completion_date&#39;, &#39;times_assessed&#39;, &#39;submission_date&#39;, &#39;portfolio_evidence&#39;, &#39;grade&#39;, &#39;quality_pts&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1379">
          
          
          <code class="ruby">      )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1380">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1381">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1382">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1383">
          
          
          <code class="ruby">  # Return the tasks that are waiting for feedback</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1384">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="1385">
          <span class="hits">1</span>
          
          <code class="ruby">  def tasks_awaiting_feedback(user)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1386">
          
          
          <code class="ruby">    get_all_tasks_for(user)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1387">
          
          
          <code class="ruby">      .where(&#39;task_statuses.id IN (:ids)&#39;, ids: [ TaskStatus.discuss, TaskStatus.redo, TaskStatus.demonstrate, TaskStatus.fix_and_resubmit ])</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="1388">
          <span class="hits">2</span>
          
          <code class="ruby">      .order(&#39;task_definition_id&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1389">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1390">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1391">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1392">
          
          
          <code class="ruby">  # Return the tasks that should be listed under a tutor&#39;s task inbox.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1393">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1394">
          
          
          <code class="ruby">  # Thses tasks are:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1395">
          
          
          <code class="ruby">  #   - those that have the ready for feedback (rtm) state, or</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1396">
          
          
          <code class="ruby">  #   - where new student comments are &gt; 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1397">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1398">
          
          
          <code class="ruby">  # They are sorted by a task&#39;s &quot;action_date&quot;. This defines the last</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1399">
          
          
          <code class="ruby">  # time a task has been &quot;actioned&quot;, either the submission date or latest</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1400">
          
          
          <code class="ruby">  # student comment -- whichever is newer.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1401">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="1402">
          <span class="hits">1</span>
          
          <code class="ruby">  def tasks_for_task_inbox(user)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1403">
          
          
          <code class="ruby">    get_all_tasks_for(user)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1404">
          
          
          <code class="ruby">      .having(&#39;task_statuses.id IN (:ids) OR SUM(case when crr.user_id is null AND NOT task_comments.id is null then 1 else 0 end) &gt; 0&#39;, ids: [ TaskStatus.ready_to_mark, TaskStatus.need_help ])</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="1405">
          <span class="hits">2</span>
          
          <code class="ruby">      .order(&#39;submission_date ASC, MAX(task_comments.created_at) ASC, task_definition_id ASC&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1406">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1407">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1408">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1409">
          
          
          <code class="ruby">  # Return stats on the number of students in each status for each task / tutorial</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1410">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1411">
          
          
          <code class="ruby">  # Returns a map:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1412">
          
          
          <code class="ruby">  #   task_def_id =&gt; {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1413">
          
          
          <code class="ruby">  #     tutorial_id =&gt; [ { :status=&gt; :not_started, :num=&gt;1}, ... ],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1414">
          
          
          <code class="ruby">  #     tutorial_id =&gt; [ { :status=&gt; :not_started, :num=&gt;1}, ... ], ...</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1415">
          
          
          <code class="ruby">  #   },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1416">
          
          
          <code class="ruby">  #   task_def_id =&gt; { ... }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1417">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="1418">
          <span class="hits">1</span>
          
          <code class="ruby">  def task_status_stats</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1419">
          
          
          <code class="ruby">    data = student_tasks</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1420">
          
          
          <code class="ruby">           .joins(:task_status)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1421">
          
          
          <code class="ruby">           .select(&#39;projects.tutorial_id as tutorial_id&#39;, &#39;task_definition_id&#39;, &#39;task_statuses.id as status_id&#39;, &#39;COUNT(tasks.id) as num_tasks&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1422">
          
          
          <code class="ruby">           .where(&#39;task_status_id &gt; 1&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1423">
          
          
          <code class="ruby">           .group(&#39;projects.tutorial_id&#39;, &#39;tasks.task_definition_id&#39;, &#39;status_id&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1424">
          
          
          <code class="ruby">           .map do |r|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1425">
          
          
          <code class="ruby">      {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1426">
          
          
          <code class="ruby">        tutorial_id: r.tutorial_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1427">
          
          
          <code class="ruby">        task_definition_id: r.task_definition_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1428">
          
          
          <code class="ruby">        status: TaskStatus.find(r.status_id).status_key,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1429">
          
          
          <code class="ruby">        num: r.num_tasks</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1430">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1431">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1432">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1433">
          
          
          <code class="ruby">    # Calculate not started...</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1434">
          
          
          <code class="ruby">    tutorials.each do |t|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1435">
          
          
          <code class="ruby">      task_definitions.each do |td|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1436">
          
          
          <code class="ruby">        count = data.select { |r| r[:task_definition_id] == td.id &amp;&amp; r[:tutorial_id] == t.id }.map { |r| r[:num] }.inject(:+)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1437">
          
          
          <code class="ruby">        count = 0 unless count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1438">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1439">
          
          
          <code class="ruby">        num = t.projects.where(&#39;projects.enrolled = TRUE AND projects.target_grade &gt;= :grade&#39;, grade: td.target_grade).count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1440">
          
          
          <code class="ruby">        num = 0 unless num</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1441">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1442">
          
          
          <code class="ruby">        next unless num - count &gt; 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1443">
          
          
          <code class="ruby">        data &lt;&lt; {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1444">
          
          
          <code class="ruby">          tutorial_id: t.id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1445">
          
          
          <code class="ruby">          task_definition_id: td.id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1446">
          
          
          <code class="ruby">          status: :not_started,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1447">
          
          
          <code class="ruby">          num: num - count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1448">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1449">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1450">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1451">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1452">
          
          
          <code class="ruby">    result = {}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1453">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1454">
          
          
          <code class="ruby">    task_definitions.each do |td|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1455">
          
          
          <code class="ruby">      result[td.id] = {}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1456">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1457">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1458">
          
          
          <code class="ruby">    data.each do |e|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1459">
          
          
          <code class="ruby">      unless result[e[:task_definition_id]].key? e[:tutorial_id]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1460">
          
          
          <code class="ruby">        result[e[:task_definition_id] ] [e[:tutorial_id]] = []</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1461">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1462">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1463">
          
          
          <code class="ruby">      result[e[:task_definition_id]][e[:tutorial_id]] &lt;&lt; { status: e[:status], num: e[:num] }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1464">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1465">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1466">
          
          
          <code class="ruby">    result</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1467">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1468">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1469">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1470">
          
          
          <code class="ruby">  # Returns an array of { tutorial_id: id, grade: g, num: n } -- showing the number of students</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1471">
          
          
          <code class="ruby">  # aiming for a grade in this indicated unit.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1472">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="1473">
          <span class="hits">1</span>
          
          <code class="ruby">  def student_target_grade_stats</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1474">
          
          
          <code class="ruby">    data = active_projects.select(&#39;projects.tutorial_id, projects.target_grade, COUNT(projects.id) as num&#39;).group(&#39;projects.tutorial_id, projects.target_grade&#39;).order(&#39;projects.tutorial_id, projects.target_grade&#39;).map { |r| { tutorial_id: r.tutorial_id, grade: r.target_grade, num: r.num } }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1475">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1476">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1477">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1478">
          
          
          <code class="ruby">  # Returns only active units</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1479">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="1480">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.active_units</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1481">
          
          
          <code class="ruby">    Unit.where(active: true)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1482">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1483">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1484">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1485">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1486">
          
          
          <code class="ruby">  # Returns the basic data used in calculating the student task completion stats</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1487">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="1488">
          <span class="hits">1</span>
          
          <code class="ruby">  def _student_task_completion_data_base</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1489">
          
          
          <code class="ruby">    data = student_tasks</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1490">
          
          
          <code class="ruby">           .select(&#39;projects.tutorial_id as tutorial_id&#39;, &#39;projects.target_grade as target_grade&#39;, &#39;tasks.project_id&#39;, &#39;Count(tasks.id) as num&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1491">
          
          
          <code class="ruby">           .where(&#39;task_status_id = :complete&#39;, complete: TaskStatus.complete.id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1492">
          
          
          <code class="ruby">           .group(&#39;projects.tutorial_id&#39;, &#39;projects.target_grade&#39;, &#39;tasks.project_id&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1493">
          
          
          <code class="ruby">           .order(&#39;projects.tutorial_id&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1494">
          
          
          <code class="ruby">    data.map { |r| { tutorial_id: r.tutorial_id, grade: r.target_grade, project: r.project_id, num: r.num } }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1495">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1496">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="1497">
          <span class="hits">1</span>
          
          <code class="ruby">  def _calculate_task_completion_stats(data)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1498">
          
          
          <code class="ruby">    values = data.map { |r| r[:num] }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1499">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1500">
          
          
          <code class="ruby">    if values &amp;&amp; values.length &gt; 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1501">
          
          
          <code class="ruby">      values.sort!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1502">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1503">
          
          
          <code class="ruby">      median_value = if values.length.even?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1504">
          
          
          <code class="ruby">                       ((values[values.length / 2] + values[values.length / 2 - 1]) / 2.0).round(1)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1505">
          
          
          <code class="ruby">                     else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1506">
          
          
          <code class="ruby">                       values[values.length / 2]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1507">
          
          
          <code class="ruby">                     end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1508">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1509">
          
          
          <code class="ruby">      lower_value = values[values.length * 3 / 10]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1510">
          
          
          <code class="ruby">      upper_value = values[values.length * 8 / 10]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1511">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1512">
          
          
          <code class="ruby">      {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1513">
          
          
          <code class="ruby">        median: median_value,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1514">
          
          
          <code class="ruby">        lower: lower_value,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1515">
          
          
          <code class="ruby">        upper: upper_value,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1516">
          
          
          <code class="ruby">        min: values.first,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1517">
          
          
          <code class="ruby">        max: values.last</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1518">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1519">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1520">
          
          
          <code class="ruby">      {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1521">
          
          
          <code class="ruby">        median: 0,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1522">
          
          
          <code class="ruby">        lower: 0,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1523">
          
          
          <code class="ruby">        upper: 0,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1524">
          
          
          <code class="ruby">        min: 0,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1525">
          
          
          <code class="ruby">        max: 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1526">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1527">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1528">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1529">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1530">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1531">
          
          
          <code class="ruby">  # Returns a map with min, max, lower, upper, and median task completion data.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1532">
          
          
          <code class="ruby">  # i.e. how many tasks students have completed</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1533">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="1534">
          <span class="hits">1</span>
          
          <code class="ruby">  def student_task_completion_stats</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1535">
          
          
          <code class="ruby">    data = _student_task_completion_data_base</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1536">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1537">
          
          
          <code class="ruby">    puts data</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1538">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1539">
          
          
          <code class="ruby">    result = {}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1540">
          
          
          <code class="ruby">    result[:unit] = _calculate_task_completion_stats(data)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1541">
          
          
          <code class="ruby">    result[:tutorial] = {}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1542">
          
          
          <code class="ruby">    result[:grade] = {}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1543">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1544">
          
          
          <code class="ruby">    tutorials.each do |t|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1545">
          
          
          <code class="ruby">      result[:tutorial][t.id] = _calculate_task_completion_stats(data.select { |r| r[:tutorial_id] == t.id })</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1546">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1547">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1548">
          
          
          <code class="ruby">    for i in 0..3 do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1549">
          
          
          <code class="ruby">      result[:grade][i] = _calculate_task_completion_stats(data.select { |r| r[:grade] == i })</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1550">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1551">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1552">
          
          
          <code class="ruby">    result</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1553">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1554">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1555">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1556">
          
          
          <code class="ruby">  # Returns a result that maps tutorial_id -&gt; { student outcome map }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1557">
          
          
          <code class="ruby">  # Where the student outcome map contains each LO and its rating for that student (no student id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1558">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="1559">
          <span class="hits">1</span>
          
          <code class="ruby">  def student_ilo_progress_stats</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1560">
          
          
          <code class="ruby">    data = student_tasks</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1561">
          
          
          <code class="ruby">           .joins(task_definition: :learning_outcome_task_links)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1562">
          
          
          <code class="ruby">           .joins(:task_status)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1563">
          
          
          <code class="ruby">           .select(&#39;projects.tutorial_id, projects.id as project_id, task_statuses.id as status_id, task_definitions.target_grade, learning_outcome_task_links.learning_outcome_id, learning_outcome_task_links.rating, COUNT(tasks.id) as num&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1564">
          
          
          <code class="ruby">           .where(&#39;projects.started = TRUE AND learning_outcome_task_links.task_id is NULL&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1565">
          
          
          <code class="ruby">           .group(&#39;projects.tutorial_id, projects.id, task_statuses.id, task_definitions.target_grade, learning_outcome_task_links.learning_outcome_id, learning_outcome_task_links.rating&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1566">
          
          
          <code class="ruby">           .order(&#39;projects.tutorial_id, projects.id&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1567">
          
          
          <code class="ruby">           .map do |r|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1568">
          
          
          <code class="ruby">      {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1569">
          
          
          <code class="ruby">        project_id: r.project_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1570">
          
          
          <code class="ruby">        tutorial_id: r.tutorial_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1571">
          
          
          <code class="ruby">        learning_outcome_id: r.learning_outcome_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1572">
          
          
          <code class="ruby">        rating: r.rating,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1573">
          
          
          <code class="ruby">        grade: r.target_grade,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1574">
          
          
          <code class="ruby">        status: TaskStatus.find(r.status_id).status_key,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1575">
          
          
          <code class="ruby">        num: r.num</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1576">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1577">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1578">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1579">
          
          
          <code class="ruby">    grade_weight = { 0 =&gt; 1, 1 =&gt; 2, 2 =&gt; 4, 3 =&gt; 8 }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1580">
          
          
          <code class="ruby">    status_weight = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1581">
          
          
          <code class="ruby">      not_started:        0.0,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1582">
          
          
          <code class="ruby">      fail:               0.0,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1583">
          
          
          <code class="ruby">      working_on_it:      0.0,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1584">
          
          
          <code class="ruby">      need_help:          0.0,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1585">
          
          
          <code class="ruby">      redo:               0.1,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1586">
          
          
          <code class="ruby">      do_not_resubmit:    0.1,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1587">
          
          
          <code class="ruby">      fix_and_resubmit:   0.3,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1588">
          
          
          <code class="ruby">      ready_to_mark:      0.5,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1589">
          
          
          <code class="ruby">      discuss:            0.8,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1590">
          
          
          <code class="ruby">      demonstrate:        0.8,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1591">
          
          
          <code class="ruby">      complete:           1.0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1592">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1593">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1594">
          
          
          <code class="ruby">    result = {}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1595">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1596">
          
          
          <code class="ruby">    # order by tutorial and project...</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1597">
          
          
          <code class="ruby">    current = nil</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1598">
          
          
          <code class="ruby">    data.each do |e|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1599">
          
          
          <code class="ruby">      # chech for change in tutorial</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1600">
          
          
          <code class="ruby">      if current.nil? || e[:tutorial_id] != current[:tutorial_id]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1601">
          
          
          <code class="ruby">        # if there was a currentious element</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1602">
          
          
          <code class="ruby">        if current</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1603">
          
          
          <code class="ruby">          # add the project to the tutorial</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1604">
          
          
          <code class="ruby">          current[:tutorial] &lt;&lt; current[:project]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1605">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1606">
          
          
          <code class="ruby">          # add the tutorial to the results</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1607">
          
          
          <code class="ruby">          result[current[:tutorial_id]] = current[:tutorial]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1608">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1609">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1610">
          
          
          <code class="ruby">        current = { project_id: e[:project_id], tutorial_id: e[:tutorial_id], tutorial: [], project: { id: e[:project_id] } }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1611">
          
          
          <code class="ruby">      elsif e[:project_id] != current[:project_id] # check change of project</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1612">
          
          
          <code class="ruby">        # add the project to the tutorial</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1613">
          
          
          <code class="ruby">        current[:tutorial] &lt;&lt; current[:project]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1614">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1615">
          
          
          <code class="ruby">        # reset the</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1616">
          
          
          <code class="ruby">        current[:project_id] = e[:project_id]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1617">
          
          
          <code class="ruby">        current[:project] = { id: e[:project_id] }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1618">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1619">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1620">
          
          
          <code class="ruby">      old_val = 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1621">
          
          
          <code class="ruby">      if current[:project].key? e[:learning_outcome_id]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1622">
          
          
          <code class="ruby">        old_val = current[:project][e[:learning_outcome_id]]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1623">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1624">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1625">
          
          
          <code class="ruby">      current[:project][e[:learning_outcome_id]] = old_val +</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1626">
          
          
          <code class="ruby">                                                   e[:rating] * status_weight[e[:status]] * grade_weight[e[:grade]] * e[:num]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1627">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1628">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1629">
          
          
          <code class="ruby">    # Add last project/tutorial to results</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1630">
          
          
          <code class="ruby">    if current</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1631">
          
          
          <code class="ruby">      # add the project to the tutorial</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1632">
          
          
          <code class="ruby">      current[:tutorial] &lt;&lt; current[:project]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1633">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1634">
          
          
          <code class="ruby">      # add the tutorial to the results</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1635">
          
          
          <code class="ruby">      result[current[:tutorial_id]] = current[:tutorial]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1636">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1637">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1638">
          
          
          <code class="ruby">    result.each do |tutorial_id_key, array_of_ilo_scores|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1639">
          
          
          <code class="ruby">      result[tutorial_id_key] = array_of_ilo_scores.map do |map_scores|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1640">
          
          
          <code class="ruby">        map_scores.each { |ilo_id, score| map_scores[ilo_id] = score.round(1) }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1641">
          
          
          <code class="ruby">        map_scores</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1642">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1643">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1644">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1645">
          
          
          <code class="ruby">    result</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1646">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1647">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1648">
          
          
          <code class="ruby">  # Functions processes the ilo data to generate stats</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1649">
          
          
          <code class="ruby">  # Can be passed all details, or details for one tutorial.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="1650">
          <span class="hits">1</span>
          
          <code class="ruby">  def _ilo_progress_summary(data)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1651">
          
          
          <code class="ruby">    result = {}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1652">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1653">
          
          
          <code class="ruby">    learning_outcomes.each do |ilo|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1654">
          
          
          <code class="ruby">      if data.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1655">
          
          
          <code class="ruby">        lower_value = upper_value = median_value = min_value = max_value = 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1656">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1657">
          
          
          <code class="ruby">        values = data.map { |e| e.key?(ilo.id) ? e[ilo.id] : 0 }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1658">
          
          
          <code class="ruby">        values = values.sort</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1659">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1660">
          
          
          <code class="ruby">        median_value = if values.length.even?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1661">
          
          
          <code class="ruby">                         ((values[values.length / 2] + values[values.length / 2 - 1]) / 2.0).round(1)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1662">
          
          
          <code class="ruby">                       else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1663">
          
          
          <code class="ruby">                         values[values.length / 2]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1664">
          
          
          <code class="ruby">                       end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1665">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1666">
          
          
          <code class="ruby">        lower_value = values[values.length * 3 / 10]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1667">
          
          
          <code class="ruby">        upper_value = values[values.length * 8 / 10]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1668">
          
          
          <code class="ruby">        min_value = values.first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1669">
          
          
          <code class="ruby">        max_value = values.last</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1670">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1671">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1672">
          
          
          <code class="ruby">      result[ilo.id] = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1673">
          
          
          <code class="ruby">        median: median_value,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1674">
          
          
          <code class="ruby">        lower: lower_value,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1675">
          
          
          <code class="ruby">        upper: upper_value,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1676">
          
          
          <code class="ruby">        min: min_value,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1677">
          
          
          <code class="ruby">        max: max_value</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1678">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1679">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1680">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1681">
          
          
          <code class="ruby">    result</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1682">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1683">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1684">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1685">
          
          
          <code class="ruby">  # Returns the details of the ILO progress for students in the class.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1686">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="1687">
          <span class="hits">1</span>
          
          <code class="ruby">  def ilo_progress_class_details</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1688">
          
          
          <code class="ruby">    result = {}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1689">
          
          
          <code class="ruby">    data = student_ilo_progress_stats</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1690">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1691">
          
          
          <code class="ruby">    return {} if data.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1692">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1693">
          
          
          <code class="ruby">    tutorials.each do |tute|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1694">
          
          
          <code class="ruby">      result[tute.id] = _ilo_progress_summary(data[tute.id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1695">
          
          
          <code class="ruby">      # if data[tute.id]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1696">
          
          
          <code class="ruby">      #   result[tute.id][:students] = data[tute.id]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1697">
          
          
          <code class="ruby">      # else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1698">
          
          
          <code class="ruby">      #   result[tute.id][:students] = []</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1699">
          
          
          <code class="ruby">      # end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1700">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1701">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1702">
          
          
          <code class="ruby">    result[&#39;all&#39;] = _ilo_progress_summary(data.values.reduce(:+))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1703">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1704">
          
          
          <code class="ruby">    result</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1705">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1706">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="1707">
          <span class="hits">1</span>
          
          <code class="ruby">  def ilo_progress_class_stats</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1708">
          
          
          <code class="ruby">    temp = student_ilo_progress_stats.values</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1709">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1710">
          
          
          <code class="ruby">    return {} if temp.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1711">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1712">
          
          
          <code class="ruby">    data = temp.reduce(:+)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1713">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1714">
          
          
          <code class="ruby">    _ilo_progress_summary(data)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1715">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1716">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="1717">
          <span class="hits">1</span>
          
          <code class="ruby">  def student_grades_csv</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1718">
          
          
          <code class="ruby">    students_with_grades = active_projects.where(&#39;grade &gt; 0&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1719">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1720">
          
          
          <code class="ruby">    CSV.generate do |row|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1721">
          
          
          <code class="ruby">      row &lt;&lt; %w(unit_code username student_id grade rationale)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1722">
          
          
          <code class="ruby">      students_with_grades.each do |project|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1723">
          
          
          <code class="ruby">        row &lt;&lt; [project.unit.code, project.student.username, project.student.student_id, project.grade, project.grade_rationale]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1724">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1725">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1726">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1727">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1728">
          
          
          <code class="ruby">  # Used to calculate the number of assessment each tutor has performed</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="1729">
          <span class="hits">1</span>
          
          <code class="ruby">  def tutor_assessment_csv(options = {})</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1730">
          
          
          <code class="ruby">    CSV.generate(options) do |csv|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1731">
          
          
          <code class="ruby">      csv &lt;&lt; [</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1732">
          
          
          <code class="ruby">        &#39;Username&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1733">
          
          
          <code class="ruby">        &#39;Tutor Name&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1734">
          
          
          <code class="ruby">        &#39;Total Tasks Assessed&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1735">
          
          
          <code class="ruby">      ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1736">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1737">
          
          
          <code class="ruby">      tasks</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1738">
          
          
          <code class="ruby">        .joins(project: [ { tutorial: { unit_role: :user } } ])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1739">
          
          
          <code class="ruby">        .select(&#39;users.username&#39;, &#39;users.first_name&#39;, &#39;users.last_name&#39;, &#39;SUM(times_assessed) AS total&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1740">
          
          
          <code class="ruby">        .group(&#39;users.username&#39;, &#39;users.first_name&#39;, &#39;users.last_name&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1741">
          
          
          <code class="ruby">        .each do |r|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1742">
          
          
          <code class="ruby">          csv &lt;&lt; [ r.username, &quot;#{r.first_name} #{r.last_name}&quot;, r.total ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1743">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1744">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1745">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1746">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1747">
          
          
          <code class="ruby">  #----------------------------------------------------------------------------</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1748">
          
          
          <code class="ruby">  # Task updates from offline download/upload</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1749">
          
          
          <code class="ruby">  #----------------------------------------------------------------------------</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1750">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1751">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1752">
          
          
          <code class="ruby">  # Defines the csv headers for batch download</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1753">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="1754">
          <span class="hits">1</span>
          
          <code class="ruby">  def mark_csv_headers</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1755">
          
          
          <code class="ruby">    &quot;Username,Name,Tutorial,Task,Student&#39;s Last Comment,Your Last Comment,Status,New Grade,New Quality,Max Quality,New Comment&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1756">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1757">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="1758">
          <span class="hits">1</span>
          
          <code class="ruby">  def check_mark_csv_headers</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1759">
          
          
          <code class="ruby">    &#39;Username,Name,Tutorial,Task,Status,New Grade,New Quality,New Comment&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1760">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1761">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="1762">
          <span class="hits">1</span>
          
          <code class="ruby">  def readme_text</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1763">
          
          
          <code class="ruby">    path = Rails.root.join(&#39;public&#39;, &#39;resources&#39;, &#39;marking_package_readme.txt&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1764">
          
          
          <code class="ruby">    File.read path</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1765">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1766">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1767">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1768">
          
          
          <code class="ruby">  # Generates a download package of the given tasks</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1769">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="1770">
          <span class="hits">1</span>
          
          <code class="ruby">  def generate_batch_task_zip(user, tasks)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1771">
          
          
          <code class="ruby">    # Reject all tasks not for this unit...</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1772">
          
          
          <code class="ruby">    tasks = tasks.reject { |task| task.project.unit.id != id }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1773">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1774">
          
          
          <code class="ruby">    download_id = &quot;#{Time.new.strftime(&#39;%Y-%m-%d&#39;)}-#{code}-#{user.username}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1775">
          
          
          <code class="ruby">    filename = FileHelper.sanitized_filename(&quot;batch_ready_to_mark_#{user.username}.zip&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1776">
          
          
          <code class="ruby">    output_zip = Tempfile.new(filename)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1777">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1778">
          
          
          <code class="ruby">    # Create a new zip</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1779">
          
          
          <code class="ruby">    Zip::File.open(output_zip.path, Zip::File::CREATE) do |zip|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1780">
          
          
          <code class="ruby">      csv_str = mark_csv_headers</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1781">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1782">
          
          
          <code class="ruby">      # Add individual tasks...</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1783">
          
          
          <code class="ruby">      tasks.select { |t| t.group_submission.nil? }.each do |task|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1784">
          
          
          <code class="ruby">        # Skip tasks that do not yet have a PDF generated</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1785">
          
          
          <code class="ruby">        next if task.processing_pdf?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1786">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1787">
          
          
          <code class="ruby">        # Add to the template entry string</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1788">
          
          
          <code class="ruby">        student = task.project.student</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1789">
          
          
          <code class="ruby">        mark_col = if task.status == :need_help</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1790">
          
          
          <code class="ruby">                     &#39;need_help&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1791">
          
          
          <code class="ruby">                   else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1792">
          
          
          <code class="ruby">                     &#39;rtm&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1793">
          
          
          <code class="ruby">                   end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1794">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1795">
          
          
          <code class="ruby">        csv_str &lt;&lt; &quot;\n#{student.username.tr(&#39;,&#39;, &#39;_&#39;)},#{student.name.tr(&#39;,&#39;, &#39;_&#39;)},#{task.project.tutorial.abbreviation},#{task.task_definition.abbreviation.tr(&#39;,&#39;, &#39;_&#39;)},\&quot;#{task.last_comment_by(task.project.student).gsub(/&quot;/, &#39;&quot;&quot;&#39;)}\&quot;,\&quot;#{task.last_comment_by(user).gsub(/&quot;/, &#39;&quot;&quot;&#39;)}\&quot;,#{mark_col},,,#{task.task_definition.max_quality_pts},&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1796">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1797">
          
          
          <code class="ruby">        src_path = task.portfolio_evidence</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1798">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1799">
          
          
          <code class="ruby">        next if src_path.nil? || src_path.empty?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1800">
          
          
          <code class="ruby">        next unless File.exist? src_path</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1801">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1802">
          
          
          <code class="ruby">        # make dst path of &quot;&lt;student id&gt;/&lt;task abbrev&gt;.pdf&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1803">
          
          
          <code class="ruby">        dst_path = FileHelper.sanitized_path(task.project.student.username.to_s, &quot;#{task.task_definition.abbreviation}-#{task.id}&quot;) + &#39;.pdf&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1804">
          
          
          <code class="ruby">        # now copy it over</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1805">
          
          
          <code class="ruby">        zip.add(dst_path, src_path)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1806">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1807">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1808">
          
          
          <code class="ruby">      # Add group tasks...</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1809">
          
          
          <code class="ruby">      tasks.select(&amp;:group_submission).group_by(&amp;:group_submission) .each do |subm, tasks|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1810">
          
          
          <code class="ruby">        task = tasks.first</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1811">
          
          
          <code class="ruby">        # Skip tasks that do not yet have a PDF generated</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1812">
          
          
          <code class="ruby">        next if task.processing_pdf?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1813">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1814">
          
          
          <code class="ruby">        # Add to the template entry string</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1815">
          
          
          <code class="ruby">        grp = task.group</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1816">
          
          
          <code class="ruby">        next if grp.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1817">
          
          
          <code class="ruby">        csv_str &lt;&lt; &quot;\nGRP_#{grp.id}_#{subm.id},#{grp.name.tr(&#39;,&#39;, &#39;_&#39;)},#{grp.tutorial.abbreviation},#{task.task_definition.abbreviation.tr(&#39;,&#39;, &#39;_&#39;)},\&quot;#{task.last_comment_not_by(user).gsub(/&quot;/, &#39;&quot;&quot;&#39;)}\&quot;,\&quot;#{task.last_comment_by(user).gsub(/&quot;/, &#39;&quot;&quot;&#39;)}\&quot;,rtm,,#{task.task_definition.max_quality_pts},&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1818">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1819">
          
          
          <code class="ruby">        src_path = task.portfolio_evidence</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1820">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1821">
          
          
          <code class="ruby">        next if src_path.nil? || src_path.empty?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1822">
          
          
          <code class="ruby">        next unless File.exist? src_path</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1823">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1824">
          
          
          <code class="ruby">        # make dst path of &quot;&lt;student id&gt;/&lt;task abbrev&gt;.pdf&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1825">
          
          
          <code class="ruby">        dst_path = FileHelper.sanitized_path(grp.name.to_s, &quot;#{task.task_definition.abbreviation}-#{task.id}&quot;) + &#39;.pdf&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1826">
          
          
          <code class="ruby">        # now copy it over</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1827">
          
          
          <code class="ruby">        zip.add(dst_path, src_path)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1828">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1829">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1830">
          
          
          <code class="ruby">      # Add marking file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1831">
          
          
          <code class="ruby">      zip.get_output_stream(&#39;marks.csv&#39;) { |f| f.puts csv_str }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1832">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1833">
          
          
          <code class="ruby">      # Add readme file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1834">
          
          
          <code class="ruby">      zip.get_output_stream(&#39;readme.txt&#39;) { |f| f.puts readme_text }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1835">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1836">
          
          
          <code class="ruby">    output_zip</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1837">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1838">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1839">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1840">
          
          
          <code class="ruby">  # Update the tasks status from the csv and email students</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1841">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="1842">
          <span class="hits">1</span>
          
          <code class="ruby">  def update_task_status_from_csv(user, csv_str, success, _ignored, errors)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1843">
          
          
          <code class="ruby">    done = {}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1844">
          
          
          <code class="ruby">    # Remove \r -- causes issues with CSV parsing (assume windows \r\n format if present)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1845">
          
          
          <code class="ruby">    csv_str.encode!(&#39;UTF-8&#39;, &#39;binary&#39;, invalid: :replace, undef: :replace, replace: &#39;&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1846">
          
          
          <code class="ruby">    csv_str.tr!(&quot;\r&quot;, &quot;\n&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1847">
          
          
          <code class="ruby">    csv_str.gsub!(&quot;\n\n&quot;, &quot;\n&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1848">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1849">
          
          
          <code class="ruby">    valid_header = true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1850">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1851">
          
          
          <code class="ruby">    # read data from CSV</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1852">
          
          
          <code class="ruby">    CSV.parse(csv_str, headers: true, return_headers: true,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1853">
          
          
          <code class="ruby">                       header_converters: [-&gt;(body) { body.encode!(&#39;UTF-8&#39;, &#39;binary&#39;, invalid: :replace, undef: :replace, replace: &#39;&#39;).downcase unless body.nil? }],</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1854">
          
          
          <code class="ruby">                       converters: [-&gt;(body) { body.encode!(&#39;UTF-8&#39;, &#39;binary&#39;, invalid: :replace, undef: :replace, replace: &#39;&#39;) unless body.nil? }]).each do |task_entry|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1855">
          
          
          <code class="ruby">      group = nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1856">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1857">
          
          
          <code class="ruby">      # check the header row</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1858">
          
          
          <code class="ruby">      if task_entry.header_row?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1859">
          
          
          <code class="ruby">        # find these headers...</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1860">
          
          
          <code class="ruby">        check_mark_csv_headers.split(&#39;,&#39;).each do |expect_header|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1861">
          
          
          <code class="ruby">          expect_header.encode!(&#39;UTF-8&#39;, &#39;binary&#39;, invalid: :replace, undef: :replace, replace: &#39;&#39;).downcase!</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1862">
          
          
          <code class="ruby">          unless task_entry.to_hash.keys.include? expect_header</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1863">
          
          
          <code class="ruby">            errors &lt;&lt; { row: task_entry, message: &quot;Missing header &#39;#{expect_header}&#39;, ensure first row has header information.&quot; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1864">
          
          
          <code class="ruby">            return false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1865">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1866">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1867">
          
          
          <code class="ruby">        # go to the next row if the headers are ok</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1868">
          
          
          <code class="ruby">        next</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1869">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1870">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1871">
          
          
          <code class="ruby">      # Find the related task definition</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1872">
          
          
          <code class="ruby">      td = task_definitions.select { |td| td.abbreviation.tr(&#39;,&#39;, &#39;_&#39;) == task_entry[&#39;task&#39;] }.first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1873">
          
          
          <code class="ruby">      if td.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1874">
          
          
          <code class="ruby">        errors &lt;&lt; { row: task_entry, message: &quot;Unable to find task with abbreviation #{task_entry[&#39;task&#39;]}&quot; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1875">
          
          
          <code class="ruby">        next</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1876">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1877">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1878">
          
          
          <code class="ruby">      task = nil</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1879">
          
          
          <code class="ruby">      related_tasks = nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1880">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1881">
          
          
          <code class="ruby">      # get the task...</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1882">
          
          
          <code class="ruby">      if td.is_group_task?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1883">
          
          
          <code class="ruby">        unless task_entry[&#39;username&#39;] =~ /GRP_\d+_\d+/</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1884">
          
          
          <code class="ruby">          errors &lt;&lt; { row: task_entry, message: &#39;Group username is in the wrong format.&#39; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1885">
          
          
          <code class="ruby">          next</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1886">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1887">
          
          
          <code class="ruby">        # its a group submission... so find task from group submission</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1888">
          
          
          <code class="ruby">        group_details = /GRP_(\d+)_(\d+)/.match(task_entry[&#39;username&#39;])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1889">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1890">
          
          
          <code class="ruby">        subm = GroupSubmission.find_by(id: group_details[2].to_i)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1891">
          
          
          <code class="ruby">        if subm.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1892">
          
          
          <code class="ruby">          errors &lt;&lt; { row: task_entry, message: &#39;Unable to find original submission for group task.&#39; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1893">
          
          
          <code class="ruby">          next</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1894">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1895">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1896">
          
          
          <code class="ruby">        task = subm.submitter_task</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1897">
          
          
          <code class="ruby">        if task.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1898">
          
          
          <code class="ruby">          errors &lt;&lt; { row: task_entry, message: &#39;Unable to find original submission for group task.&#39; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1899">
          
          
          <code class="ruby">          next</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1900">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1901">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1902">
          
          
          <code class="ruby">        group = Group.find(group_details[1].to_i)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1903">
          
          
          <code class="ruby">        if group.id != task.group.id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1904">
          
          
          <code class="ruby">          errors &lt;&lt; { row: task_entry, message: &quot;Group mismatch (expected task #{td.abbreviation} to match #{task.group.name})&quot; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1905">
          
          
          <code class="ruby">          next</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1906">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1907">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1908">
          
          
          <code class="ruby">        related_tasks = subm.tasks</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1909">
          
          
          <code class="ruby">        owner_text = group.name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1910">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1911">
          
          
          <code class="ruby">        # its an individual task... so find from the project</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1912">
          
          
          <code class="ruby">        project = projects.joins(:user).where(&#39;users.username&#39; =&gt; task_entry[&#39;username&#39;]).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1913">
          
          
          <code class="ruby">        if project.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1914">
          
          
          <code class="ruby">          errors &lt;&lt; { row: task_entry, message: &#39;Unable to find student project for this task.&#39; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1915">
          
          
          <code class="ruby">          next</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1916">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1917">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1918">
          
          
          <code class="ruby">        task = project.task_for_task_definition(td)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1919">
          
          
          <code class="ruby">        if task.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1920">
          
          
          <code class="ruby">          errors &lt;&lt; { row: task_entry, message: &quot;Unable to find task for #{task_entry[&#39;task&#39;]} not found&quot; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1921">
          
          
          <code class="ruby">          next</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1922">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1923">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1924">
          
          
          <code class="ruby">        related_tasks = [ task ]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1925">
          
          
          <code class="ruby">        owner_text = project.user.name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1926">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1927">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1928">
          
          
          <code class="ruby">      unless AuthorisationHelpers.authorise? user, task, :put</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1929">
          
          
          <code class="ruby">        errors &lt;&lt; { row: task_entry, error: &#39;You do not have permission to assess this task.&#39; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1930">
          
          
          <code class="ruby">        next</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1931">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1932">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1933">
          
          
          <code class="ruby">      begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1934">
          
          
          <code class="ruby">        task.trigger_transition(trigger: task_entry[&#39;status&#39;], by_user: user, quality: task_entry[&#39;new quality&#39;].to_i) # saves task</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1935">
          
          
          <code class="ruby">        task.grade_task(task_entry[&#39;new grade&#39;]) # try to grade task if need be</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1936">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1937">
          
          
          <code class="ruby">        if !(task_entry[&#39;new comment&#39;].nil? || task_entry[&#39;new comment&#39;].empty?)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1938">
          
          
          <code class="ruby">          task.add_text_comment user, task_entry[&#39;new comment&#39;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1939">
          
          
          <code class="ruby">          success &lt;&lt; { row: task_entry, message: &quot;Updated task #{task.task_definition.abbreviation} for #{owner_text}&quot; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1940">
          
          
          <code class="ruby">          success &lt;&lt; { row: {}, message: &quot;Added comment to #{task.task_definition.abbreviation} for #{owner_text}&quot; }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1941">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1942">
          
          
          <code class="ruby">          success &lt;&lt; { row: task_entry, message: &quot;Updated task #{task.task_definition.abbreviation} for #{owner_text}&quot; }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1943">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1944">
          
          
          <code class="ruby">      rescue Exception =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1945">
          
          
          <code class="ruby">        errors &lt;&lt; { row: task_entry, message: e.message }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1946">
          
          
          <code class="ruby">        next</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1947">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1948">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1949">
          
          
          <code class="ruby">      related_tasks.each do |task|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1950">
          
          
          <code class="ruby">        # add to done projects for emailing</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1951">
          
          
          <code class="ruby">        done[task.project] = [] if done[task.project].nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1952">
          
          
          <code class="ruby">        done[task.project] &lt;&lt; task</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1953">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1954">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1955">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1956">
          
          
          <code class="ruby">    # send emails...</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1957">
          
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1958">
          
          
          <code class="ruby">      done.each do |project, tasks|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1959">
          
          
          <code class="ruby">        logger.info &quot;Checking feedback email for project #{project.id}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1960">
          
          
          <code class="ruby">        if project.student.receive_feedback_notifications</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1961">
          
          
          <code class="ruby">          logger.info &quot;Emailing feedback notification to #{project.student.name}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1962">
          
          
          <code class="ruby">          PortfolioEvidenceMailer.task_feedback_ready(project, tasks).deliver</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1963">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1964">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1965">
          
          
          <code class="ruby">    rescue =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1966">
          
          
          <code class="ruby">      logger.error &quot;Failed to send emails from feedback submission. Rescued with error: #{e.message}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1967">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1968">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1969">
          
          
          <code class="ruby">    true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1970">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1971">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1972">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1973">
          
          
          <code class="ruby">  # Uploads a batch package back into doubtfire</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1974">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="1975">
          <span class="hits">1</span>
          
          <code class="ruby">  def upload_batch_task_zip_or_csv(user, file)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1976">
          
          
          <code class="ruby">    success = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1977">
          
          
          <code class="ruby">    errors = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1978">
          
          
          <code class="ruby">    ignored = []</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1979">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1980">
          
          
          <code class="ruby">    type = mime_type(file.tempfile.path)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1981">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1982">
          
          
          <code class="ruby">    # check mime is correct before uploading</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1983">
          
          
          <code class="ruby">    accept = [&#39;text/&#39;, &#39;text/plain&#39;, &#39;text/csv&#39;, &#39;application/zip&#39;, &#39;multipart/x-gzip&#39;, &#39;multipart/x-zip&#39;, &#39;application/x-gzip&#39;, &#39;application/octet-stream&#39;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1984">
          
          
          <code class="ruby">    unless mime_in_list?(file.tempfile.path, accept)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1985">
          
          
          <code class="ruby">      errors &lt;&lt; { row: {}, message: &quot;File given is not a zip or csv file - detected #{type}&quot; }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1986">
          
          
          <code class="ruby">      return {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1987">
          
          
          <code class="ruby">        success:  success,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1988">
          
          
          <code class="ruby">        ignored:  ignored,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1989">
          
          
          <code class="ruby">        errors:   errors</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1990">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1991">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1992">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1993">
          
          
          <code class="ruby">    if type.start_with?(&#39;text/&#39;, &#39;text/plain&#39;, &#39;text/csv&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1994">
          
          
          <code class="ruby">      update_task_status_from_csv(user, File.open(file.tempfile.path).read, success, ignored, errors)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1995">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1996">
          
          
          <code class="ruby">      # files are extracted to a temp dir first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1997">
          
          
          <code class="ruby">      i = 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1998">
          
          
          <code class="ruby">      tmp_dir = File.join(Dir.tmpdir, &#39;doubtfire&#39;, &#39;batch&#39;, i.to_s)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1999">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2000">
          
          
          <code class="ruby">      while Dir.exist? tmp_dir</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2001">
          
          
          <code class="ruby">        i += 1</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2002">
          
          
          <code class="ruby">        tmp_dir = File.join(Dir.tmpdir, &#39;doubtfire&#39;, &#39;batch&#39;, i.to_s)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2003">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2004">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2005">
          
          
          <code class="ruby">      logger.debug &quot;Created temp directory for batch zip at #{tmp_dir}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2006">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2007">
          
          
          <code class="ruby">      FileUtils.mkdir_p(tmp_dir)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2008">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2009">
          
          
          <code class="ruby">      begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2010">
          
          
          <code class="ruby">        Zip::File.open(file.tempfile.path) do |zip|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2011">
          
          
          <code class="ruby">          # Find the marking file within the directory tree</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2012">
          
          
          <code class="ruby">          marking_file = zip.glob(&#39;**/marks.csv&#39;).first</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2013">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2014">
          
          
          <code class="ruby">          # No marking file found</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2015">
          
          
          <code class="ruby">          if marking_file.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2016">
          
          
          <code class="ruby">            errors &lt;&lt; { row: {}, message: &#39;No marks.csv contained in zip.&#39; }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2017">
          
          
          <code class="ruby">            return {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2018">
          
          
          <code class="ruby">              success:  success,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2019">
          
          
          <code class="ruby">              ignored:  ignored,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2020">
          
          
          <code class="ruby">              errors:   errors</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2021">
          
          
          <code class="ruby">            }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2022">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2023">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2024">
          
          
          <code class="ruby">          # Read the csv</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2025">
          
          
          <code class="ruby">          csv_str = marking_file.get_input_stream.read</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2026">
          
          
          <code class="ruby">          csv_str.encode!(&#39;UTF-8&#39;, &#39;binary&#39;, invalid: :replace, undef: :replace, replace: &#39;&#39;) unless csv_str.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2027">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2028">
          
          
          <code class="ruby">          # Update tasks and email students</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2029">
          
          
          <code class="ruby">          unless update_task_status_from_csv(user, csv_str, success, ignored, errors)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2030">
          
          
          <code class="ruby">            errors &lt;&lt; { row: {}, message: &#39;Aborting import as mark.csv was not processed successfully.&#39; }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2031">
          
          
          <code class="ruby">            return {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2032">
          
          
          <code class="ruby">              success:  success,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2033">
          
          
          <code class="ruby">              ignored:  ignored,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2034">
          
          
          <code class="ruby">              errors:   errors</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2035">
          
          
          <code class="ruby">            }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2036">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2037">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2038">
          
          
          <code class="ruby">          # read keys from CSV - to check that files exist in csv</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2039">
          
          
          <code class="ruby">          entry_data = CSV.parse(csv_str, headers: true,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2040">
          
          
          <code class="ruby">                                          header_converters: [-&gt;(i) { i.nil? ? &#39;&#39; : i }, :downcase],</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2041">
          
          
          <code class="ruby">                                          converters: [-&gt;(body) { body.encode!(&#39;UTF-8&#39;, &#39;binary&#39;, invalid: :replace, undef: :replace, replace: &#39;&#39;) unless body.nil? }])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2042">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2043">
          
          
          <code class="ruby">          # Copy over the updated/marked files to the file system</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2044">
          
          
          <code class="ruby">          zip.each do |file|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2045">
          
          
          <code class="ruby">            # Skip processing marking file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2046">
          
          
          <code class="ruby">            next if File.basename(file.name) == &#39;marks.csv&#39; || File.basename(file.name) == &#39;readme.txt&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2047">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2048">
          
          
          <code class="ruby">            # Test filename pattern</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2049">
          
          
          <code class="ruby">            if (/.*-\d+.pdf/i =~ File.basename(file.name)) != 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2050">
          
          
          <code class="ruby">              if file.name[-1] != &#39;/&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2051">
          
          
          <code class="ruby">                ignored &lt;&lt; { row: &quot;File #{file.name}&quot;, message: &#39;Does not appear to be a task PDF.&#39; }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2052">
          
          
          <code class="ruby">              end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2053">
          
          
          <code class="ruby">              next</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2054">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2055">
          
          
          <code class="ruby">            if (/\._.*/ =~ File.basename(file.name)) == 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2056">
          
          
          <code class="ruby">              ignored &lt;&lt; { row: &quot;File #{file.name}&quot;, message: &#39;Does not appear to be a task PDF.&#39; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2057">
          
          
          <code class="ruby">              next</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2058">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2059">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2060">
          
          
          <code class="ruby">            # Extract the id from the filename</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2061">
          
          
          <code class="ruby">            task_id_from_filename = File.basename(file.name, &#39;.pdf&#39;).split(&#39;-&#39;).last</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2062">
          
          
          <code class="ruby">            task = Task.find_by(id: task_id_from_filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2063">
          
          
          <code class="ruby">            if task.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2064">
          
          
          <code class="ruby">              ignored &lt;&lt; { row: &quot;File #{file.name}&quot;, message: &#39;Unable to find associated task.&#39; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2065">
          
          
          <code class="ruby">              next</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2066">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2067">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2068">
          
          
          <code class="ruby">            # Ensure that this task&#39;s id is inside entry_data</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2069">
          
          
          <code class="ruby">            task_entry = entry_data.select { |t| t[&#39;task&#39;] == task.task_definition.abbreviation.tr(&#39;,&#39;, &#39;_&#39;) &amp;&amp; t[&#39;username&#39;] == task.project.user.username }.first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2070">
          
          
          <code class="ruby">            if task_entry.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2071">
          
          
          <code class="ruby">              # error!({&quot;error&quot; =&gt; &quot;File #{file.name} has a mismatch of task id ##{task.id} (this task id does not exist in marks.csv)&quot;}, 403)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2072">
          
          
          <code class="ruby">              errors &lt;&lt; { row: &quot;File #{file.name}&quot;, message: &quot;Task id #{task.id} not in marks.csv&quot; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2073">
          
          
          <code class="ruby">              next</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2074">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2075">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2076">
          
          
          <code class="ruby">            if task.unit != self</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2077">
          
          
          <code class="ruby">              errors &lt;&lt; { row: &quot;File #{file.name}&quot;, message: &#39;This task does not relate to this unit.&#39; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2078">
          
          
          <code class="ruby">              next</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2079">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2080">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2081">
          
          
          <code class="ruby">            # Can the user assess this task?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2082">
          
          
          <code class="ruby">            unless AuthorisationHelpers.authorise? user, task, :put</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2083">
          
          
          <code class="ruby">              errors &lt;&lt; { row: &quot;File #{file.name}&quot;, error: &quot;You do not have permission to assess task with id #{task.id}&quot; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2084">
          
          
          <code class="ruby">              next</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2085">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2086">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2087">
          
          
          <code class="ruby">            # Read into the task&#39;s portfolio_evidence path the new file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2088">
          
          
          <code class="ruby">            tmp_file = File.join(tmp_dir, File.basename(file.name))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2089">
          
          
          <code class="ruby">            task.portfolio_evidence = task.final_pdf_path</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2090">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2091">
          
          
          <code class="ruby">            # get file out of zip... to tmp_file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2092">
          
          
          <code class="ruby">            file.extract(tmp_file) { true }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2093">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2094">
          
          
          <code class="ruby">            # copy tmp_file to dest</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2095">
          
          
          <code class="ruby">            if FileHelper.copy_pdf(tmp_file, task.portfolio_evidence)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2096">
          
          
          <code class="ruby">              if task.group.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2097">
          
          
          <code class="ruby">                success &lt;&lt; { row: &quot;File #{file.name}&quot;, message: &quot;Replace PDF of task #{task.task_definition.abbreviation} for #{task.student.name}&quot; }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2098">
          
          
          <code class="ruby">              else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2099">
          
          
          <code class="ruby">                success &lt;&lt; { row: &quot;File #{file.name}&quot;, message: &quot;Replace PDF of group task #{task.task_definition.abbreviation} for #{task.group.name}&quot; }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2100">
          
          
          <code class="ruby">              end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2101">
          
          
          <code class="ruby">              FileUtils.rm tmp_file</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2102">
          
          
          <code class="ruby">            else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2103">
          
          
          <code class="ruby">              errors &lt;&lt; { row: &quot;File #{file.name}&quot;, message: &#39;The file does not appear to be a valid PDF.&#39; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2104">
          
          
          <code class="ruby">              next</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2105">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2106">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2107">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2108">
          
          
          <code class="ruby">      rescue</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2109">
          
          
          <code class="ruby">        # FileUtils.cp(file.tempfile.path, Doubtfire::Application.config.student_work_dir)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2110">
          
          
          <code class="ruby">        raise</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2111">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2112">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2113">
          
          
          <code class="ruby">      # Remove the extract dir</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2114">
          
          
          <code class="ruby">      FileUtils.rm_rf tmp_dir</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2115">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2116">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2117">
          
          
          <code class="ruby">    {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2118">
          
          
          <code class="ruby">      success:  success,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2119">
          
          
          <code class="ruby">      ignored:  ignored,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2120">
          
          
          <code class="ruby">      errors:   errors</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2121">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2122">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2123">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2124">
          <span class="hits">1</span>
          
          <code class="ruby">  def send_weekly_status_emails(summary_stats)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2125">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2126">
          
          
          <code class="ruby">    summary_stats[:unit] = self</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2127">
          
          
          <code class="ruby">    summary_stats[:unit_week_comments] = comments.where(&quot;task_comments.created_at &gt; :start AND task_comments.created_at &lt; :end&quot;, start: summary_stats[:week_start], end: summary_stats[:week_end]).count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2128">
          
          
          <code class="ruby">    summary_stats[:unit_week_engagements] = task_engagements.where(&quot;task_engagements.engagement_time &gt; :start AND task_engagements.engagement_time &lt; :end&quot;, start: summary_stats[:week_start], end: summary_stats[:week_end]).count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2129">
          
          
          <code class="ruby">    summary_stats[:revert_count] = 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2130">
          
          
          <code class="ruby">    summary_stats[:revert] = {}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2131">
          
          
          <code class="ruby">    summary_stats[:staff] = {}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2132">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2133">
          
          
          <code class="ruby">    days_to_end_of_unit = (end_date.to_date - DateTime.now).to_i</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2134">
          
          
          <code class="ruby">    days_from_start_of_unit = (DateTime.now - start_date.to_date).to_i</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2135">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2136">
          
          
          <code class="ruby">    return if days_from_start_of_unit &lt; 4 || days_to_end_of_unit &lt; 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2137">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2138">
          
          
          <code class="ruby">    staff.each do |ur|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2139">
          
          
          <code class="ruby">      summary_stats[:revert][ur.user] = []</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2140">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2141">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2142">
          
          
          <code class="ruby">    active_projects.each do |project|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2143">
          
          
          <code class="ruby">      project.send_weekly_status_email(summary_stats, days_from_start_of_unit &gt; 28 &amp;&amp; days_to_end_of_unit &gt; 14 )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2144">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2145">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2146">
          
          
          <code class="ruby">    summary_stats[:num_students_without_tutors] = active_projects.where(tutorial_id: nil).count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2147">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2148">
          
          
          <code class="ruby">    staff.each do |ur|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2149">
          
          
          <code class="ruby">      ur.populate_summary_stats(summary_stats)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2150">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2151">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2152">
          
          
          <code class="ruby">    staff.each do |ur|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2153">
          
          
          <code class="ruby">      ur.send_weekly_status_email(summary_stats)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2154">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2155">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2156">
          
          
          <code class="ruby">    summary_stats[:staff] = {}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2157">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2158">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2159">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="444000ab681deec83bb0ef8354a59be67bb4d91a">
  <div class="header">
    <h3>app/models/unit_role.rb</h3>
    <h4><span class="red">42.65 %</span> covered</h4>
    <div>
      <b>68</b> relevant lines. 
      <span class="green"><b>29</b> lines covered</span> and
      <span class="red"><b>39</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class UnitRole &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby">  # Model associations</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :unit    # Foreign key</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :user    # Foreign key</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :role    # Foreign key</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :tutorials, class_name: &#39;Tutorial&#39;, dependent: :nullify</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :projects, through: :tutorials</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :tasks, through: :projects</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :task_engagements, through: :tasks</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :comments, through: :tasks</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :unit_id, presence: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :user_id, presence: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :role_id, presence: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :tutors,    -&gt; { joins(:role).where(&#39;roles.name = :role&#39;, role: &#39;Tutor&#39;) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :convenors, -&gt; { joins(:role).where(&#39;roles.name = :role&#39;, role: &#39;Convenor&#39;) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">  # scope :staff,     -&gt; { where(&#39;role_id != ?&#39;, 1) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.for_user(user)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">    UnitRole.joins(:role, :unit).where(&quot;user_id = :user_id and roles.name &lt;&gt; &#39;Student&#39;&quot;, user_id: user.id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">  # unit roles are now unique for users in units</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">  # TODO: check this usage</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">  def other_roles</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">    []</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">  def tasks_awaiting_feedback</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">    tasks.joins(:task_definition).where(&#39;projects.enrolled = TRUE AND projects.target_grade &gt;= task_definitions.target_grade AND tasks.task_status_id = :status&#39;, status: TaskStatus.ready_to_mark)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="36">
          <span class="hits">1</span>
          
          <code class="ruby">  def oldest_task_awaiting_feedback</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">    tasks_awaiting_feedback.order(&quot;submission_date ASC&quot;).first</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">  # Permissions around unit role data</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="43">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.permissions</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">    # What can students do with unit roles?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">    student_role_permissions = [</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">      :get</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">    ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">    # What can tutors do with unit roles?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="49">
          
          
          <code class="ruby">    tutor_role_permissions = [</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">      :get</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">    ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">    # What can convenors do with unit roles?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">    convenor_role_permissions = [</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">      :get,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">      :delete</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">    ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">    # What can nil users do with unit roles?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="58">
          
          
          <code class="ruby">    nil_role_permissions = [</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">    ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">    # Return permissions hash</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">    {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">      student: student_role_permissions,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">      tutor: tutor_role_permissions,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">      convenor: convenor_role_permissions,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">      nil: nil_role_permissions</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="68">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="71">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.tasks_to_review(user)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">    Tutorial.find_by_user(user)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">            .map(&amp;:projects)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">            .flatten</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">            .map(&amp;:tasks)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">            .flatten</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="77">
          
          
          <code class="ruby">            .select(&amp;:reviewable?)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="80">
          <span class="hits">1</span>
          
          <code class="ruby">  def role_for(user)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="81">
          
          
          <code class="ruby">    unit_role = unit.role_for(user)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="82">
          
          
          <code class="ruby">    unit_role = nil if unit_role == Role.student &amp;&amp; self.user != user</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="83">
          
          
          <code class="ruby">    unit_role</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="86">
          <span class="hits">1</span>
          
          <code class="ruby">  def is_tutor?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="87">
          
          
          <code class="ruby">    role == Role.tutor</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="90">
          <span class="hits">1</span>
          
          <code class="ruby">  def is_student?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="91">
          
          
          <code class="ruby">    role == Role.student</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="94">
          <span class="hits">1</span>
          
          <code class="ruby">  def is_convenor?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="95">
          
          
          <code class="ruby">    role == Role.convenor</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="98">
          <span class="hits">1</span>
          
          <code class="ruby">  def is_teacher?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="99">
          
          
          <code class="ruby">    is_tutor? || is_convenor?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="102">
          <span class="hits">1</span>
          
          <code class="ruby">  def has_students?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="103">
          
          
          <code class="ruby">    number_of_students &gt; 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="106">
          <span class="hits">1</span>
          
          <code class="ruby">  def number_of_students</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="107">
          
          
          <code class="ruby">    projects.where(enrolled: true).count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby">  # Add data to the summary stats about this staff member</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="113">
          <span class="hits">1</span>
          
          <code class="ruby">  def populate_summary_stats(summary_stats)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="115">
          
          
          <code class="ruby">    data = {}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="117">
          
          
          <code class="ruby">    data[:staff] = user</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="118">
          
          
          <code class="ruby">    data[:unit_role] = self</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="120">
          
          
          <code class="ruby">    data[:engagements] = task_engagements.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby">      where(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby">        &quot;task_engagements.engagement_time &gt;= :start AND task_engagements.engagement_time &lt; :end&quot;, </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby">        start: summary_stats[:week_start], end: summary_stats[:week_end])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="125">
          
          
          <code class="ruby">    data[:total_engagements_count] = task_engagements.count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="126">
          
          
          <code class="ruby">    data[:weekly_engagements_count] = data[:engagements].count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="128">
          
          
          <code class="ruby">    if tasks_awaiting_feedback.count &gt; 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="129">
          
          
          <code class="ruby">      data[:oldest_task_days] = (Time.zone.today - tasks_awaiting_feedback.order(&quot;submission_date ASC&quot;).first.submission_date.to_date).to_i</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="130">
          
          
          <code class="ruby">      data[:tasks_awaiting_feedback_count] = tasks_awaiting_feedback.count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="132">
          
          
          <code class="ruby">      data[:oldest_task_days] = 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="133">
          
          
          <code class="ruby">      data[:tasks_awaiting_feedback_count] = 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="134">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="135">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="136">
          
          
          <code class="ruby">    data[:number_of_students] = number_of_students</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="138">
          
          
          <code class="ruby">    data[:total_staff_engagements] = task_engagements.where(engagement: [TaskStatus.complete.name, TaskStatus.do_not_resubmit.name, TaskStatus.redo.name, TaskStatus.discuss.name, TaskStatus.demonstrate.name, TaskStatus.fail.name]).count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="139">
          
          
          <code class="ruby">    data[:staff_engagements] = data[:engagements].where(engagement: [TaskStatus.complete.name, TaskStatus.do_not_resubmit.name, TaskStatus.redo.name, TaskStatus.discuss.name, TaskStatus.demonstrate.name, TaskStatus.fail.name]).count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="140">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="141">
          
          
          <code class="ruby">    data[:received_comments] = comments.where(&quot;recipient_id = :staff_id AND task_comments.created_at &gt; :start&quot;, staff_id: data[:staff].id, start: Time.zone.today - 7.days).count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="142">
          
          
          <code class="ruby">    data[:sent_comments] = comments.where(&quot;task_comments.user_id = :staff_id AND task_comments.created_at &gt; :start&quot;, staff_id: data[:staff].id, start: Time.zone.today - 7.days).count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="143">
          
          
          <code class="ruby">    data[:total_comments] = comments.where(&quot;task_comments.user_id = :staff_id&quot;, staff_id: data[:staff].id).count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="144">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="145">
          
          
          <code class="ruby">    summary_stats[:staff][self] = data</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="146">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="147">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="148">
          <span class="hits">1</span>
          
          <code class="ruby">  def send_weekly_status_email(summary_stats)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="149">
          
          
          <code class="ruby">    return unless user.receive_feedback_notifications</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="150">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="151">
          
          
          <code class="ruby">    NotificationsMailer.weekly_staff_summary(self, summary_stats).deliver_now</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="152">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="153">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="0af27a24a8b4dd55e259899999667e2ffdd54cd9">
  <div class="header">
    <h3>app/models/user.rb</h3>
    <h4><span class="red">54.73 %</span> covered</h4>
    <div>
      <b>201</b> relevant lines. 
      <span class="green"><b>110</b> lines covered</span> and
      <span class="red"><b>91</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;bcrypt&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;authorisation_helpers&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">class User &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  include AuthenticationHelpers</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">  ###</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">  # Authentication</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">  ###</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">  # Auth token encryption settings</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">  attr_encrypted :auth_token,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">                 key: Doubtfire::Application.secrets.secret_key_attr,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">                 encode: true,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">                 attribute: &#39;authentication_token&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">  # User authentication config</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">  if AuthenticationHelpers.aaf_auth?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">    # Decodes a JWS against the JWT secret, returning JWT data or nil if no data</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">    # could be decoded</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">    def self.decode_jws(jws)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">      JSON::JWT.decode(jws.to_s, Doubtfire::Application.secrets.secret_key_aaf)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">    rescue</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">      nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">    # Validates a JSON web Signature against assertion rules. Returns false if</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">    # it could not be verified.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">    #</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">    def valid_jwt?(jws)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">      # 1. The signed JWT matches the JWT key</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">      jwt = User.decode_jws(jws)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">      return false if jwt.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">      # 2. The `aud` claim matches the application URL</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">      aud_ok = jwt[&#39;aud&#39;] == Doubtfire::Application.config.aaf[:audience_url]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">      # 3. The `iss` claim has the correct issuer URL</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">      iss_ok = jwt[&#39;iss&#39;] == Doubtfire::Application.config.aaf[:issuer_url]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">      # 4. The time MUST &gt;= nbf time and &lt; exp claim</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">      time_ok = Time.zone.now &gt;= Time.zone.at(jwt[&#39;nbf&#39;]) &amp;&amp;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">                Time.zone.now &lt;  Time.zone.at(jwt[&#39;exp&#39;])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">      # Assert all</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">      aud_ok &amp;&amp; iss_ok &amp;&amp; time_ok</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">  else</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="48">
          <span class="hits">1</span>
          
          <code class="ruby">    devise_keys = %i(registerable recoverable rememberable trackable validatable)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="49">
          <span class="hits">1</span>
          
          <code class="ruby">    strategy = AuthenticationHelpers.ldap_auth? ? :ldap_authenticatable : :database_authenticatable</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="50">
          <span class="hits">1</span>
          
          <code class="ruby">    devise strategy, *devise_keys</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">  # </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">  # We incorporate password details for local dev server - needed to keep devise happy</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="56">
          <span class="hits">1</span>
          
          <code class="ruby">  def password</code>
        </li>
      
        <li class="covered" data-hits="571" data-linenumber="57">
          <span class="hits">571</span>
          
          <code class="ruby">    &#39;password&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="60">
          <span class="hits">1</span>
          
          <code class="ruby">  def password_confirmation</code>
        </li>
      
        <li class="covered" data-hits="121" data-linenumber="61">
          <span class="hits">121</span>
          
          <code class="ruby">    &#39;password&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="64">
          <span class="hits">1</span>
          
          <code class="ruby">  def password= (value)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="65">
          <span class="hits">1</span>
          
          <code class="ruby">    self.encrypted_password = BCrypt::Password.create(value)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">  # Authenticates a user against a piece of data</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="71">
          <span class="hits">1</span>
          
          <code class="ruby">  def authenticate?(data)</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="72">
          <span class="hits">9</span>
          
          <code class="ruby">    if aaf_auth?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="73">
          
          
          <code class="ruby">      valid_jwt?(data)</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="74">
          <span class="hits">9</span>
          
          <code class="ruby">    elsif ldap_auth?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="75">
          
          
          <code class="ruby">      valid_ldap_authentication?(data)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="77">
          <span class="hits">9</span>
          
          <code class="ruby">      valid_password?(data)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">  # Extends an existing auth_token if needed</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="84">
          <span class="hits">1</span>
          
          <code class="ruby">  def extend_authentication_token(remember)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">    # Extending a nil token will just create one first</code>
        </li>
      
        <li class="covered" data-hits="91" data-linenumber="86">
          <span class="hits">91</span>
          
          <code class="ruby">    if auth_token.nil?</code>
        </li>
      
        <li class="covered" data-hits="37" data-linenumber="87">
          <span class="hits">37</span>
          
          <code class="ruby">      generate_authentication_token! false</code>
        </li>
      
        <li class="covered" data-hits="37" data-linenumber="88">
          <span class="hits">37</span>
          
          <code class="ruby">      return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby">    # Default expire time</code>
        </li>
      
        <li class="covered" data-hits="54" data-linenumber="92">
          <span class="hits">54</span>
          
          <code class="ruby">    expiry_time = Time.zone.now + 2.hours</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby">    # Extended expiry times only apply to students and convenors</code>
        </li>
      
        <li class="covered" data-hits="54" data-linenumber="95">
          <span class="hits">54</span>
          
          <code class="ruby">    if remember</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="96">
          <span class="hits">12</span>
          
          <code class="ruby">      student_expiry_time = Time.zone.now + 2.weeks</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="97">
          <span class="hits">12</span>
          
          <code class="ruby">      tutor_expiry_time = Time.zone.now + 1.week</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="98">
          <span class="hits">12</span>
          
          <code class="ruby">      expiry_time =</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby">        if role == Role.student || role == :student</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="100">
          
          
          <code class="ruby">          student_expiry_time</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby">        elsif role == Role.tutor || role == :tutor</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="102">
          
          
          <code class="ruby">          tutor_expiry_time</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="104">
          <span class="hits">12</span>
          
          <code class="ruby">          expiry_time</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="54" data-linenumber="108">
          <span class="hits">54</span>
          
          <code class="ruby">    self.auth_token_expiry = expiry_time</code>
        </li>
      
        <li class="covered" data-hits="54" data-linenumber="109">
          <span class="hits">54</span>
          
          <code class="ruby">    save</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby">  # Force-generates a new authentication token, regardless of whether or not</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby">  # it is actually expired</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="116">
          <span class="hits">1</span>
          
          <code class="ruby">  def generate_authentication_token!(remember)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby">    # Loop until new unique auth token is found</code>
        </li>
      
        <li class="covered" data-hits="42" data-linenumber="118">
          <span class="hits">42</span>
          
          <code class="ruby">    token = loop do</code>
        </li>
      
        <li class="covered" data-hits="42" data-linenumber="119">
          <span class="hits">42</span>
          
          <code class="ruby">      token = Devise.friendly_token</code>
        </li>
      
        <li class="covered" data-hits="42" data-linenumber="120">
          <span class="hits">42</span>
          
          <code class="ruby">      break token unless User.find_by_auth_token(token)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby">    # Set and return new auth token</code>
        </li>
      
        <li class="covered" data-hits="42" data-linenumber="123">
          <span class="hits">42</span>
          
          <code class="ruby">    self.auth_token = token</code>
        </li>
      
        <li class="covered" data-hits="42" data-linenumber="124">
          <span class="hits">42</span>
          
          <code class="ruby">    extend_authentication_token(remember)</code>
        </li>
      
        <li class="covered" data-hits="42" data-linenumber="125">
          <span class="hits">42</span>
          
          <code class="ruby">    save</code>
        </li>
      
        <li class="covered" data-hits="42" data-linenumber="126">
          <span class="hits">42</span>
          
          <code class="ruby">    token</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="128">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="129">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="130">
          
          
          <code class="ruby">  # Generate an authentication token that will expire in 30 seconds</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="132">
          <span class="hits">1</span>
          
          <code class="ruby">  def generate_temporary_authentication_token!</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="133">
          
          
          <code class="ruby">    generate_authentication_token!(false)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="134">
          
          
          <code class="ruby">    self.auth_token_expiry = Time.zone.now + 30.seconds</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="135">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="136">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="138">
          
          
          <code class="ruby">  # Deletes authentication token</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="139">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="140">
          <span class="hits">1</span>
          
          <code class="ruby">  def reset_authentication_token!</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="141">
          <span class="hits">1</span>
          
          <code class="ruby">    self.auth_token = nil</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="142">
          <span class="hits">1</span>
          
          <code class="ruby">    self.auth_token_expiry = Time.zone.now - 1.week</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="143">
          <span class="hits">1</span>
          
          <code class="ruby">    save</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="144">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="145">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="146">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="147">
          
          
          <code class="ruby">  # Returns whether the authentication token has expired</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="148">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="149">
          <span class="hits">1</span>
          
          <code class="ruby">  def authentication_token_expired?</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="150">
          <span class="hits">5</span>
          
          <code class="ruby">    auth_token_expiry.nil? || auth_token_expiry &lt;= Time.zone.now</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="151">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="152">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="153">
          
          
          <code class="ruby">  ###</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="154">
          
          
          <code class="ruby">  # Schema</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="155">
          
          
          <code class="ruby">  ###</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="156">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="157">
          
          
          <code class="ruby">  # Model associations</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="158">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to  :role # Foreign Key</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="159">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many    :unit_roles, dependent: :destroy</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="160">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many    :projects</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="161">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="162">
          
          
          <code class="ruby">  # Model validations/constraints</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="163">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :first_name,  presence: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="164">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :last_name,   presence: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="165">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :role_id,     presence: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="166">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :username,    presence: true, uniqueness: { case_sensitive: false }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="167">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :email,       presence: true, uniqueness: { case_sensitive: false }, format: {with: /\A([^@\s]+)@((?:[-a-z0-9]+\.)+[a-z]{2,})\z/i}</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="168">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :student_id,  uniqueness: true, allow_nil: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="169">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="170">
          
          
          <code class="ruby">  # Queries</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="171">
          <span class="hits">2</span>
          
          <code class="ruby">  scope :tutors,    -&gt; { joins(:role).where(&#39;roles.id = :tutor_role or roles.id = :convenor_role or roles.id = :admin_role&#39;, tutor_role: Role.tutor_id, convenor_role: Role.convenor_id, admin_role: Role.admin_id) }</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="172">
          <span class="hits">2</span>
          
          <code class="ruby">  scope :convenors, -&gt; { joins(:role).where(&#39;roles.id = :convenor_role or roles.id = :admin_role&#39;, convenor_role: Role.convenor_id, admin_role: Role.admin_id) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="173">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :admins,    -&gt; { joins(:role).where(&#39;roles.id = :admin_role&#39;, admin_role: Role.admin_id) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="174">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="175">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.teaching(unit)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="176">
          
          
          <code class="ruby">    User.joins(:unit_roles).where(&#39;unit_roles.unit_id = :unit_id and ( unit_roles.role_id = :tutor_role_id or unit_roles.role_id = :convenor_role_id) &#39;, unit_id: unit.id, tutor_role_id: Role.tutor_id, convenor_role_id: Role.convenor_id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="177">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="178">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="179">
          <span class="hits">1</span>
          
          <code class="ruby">  def username=(name)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="180">
          
          
          <code class="ruby">    # strip S or s from start of ids in the form S1234567 or S123456X</code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="181">
          <span class="hits">17</span>
          
          <code class="ruby">    truncate_s_match = (name =~ /^[Ss]\d{6,10}([Xx]|\d)$/)</code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="182">
          <span class="hits">17</span>
          
          <code class="ruby">    name[0] = &#39;&#39; if !truncate_s_match.nil? &amp;&amp; truncate_s_match.zero?</code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="183">
          <span class="hits">17</span>
          
          <code class="ruby">    self[:username] = name.downcase</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="184">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="185">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="186">
          <span class="hits">1</span>
          
          <code class="ruby">  def has_student_capability?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="187">
          
          
          <code class="ruby">    true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="188">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="189">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="190">
          <span class="hits">1</span>
          
          <code class="ruby">  def has_tutor_capability?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="191">
          <span class="hits">1</span>
          
          <code class="ruby">    role_id == Role.tutor_id || has_convenor_capability?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="192">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="193">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="194">
          <span class="hits">1</span>
          
          <code class="ruby">  def has_convenor_capability?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="195">
          <span class="hits">1</span>
          
          <code class="ruby">    role_id == Role.convenor_id || has_admin_capability?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="196">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="197">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="198">
          <span class="hits">1</span>
          
          <code class="ruby">  def has_admin_capability?</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="199">
          <span class="hits">2</span>
          
          <code class="ruby">    role_id == Role.admin_id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="200">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="201">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="202">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.get_change_role_perm_fn</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="203">
          <span class="hits">15</span>
          
          <code class="ruby">    lambda do |role, perm_hash, other|</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="204">
          <span class="hits">15</span>
          
          <code class="ruby">      from_role = other[0]</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="205">
          <span class="hits">15</span>
          
          <code class="ruby">      to_role = other[1]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="206">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="207">
          <span class="hits">15</span>
          
          <code class="ruby">      (chg_roles = perm_hash[:change_role]) &amp;&amp;</code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="208">
          <span class="hits">30</span>
          
          <code class="ruby">        (role_hash = chg_roles[role]) &amp;&amp;</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="209">
          <span class="hits">15</span>
          
          <code class="ruby">        (from_role_hash = role_hash[from_role]) &amp;&amp;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="210">
          
          
          <code class="ruby">        from_role_hash[to_role]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="211">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="212">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="213">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="214">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="215">
          
          
          <code class="ruby">  # Permissions around user data</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="216">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="217">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.permissions</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="218">
          
          
          <code class="ruby">    # Change role permissons:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="219">
          
          
          <code class="ruby">    #   who can change a Doubtfire user&#39;s role?</code>
        </li>
      
        <li class="covered" data-hits="45" data-linenumber="220">
          <span class="hits">45</span>
          
          <code class="ruby">    change_role_permissions = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="221">
          
          
          <code class="ruby">      # The current_user&#39;s role is an Administrator</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="222">
          
          
          <code class="ruby">      admin: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="223">
          
          
          <code class="ruby">        # User being assigned is an admin?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="224">
          
          
          <code class="ruby">        #   An admin current_user can demote them to either a student, tutor or convenor</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="225">
          
          
          <code class="ruby">        admin: {     student: [ :demote_user  ],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="226">
          
          
          <code class="ruby">                     tutor: [ :demote_user ],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="227">
          
          
          <code class="ruby">                     convenor: [ :demote_user ] },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="228">
          
          
          <code class="ruby">        # User being assigned is a convenor?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="229">
          
          
          <code class="ruby">        #   An admin current_user can demote them to student or tutor</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="230">
          
          
          <code class="ruby">        #   An admin current_user can promote them to an admin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="231">
          
          
          <code class="ruby">        convenor: {  student: [ :demote_user  ],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="232">
          
          
          <code class="ruby">                     tutor: [ :demote_user  ],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="233">
          
          
          <code class="ruby">                     admin: [ :promote_user ] },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="234">
          
          
          <code class="ruby">        # User being assigned is a tutor?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="235">
          
          
          <code class="ruby">        #   An admin current_user can demote them to a student</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="236">
          
          
          <code class="ruby">        #   An admin current_user can promote them to a convenor or admin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="237">
          
          
          <code class="ruby">        tutor: {     student: [ :demote_user  ],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="238">
          
          
          <code class="ruby">                     convenor: [ :promote_user ],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="239">
          
          
          <code class="ruby">                     admin: [ :promote_user ] },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="240">
          
          
          <code class="ruby">        # User being assigned is a student?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="241">
          
          
          <code class="ruby">        #   An admin current_user can promote them to a tutor, convenor or admin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="242">
          
          
          <code class="ruby">        student: {   tutor: [ :promote_user ],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="243">
          
          
          <code class="ruby">                     convenor: [ :promote_user ],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="244">
          
          
          <code class="ruby">                     admin: [ :promote_user ] },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="245">
          
          
          <code class="ruby">        # User being assigned has no role?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="246">
          
          
          <code class="ruby">        #   An admin current_user can create user to any role</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="247">
          
          
          <code class="ruby">        nil: {       student: [ :create_user  ],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="248">
          
          
          <code class="ruby">                     tutor: [ :create_user  ],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="249">
          
          
          <code class="ruby">                     convenor: [ :create_user ],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="250">
          
          
          <code class="ruby">                     admin: [ :create_user  ] }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="251">
          
          
          <code class="ruby">      },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="252">
          
          
          <code class="ruby">      # The current_user&#39;s role is a Convenor</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="253">
          
          
          <code class="ruby">      convenor: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="254">
          
          
          <code class="ruby">        # User being assigned is an tutor?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="255">
          
          
          <code class="ruby">        #   A convenor current_user can demote them to a student</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="256">
          
          
          <code class="ruby">        tutor: {     student: [ :demote_user  ] },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="257">
          
          
          <code class="ruby">        # User being assigned is an student?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="258">
          
          
          <code class="ruby">        #   A convenor current_user can promote them to a student</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="259">
          
          
          <code class="ruby">        student: {   tutor: [ :promote_user ] },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="260">
          
          
          <code class="ruby">        # User being assigned has no role?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="261">
          
          
          <code class="ruby">        #   A convenor current_user can create a user to either a student or tutor role</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="262">
          
          
          <code class="ruby">        nil: {       student: [ :create_user  ],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="263">
          
          
          <code class="ruby">                     tutor: [ :create_user  ] }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="264">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="265">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="266">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="267">
          
          
          <code class="ruby">    # What can admins do with users?</code>
        </li>
      
        <li class="covered" data-hits="45" data-linenumber="268">
          <span class="hits">45</span>
          
          <code class="ruby">    admin_role_permissions = [</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="269">
          
          
          <code class="ruby">      :create_user,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="270">
          
          
          <code class="ruby">      :upload_csv,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="271">
          
          
          <code class="ruby">      :list_users,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="272">
          
          
          <code class="ruby">      :download_system_csv,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="273">
          
          
          <code class="ruby">      :download_unit_csv,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="274">
          
          
          <code class="ruby">      :update_user,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="275">
          
          
          <code class="ruby">      :create_unit,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="276">
          
          
          <code class="ruby">      :act_tutor,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="277">
          
          
          <code class="ruby">      :admin_units,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="278">
          
          
          <code class="ruby">      :admin_users,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="279">
          
          
          <code class="ruby">      :convene_units,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="280">
          
          
          <code class="ruby">      :download_stats</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="281">
          
          
          <code class="ruby">    ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="282">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="283">
          
          
          <code class="ruby">    # What can convenors do with users?</code>
        </li>
      
        <li class="covered" data-hits="45" data-linenumber="284">
          <span class="hits">45</span>
          
          <code class="ruby">    convenor_role_permissions = [</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="285">
          
          
          <code class="ruby">      :promote_user,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="286">
          
          
          <code class="ruby">      :list_users,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="287">
          
          
          <code class="ruby">      :create_user,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="288">
          
          
          <code class="ruby">      :update_user,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="289">
          
          
          <code class="ruby">      :demote_user,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="290">
          
          
          <code class="ruby">      :upload_csv,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="291">
          
          
          <code class="ruby">      :download_unit_csv,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="292">
          
          
          <code class="ruby">      :create_unit,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="293">
          
          
          <code class="ruby">      :act_tutor,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="294">
          
          
          <code class="ruby">      :convene_units,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="295">
          
          
          <code class="ruby">      :download_stats</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="296">
          
          
          <code class="ruby">    ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="297">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="298">
          
          
          <code class="ruby">    # What can tutors do with users?</code>
        </li>
      
        <li class="covered" data-hits="45" data-linenumber="299">
          <span class="hits">45</span>
          
          <code class="ruby">    tutor_role_permissions = [</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="300">
          
          
          <code class="ruby">      :act_tutor,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="301">
          
          
          <code class="ruby">      :download_unit_csv</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="302">
          
          
          <code class="ruby">    ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="303">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="304">
          
          
          <code class="ruby">    # What can students do with users?</code>
        </li>
      
        <li class="covered" data-hits="45" data-linenumber="305">
          <span class="hits">45</span>
          
          <code class="ruby">    student_role_permissions = [</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="306">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="307">
          
          
          <code class="ruby">    ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="308">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="309">
          
          
          <code class="ruby">    # Return the permissions hash</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="310">
          
          
          <code class="ruby">    {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="311">
          
          
          <code class="ruby">      change_role: change_role_permissions,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="312">
          
          
          <code class="ruby">      admin: admin_role_permissions,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="313">
          
          
          <code class="ruby">      convenor: convenor_role_permissions,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="314">
          
          
          <code class="ruby">      tutor: tutor_role_permissions,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="315">
          
          
          <code class="ruby">      student: student_role_permissions</code>
        </li>
      
        <li class="covered" data-hits="45" data-linenumber="316">
          <span class="hits">45</span>
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="317">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="318">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="319">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.default</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="320">
          
          
          <code class="ruby">    user = new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="321">
          
          
          <code class="ruby">    institution_email_domain = Doubtfire::Application.config.institution[:email_domain]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="322">
          
          
          <code class="ruby">    user.username   = &#39;username&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="323">
          
          
          <code class="ruby">    user.first_name = &#39;First&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="324">
          
          
          <code class="ruby">    user.last_name  = &#39;Last&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="325">
          
          
          <code class="ruby">    user.email      = &quot;XXXXXXX@#{institution_email_domain}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="326">
          
          
          <code class="ruby">    user.nickname   = &#39;Nickname&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="327">
          
          
          <code class="ruby">    user.role_id    = Role.student_id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="328">
          
          
          <code class="ruby">    user</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="329">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="330">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="331">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.role_for(user)</code>
        </li>
      
        <li class="covered" data-hits="45" data-linenumber="332">
          <span class="hits">45</span>
          
          <code class="ruby">    user.role</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="333">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="334">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="335">
          <span class="hits">1</span>
          
          <code class="ruby">  def role_id=(new_role_id)</code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="336">
          <span class="hits">17</span>
          
          <code class="ruby">    new_role = Role.find(new_role_id)</code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="337">
          <span class="hits">17</span>
          
          <code class="ruby">    new_role = Role.student if new_role.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="338">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="339">
          <span class="hits">17</span>
          
          <code class="ruby">    fail_if_in_unit_role = [ Role.tutor, Role.convenor ] if new_role == Role.student</code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="340">
          <span class="hits">17</span>
          
          <code class="ruby">    fail_if_in_unit_role = [ Role.convenor ] if new_role == Role.tutor</code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="341">
          <span class="hits">17</span>
          
          <code class="ruby">    fail_if_in_unit_role = [] if new_role == Role.admin || new_role == Role.convenor</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="342">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="343">
          <span class="hits">17</span>
          
          <code class="ruby">    for check_role in fail_if_in_unit_role do</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="344">
          <span class="hits">4</span>
          
          <code class="ruby">      if unit_roles.where(&#39;role_id = :role_id&#39;, role_id: check_role.id).count &gt; 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="345">
          
          
          <code class="ruby">        return role</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="346">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="347">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="348">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="349">
          <span class="hits">17</span>
          
          <code class="ruby">    self[:role_id] = new_role.id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="350">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="351">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="352">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="353">
          
          
          <code class="ruby">  # Change the user&#39;s role - but ensure that it remains valid based on their roles in units</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="354">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="355">
          <span class="hits">1</span>
          
          <code class="ruby">  def role=(new_role)</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="356">
          <span class="hits">15</span>
          
          <code class="ruby">    self.role_id = new_role.id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="357">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="358">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="359">
          <span class="hits">1</span>
          
          <code class="ruby">  def email_required?</code>
        </li>
      
        <li class="covered" data-hits="121" data-linenumber="360">
          <span class="hits">121</span>
          
          <code class="ruby">    false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="361">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="362">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="363">
          <span class="hits">1</span>
          
          <code class="ruby">  def name</code>
        </li>
      
        <li class="covered" data-hits="140" data-linenumber="364">
          <span class="hits">140</span>
          
          <code class="ruby">    fn = first_name.split(&#39; &#39;).first</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="365">
          
          
          <code class="ruby">    # fn = nickname</code>
        </li>
      
        <li class="covered" data-hits="140" data-linenumber="366">
          <span class="hits">140</span>
          
          <code class="ruby">    sn = last_name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="367">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="140" data-linenumber="368">
          <span class="hits">140</span>
          
          <code class="ruby">    fn = &quot;#{fn[0..11]}...&quot; if fn.length &gt; 15</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="369">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="140" data-linenumber="370">
          <span class="hits">140</span>
          
          <code class="ruby">    sn = &quot;#{sn[0..11]}...&quot; if sn.length &gt; 15</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="371">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="140" data-linenumber="372">
          <span class="hits">140</span>
          
          <code class="ruby">    &quot;#{fn} #{sn}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="373">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="374">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="375">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.export_to_csv</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="376">
          
          
          <code class="ruby">    exportables = csv_columns.map { |col| col == &#39;role&#39; ? &#39;role_id&#39; : col }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="377">
          
          
          <code class="ruby">    CSV.generate do |row|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="378">
          
          
          <code class="ruby">      row &lt;&lt; User.attribute_names.select { |attribute| exportables.include? attribute }.map do |attribute|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="379">
          
          
          <code class="ruby">        # rename encrypted_password key to just password and role_id key to just role</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="380">
          
          
          <code class="ruby">        if attribute == &#39;encrypted_password&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="381">
          
          
          <code class="ruby">          &#39;password&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="382">
          
          
          <code class="ruby">        elsif attribute == &#39;role_id&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="383">
          
          
          <code class="ruby">          &#39;role&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="384">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="385">
          
          
          <code class="ruby">          attribute</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="386">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="387">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="388">
          
          
          <code class="ruby">      User.order(&#39;id&#39;).each do |user|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="389">
          
          
          <code class="ruby">        row &lt;&lt; user.attributes.select { |attribute| exportables.include? attribute }.map do |key, value|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="390">
          
          
          <code class="ruby">          # pass in a blank encrypted_password and the role name instead of just role_id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="391">
          
          
          <code class="ruby">          if key == &#39;encrypted_password&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="392">
          
          
          <code class="ruby">            &#39;&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="393">
          
          
          <code class="ruby">          elsif key == &#39;role_id&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="394">
          
          
          <code class="ruby">            Role.find(value).name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="395">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="396">
          
          
          <code class="ruby">            value</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="397">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="398">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="399">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="400">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="401">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="402">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="403">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.missing_headers(row, headers)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="404">
          
          
          <code class="ruby">    headers - row.to_hash.keys</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="405">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="406">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="407">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.csv_columns</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="408">
          
          
          <code class="ruby">    %w(username first_name last_name email student_id nickname role)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="409">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="410">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="411">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.import_from_csv(current_user, file)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="412">
          
          
          <code class="ruby">    success = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="413">
          
          
          <code class="ruby">    errors = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="414">
          
          
          <code class="ruby">    ignored = []</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="415">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="416">
          
          
          <code class="ruby">    CSV.parse(file,                 headers: true,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="417">
          
          
          <code class="ruby">                                    header_converters: [-&gt;(i) { i.nil? ? &#39;&#39; : i }, :downcase, -&gt;(hdr) { hdr.strip.tr(&#39; &#39;, &#39;_&#39;) unless hdr.nil? } ],</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="418">
          
          
          <code class="ruby">                                    converters: [-&gt;(body) { body.encode!(&#39;UTF-8&#39;, &#39;binary&#39;, invalid: :replace, undef: :replace, replace: &#39;&#39;) unless body.nil? }]).each do |row|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="419">
          
          
          <code class="ruby">      next if row[0] =~ /(email)|(username)/</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="420">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="421">
          
          
          <code class="ruby">      begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="422">
          
          
          <code class="ruby">        missing = missing_headers(row, csv_columns)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="423">
          
          
          <code class="ruby">        if missing.count &gt; 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="424">
          
          
          <code class="ruby">          errors &lt;&lt; { row: row, message: &quot;Missing headers: #{missing.join(&#39;, &#39;)}&quot; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="425">
          
          
          <code class="ruby">          next</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="426">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="427">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="428">
          
          
          <code class="ruby">        email = row[&#39;email&#39;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="429">
          
          
          <code class="ruby">        first_name = row[&#39;first_name&#39;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="430">
          
          
          <code class="ruby">        last_name = row[&#39;last_name&#39;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="431">
          
          
          <code class="ruby">        username = row[&#39;username&#39;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="432">
          
          
          <code class="ruby">        nickname = row[&#39;nickname&#39;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="433">
          
          
          <code class="ruby">        role = row[&#39;role&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="434">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="435">
          
          
          <code class="ruby">        pass_checks = true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="436">
          
          
          <code class="ruby">        %w(username email role first_name).each do |col|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="437">
          
          
          <code class="ruby">          next unless row[col].nil? || row[col].empty?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="438">
          
          
          <code class="ruby">          errors &lt;&lt; { row: row, message: &quot;The #{col} cannot be blank or empty&quot; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="439">
          
          
          <code class="ruby">          pass_checks = false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="440">
          
          
          <code class="ruby">          break</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="441">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="442">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="443">
          
          
          <code class="ruby">        next unless pass_checks</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="444">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="445">
          
          
          <code class="ruby">        unless email =~ /\A([^@\s]+)@((?:[-a-z0-9]+\.)+[a-z]{2,})\z/i</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="446">
          
          
          <code class="ruby">          errors &lt;&lt; { row: row, message: &quot;Invalid email address (#{email})&quot; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="447">
          
          
          <code class="ruby">          next</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="448">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="449">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="450">
          
          
          <code class="ruby">        new_role = Role.with_name(role)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="451">
          
          
          <code class="ruby">        username = username.downcase # ensure that find by username uses lowercase</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="452">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="453">
          
          
          <code class="ruby">        if new_role.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="454">
          
          
          <code class="ruby">          errors &lt;&lt; { row: row, message: &quot;Unable to find role #{new_role}&quot; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="455">
          
          
          <code class="ruby">          next</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="456">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="457">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="458">
          
          
          <code class="ruby">        #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="459">
          
          
          <code class="ruby">        # If the current user is allowed to create a user in this role</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="460">
          
          
          <code class="ruby">        #</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="461">
          
          
          <code class="ruby">        if AuthorisationHelpers.authorise?(current_user, User, :create_user, User.get_change_role_perm_fn, [ :nil, new_role.to_sym ])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="462">
          
          
          <code class="ruby">          #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="463">
          
          
          <code class="ruby">          # Find and update or create</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="464">
          
          
          <code class="ruby">          #</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="465">
          
          
          <code class="ruby">          user = User.find_or_create_by(username: username) do |new_user|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="466">
          
          
          <code class="ruby">            new_user.first_name         = first_name.titleize</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="467">
          
          
          <code class="ruby">            new_user.last_name          = last_name.titleize</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="468">
          
          
          <code class="ruby">            new_user.email              = email</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="469">
          
          
          <code class="ruby">            new_user.nickname           = nickname</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="470">
          
          
          <code class="ruby">            new_user.role_id            = new_role.id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="471">
          
          
          <code class="ruby">            new_user.encrypted_password = BCrypt::Password.create(&#39;password&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="472">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="473">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="474">
          
          
          <code class="ruby">          # will not be persisted initially as password cannot be blank - so can check</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="475">
          
          
          <code class="ruby">          # which were created using this - will persist changes imported</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="476">
          
          
          <code class="ruby">          if user.new_record?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="477">
          
          
          <code class="ruby">            user.save!</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="478">
          
          
          <code class="ruby">            success &lt;&lt; { row: row, message: &quot;Added user #{username} as #{role}.&quot; }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="479">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="480">
          
          
          <code class="ruby">            ignored &lt;&lt; { row: row, message: &quot;User #{username} already existed.&quot; }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="481">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="482">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="483">
          
          
          <code class="ruby">      rescue Exception =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="484">
          
          
          <code class="ruby">        errors &lt;&lt; { row: row, message: e.message }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="485">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="486">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="487">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="488">
          
          
          <code class="ruby">    {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="489">
          
          
          <code class="ruby">      success: success,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="490">
          
          
          <code class="ruby">      ignored: ignored,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="491">
          
          
          <code class="ruby">      errors:  errors</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="492">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="493">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="494">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="8cf325e62291f6c5562bdfac50bd1aabc322c4ae">
  <div class="header">
    <h3>app/serializers/group_serializer.rb</h3>
    <h4><span class="yellow">83.33 %</span> covered</h4>
    <div>
      <b>6</b> relevant lines. 
      <span class="green"><b>5</b> lines covered</span> and
      <span class="red"><b>1</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class GroupSerializer &lt; ActiveModel::Serializer</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  attributes :id, :name, :tutorial_id, :group_set_id, :number</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">class DeepGroupSerializer &lt; ActiveModel::Serializer</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  attributes :id, :name, :tutorial_id, :group_set_id, :number, :projects</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  def projects</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">    object.projects.map { |p| p.id }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="c4a07f8e04336b0c352b7b8803b16d33be8e641a">
  <div class="header">
    <h3>app/serializers/group_set_serializer.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>2</b> relevant lines. 
      <span class="green"><b>2</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class GroupSetSerializer &lt; ActiveModel::Serializer</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  attributes :id, :name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby">             :allow_students_to_create_groups,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">             :allow_students_to_manage_groups,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">             :keep_groups_in_same_class</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="c23fd14ab725530d554630bcd58176590f3e704c">
  <div class="header">
    <h3>app/serializers/learning_outcome_serializer.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>2</b> relevant lines. 
      <span class="green"><b>2</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">class LearningOutcomeSerializer &lt; ActiveModel::Serializer</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  attributes :id, :ilo_number, :abbreviation, :name, :description</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="597dace87a6249283bbc53b9bb9b65d612073e9b">
  <div class="header">
    <h3>app/serializers/learning_outcome_task_link_serializer.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>2</b> relevant lines. 
      <span class="green"><b>2</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class LearningOutcomeTaskLinkSerializer &lt; ActiveModel::Serializer</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  attributes :id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby">             :description,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">             :rating,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">             :learning_outcome_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">             :task_definition_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">             :task_id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="06ffb7be1bd2b207f92f0fe9a435a0c2a8e51a40">
  <div class="header">
    <h3>app/serializers/project_serializer.rb</h3>
    <h4><span class="red">56.52 %</span> covered</h4>
    <div>
      <b>46</b> relevant lines. 
      <span class="green"><b>26</b> lines covered</span> and
      <span class="red"><b>20</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;task_serializer&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"># Shallow serialization is used for student...</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">class ShallowProjectSerializer &lt; ActiveModel::Serializer</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  attributes :unit_id, :unit_code, :unit_name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">             :project_id, :student_name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">             :tutor_name, :target_grade,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">             :has_portfolio, :start_date</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">  def project_id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">    object.id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">class ProjectSerializer &lt; ActiveModel::Serializer</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">  attributes :unit_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">             :project_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">             :student_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">             :started,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">             :stats,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">             :student_name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">             :tutor_name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">             :tutorial_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">             :burndown_chart_data,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">             :enrolled,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">             :target_grade,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">             :portfolio_files,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">             :compile_portfolio,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">             :portfolio_available,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">             :grade,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">             :grade_rationale,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">             :tasks</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="34">
          <span class="hits">1</span>
          
          <code class="ruby">  def project_id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">    object.id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="38">
          <span class="hits">1</span>
          
          <code class="ruby">  def student_name</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">    &quot;#{object.student.name}#{object.student.nickname.nil? ? &#39;&#39; : &#39; (&#39; &lt;&lt; object.student.nickname &lt;&lt; &#39;)&#39;}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="42">
          <span class="hits">1</span>
          
          <code class="ruby">  def student_id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">    object.student.username</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="46">
          <span class="hits">1</span>
          
          <code class="ruby">  def tutor_name</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">    object.main_tutor.first_name unless object.main_tutor.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="50">
          <span class="hits">1</span>
          
          <code class="ruby">  def stats</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">    object.task_stats</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="54">
          <span class="hits">1</span>
          
          <code class="ruby">  def tasks</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="55">
          
          
          <code class="ruby">    object.task_details_for_shallow_serializer(Thread.current[:user])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="58">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :groups, serializer: GroupSerializer</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="59">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :task_outcome_alignments, serializer: LearningOutcomeTaskLinkSerializer</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="61">
          <span class="hits">1</span>
          
          <code class="ruby">  def my_role_obj</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="62">
          
          
          <code class="ruby">    object.role_for(Thread.current[:user]) if Thread.current[:user]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="65">
          <span class="hits">1</span>
          
          <code class="ruby">  def include_grade?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="66">
          
          
          <code class="ruby">    ([ Role.convenor, :convenor, Role.tutor, :tutor ].include? my_role_obj)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="69">
          <span class="hits">1</span>
          
          <code class="ruby">  def include_grade_rationale?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="70">
          
          
          <code class="ruby">    ([ Role.convenor, :convenor, Role.tutor, :tutor ].include? my_role_obj)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="73">
          <span class="hits">1</span>
          
          <code class="ruby">  def filter(keys)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="74">
          
          
          <code class="ruby">    keys.delete :grade unless include_grade?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="75">
          
          
          <code class="ruby">    keys.delete :grade_rationale unless include_grade_rationale?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="76">
          
          
          <code class="ruby">    keys</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="80">
          <span class="hits">1</span>
          
          <code class="ruby">class GroupMemberProjectSerializer &lt; ActiveModel::Serializer</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="81">
          <span class="hits">1</span>
          
          <code class="ruby">  attributes :student_id, :project_id, :student_name, :target_grade</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="83">
          <span class="hits">1</span>
          
          <code class="ruby">  def project_id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="84">
          
          
          <code class="ruby">    object.id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="87">
          <span class="hits">1</span>
          
          <code class="ruby">  def student_id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="88">
          
          
          <code class="ruby">    object.student.username</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="91">
          <span class="hits">1</span>
          
          <code class="ruby">  def student_name</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="92">
          
          
          <code class="ruby">    &quot;#{object.student.name}#{object.student.nickname.nil? ? &#39;&#39; : &#39; (&#39; &lt;&lt; object.student.nickname &lt;&lt; &#39;)&#39;}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="95">
          <span class="hits">1</span>
          
          <code class="ruby">  def my_role_obj</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="96">
          
          
          <code class="ruby">    object.role_for(Thread.current[:user]) if Thread.current[:user]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="99">
          <span class="hits">1</span>
          
          <code class="ruby">  def include_student_id?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="100">
          
          
          <code class="ruby">    ([ Role.convenor, Role.tutor, :tutor, :convenor ].include? my_role_obj)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="103">
          <span class="hits">1</span>
          
          <code class="ruby">  def filter(keys)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="104">
          
          
          <code class="ruby">    keys.delete :student_id unless include_student_id?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="105">
          
          
          <code class="ruby">    keys</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="e0a86349491149f80f2d5c7abb6212fc775d3313">
  <div class="header">
    <h3>app/serializers/role_serializer.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>3</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>3</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="missed" data-hits="0" data-linenumber="1">
          
          
          <code class="ruby">class RoleSerializer &lt; ActiveModel::Serializer</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2">
          
          
          <code class="ruby">  attributes :name, :description</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="b5acfb72ef42b695b165549c5a7c5dffd403741b">
  <div class="header">
    <h3>app/serializers/task_comment_serializer.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>17</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>17</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="missed" data-hits="0" data-linenumber="1">
          
          
          <code class="ruby">class TaskCommentSerializer &lt; ActiveModel::Serializer</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2">
          
          
          <code class="ruby">  attributes :id, :comment, :created_at, :author, :recipient</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">  def author</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">    {</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">      id: object.user.id,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">      name: object.user.name,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">      email: object.user.email</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">  def recipient</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">    {</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">      id: object.recipient.id,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">      name: object.recipient.name,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">      email: object.user.email</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="7aa61ebdb7b98f897c77fa7258bf65bdfd35e68e">
  <div class="header">
    <h3>app/serializers/task_definition_serializer.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>4</b> relevant lines. 
      <span class="green"><b>4</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class TaskDefinitionSerializer &lt; ActiveModel::Serializer</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  attributes :id, :abbreviation, :name, :description,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby">             :weight, :target_grade, :target_date,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">             :upload_requirements,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">             :plagiarism_checks, :plagiarism_report_url, :plagiarism_warn_pct,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">             :restrict_status_updates,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">             :group_set_id, :has_task_sheet?, :has_task_resources?,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">             :due_date, :start_date, :is_graded, :max_quality_pts</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">  def weight</code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="11">
          <span class="hits">30</span>
          
          <code class="ruby">    object.weighting</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="874fe9917169e93e61b6378d98789a718b5e1730">
  <div class="header">
    <h3>app/serializers/task_serializer.rb</h3>
    <h4><span class="red">69.23 %</span> covered</h4>
    <div>
      <b>26</b> relevant lines. 
      <span class="green"><b>18</b> lines covered</span> and
      <span class="red"><b>8</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class TaskUpdateSerializer &lt; ActiveModel::Serializer</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  attributes :id, :status, :project_id, :new_stats, :include_in_portfolio, :other_projects, :times_assessed, :grade, :quality_pts, :due_date, :extensions</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  def new_stats</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">    object.project.task_stats</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  def other_projects</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">    grp = object.group</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">    grp.projects.select { |p| p.id != object.project_id }.map { |p| { id: p.id, new_stats: p.task_stats } }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">  def filter(keys)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="14">
          <span class="hits">2</span>
          
          <code class="ruby">    keys.delete :other_projects unless object.group_task? &amp;&amp; !object.group.nil?</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="15">
          <span class="hits">2</span>
          
          <code class="ruby">    keys</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">class TaskStatSerializer &lt; ActiveModel::Serializer</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">  attributes :id, :task_abbr, :status, :tutorial_id, :times_assessed</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">  def task_abbr</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">    object.task_definition.abbreviation</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">  # def tutorial_id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">  #   object.project.tutorial.id unless object.project.tutorial.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">  # end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>
          
          <code class="ruby">class TaskSerializer &lt; ActiveModel::Serializer</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">  attributes :id, :status, :completion_date, :due_date, :extensions, :task_name, :task_desc, :task_weight, :task_abbr, :upload_requirements, :pct_similar, :similar_to_count, :times_assessed, :similar_to_dismissed_count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="34">
          <span class="hits">1</span>
          
          <code class="ruby">  def task_name</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">    object.task_definition.name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="38">
          <span class="hits">1</span>
          
          <code class="ruby">  def task_desc</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">    object.task_definition.description</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="42">
          <span class="hits">1</span>
          
          <code class="ruby">  def task_weight</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">    object.task_definition.weighting</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="46">
          <span class="hits">1</span>
          
          <code class="ruby">  def task_abbr</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">    object.task_definition.abbreviation</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="50">
          <span class="hits">1</span>
          
          <code class="ruby">  def upload_requirements</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">    object.task_definition.upload_requirements</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="c96e78d9fa0b34066abf0f2568a135fd9b2a4d73">
  <div class="header">
    <h3>app/serializers/tutorial_serializer.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>20</b> relevant lines. 
      <span class="green"><b>20</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;user_serializer&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">class TutorialSerializer &lt; ActiveModel::Serializer</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  attributes :id, :meeting_day, :meeting_time, :meeting_location, :abbreviation, :tutor_name, :num_students</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  def meeting_time</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="7">
          <span class="hits">12</span>
          
          <code class="ruby">    object.meeting_time.to_time</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">    # DateTime.parse(&quot;#{object.meeting_time}&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">  def tutor_name</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="12">
          <span class="hits">12</span>
          
          <code class="ruby">    object.tutor.name unless object.tutor.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">  has_one :tutor, serializer: ShallowUserSerializer</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">  def include_tutor?</code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="18">
          <span class="hits">24</span>
          
          <code class="ruby">    if Thread.current[:user]</code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="19">
          <span class="hits">24</span>
          
          <code class="ruby">      my_role = object.unit.role_for(Thread.current[:user])</code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="20">
          <span class="hits">24</span>
          
          <code class="ruby">      [ Role.convenor, Role.admin ].include? my_role</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">  def include_num_students?</code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="25">
          <span class="hits">24</span>
          
          <code class="ruby">    if Thread.current[:user]</code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="26">
          <span class="hits">24</span>
          
          <code class="ruby">      my_role = object.unit.role_for(Thread.current[:user])</code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="27">
          <span class="hits">24</span>
          
          <code class="ruby">      [ Role.convenor, Role.tutor, Role.admin ].include? my_role</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>
          
          <code class="ruby">  def filter(keys)</code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="32">
          <span class="hits">24</span>
          
          <code class="ruby">    keys.delete :tutor unless include_tutor?</code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="33">
          <span class="hits">24</span>
          
          <code class="ruby">    keys.delete :num_students unless include_num_students?</code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="34">
          <span class="hits">24</span>
          
          <code class="ruby">    keys</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="22ca2cd92ae6331364e89845bb5c9b8d236b383a">
  <div class="header">
    <h3>app/serializers/unit_role_serializer.rb</h3>
    <h4><span class="green">93.75 %</span> covered</h4>
    <div>
      <b>32</b> relevant lines. 
      <span class="green"><b>30</b> lines covered</span> and
      <span class="red"><b>2</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;user_serializer&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">class ShallowUnitRoleSerializer &lt; ActiveModel::Serializer</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  attributes :id, :role</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  def role</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">    object.role.name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">class UnitRoleSerializer &lt; ActiveModel::Serializer</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">  attributes :id, :role, :user_id, :unit_id, :unit_name, :name, :unit_code, :start_date, :active</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">  # has_one :user, serializer: ShallowUserSerializer</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">  # has_one :unit, serializer: ShallowUnitSerializer</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">  # has_one :role</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">  def role</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">    object.role.name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">  def unit_id</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">    object.unit.id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="26">
          <span class="hits">1</span>
          
          <code class="ruby">  def unit_code</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>
          
          <code class="ruby">    object.unit.code</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="30">
          <span class="hits">1</span>
          
          <code class="ruby">  def unit_name</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>
          
          <code class="ruby">    object.unit.name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="34">
          <span class="hits">1</span>
          
          <code class="ruby">  def name</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="35">
          <span class="hits">1</span>
          
          <code class="ruby">    object.user.name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="38">
          <span class="hits">1</span>
          
          <code class="ruby">  def active</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="39">
          <span class="hits">1</span>
          
          <code class="ruby">    object.unit.active</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="42">
          <span class="hits">1</span>
          
          <code class="ruby">  def include_start_date?</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="43">
          <span class="hits">2</span>
          
          <code class="ruby">    object.has_attribute? :start_date</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="46">
          <span class="hits">1</span>
          
          <code class="ruby">  def filter(keys)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="47">
          <span class="hits">2</span>
          
          <code class="ruby">    keys.delete :start_date unless include_start_date?</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="48">
          <span class="hits">2</span>
          
          <code class="ruby">    keys</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="52">
          <span class="hits">1</span>
          
          <code class="ruby">class UserUnitRoleSerializer &lt; ActiveModel::Serializer</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="53">
          <span class="hits">1</span>
          
          <code class="ruby">  attributes :id, :user_id, :name, :role #:user_name?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="55">
          <span class="hits">1</span>
          
          <code class="ruby">  def role</code>
        </li>
      
        <li class="covered" data-hits="19" data-linenumber="56">
          <span class="hits">19</span>
          
          <code class="ruby">    object.role.name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="59">
          <span class="hits">1</span>
          
          <code class="ruby">  def name</code>
        </li>
      
        <li class="covered" data-hits="19" data-linenumber="60">
          <span class="hits">19</span>
          
          <code class="ruby">    object.user.name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="63">
          <span class="hits">1</span>
          
          <code class="ruby">  def user_name</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="64">
          
          
          <code class="ruby">    object.user.name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="f19b2895c64d322f0a8a4cd50e3123d2f8eaa373">
  <div class="header">
    <h3>app/serializers/unit_serializer.rb</h3>
    <h4><span class="green">97.44 %</span> covered</h4>
    <div>
      <b>39</b> relevant lines. 
      <span class="green"><b>38</b> lines covered</span> and
      <span class="red"><b>1</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;unit_role_serializer&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">class ShallowUnitSerializer &lt; ActiveModel::Serializer</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  attributes :code, :id, :name, :start_date, :end_date, :active</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">class UnitSerializer &lt; ActiveModel::Serializer</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  attributes :code, :id, :name, :my_role, :description, :start_date, :end_date, :active, :convenors, :ilos</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">  def start_date</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="11">
          <span class="hits">2</span>
          
          <code class="ruby">    object.start_date.to_date</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">  def end_date</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="15">
          <span class="hits">2</span>
          
          <code class="ruby">    object.end_date.to_date</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">  def my_role_obj</code>
        </li>
      
        <li class="covered" data-hits="14" data-linenumber="19">
          <span class="hits">14</span>
          
          <code class="ruby">    object.role_for(Thread.current[:user]) if Thread.current[:user]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">  def my_user_role</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">    Thread.current[:user].role if Thread.current[:user]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="26">
          <span class="hits">1</span>
          
          <code class="ruby">  def role</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="27">
          <span class="hits">2</span>
          
          <code class="ruby">    role = my_role_obj</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="28">
          <span class="hits">2</span>
          
          <code class="ruby">    role.name unless role.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>
          
          <code class="ruby">  def my_role</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="32">
          <span class="hits">2</span>
          
          <code class="ruby">    role</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="35">
          <span class="hits">1</span>
          
          <code class="ruby">  def ilos</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="36">
          <span class="hits">4</span>
          
          <code class="ruby">    object.learning_outcomes</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="39">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :tutorials</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="40">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :task_definitions</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="41">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :convenors, serializer: UserUnitRoleSerializer</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="42">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :staff, serializer: UserUnitRoleSerializer</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="43">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :group_sets, serializer: GroupSetSerializer</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="44">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :ilos, serializer: LearningOutcomeSerializer</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="45">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :task_outcome_alignments, serializer: LearningOutcomeTaskLinkSerializer</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="46">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :groups, serializer: DeepGroupSerializer</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="48">
          <span class="hits">1</span>
          
          <code class="ruby">  def include_convenors?</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="49">
          <span class="hits">4</span>
          
          <code class="ruby">    ([ Role.convenor, :convenor ].include? my_role_obj) || (my_user_role == Role.admin)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="52">
          <span class="hits">1</span>
          
          <code class="ruby">  def include_staff?</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="53">
          <span class="hits">4</span>
          
          <code class="ruby">    ([ Role.convenor, :convenor, Role.tutor, :tutor ].include? my_role_obj) || (my_user_role == Role.admin)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="56">
          <span class="hits">1</span>
          
          <code class="ruby">  def include_groups?</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="57">
          <span class="hits">4</span>
          
          <code class="ruby">    ([ Role.convenor, :convenor, Role.tutor, :tutor ].include? my_role_obj) || (my_user_role == Role.admin)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="60">
          <span class="hits">1</span>
          
          <code class="ruby">  def filter(keys)</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="61">
          <span class="hits">4</span>
          
          <code class="ruby">    keys.delete :groups unless include_groups?</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="62">
          <span class="hits">4</span>
          
          <code class="ruby">    keys.delete :convenors unless include_convenors?</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="63">
          <span class="hits">4</span>
          
          <code class="ruby">    keys.delete :staff unless include_staff?</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="64">
          <span class="hits">4</span>
          
          <code class="ruby">    keys</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="7a71d446d2a4d8ad45da838bf785d269e674e8b3">
  <div class="header">
    <h3>app/serializers/user_role_serializer.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>5</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>5</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="missed" data-hits="0" data-linenumber="1">
          
          
          <code class="ruby">class UserRoleSerializer &lt; ActiveModel::Serializer</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2">
          
          
          <code class="ruby">  attributes :id, :role_id, :user_id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">  has_one :role</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">  has_one :user</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="08becbc800961ae554eeef0740cce19c120ca2ab">
  <div class="header">
    <h3>app/serializers/user_serializer.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>6</b> relevant lines. 
      <span class="green"><b>6</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">class UserSerializer &lt; ActiveModel::Serializer</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  attributes :id, :student_id, :email, :name, :first_name, :last_name, :username, :nickname, :system_role, :receive_task_notifications, :receive_portfolio_notifications, :receive_feedback_notifications, :opt_in_to_research, :has_run_first_time_setup</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  def system_role</code>
        </li>
      
        <li class="covered" data-hits="82" data-linenumber="6">
          <span class="hits">82</span>
          
          <code class="ruby">    object.role.name if object.role</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">class ShallowUserSerializer &lt; ActiveModel::Serializer</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">  attributes :id, :name, :email, :student_id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="a5d5f8025fdac669c5c77913afaedb49083dcb71">
  <div class="header">
    <h3>lib/helpers/database_populator.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>345</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>345</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="missed" data-hits="0" data-linenumber="1">
          
          
          <code class="ruby">require &#39;populator&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="2">
          
          
          <code class="ruby">require &#39;faker&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="3">
          
          
          <code class="ruby">require &#39;bcrypt&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">require &#39;json&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">require_all &#39;lib/helpers&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"># This class populates data in the database</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">class DatabasePopulator</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">  # Initialiser sets up the cache required for the populator.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">  # Scale is set to :small by default.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">  def initialize(scale = :small)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">    # Set up our caches</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">    scale ||= :small</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">    @user_cache = {}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">    @unit_cache = {}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">    @task_def_cache = {}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">    # Set up the scale</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">    scale_data = {</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">      small: {</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">        min_students: 5,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">        delta_students: 2,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">        few_tasks: 5,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">        some_tasks: 10,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">        many_tasks: 20,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">        few_tutorials: 1,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">        some_tutorials: 1,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">        many_tutorials: 1,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">        max_tutorials: 4,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">        tickets_generated: 10</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">      },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">      large: {</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">        min_students: 15,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">        delta_students: 7,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">        few_tasks: 10,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">        some_tasks: 30,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">        many_tasks: 50,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">        few_tutorials: 1,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">        some_tutorials: 2,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">        many_tutorials: 4,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">        max_tutorials: 20,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">        tickets_generated: 50</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">    accepted_scale_types = scale_data.keys</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="49">
          
          
          <code class="ruby">    unless accepted_scale_types.include?(scale)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">      throw &quot;Invalid scale value &#39;#{scale}&#39;. Acceptable values are: #{accepted_scale_types.join(&quot;, &quot;)}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">      puts &quot;-&gt; Scale is set to #{scale}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby">    @scale = scale_data[scale]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">    </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="56">
          
          
          <code class="ruby">    generate_user_roles</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="57">
          
          
          <code class="ruby">    generate_task_statuses</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">    </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">    # Fixed data contains all fixed units and users created</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="60">
          
          
          <code class="ruby">    generate_fixed_data()</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="61">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="63">
          
          
          <code class="ruby">  def generate_admin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="64">
          
          
          <code class="ruby">    @user_data = {</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="65">
          
          
          <code class="ruby">      acain: { first_name: &#39;Andrew&#39;, last_name: &#39;Cain&#39;, nickname: &#39;Macite&#39;, role_id: Role.admin_id }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="66">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="67">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">  # Generate some users. Pass in an optional filter(s) for:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">  # Role.admin, Role.convenor, Role.tutor, Role.student</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="72">
          
          
          <code class="ruby">  def generate_users(filter = nil)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="73">
          
          
          <code class="ruby">    accepted_roles = Role.all</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="75">
          
          
          <code class="ruby">    if filter.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="76">
          
          
          <code class="ruby">      filter = accepted_roles</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="77">
          
          
          <code class="ruby">    elsif accepted_roles.include? filter</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="78">
          
          
          <code class="ruby">      filter_ids = [filter].flatten.map(&amp;:id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="79">
          
          
          <code class="ruby">      filter = Role.where(id: filter_ids)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="80">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="81">
          
          
          <code class="ruby">      accepted_to_str = Role.all.pluck(:name).map { | s | &quot;Role.&quot; &lt;&lt; s.downcase }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="82">
          
          
          <code class="ruby">      throw &quot;Unaccepted filter for generate_users, should be one of #{accepted_to_str}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="83">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="85">
          
          
          <code class="ruby">    print &quot;--&gt; Generating users with role(s) #{filter.pluck(:name).join(&#39;, &#39;)}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="86">
          
          
          <code class="ruby">    users_to_generate = @user_data.select { | user_key, profile | filter.pluck(:id).include? profile[:role_id] }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">    # Create each user</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="89">
          
          
          <code class="ruby">    users_to_generate.each do |user_key, profile|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="90">
          
          
          <code class="ruby">      print &#39;.&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="91">
          
          
          <code class="ruby">      username = user_key.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="93">
          
          
          <code class="ruby">      profile[:email]     ||= &quot;#{username}@doubtfire.com&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="94">
          
          
          <code class="ruby">      profile[:username]  ||= username</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="95">
          
          
          <code class="ruby">      profile[:login_id]  ||= username</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="97">
          
          
          <code class="ruby">      if AuthenticationHelpers.aaf_auth?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="98">
          
          
          <code class="ruby">        user = User.create!(profile)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="99">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="100">
          
          
          <code class="ruby">        user = User.create!(profile.merge({</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="101">
          
          
          <code class="ruby">          password: &#39;password&#39;,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="102">
          
          
          <code class="ruby">          password_confirmation: &#39;password&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="103">
          
          
          <code class="ruby">        }))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="104">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="106">
          
          
          <code class="ruby">      @user_cache[user_key] = user</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="107">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="108">
          
          
          <code class="ruby">    puts &#39;!&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="109">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby">  # Generates some units</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="114">
          
          
          <code class="ruby">  def generate_units</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="115">
          
          
          <code class="ruby">    puts &quot;--&gt; Generating units&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="117">
          
          
          <code class="ruby">    if @user_cache.empty?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby">      # Must generate users first!</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="119">
          
          
          <code class="ruby">      puts &quot;---&gt; No users generated. Generating users first...&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="120">
          
          
          <code class="ruby">      generate_users()</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="121">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby">    # Set sizes from scale</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="124">
          
          
          <code class="ruby">    some_tasks = @scale[:some_tasks]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="125">
          
          
          <code class="ruby">    many_tasks = @scale[:many_tasks]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="126">
          
          
          <code class="ruby">    some_tutorials = @scale[:some_tutorials]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="127">
          
          
          <code class="ruby">    many_tutorials = @scale[:many_tutorials]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="128">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="129">
          
          
          <code class="ruby">    # Run through the unit_details and initialise their data</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="130">
          
          
          <code class="ruby">    @unit_data.each do | unit_key, unit_details |</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="131">
          
          
          <code class="ruby">      puts &quot;---&gt; Generating unit #{unit_details[:code]}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="132">
          
          
          <code class="ruby">      unit = Unit.create!(</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="133">
          
          
          <code class="ruby">        code: unit_details[:code],</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="134">
          
          
          <code class="ruby">        name: unit_details[:name],</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="135">
          
          
          <code class="ruby">        description: Populator.words(10..15),</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="136">
          
          
          <code class="ruby">        start_date: Time.zone.now  - 6.weeks,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="137">
          
          
          <code class="ruby">        end_date: 13.weeks.since(Time.zone.now - 6.weeks)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="138">
          
          
          <code class="ruby">      )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="139">
          
          
          <code class="ruby">      # Assign the convenors for this unit</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="140">
          
          
          <code class="ruby">      unit_details[:convenors].each do | user_key |</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="141">
          
          
          <code class="ruby">        puts &quot;----&gt; Adding convenor #{user_key}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="142">
          
          
          <code class="ruby">        unit.employ_staff(@user_cache[user_key], Role.convenor)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="143">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="144">
          
          
          <code class="ruby">      # Cache what we have</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="145">
          
          
          <code class="ruby">      @unit_cache[unit_key] = unit</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="146">
          
          
          <code class="ruby">      # Generate other unit-related stuff</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="147">
          
          
          <code class="ruby">      generate_tasks_for_unit(unit, unit_details)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="148">
          
          
          <code class="ruby">      generate_and_align_ilos_for_unit(unit, unit_details)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="149">
          
          
          <code class="ruby">      generate_tutorials_and_enrol_students_for_unit(unit, unit_details)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="150">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="151">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="152">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="153">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="154">
          
          
          <code class="ruby">  # Random project helper</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="155">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="156">
          
          
          <code class="ruby">  def random_project</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="157">
          
          
          <code class="ruby">    id = Project.pluck(:id).sample</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="158">
          
          
          <code class="ruby">    Project.find(id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="159">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="160">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="161">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="162">
          
          
          <code class="ruby">  # Generated fixed data here for students and units</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="164">
          
          
          <code class="ruby">  def generate_fixed_data</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="165">
          
          
          <code class="ruby">    # Define fixed user data here</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="166">
          
          
          <code class="ruby">    @user_data = {</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="167">
          
          
          <code class="ruby">      acain:              {first_name: &quot;Andrew&quot;,  last_name: &quot;Cain&quot;,          nickname: &quot;Macite&quot;,         role_id: Role.admin_id },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="168">
          
          
          <code class="ruby">      aconvenor:          {first_name: &quot;Clinton&quot;, last_name: &quot;Woodward&quot;,      nickname: &quot;The Giant&quot;,      role_id: Role.convenor_id },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="169">
          
          
          <code class="ruby">      aadmin:             {first_name: &quot;Allan&quot;,   last_name: &quot;Jones&quot;,         nickname: &quot;P-Jiddy&quot;,        role_id: Role.admin_id },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="170">
          
          
          <code class="ruby">      rwilson:            {first_name: &quot;Reuben&quot;,  last_name: &quot;Wilson&quot;,        nickname: &quot;Reubs&quot;,          role_id: Role.convenor_id },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="171">
          
          
          <code class="ruby">      atutor:             {first_name: &quot;Akihiro&quot;, last_name: &quot;Noguchi&quot;,       nickname: &quot;Animations&quot;,     role_id: Role.tutor_id },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="172">
          
          
          <code class="ruby">      acummaudo:          {first_name: &quot;Alex&quot;,    last_name: &quot;Cummaudo&quot;,      nickname: &quot;DoubtfireDude&quot;,  role_id: Role.convenor_id },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="173">
          
          
          <code class="ruby">      cliff:              {first_name: &quot;Cliff&quot;,   last_name: &quot;Warren&quot;,        nickname: &quot;Cliff&quot;,          role_id: Role.tutor_id },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="174">
          
          
          <code class="ruby">      joostfunkekupper:   {first_name: &quot;Joost&quot;,   last_name: &quot;Funke Kupper&quot;,  nickname: &quot;Joe&quot;,            role_id: Role.tutor_id },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="175">
          
          
          <code class="ruby">      angusmorton:        {first_name: &quot;Angus&quot;,   last_name: &quot;Morton&quot;,        nickname: &quot;Angus&quot;,          role_id: Role.tutor_id },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="176">
          
          
          <code class="ruby">      &quot;123456X&quot; =&gt;        {first_name: &quot;Fred&quot;,    last_name: &quot;Jones&quot;,         nickname: &quot;Foo&quot;,            role_id: Role.student_id },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="177">
          
          
          <code class="ruby">      astudent:           {first_name: &quot;student&quot;, last_name: &quot;surname&quot;,       nickname: &quot;Foo&quot;,            role_id: Role.student_id }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="178">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="179">
          
          
          <code class="ruby">    # Add 10 tutors to fixed info</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="180">
          
          
          <code class="ruby">    10.times do |count|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="181">
          
          
          <code class="ruby">      tutor_name = &quot;tutor_#{count}&quot;;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="182">
          
          
          <code class="ruby">      @user_data[tutor_name] = {</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="183">
          
          
          <code class="ruby">        first_name: Faker::Name.first_name,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="184">
          
          
          <code class="ruby">        last_name: Faker::Name.last_name,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="185">
          
          
          <code class="ruby">        nickname: tutor_name,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="186">
          
          
          <code class="ruby">        role_id: Role.tutor_id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="187">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="188">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="189">
          
          
          <code class="ruby">    # Define fixed unit details here</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="190">
          
          
          <code class="ruby">    many_tutorials = @scale[:many_tutorials]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="191">
          
          
          <code class="ruby">    some_tutorials = @scale[:some_tutorials]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="192">
          
          
          <code class="ruby">    few_tutorials  = @scale[:few_tutorials]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="193">
          
          
          <code class="ruby">    some_tasks     = @scale[:some_tasks]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="194">
          
          
          <code class="ruby">    many_tasks     = @scale[:many_tasks]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="195">
          
          
          <code class="ruby">    few_tasks      = @scale[:few_tasks]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="196">
          
          
          <code class="ruby">    @unit_data = {</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="197">
          
          
          <code class="ruby">      intro_prog: {</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="198">
          
          
          <code class="ruby">        code: &quot;COS10001&quot;,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="199">
          
          
          <code class="ruby">        name: &quot;Introduction to Programming&quot;,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="200">
          
          
          <code class="ruby">        convenors: [ :acain, :aconvenor ],</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="201">
          
          
          <code class="ruby">        tutors: [</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="202">
          
          
          <code class="ruby">          { user: :acain, num: many_tutorials },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="203">
          
          
          <code class="ruby">          { user: :aconvenor, num: many_tutorials },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="204">
          
          
          <code class="ruby">          { user: :aadmin, num: many_tutorials },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="205">
          
          
          <code class="ruby">          { user: :rwilson, num: many_tutorials },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="206">
          
          
          <code class="ruby">          { user: :acummaudo, num: some_tutorials },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="207">
          
          
          <code class="ruby">          { user: :atutor, num: many_tutorials },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="208">
          
          
          <code class="ruby">          { user: :joostfunkekupper, num: many_tutorials },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="209">
          
          
          <code class="ruby">          { user: :angusmorton, num: some_tutorials },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="210">
          
          
          <code class="ruby">          { user: :cliff, num: some_tutorials },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="211">
          
          
          <code class="ruby">        ],</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="212">
          
          
          <code class="ruby">        num_tasks: some_tasks,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="213">
          
          
          <code class="ruby">        ilos: rand(0..3),</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="214">
          
          
          <code class="ruby">        students: [ ]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="215">
          
          
          <code class="ruby">      },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="216">
          
          
          <code class="ruby">      oop: {</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="217">
          
          
          <code class="ruby">        code: &quot;COS20007&quot;,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="218">
          
          
          <code class="ruby">        name: &quot;Object Oriented Programming&quot;,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="219">
          
          
          <code class="ruby">        convenors: [ :acain, :aconvenor, :aadmin, :acummaudo ],</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="220">
          
          
          <code class="ruby">        tutors: [</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="221">
          
          
          <code class="ruby">          { user: &quot;tutor_1&quot;, num: few_tutorials },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="222">
          
          
          <code class="ruby">          { user: :angusmorton, num: few_tutorials },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="223">
          
          
          <code class="ruby">          { user: :atutor, num: few_tutorials },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="224">
          
          
          <code class="ruby">          { user: :joostfunkekupper, num: few_tutorials },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="225">
          
          
          <code class="ruby">        ],</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="226">
          
          
          <code class="ruby">        num_tasks: many_tasks,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="227">
          
          
          <code class="ruby">        ilos: rand(0..3),</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="228">
          
          
          <code class="ruby">        students: [ :cliff ]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="229">
          
          
          <code class="ruby">      },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="230">
          
          
          <code class="ruby">      ai4g: {</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="231">
          
          
          <code class="ruby">        code: &quot;COS30046&quot;,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="232">
          
          
          <code class="ruby">        name: &quot;Artificial Intelligence for Games&quot;,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="233">
          
          
          <code class="ruby">        convenors: [ :aconvenor ],</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="234">
          
          
          <code class="ruby">        tutors: [</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="235">
          
          
          <code class="ruby">          { user: :aconvenor, num: few_tutorials },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="236">
          
          
          <code class="ruby">          { user: :cliff, num: few_tutorials },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="237">
          
          
          <code class="ruby">        ],</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="238">
          
          
          <code class="ruby">        num_tasks: few_tasks,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="239">
          
          
          <code class="ruby">        ilos: rand(0..3),</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="240">
          
          
          <code class="ruby">        students: [ :acummaudo ]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="241">
          
          
          <code class="ruby">      },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="242">
          
          
          <code class="ruby">      gameprog: {</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="243">
          
          
          <code class="ruby">        code: &quot;COS30243&quot;,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="244">
          
          
          <code class="ruby">        name: &quot;Game Programming&quot;,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="245">
          
          
          <code class="ruby">        convenors: [ :aconvenor, :acummaudo ],</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="246">
          
          
          <code class="ruby">        tutors: [</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="247">
          
          
          <code class="ruby">          { user: :aconvenor, num: few_tutorials },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="248">
          
          
          <code class="ruby">        ],</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="249">
          
          
          <code class="ruby">        num_tasks: few_tasks,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="250">
          
          
          <code class="ruby">        ilos: rand(0..3),</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="251">
          
          
          <code class="ruby">        students: [ :acain, :aadmin ]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="252">
          
          
          <code class="ruby">      },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="253">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="254">
          
          
          <code class="ruby">    puts &quot;-&gt; Defined #{@user_data.length} fixed users and #{@unit_data.length} units&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="255">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="256">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="257">
          
          
          <code class="ruby">  private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="258">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="259">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="260">
          
          
          <code class="ruby">  # Generate roles</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="261">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="262">
          
          
          <code class="ruby">  def generate_user_roles</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="263">
          
          
          <code class="ruby">    print &quot;-&gt; Generating user roles&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="264">
          
          
          <code class="ruby">    roles = [</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="265">
          
          
          <code class="ruby">      { name: &#39;Student&#39;, description: &quot;Students are able to be enrolled into units, and to submit progress for their unit projects.&quot; },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="266">
          
          
          <code class="ruby">      { name: &#39;Tutor&#39;, description: &quot;Tutors are able to supervise tutorial classes and provide feedback to students, they may also be students in other units&quot; },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="267">
          
          
          <code class="ruby">      { name: &#39;Convenor&#39;, description: &quot;Convenors are able to create and manage units, as well as act as tutors and students.&quot; },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="268">
          
          
          <code class="ruby">      { name: &#39;Admin&#39;, description: &quot;Admin are able to create convenors, and act as convenors, tutors, and students in units.&quot; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="269">
          
          
          <code class="ruby">    ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="270">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="271">
          
          
          <code class="ruby">    roles.each do |role|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="272">
          
          
          <code class="ruby">      Role.create!(name: role[:name], description: role[:description])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="273">
          
          
          <code class="ruby">      print &quot;.&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="274">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="275">
          
          
          <code class="ruby">    puts &quot;!&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="276">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="277">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="278">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="279">
          
          
          <code class="ruby">  # Generate tasks statuses</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="280">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="281">
          
          
          <code class="ruby">  def generate_task_statuses</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="282">
          
          
          <code class="ruby">    print &quot;-&gt; Generating task statuses&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="283">
          
          
          <code class="ruby">    statuses = {</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="284">
          
          
          <code class="ruby">      &quot;Not Started&quot;: &quot;You have not yet started this task.&quot;,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="285">
          
          
          <code class="ruby">      &quot;Complete&quot;: &quot;This task has been signed off by your tutor.&quot;,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="286">
          
          
          <code class="ruby">      &quot;Need Help&quot;: &quot;Some help is required in order to complete this task.&quot;,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="287">
          
          
          <code class="ruby">      &quot;Working On It&quot;: &quot;This task is currently being worked on.&quot;,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="288">
          
          
          <code class="ruby">      &quot;Fix and Resubmit&quot;: &quot;This task must be resubmitted after fixing some issues.&quot;,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="289">
          
          
          <code class="ruby">      &quot;Do Not Resubmit&quot;: &quot;This task must be fixed and included in your portfolio, but should not be resubmitted.&quot;,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="290">
          
          
          <code class="ruby">      &quot;Redo&quot;: &quot;This task needs to be redone.&quot;,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="291">
          
          
          <code class="ruby">      &quot;Discuss&quot;: &quot;Your work looks good, discuss it with your tutor to complete.&quot;,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="292">
          
          
          <code class="ruby">      &quot;Ready to Mark&quot;: &quot;This task is ready for the tutor to assess to provide feedback.&quot;,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="293">
          
          
          <code class="ruby">      &quot;Demonstrate&quot;: &quot;Your work looks good, demonstrate it to your tutor to complete.&quot;,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="294">
          
          
          <code class="ruby">      &quot;Fail&quot;: &quot;You did not successfully demonstrate the required learning in this task.&quot;,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="295">
          
          
          <code class="ruby">      &quot;Time Exceeded&quot;: &quot;You did not submit or complete the task before the appropriate deadline.&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="296">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="297">
          
          
          <code class="ruby">    statuses.each do | name, desc |</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="298">
          
          
          <code class="ruby">      print &quot;.&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="299">
          
          
          <code class="ruby">      TaskStatus.create(name: name, description: desc)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="300">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="301">
          
          
          <code class="ruby">    puts &quot;!&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="302">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="303">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="304">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="305">
          
          
          <code class="ruby">  # Generates tasks for the given unit</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="306">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="307">
          
          
          <code class="ruby">  def generate_tasks_for_unit(unit, unit_details)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="308">
          
          
          <code class="ruby">    print &quot;----&gt; Generating #{unit_details[:num_tasks]} tasks&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="309">
          
          
          <code class="ruby">    unit_details[:num_tasks].times do |count|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="310">
          
          
          <code class="ruby">      up_reqs = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="311">
          
          
          <code class="ruby">      rand(1..4).times.each_with_index do | file, idx |</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="312">
          
          
          <code class="ruby">        up_reqs[idx] = { :key =&gt; &quot;file#{idx}&quot;, :name =&gt; Populator.words(1..3).capitalize, :type =&gt; [&quot;code&quot;, &quot;document&quot;, &quot;image&quot;].sample }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="313">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="314">
          
          
          <code class="ruby">      target_date = unit.start_date + ((count + 1) % 12).weeks # Assignment 6 due week 6, etc.</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="315">
          
          
          <code class="ruby">      start_date = target_date - rand(1.0..2.0).weeks</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="316">
          
          
          <code class="ruby">      # Make sure at least 30% of the tasks are pass</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="317">
          
          
          <code class="ruby">      target_grade = @task_def_cache.length &gt; (unit_details[:num_tasks] / 3) ? rand(0..3) : 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="318">
          
          
          <code class="ruby">      task_def = TaskDefinition.create(</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="319">
          
          
          <code class="ruby">        name: &quot;Assignment #{count + 1}&quot;,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="320">
          
          
          <code class="ruby">        abbreviation: &quot;A#{count + 1}&quot;,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="321">
          
          
          <code class="ruby">        unit_id: unit.id,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="322">
          
          
          <code class="ruby">        description: Populator.words(5..10),</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="323">
          
          
          <code class="ruby">        weighting: BigDecimal.new(&quot;2&quot;),</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="324">
          
          
          <code class="ruby">        target_date: target_date,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="325">
          
          
          <code class="ruby">        upload_requirements: up_reqs.to_json,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="326">
          
          
          <code class="ruby">        start_date: start_date,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="327">
          
          
          <code class="ruby">        target_grade: target_grade</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="328">
          
          
          <code class="ruby">      )</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="329">
          
          
          <code class="ruby">      @task_def_cache[task_def.id] = task_def</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="330">
          
          
          <code class="ruby">      print &quot;.&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="331">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="332">
          
          
          <code class="ruby">    puts &quot;!&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="333">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="334">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="335">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="336">
          
          
          <code class="ruby">  # Generates ILOs and aligns ILOs to tasks for unit</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="337">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="338">
          
          
          <code class="ruby">  def generate_and_align_ilos_for_unit(unit, unit_details)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="339">
          
          
          <code class="ruby">    if @task_def_cache.empty?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="340">
          
          
          <code class="ruby">      throw &quot;Task definition cache is empty. Call generate_tasks_for_unit unit_key, first before calling generate_and_align_ilos_for_unit&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="341">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="342">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="343">
          
          
          <code class="ruby">    # Create the ILOs</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="344">
          
          
          <code class="ruby">    print &quot;----&gt; Adding #{unit_details[:ilos]} ILOs&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="345">
          
          
          <code class="ruby">    ilo_cache = {}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="346">
          
          
          <code class="ruby">    unit_details[:ilos].times do |index|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="347">
          
          
          <code class="ruby">      ilo_number = index + 1</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="348">
          
          
          <code class="ruby">      ilo = LearningOutcome.create!(</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="349">
          
          
          <code class="ruby">        unit_id: unit.id,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="350">
          
          
          <code class="ruby">        ilo_number: ilo_number,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="351">
          
          
          <code class="ruby">        abbreviation: &quot;ILO#{ilo_number}&quot;,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="352">
          
          
          <code class="ruby">        name: Populator.words(1..4).capitalize,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="353">
          
          
          <code class="ruby">        description:  Populator.words(10..15)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="354">
          
          
          <code class="ruby">      )</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="355">
          
          
          <code class="ruby">      ilo_cache[ilo.id] = ilo</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="356">
          
          
          <code class="ruby">      print &quot;.&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="357">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="358">
          
          
          <code class="ruby">    puts &quot;!&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="359">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="360">
          
          
          <code class="ruby">    # Align each of the ILOs to a task</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="361">
          
          
          <code class="ruby">    if unit_details[:ilos] &gt; 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="362">
          
          
          <code class="ruby">      print &quot;----&gt; Aligning tasks to ILOs&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="363">
          
          
          <code class="ruby">      20.times do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="364">
          
          
          <code class="ruby">        ilo_id = unit.learning_outcomes.pluck(&#39;id&#39;).sample</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="365">
          
          
          <code class="ruby">        task_def_id = unit.task_definition_ids.sample</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="366">
          
          
          <code class="ruby">        link = LearningOutcomeTaskLink.find_or_create_by(</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="367">
          
          
          <code class="ruby">          task_definition_id: task_def_id,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="368">
          
          
          <code class="ruby">          learning_outcome_id: ilo_id,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="369">
          
          
          <code class="ruby">          task_id: nil</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="370">
          
          
          <code class="ruby">        )</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="371">
          
          
          <code class="ruby">        link.rating = rand(1..4)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="372">
          
          
          <code class="ruby">        link.description = Populator.words(5..10)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="373">
          
          
          <code class="ruby">        link.save!</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="374">
          
          
          <code class="ruby">        print &#39;.&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="375">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="376">
          
          
          <code class="ruby">      puts &#39;!&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="377">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="378">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="379">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="380">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="381">
          
          
          <code class="ruby">  # Generates tutorials for unit and enrols some students in them</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="382">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="383">
          
          
          <code class="ruby">  def generate_tutorials_and_enrol_students_for_unit(unit, unit_details)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="384">
          
          
          <code class="ruby">    student_count  = 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="385">
          
          
          <code class="ruby">    tutorial_count = 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="386">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="387">
          
          
          <code class="ruby">    # Grab stuff from scale</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="388">
          
          
          <code class="ruby">    max_tutorials  = @scale[:max_tutorials]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="389">
          
          
          <code class="ruby">    min_students   = @scale[:min_students]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="390">
          
          
          <code class="ruby">    delta_students = @scale[:delta_students]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="391">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="392">
          
          
          <code class="ruby">    # Collection of weekdays to be used</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="393">
          
          
          <code class="ruby">    weekdays = %w[Monday Tuesday Wednesday Thursday Friday]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="394">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="395">
          
          
          <code class="ruby">    # Create tutorials and enrol students</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="396">
          
          
          <code class="ruby">    unit_details[:tutors].each do | user_details |</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="397">
          
          
          <code class="ruby">      # only up to 4 tutorials for small scale</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="398">
          
          
          <code class="ruby">      if tutorial_count &gt; max_tutorials then break end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="399">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="400">
          
          
          <code class="ruby">      tutor = @user_cache[user_details[:user]]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="401">
          
          
          <code class="ruby">      puts &quot;----&gt; Enrolling tutor #{tutor.name} with #{user_details[:num]} tutorials&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="402">
          
          
          <code class="ruby">      tutor_unit_role = unit.employ_staff(tutor, Role.tutor)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="403">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="404">
          
          
          <code class="ruby">      user_details[:num].times do | count |</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="405">
          
          
          <code class="ruby">        tutorial_count += 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="406">
          
          
          <code class="ruby">        #day, time, location, tutor_username, abbrev</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="407">
          
          
          <code class="ruby">        tutorial = unit.add_tutorial(</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="408">
          
          
          <code class="ruby">          &quot;#{weekdays.sample}&quot;,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="409">
          
          
          <code class="ruby">          &quot;#{8 + rand(12)}:#{[&#39;00&#39;, &#39;30&#39;].sample}&quot;,    # Mon-Fri 8am-7:30pm</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="410">
          
          
          <code class="ruby">          &quot;#{[&#39;EN&#39;, &#39;BA&#39;].sample}#{rand(7)}#{rand(1)}#{rand(9)}&quot;, # EN###/BA###</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="411">
          
          
          <code class="ruby">          tutor,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="412">
          
          
          <code class="ruby">          &quot;LA1-#{tutorial_count.to_s.rjust(2, &#39;0&#39;)}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="413">
          
          
          <code class="ruby">        )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="414">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="415">
          
          
          <code class="ruby">        # Add a random number of students to the tutorial</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="416">
          
          
          <code class="ruby">        num_students_in_tutorial = (min_students + rand(delta_students))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="417">
          
          
          <code class="ruby">        print &quot;-----&gt; Creating #{num_students_in_tutorial} projects under tutorial #{tutorial.abbreviation}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="418">
          
          
          <code class="ruby">        num_students_in_tutorial.times do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="419">
          
          
          <code class="ruby">          student = find_or_create_student(&quot;student_#{student_count}&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="420">
          
          
          <code class="ruby">          project = unit.enrol_student(student, tutorial.id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="421">
          
          
          <code class="ruby">          student_count += 1</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="422">
          
          
          <code class="ruby">          print &#39;.&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="423">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="424">
          
          
          <code class="ruby">        # Add fixed students to first tutorial</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="425">
          
          
          <code class="ruby">        if count == 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="426">
          
          
          <code class="ruby">          unit_details[:students].each do | student_key |</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="427">
          
          
          <code class="ruby">            unit.enrol_student(@user_cache[student_key], tutorial.id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="428">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="429">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="430">
          
          
          <code class="ruby">        puts &quot;!&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="431">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="432">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="433">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="434">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="38585849ec681e9a0a489b98ee2aec73aa3375e5">
  <div class="header">
    <h3>lib/helpers/find_or_create_students.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>21</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>21</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"># Finds or creates a student if not found</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">def find_or_create_student(username)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">  user_created = nil</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">  using_cache = !@user_cache.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">  if !using_cache || !@user_cache.key?(username)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">    profile = {</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">      first_name:             Faker::Name.first_name,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">      last_name:              Faker::Name.last_name,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">      nickname:               username,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">      role_id:                Role.student_id,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">      email:                  &quot;#{username}@doubtfire.com&quot;,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">      username:               username</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">    unless AuthenticationHelpers.aaf_auth?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">      profile[:password] = &#39;password&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">      profile[:password_confirmation] = &#39;password&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">    user_created = User.create!(profile)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">    @user_cache[username] = user_created if using_cache</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">  user_created || @user_cache[username]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="092a7f28fe849b641b460fceb6919b2074e5fded">
  <div class="header">
    <h3>lib/helpers/randomizer.rb</h3>
    <h4><span class="red">0.0 %</span> covered</h4>
    <div>
      <b>14</b> relevant lines. 
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>14</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="missed" data-hits="0" data-linenumber="1">
          
          
          <code class="ruby">class Randomizer</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby">  # Randomly returns a new model (e.g., random_record_for_model(Project))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">  def self.random_record_for_model(model)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">    throw &#39;Must provide a model&#39; unless model.is_a? Class</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">    id = model.all.pluck(:id).sample</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">    model.find(id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">  # Randomly returns a new task for the given project</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">  def self.random_task_for_project(project)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">    task_def = random_task_def_for_project(project)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">    project.task_for_task_definition(task_def)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">  # Randomly returns a new task definition for the given project</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">  def self.random_task_def_for_project(project)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">    project.unit.task_definitions.sample</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
      </div>
    </div>
  </body>
</html>
